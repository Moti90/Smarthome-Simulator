<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <title>SMARTHOME SIMULATOR (WebView2)</title>
  <meta http-equiv="x-ua-compatible" content="IE=edge" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <!-- Firebase Firestore SDK (kun til progress tracking) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- App Initialization -->
  <script>
    console.log('🚀 App starter...');
  </script>

  <style>
    /* Stabil CSS-beregning */
    *, *::before, *::after { box-sizing: border-box; }

    /* Global smooth transitions - exclude wiresheet elements for performance */
    *:not(.ws-node):not(.ws-canvas):not(.ws-wires):not(.ws-nodes):not([class*="ws-"]) {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Theme transition */
    html, body, .card, .appbar, .mainnav button, .tabs button, input, select, textarea {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    /* Performance optimized transitions for specific properties */
    button:not(.ws-node button), .card:not(.ws-canvas .card), .tabs button, input, select, textarea {
      transition: 
        background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1),
        border-color 0.2s cubic-bezier(0.4, 0, 0.2, 1),
        box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
        transform 0.2s cubic-bezier(0.4, 0, 0.2, 1),
        opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Disable transitions for wiresheet elements during drag operations */
    .ws-node, .ws-canvas, .ws-wires, .ws-nodes, [class*="ws-"] {
      transition: none !important;
    }

    .ws-node.dragging, .ws-node.dragging * {
      transition: none !important;
      pointer-events: none;
    }

    html,body{
      font-family:Segoe UI,system-ui,-apple-system,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;
      margin:0;background:var(--bg-primary);color:var(--text-primary)
    }

    header{padding:12px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:12px;position:relative;justify-content:flex-start}
    .brand{ display:flex; align-items:center; justify-content:flex-start; text-align:left; margin-left: -25%; }
    .brand .goldtext{ color:#D4AF37; font-weight:700; text-shadow:0 1px 0 #000, 0 0 6px rgba(212,175,55,.5); letter-spacing:0.5px; }
    .top-right{margin-left:auto;display:flex;gap:8px;align-items:center}
    
    /* Tema vælger styling */
    .theme-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-right: 16px;
    }
    
    .theme-selector label {
      color: #cbd5e1;
      font-size: 12px;
      margin: 0;
    }
    
    .theme-selector select {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .theme-selector select:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    /* Faner (SPA) */
    .tabs{display:flex;gap:8px;margin:8px 16px 0 16px}
    .tabs button{background:var(--bg-secondary);border:1px solid var(--border-color);color:var(--text-primary);border-radius:8px;padding:6px 10px;cursor:pointer}
    .tabs button.active{background:var(--accent-color);color:var(--text-primary)}
    .views{padding:8px 16px 16px 16px;background:var(--bg-primary)}
    .view{display:none;background:var(--bg-primary)}
    .view.active{display:block}

    /* 3-kolonne layout inde i Simulator - balanceret plads */
.wrap{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    .card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:10px;overflow:visible}
    .card h2{font-size:14px;margin:0;padding:10px 12px;border-bottom:1px solid var(--border-color);background:var(--bg-secondary)}
    .card .body{padding:10px 12px;color:var(--text-primary)}

    label{display:block;font-size:12px;margin-top:6px;margin-bottom:4px;color:var(--text-secondary)}
    input[type="text"], input[type="number"], select, input[type="time"]{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border-color);background:var(--bg-primary);color:var(--text-primary);position:relative;z-index:2}
    input[type="file"]{width:100%;padding:6px;border-radius:8px;border:1px solid var(--border-color);background:var(--bg-primary);color:var(--text-primary)}
    input[type="checkbox"]{transform:scale(1.2)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    @media (max-width: 900px) { .grid2, .grid3 { grid-template-columns: 1fr; } }
    button{background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:8px;padding:8px 10px;cursor:pointer}
    button:hover{background:var(--accent-color);color:var(--text-primary)}
    .danger{background:#5b2d2d;border-color:#7a3a3a;color:white}
    .success{background:#2d5b3a;border-color:#3a7a4c;color:white}
    .info{background:#2d4e5b;border-color:#3a6b7a;color:white}
    .muted{opacity:.8;color:var(--text-secondary)}
    .tag{padding:2px 6px;border-radius:6px;background:var(--bg-secondary);border:1px solid var(--border-color);font-size:11px;color:var(--text-primary)}
    .rule{border:1px dashed var(--border-color);border-radius:8px;padding:8px;margin-bottom:8px;background:var(--bg-primary);color:var(--text-primary)}
    .log{height:240px;overflow:auto;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:8px;padding:8px;font-family:Consolas,ui-monospace,Menlo,monospace;font-size:12px;white-space:normal;color:var(--text-primary)}
    .footer{opacity:.7;padding:8px 16px;color:var(--text-secondary)}
    .small{font-size:12px;color:var(--text-secondary)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--border-color);border-radius:999px;background:var(--bg-primary);color:var(--text-primary)}
    .sp{height:8px}
    .divider{height:1px;background:var(--border-color);margin:8px 0}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .kpi .box{background:var(--bg-primary);border:1px solid var(--border-color);border-radius:8px;padding:8px;text-align:center;color:var(--text-primary)}
    textarea{width:100%;height:260px;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:8px;padding:8px;font-family:Consolas,ui-monospace}

    .menu{ position:absolute; right:12px; top:50%; transform:translateY(-50%); z-index:3000; }
    .menu > button{min-width:110px}
    .menu-list{position:absolute;right:0;top:110%;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;min-width:220px;display:none;z-index:4000;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .menu-list button{display:block;width:100%;text-align:left;background:transparent;border:0;border-bottom:1px solid var(--border-color);padding:10px;color:var(--text-primary)}
    .menu-list button:last-child{border-bottom:0}
    .menu.open .menu-list{display:block}

    .has-tip{position:relative}
    .has-tip:hover::after{
      content:attr(data-tip); position:absolute; left:auto; right:0; top:-8px; transform:translateY(-100%);
      background:var(--bg-secondary); border:1px solid var(--border-color); padding:6px 8px; border-radius:8px;
      color:var(--text-primary); font-size:11px; white-space:pre-wrap; max-width:320px; box-shadow:0 6px 16px rgba(0,0,0,.35);
      pointer-events:none; z-index:1500;
    }
    .log .match{ color:#00d26a; font-weight:600; }

    /* Nye styles for forbedret design */
    .section-group {
      margin-bottom: 16px;
      padding: 8px;
      background: rgba(var(--bg-primary), 0.6);
      border: 1px solid var(--border-color);
      border-radius: 12px;
    }
    
    .section-group:last-child {
      margin-bottom: 0;
    }
    
    .control-group {
      margin-bottom: 12px;
    }
    
    .control-group:last-child {
      margin-bottom: 0;
    }
    
    .input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .input-row .styled-input {
      flex: 1;
    }
    
    .button-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .styled-input {
      background: var(--bg-primary) !important;
      color: var(--text-primary) !important;
      border: 1px solid var(--border-color) !important;
      padding: 10px 12px !important;
      border-radius: 8px !important;
      font-size: 13px !important;
      transition: all 0.2s ease !important;
    }
    
    .styled-input:focus {
      outline: none;
      border-color: var(--accent-color) !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    }
    
    .styled-input:hover {
      border-color: var(--accent-color) !important;
    }

    /* CSS variabler for tema support */
    :root {
      /* Standard mørkt tema */
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border-color: #475569;
      --accent-color: #60a5fa;
      
      /* Ocean Blue tema */
      --ocean-bg-primary: #0f172a;
      --ocean-bg-secondary: #1e3a5f;
      --ocean-bg-card: #1e40af;
      --ocean-text-primary: #e0f2fe;
      --ocean-text-secondary: #bae6fd;
      --ocean-border-color: #0369a1;
      --ocean-accent-color: #0ea5e9;
      
      /* Forest Green tema */
      --forest-bg-primary: #0f172a;
      --forest-bg-secondary: #1e3a2d;
      --forest-bg-card: #166534;
      --forest-text-primary: #f0fdf4;
      --forest-text-secondary: #bbf7d0;
      --forest-border-color: #15803d;
      --forest-accent-color: #22c55e;
      
      /* Sunset Orange tema */
      --sunset-bg-primary: #1c1917;
      --sunset-bg-secondary: #451a03;
      --sunset-bg-card: #7c2d12;
      --sunset-text-primary: #fef3c7;
      --sunset-text-secondary: #fed7aa;
      --sunset-border-color: #ea580c;
      --sunset-accent-color: #f97316;
      
      /* Purple Night tema */
      --purple-bg-primary: #0f0a1a;
      --purple-bg-secondary: #2e1b4b;
      --purple-bg-card: #4c1d95;
      --purple-text-primary: #faf5ff;
      --purple-text-secondary: #e9d5ff;
      --purple-border-color: #7c3aed;
      --purple-accent-color: #a855f7;
      
                        /* Ruby Red tema */
                  --ruby-bg-primary: #1a0f0f;
                  --ruby-bg-secondary: #2d1a1a;
                  --ruby-bg-card: #3d1f1f;
                  --ruby-text-primary: #fef2f2;
                  --ruby-text-secondary: #fecaca;
                  --ruby-border-color: #dc2626;
                  --ruby-accent-color: #ef4444;
                  
                  /* Golden Yellow tema */
                  --golden-bg-primary: #1a1a0f;
                  --golden-bg-secondary: #2d2d1a;
                  --golden-bg-card: #3d3d1f;
                  --golden-text-primary: #fefef2;
                  --golden-text-secondary: #fefeca;
                  --golden-border-color: #d4af37;
                  --golden-accent-color: #fbbf24;
    }
    
    /* Tema klasser */
    .theme-ocean {
      --bg-primary: var(--ocean-bg-primary);
      --bg-secondary: var(--ocean-bg-secondary);
      --bg-card: var(--ocean-bg-card);
      --text-primary: var(--ocean-text-primary);
      --text-secondary: var(--ocean-text-secondary);
      --border-color: var(--ocean-border-color);
      --accent-color: var(--ocean-accent-color);
    }
    
    .theme-forest {
      --bg-primary: var(--forest-bg-primary);
      --bg-secondary: var(--forest-bg-secondary);
      --bg-card: var(--forest-bg-card);
      --text-primary: var(--forest-text-primary);
      --text-secondary: var(--forest-text-secondary);
      --border-color: var(--forest-border-color);
      --accent-color: var(--forest-accent-color);
    }
    
    .theme-sunset {
      --bg-primary: var(--sunset-bg-primary);
      --bg-secondary: var(--sunset-bg-secondary);
      --bg-card: var(--sunset-bg-card);
      --text-primary: var(--sunset-text-primary);
      --text-secondary: var(--sunset-text-secondary);
      --border-color: var(--sunset-border-color);
      --accent-color: var(--sunset-accent-color);
    }
    
    .theme-purple {
      --bg-primary: var(--purple-bg-primary);
      --bg-secondary: var(--purple-bg-secondary);
      --bg-card: var(--purple-bg-card);
      --text-primary: var(--purple-text-primary);
      --text-secondary: var(--purple-text-secondary);
      --border-color: var(--purple-border-color);
      --accent-color: var(--purple-accent-color);
    }
    
    .theme-ruby {
      --bg-primary: var(--ruby-bg-primary);
      --bg-secondary: var(--ruby-bg-secondary);
      --bg-card: var(--ruby-bg-card);
      --text-primary: var(--ruby-text-primary);
      --text-secondary: var(--ruby-text-secondary);
      --border-color: var(--ruby-border-color);
      --accent-color: var(--ruby-accent-color);
    }
    
    .theme-golden {
      --bg-primary: var(--golden-bg-primary);
      --bg-secondary: var(--golden-bg-secondary);
      --bg-card: var(--golden-bg-card);
      --text-primary: var(--golden-text-primary);
      --text-secondary: var(--golden-text-secondary);
      --border-color: var(--golden-border-color);
      --accent-color: var(--golden-accent-color);
    }

    /* Indstillinger side styling */
    .settings-section {
      margin-bottom: 24px;
      padding: 20px;
      background: rgba(var(--bg-primary), 0.4);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      transition: all 0.2s ease;
    }
    
    /* Lærer Dashboard styling */
    .progress-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .progress-item {
      background: #0f141c;
      border: 1px solid #1f2933;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }
    .progress-item .student-name {
      font-weight: 600;
      color: #e5e9f0;
      margin-bottom: 4px;
    }
    .progress-item .task-info {
      color: #cbd5e1;
      font-size: 12px;
    }
    .progress-item .timestamp {
      color: #64748b;
      font-size: 11px;
      margin-top: 4px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    .stat-box {
      background: #0f141c;
      border: 1px solid #1f2933;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }
    .stat-number {
      font-size: 24px;
      font-weight: 700;
      color: #10b981;
      margin-bottom: 4px;
    }
    .stat-label {
      color: #cbd5e1;
      font-size: 12px;
    }
    
    .settings-section:hover {
      background: rgba(var(--bg-primary), 0.6);
      border-color: var(--accent-color);
    }
    
    .settings-section h3 {
      margin: 0 0 16px 0;
      color: var(--text-primary);
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .setting-item {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .setting-item:last-child {
      margin-bottom: 0;
    }
    
    .setting-item label {
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 14px;
    }
    
    .setting-description {
      color: var(--text-secondary);
      font-size: 13px;
      line-height: 1.4;
    }
    
    /* Simulation mode styling */
    .simulation-status {
      padding: 12px;
      background: rgba(42,176,255,0.1);
      border-radius: 8px;
      border-left: 3px solid #2ab0ff;
      margin-top: 16px;
    }
    
    .simulation-active {
      background: rgba(16,185,129,0.1);
      border-left-color: #10b981;
    }
    
    /* Simulation Log Styling */
    .simulation-log {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f8f9fa;
      padding: 10px;
    }
    
    .log-controls {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .log-filters {
      margin-bottom: 15px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .log-filters label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .log-filters input[type="checkbox"] {
      margin: 0;
    }
    
    .log-entry {
      display: flex;
      gap: 10px;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      border-left: 3px solid #ddd;
    }
    
    .log-entry.system { border-left-color: #007bff; background: #e3f2fd; }
    .log-entry.sensor { border-left-color: #28a745; background: #e8f5e8; }
    .log-entry.activate { border-left-color: #ffc107; background: #fff8e1; }
    .log-entry.error { border-left-color: #dc3545; background: #f8d7da; }
    
    .log-time {
      color: #666;
      min-width: 60px;
    }
    
    .log-type {
      font-weight: bold;
      min-width: 80px;
      text-transform: uppercase;
      font-size: 11px;
    }
    
    .log-message {
      flex: 1;
    }
    
    /* Actor Status Styling */
    .tag.active {
      background: #10b981 !important;
      color: white !important;
    }
    
    .tag.inactive {
      background: #6b7280 !important;
      color: white !important;
    }
    
    /* Simulation Knap Styling */
    .btn-simulation {
      background: linear-gradient(135deg, #8b5cf6, #a855f7);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }
    
    .btn-simulation:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
      background: linear-gradient(135deg, #7c3aed, #9333ea);
    }
    
    .btn-simulation:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
    }
    
    /* HOME Knap Styling */
    .btn-home {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }
    
    .btn-home:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      background: linear-gradient(135deg, #34d399, #10b981);
    }
    
    .btn-home:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }
    
    /* === HOME SMART HOME SIMULATOR STYLING === */
    
    /* Ingen header styling - kun plantegning */
    
    /* HOME view styling */
    #view-home {
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      background: #111720;
      position: relative;
      z-index: 1;
    }
    
    /* Sikre at HOME view bliver helt skjult */
    #view-home.hidden {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      z-index: -1 !important;
    }
    
    /* Sikre at andre views ikke overlapper */
    .view:not(#view-home) {
      z-index: 2;
    }
    
    /* Sikre at HOME view har lavere z-index når det er skjult */
    #view-home.hidden {
      z-index: -999 !important;
    }
    
    /* Sikre at alle views har korrekt z-index når de er aktive */
    .view.active {
      z-index: 10;
    }
    
    /* Sikre at HOME view ikke kan overlappe andre views */
    #view-home:not(.active) {
      z-index: -1;
    }
    
    /* Sikre at HOME view er helt skjult når det ikke er aktivt */
    #view-home:not(.active) .floor-plan-background {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    
    /* Når HOME view er aktivt, skal floor-plan-background vises */
    #view-home.active .floor-plan-background {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      z-index: 999 !important;
    }
    
    /* Sikre at HOME view har højeste z-index når aktivt */
    #view-home.active {
      z-index: 1000 !important;
    }
    
    /* Sikre at andre views ikke kan overlappe HOME view */
    .view:not(#view-home):not(.hidden) {
      z-index: 100;
    }
    
    /* Home Content Layout - Simple flex layout */
    .home-content {
      display: flex;
      flex-direction: row;
      gap: 20px;
      height: calc(100vh - 100px);
      background: #111720;
    }
    
    /* Override .wrap grid for Smart Home */
    #view-home .wrap {
      display: block !important;
    }
    
    /* Base styling for body og html */
    body, html {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow-x: hidden; /* Kun horizontal scroll deaktiveret */
    }
    
    /* HOME view skal have overflow hidden på body */
    body.home-active {
      overflow: hidden;
      height: 100vh;
    }
    
    /* Wrap styling */
    .wrap {
      background: var(--bg-primary);
      margin: 0;
      padding: 0;
    }
    
    /* Sikre ensartet baggrund på alle elementer */
    .view {
      background: var(--bg-primary);
    }
    
    * {
      box-sizing: border-box;
    }
    
    /* Floor Plan Styling */
    .floor-plan-container {
      background: 
        url('floorplan1.jpg.png') center center / contain no-repeat;
      border: 3px solid var(--accent-color);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 15px 40px rgba(16, 185, 129, 0.15);
      position: relative;
      overflow: hidden;
      min-height: 600px;
      background-color: var(--bg-card);
    }
    
    /* Ingen overlay på plantegningen */
    
    /* Floor plan background - takes most of the space */
    .floor-plan-background {
      background: 
        url('floorplan1.jpg.png') center center / contain no-repeat,
        var(--bg-primary);
      flex: 1;
      position: relative;
      border-radius: 10px;
      border: 2px solid var(--accent-color);
      margin-top: -4%;
    }
    
    /* Smart Home Device Ikoner */
    .smart-device {
      position: absolute;
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
      border: 2px solid rgba(16, 185, 129, 0.8);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 100;
      backdrop-filter: blur(5px);
    }
    
    .smart-device:hover {
      transform: scale(1.2);
      background: linear-gradient(135deg, #10b981, #059669);
      border-color: #ffffff;
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
      z-index: 200;
    }
    
    .smart-device:active {
      transform: scale(1.1);
      transition-duration: 0.1s;
    }
    
    /* Drag states for smart devices */
    .smart-device.dragging {
      cursor: grabbing !important;
      z-index: 1000 !important;
      opacity: 0.8;
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
    }
    
    .smart-device.locked {
      cursor: default !important;
    }
    
    .smart-device.locked::after {
      content: "🔒";
      position: absolute;
      top: -5px;
      right: -5px;
      font-size: 12px;
      background: rgba(16, 185, 129, 0.9);
      border-radius: 50%;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid white;
    }

    /* Lys i tændt tilstand - lysende effekt */
        .smart-device.light.on {
      background: radial-gradient(circle, rgba(255, 235, 59, 0.9) 0%, rgba(255, 193, 7, 0.8) 50%, rgba(255, 152, 0, 0.7) 100%);
      border: 2px solid #ffd700;
      box-shadow:
        0 0 25px rgba(255, 235, 59, 0.8),
        0 0 40px rgba(255, 235, 59, 0.6),
        0 4px 20px rgba(0, 0, 0, 0.3);
      animation: lightGlow 2s ease-in-out infinite alternate;
    }

    /* Aktive tilstande for forskellige enheder */
    .smart-device.fan.on {
      background: radial-gradient(circle, rgba(34, 197, 94, 0.9) 0%, rgba(16, 185, 129, 0.8) 50%, rgba(5, 150, 105, 0.7) 100%);
      border: 2px solid #10b981;
      box-shadow:
        0 0 20px rgba(34, 197, 94, 0.6),
        0 0 30px rgba(34, 197, 94, 0.4);
      animation: fanSpin 1s linear infinite;
    }

    /* Sensor .on class removed - sensors now use specific value-based classes */

    .smart-device.camera.on {
      background: radial-gradient(circle, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.8) 50%, rgba(29, 78, 216, 0.7) 100%);
      border: 2px solid #3b82f6;
      box-shadow:
        0 0 20px rgba(59, 130, 246, 0.6),
        0 0 30px rgba(59, 130, 246, 0.4);
      animation: cameraBlink 2s ease-in-out infinite;
    }

    .smart-device.lock.on {
      background: radial-gradient(circle, rgba(239, 68, 68, 0.9) 0%, rgba(220, 38, 38, 0.8) 50%, rgba(185, 28, 28, 0.7) 100%);
      border: 2px solid #ef4444;
      box-shadow:
        0 0 20px rgba(239, 68, 68, 0.6),
        0 0 30px rgba(239, 68, 68, 0.4);
    }

    .smart-device.lock.off {
      background: radial-gradient(circle, rgba(16, 185, 129, 0.9) 0%, rgba(5, 150, 105, 0.8) 50%, rgba(4, 120, 87, 0.7) 100%);
      border: 2px solid #10b981;
      box-shadow:
        0 0 20px rgba(16, 185, 129, 0.6),
        0 0 30px rgba(16, 185, 129, 0.4);
    }

    .smart-device.speaker.on {
      background: radial-gradient(circle, rgba(168, 85, 247, 0.9) 0%, rgba(147, 51, 234, 0.8) 50%, rgba(126, 34, 206, 0.7) 100%);
      border: 2px solid #a855f7;
      box-shadow:
        0 0 20px rgba(168, 85, 247, 0.6),
        0 0 30px rgba(168, 85, 247, 0.4);
      animation: speakerPulse 1s ease-in-out infinite alternate;
    }

    .smart-device.window.on {
      background: radial-gradient(circle, rgba(245, 158, 11, 0.9) 0%, rgba(217, 119, 6, 0.8) 50%, rgba(180, 83, 9, 0.7) 100%);
      border: 2px solid #f59e0b;
      box-shadow:
        0 0 20px rgba(245, 158, 11, 0.6),
        0 0 30px rgba(245, 158, 11, 0.4);
    }

    .smart-device.smoke.on {
      background: radial-gradient(circle, rgba(239, 68, 68, 0.95) 0%, rgba(220, 38, 38, 0.9) 50%, rgba(185, 28, 28, 0.8) 100%);
      border: 2px solid #ef4444;
      box-shadow:
        0 0 25px rgba(239, 68, 68, 0.8),
        0 0 40px rgba(239, 68, 68, 0.6);
      animation: smokeAlarm 0.5s ease-in-out infinite alternate;
    }

    @keyframes lightGlow {
      0% { 
        box-shadow: 
          0 0 25px rgba(255, 235, 59, 0.8),
          0 0 40px rgba(255, 235, 59, 0.6),
          0 4px 20px rgba(0, 0, 0, 0.3);
      }
      100% { 
        box-shadow: 
          0 0 35px rgba(255, 235, 59, 1),
          0 0 50px rgba(255, 235, 59, 0.8),
          0 4px 20px rgba(0, 0, 0, 0.3);
      }
    }

    @keyframes fanSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes sensorPulse {
      0% { 
        box-shadow: 
          0 0 20px rgba(239, 68, 68, 0.6),
          0 0 30px rgba(239, 68, 68, 0.4);
      }
      100% { 
        box-shadow: 
          0 0 30px rgba(239, 68, 68, 0.9),
          0 0 45px rgba(239, 68, 68, 0.7);
      }
    }

    @keyframes cameraBlink {
      0%, 90% { opacity: 1; }
      95% { opacity: 0.3; }
      100% { opacity: 1; }
    }

    @keyframes speakerPulse {
      0% { 
        box-shadow: 
          0 0 20px rgba(168, 85, 247, 0.6),
          0 0 30px rgba(168, 85, 247, 0.4);
      }
      100% { 
        box-shadow: 
          0 0 30px rgba(168, 85, 247, 0.9),
          0 0 45px rgba(168, 85, 247, 0.7);
      }
    }

    @keyframes smokeAlarm {
      0% { 
        box-shadow: 
          0 0 25px rgba(239, 68, 68, 0.8),
          0 0 40px rgba(239, 68, 68, 0.6);
      }
      100% { 
        box-shadow: 
          0 0 40px rgba(239, 68, 68, 1),
          0 0 60px rgba(239, 68, 68, 0.9);
      }
    }

    /* Sensor value states */
    .smart-device.sensor-normal {
      background: radial-gradient(circle, rgba(34, 197, 94, 0.9) 0%, rgba(16, 185, 129, 0.8) 50%, rgba(5, 150, 105, 0.7) 100%);
      border: 2px solid #10b981;
      box-shadow:
        0 0 15px rgba(34, 197, 94, 0.5),
        0 0 25px rgba(34, 197, 94, 0.3);
    }

    .smart-device.sensor-low {
      background: radial-gradient(circle, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.8) 50%, rgba(29, 78, 216, 0.7) 100%);
      border: 2px solid #3b82f6;
      box-shadow:
        0 0 15px rgba(59, 130, 246, 0.5),
        0 0 25px rgba(59, 130, 246, 0.3);
    }

    .smart-device.sensor-high {
      background: radial-gradient(circle, rgba(245, 158, 11, 0.9) 0%, rgba(217, 119, 6, 0.8) 50%, rgba(180, 83, 9, 0.7) 100%);
      border: 2px solid #f59e0b;
      box-shadow:
        0 0 15px rgba(245, 158, 11, 0.5),
        0 0 25px rgba(245, 158, 11, 0.3);
    }

    .smart-device.sensor-critical {
      background: radial-gradient(circle, rgba(239, 68, 68, 0.9) 0%, rgba(220, 38, 38, 0.8) 50%, rgba(185, 28, 28, 0.7) 100%);
      border: 2px solid #ef4444;
      box-shadow:
        0 0 20px rgba(239, 68, 68, 0.6),
        0 0 30px rgba(239, 68, 68, 0.4);
      animation: sensorPulse 1.5s ease-in-out infinite alternate;
    }

    /* Smart Home Kontrolpanel til højre */
    .smart-home-control-panel {
      width: 300px;
      background: rgba(30, 41, 59, 0.95);
      border: 2px solid rgba(16, 185, 129, 0.6);
      border-radius: 10px;
      padding: 16px;
      height: calc(100vh - 120px);
      overflow-y: auto;
      flex-shrink: 0;
    }

    .smart-home-control-panel h3 {
      color: #10b981;
      margin: 0 0 20px 0;
      font-size: 18px;
      text-align: center;
      border-bottom: 1px solid rgba(16, 185, 129, 0.3);
      padding-bottom: 10px;
    }

    .smart-home-control-panel .control-section {
      margin-bottom: 25px;
    }

    .smart-home-control-panel .control-section h4 {
      color: #cbd5e1;
      margin: 0 0 15px 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .smart-home-control-panel .device-control {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .smart-home-control-panel .device-control:hover {
      background: rgba(30, 41, 59, 0.8);
      border-color: rgba(16, 185, 129, 0.4);
    }

    .smart-home-control-panel .device-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .smart-home-control-panel .device-icon {
      font-size: 18px;
      width: 30px;
      text-align: center;
    }

    .smart-home-control-panel .device-name {
      color: #cbd5e1;
      font-size: 14px;
    }

    .smart-home-control-panel .device-toggle {
      width: 50px;
      height: 25px;
      background: #374151;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
    }

    .smart-home-control-panel .device-toggle.on {
      background: #10b981;
    }

    .smart-home-control-panel .device-toggle::after {
      content: '';
      position: absolute;
      width: 19px;
      height: 19px;
      border-radius: 50%;
      background: white;
      top: 3px;
      left: 3px;
      transition: all 0.3s ease;
    }

    .smart-home-control-panel .device-toggle.on::after {
      transform: translateX(25px);
    }

    /* Climate Control Styling */
    .climate-control {
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
    }

    .climate-control .device-info {
      justify-content: space-between;
      width: 100%;
    }

    .temperature-display {
      color: #10b981;
      font-weight: 600;
      font-size: 16px;
    }

    .temperature-slider-container {
      width: 100%;
      padding: 10px 0;
    }

    .temperature-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #374151;
      outline: none;
      -webkit-appearance: none;
      margin: 5px 0;
    }

    .temperature-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #10b981;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .temperature-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #10b981;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .temp-labels {
      display: flex;
      justify-content: space-between;
      color: #9ca3af;
      font-size: 12px;
      margin-top: 5px;
    }

    /* Security Controls */
    .security-status {
      color: #ef4444;
      font-size: 12px;
      font-weight: 500;
    }

    .security-toggle.on + .security-status,
    .security-status.active {
      color: #10b981;
    }

    /* Scenario Buttons */
    .scenario-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 5px;
    }

    .scenario-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px 10px;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #cbd5e1;
    }

    .scenario-btn:hover {
      background: rgba(30, 41, 59, 0.8);
      border-color: rgba(16, 185, 129, 0.4);
      transform: translateY(-2px);
    }

    .scenario-btn.active {
      background: rgba(16, 185, 129, 0.2);
      border-color: #10b981;
      color: #10b981;
    }

    .scenario-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .scenario-name {
      font-size: 12px;
      font-weight: 500;
      text-align: center;
    }

    /* Automation Section */
    .automation-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .automation-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .automation-icon {
      font-size: 20px;
    }

    .automation-text {
      display: flex;
      flex-direction: column;
    }

    .automation-name {
      color: #cbd5e1;
      font-size: 14px;
      font-weight: 500;
    }

    .automation-count {
      color: #9ca3af;
      font-size: 12px;
    }

    .rule-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .rule-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(16, 185, 129, 0.1);
      border-radius: 6px;
      margin-bottom: 6px;
      transition: all 0.3s ease;
    }
    
    .rule-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rule-item:hover {
      background: rgba(15, 23, 42, 0.8);
      border-color: rgba(16, 185, 129, 0.3);
    }

    .rule-info {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .rule-name {
      color: #cbd5e1;
      font-size: 13px;
      font-weight: 500;
    }

    .rule-description {
      color: #9ca3af;
      font-size: 11px;
      margin-top: 2px;
    }

    .rule-toggle {
      width: 30px;
      height: 15px;
      background: #374151;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
    }

    .rule-toggle.on {
      background: #10b981;
    }

    .rule-toggle::after {
      content: '';
      position: absolute;
      width: 11px;
      height: 11px;
      border-radius: 50%;
      background: white;
      top: 2px;
      left: 2px;
      transition: all 0.3s ease;
    }

    .rule-toggle.on::after {
      transform: translateX(15px);
    }

    .rule-delete {
      width: 24px;
      height: 24px;
      border: 1px solid #ef4444;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 4px;
      color: #ef4444;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    .rule-delete:hover {
      background: #ef4444;
      color: white;
      transform: scale(1.1);
    }

    .rule-delete:active {
      transform: scale(0.95);
    }

    /* Responsive adjustments for smaller screens */
    @media (max-width: 1200px) {
      .smart-home-control-panel {
        width: 260px;
        max-width: 260px;
        min-width: 240px;
        padding: 12px;
      }
      
      .home-content {
        gap: 8px;
        padding: 8px;
      }
    }
    
    @media (max-width: 768px) {
      .home-content {
        flex-direction: column;
        overflow-y: auto;
        height: auto;
        max-height: none;
      }
      
      .smart-home-control-panel {
        width: 100%;
        max-width: 100%;
        max-height: 250px;
        margin-top: 0;
      }
      
      .floor-plan-background {
        min-height: 300px;
        flex: none;
      }
    }

    /* Notification System */
    .notification {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      max-width: 400px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      animation: notificationSlideIn 0.3s ease-out;
    }

    .notification-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      border-radius: 12px;
    }

    .notification-message {
      color: white;
      font-size: 14px;
      font-weight: 500;
    }

    .notification-close {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.3s ease;
      margin-left: 10px;
    }

    .notification-close:hover {
      opacity: 1;
    }

    .notification-info .notification-content {
      background: rgba(59, 130, 246, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .notification-success .notification-content {
      background: rgba(16, 185, 129, 0.9);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .notification-security .notification-content {
      background: rgba(239, 68, 68, 0.9);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .notification-scenario .notification-content {
      background: rgba(139, 92, 246, 0.9);
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .notification-automation .notification-content {
      background: rgba(245, 158, 11, 0.9);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .notification.fade-out {
      animation: notificationSlideOut 0.3s ease-in forwards;
    }

    @keyframes notificationSlideIn {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    @keyframes notificationSlideOut {
      from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      to {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
    }

    /* Animation for temperature and security effects */
    @keyframes tempPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }

    @keyframes securityPulse {
      0%, 100% { 
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.8);
        border-color: #ef4444;
      }
      50% { 
        box-shadow: 0 0 25px rgba(239, 68, 68, 1);
        border-color: #dc2626;
      }
    }
    
    /* Device type specific styling */
    .smart-device.light {
      border-color: rgba(251, 191, 36, 0.8);
    }
    
    .smart-device.light:hover {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      border-color: #ffffff;
      box-shadow: 0 8px 25px rgba(251, 191, 36, 0.5);
    }
    
    .smart-device.thermostat {
      border-color: rgba(239, 68, 68, 0.8);
    }
    
    .smart-device.thermostat:hover {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border-color: #ffffff;
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.5);
    }
    
    .smart-device.camera {
      border-color: rgba(139, 92, 246, 0.8);
    }
    
    .smart-device.camera:hover {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      border-color: #ffffff;
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.5);
    }
    
    .smart-device.sensor {
      border-color: rgba(59, 130, 246, 0.8);
    }
    
    .smart-device.sensor:hover {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border-color: #ffffff;
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5);
    }
    
    .smart-device.lock {
      border-color: rgba(107, 114, 128, 0.8);
    }
    
    .smart-device.lock:hover {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      border-color: #ffffff;
      box-shadow: 0 8px 25px rgba(107, 114, 128, 0.5);
    }
    
    /* Responsive device icons på smaller screens */
    @media (max-width: 768px) {
      .smart-device {
        width: 35px;
        height: 35px;
        font-size: 16px;
      }
    }
    
    /* Drag mode styling */
    .smart-device.draggable {
      cursor: move !important;
      border: 3px dashed #10b981 !important;
      animation: dragPulse 2s infinite;
    }
    
    .smart-device.dragging {
      transform: scale(1.3) !important;
      z-index: 300 !important;
      opacity: 0.8;
      box-shadow: 0 15px 35px rgba(16, 185, 129, 0.6) !important;
    }
    
    @keyframes dragPulse {
      0%, 100% { border-color: #10b981; }
      50% { border-color: #34d399; }
    }
    
    /* Gammel Control Panel Styling fjernet - bruges kun smart-home-control-panel nu */
    
    .panel-header h2 {
      color: #0f172a;
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 25px 0;
      text-align: center;
      background: linear-gradient(135deg, #10b981, #059669);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* Gamle Control Sections fjernet - bruges kun smart-home-control-panel versioner nu */
    
    .control-section h3 {
      color: #0f172a;
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0 0 20px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Control Items */
    .control-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 12px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .control-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    
    .control-item label {
      color: #475569;
      font-weight: 500;
      font-size: 0.95rem;
    }
    
    /* Slider Styling */
    .slider-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .control-slider {
      width: 120px;
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .control-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #10b981, #059669);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
      transition: all 0.3s ease;
    }
    
    .control-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    
    .slider-value {
      color: #10b981;
      font-weight: 600;
      font-family: 'Courier New', monospace;
      min-width: 50px;
      text-align: center;
    }
    
    /* Toggle Styling */
    .toggle-container {
      position: relative;
    }
    
    .control-toggle {
      display: none;
    }
    
    .toggle-label {
      display: block;
      width: 50px;
      height: 26px;
      background: #cbd5e1;
      border-radius: 13px;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .toggle-label::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: #ffffff;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .control-toggle:checked + .toggle-label {
      background: linear-gradient(135deg, #10b981, #059669);
    }
    
    .control-toggle:checked + .toggle-label::after {
      transform: translateX(24px);
    }
    
    /* Action Buttons */
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 30px;
    }
    
    .action-btn {
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .action-btn.primary {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .action-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }
    
    .action-btn.secondary {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
    }
    
    .action-btn.secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
    }
    
    .action-btn.success {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }
    
    .action-btn.success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
    }
    
    /* Home Footer */
    .home-footer {
      display: flex;
      justify-content: center;
      padding: 20px 0;
      border-top: 2px solid rgba(16, 185, 129, 0.3);
    }
    
    .time-display {
      display: flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border: 2px solid rgba(16, 185, 129, 0.3);
      border-radius: 16px;
      padding: 16px 24px;
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
    }
    
    .time-icon {
      font-size: 1.5rem;
      filter: drop-shadow(0 0 10px rgba(16, 185, 129, 0.5));
    }
    
    .time-text {
      font-size: 1.2rem;
      font-weight: 700;
      color: #f8fafc;
      font-family: 'Courier New', monospace;
    }
    
    /* Home Welcome Notification */
    .home-welcome-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #10b981, #059669);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 15px 40px rgba(16, 185, 129, 0.3);
      z-index: 1000;
      animation: slideInRight 0.5s ease-out;
      max-width: 350px;
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .home-welcome-notification .notification-content {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .home-welcome-notification .notification-icon {
      font-size: 2rem;
      filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
    }
    
    .home-welcome-notification .notification-text {
      flex: 1;
    }
    
    .home-welcome-notification .notification-title {
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 4px;
    }
    
    .home-welcome-notification .notification-subtitle {
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.9rem;
    }
    
    .home-welcome-notification .notification-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      font-weight: 700;
      transition: all 0.3s ease;
    }
    
    .home-welcome-notification .notification-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    /* Sensor Grid Layout */
    .sensor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .sensor-card {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .sensor-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #8b5cf6, #a855f7);
    }

    .sensor-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.15);
      border-color: #8b5cf6;
    }

    .sensor-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .sensor-title {
      color: #e2e8f0;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .sensor-value {
      color: #f8fafc;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
      font-family: 'Courier New', monospace;
    }

    .sensor-subtitle {
      color: #94a3b8;
      font-size: 12px;
      font-weight: 500;
    }

    /* Status Grid */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }

    .status-item {
      background: rgba(15, 20, 28, 0.4);
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .status-label {
      color: #94a3b8;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .status-value {
      color: #f8fafc;
      font-size: 16px;
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    /* Sensor Card Variants */
    .clock-card::before { background: linear-gradient(90deg, #3b82f6, #1d4ed8); }
    .light-card::before { background: linear-gradient(90deg, #f59e0b, #d97706); }
    .humidity-card::before { background: linear-gradient(90deg, #10b981, #059669); }
    .wind-card::before { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
    .motion-card::before { background: linear-gradient(90deg, #ef4444, #dc2626); }
    .door-card::before { background: linear-gradient(90deg, #f97316, #ea580c); }
    .alarm-card::before { background: linear-gradient(90deg, #ec4899, #db2777); }
    .temp-card::before { background: linear-gradient(90deg, #06b6d4, #0891b2); }
    
    .styled-select {
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .styled-select:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .styled-select:hover {
      border-color: var(--accent-color);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-color), var(--accent-color));
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--accent-color), var(--accent-color));
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      filter: brightness(1.1);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-secondary));
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, var(--accent-color), var(--bg-secondary));
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
      color: var(--text-primary);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }
    
    .btn-danger:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    /* Style for ugedag og dæmper felter - matcher klokkeslæts boksen */
    .styled-input.weekday-select,
    .styled-input.dimmer-select {
      background: rgba(15, 20, 28, 0.8) !important;
      color: #e5e9f0 !important;
      border: 1px solid #2a3442 !important;
    }

    /* Z-Wave rækker – nu med wrap og metachips */
    .zw-row{
      display:flex; align-items:center; gap:8px;
      flex-wrap:wrap; width:100%;
      margin:6px 0;
    }
    .zw-row .zw-type{ flex:1 1 180px; min-width:160px; }
    .zw-row .zw-val{  flex:0 0 120px; }

    .zw-row button{ flex:0 0 auto; }
    .zw-meta{ margin-left:auto; display:flex; gap:8px; }
    .zw-badge{font-size:11px;padding:2px 6px;border:1px solid #2a3442;border-radius:999px;background:#0b1118;opacity:.8}
    .zw-global, .zw-maps{
      font-family:Consolas,ui-monospace,Menlo,monospace;font-size:11px;
      background:#0b1118;border:1px solid #2a3442;border-radius:6px;padding:2px 6px
    }
    .zw-maps::before{ content:"↦ "; }
  
/* === WIRESHEET MVP === */
.ws-canvas{
  position:relative; height:560px; background:
    linear-gradient(180deg,#0b1118,#0a0f15 60%);
  border:1px solid #1f2933; border-radius:12px; overflow:hidden;
}
.ws-wires{ position:absolute; inset:0; pointer-events:none }
.ws-nodes{ position:absolute; inset:0; }

.ws-node{
  position:absolute; min-width:200px; max-width:260px;
  background:#0e1520; border:1px solid #1f2933; border-radius:12px;
  box-shadow:0 8px 24px rgba(0,0,0,.25);
  user-select:none;
}
.ws-node.dragging{ opacity:.9; outline:1px dashed #3a4b63 }
.ws-head{
  display:flex; align-items:center; gap:8px; justify-content:space-between;
  padding:8px 10px; background:#0f141c; border-bottom:1px solid #16202c; border-radius:12px 12px 0 0;
  font-size:12px;
}
.ws-head .type{opacity:.85}
.ws-body{ padding:8px 10px; }
.ws-body .row{ margin-bottom:6px }
.ws-body select, .ws-body input[type="text"]{
  width:100%; padding:8px; border-radius:8px; border:1px solid #2a3442;
  background:#0b1118; color:#e5e9f0; font-size:12px;
}

.port{
  width:12px; height:12px; border-radius:50%;
  border:2px solid #2a3442; background:#0b1118;
}
.port.out{ box-shadow:0 0 0 2px rgba(88,131,196,.25); }
.port.in{ box-shadow:0 0 0 2px rgba(88,196,131,.25); }
.port-row{
  display:flex; align-items:center; gap:6px; margin:6px 0;
}
.port-label{ font-size:11px; opacity:.85 }
.ws-foot{ padding:6px 10px; border-top:1px solid #16202c; display:flex; gap:6px; justify-content:flex-end }

/* Node color accents */
.ws-node.trig .ws-head{ color:#bfe8ff }
.ws-node.cond .ws-head{ color:#c8e6ff }
.ws-node.act  .ws-head{ color:#ffe7b3 }
.ws-node.rule .ws-head{ color:#b3ffd3 }
.ws-btn{ background:#1a2430; border:1px solid #2a3442; color:#e5e9f0; border-radius:8px; padding:4px 8px; cursor:pointer; font-size:11px }
.ws-btn:hover{ background:#223247 }

.ws-badge{ font-size:10px; padding:2px 6px; border-radius:999px; border:1px solid #334155; background:#101821; }
.ws-warn{ color:#ffd38a; font-size:11px; }
.ws-ok{ color:#9ee6b8; font-size:11px; }
.ws-preview{ font-family:Consolas,ui-monospace; font-size:11px; opacity:.9; padding:6px 8px; background:#0b1118; border:1px solid #1f2933; border-radius:8px; margin-top:6px }

  
.ws-id{font-weight:600; opacity:.9; margin-right:auto}
.ws-links{font-size:11px; opacity:.8; padding:4px 6px; border-top:1px dashed #223; margin-top:4px}

  
/* === Type colors === */
.ws-node.trig { border-color:#2563eb; }
.ws-node.trig .ws-head { background:linear-gradient(90deg,#1e3a8a,#1e40af); color:#dbeafe; }
.ws-node.trig::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background:#2563eb; border-radius:12px 0 0 12px; }

.ws-node.cond { border-color:#7c3aed; }
.ws-node.cond .ws-head { background:linear-gradient(90deg,#581c87,#6d28d9); color:#ede9fe; }
.ws-node.cond::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background:#7c3aed; border-radius:12px 0 0 12px; }

.ws-node.act  { border-color:#f59e0b; }
.ws-node.act  .ws-head { background:linear-gradient(90deg,#78350f,#b45309); color:#fef3c7; }
.ws-node.act::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background:#f59e0b; border-radius:12px 0 0 12px; }

.ws-node.rule { border-color:#10b981; }
.ws-node.rule .ws-head { background:linear-gradient(90deg,#064e3b,#047857); color:#d1fae5; }
.ws-node.rule::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background:#10b981; border-radius:12px 0 0 12px; }

  
/* Palette buttons farver */
#wsAddTrig { background:#1e40af; border-color:#2563eb; color:#dbeafe; }
#wsAddTrig:hover { filter:brightness(1.05); }
#wsAddCond { background:#6d28d9; border-color:#7c3aed; color:#ede9fe; }
#wsAddCond:hover { filter:brightness(1.05); }
#wsAddAct  { background:#b45309; border-color:#f59e0b; color:#fef3c7; }
#wsAddAct:hover { filter:brightness(1.05); }
#wsAddRule { background:#047857; border-color:#10b981; color:#d1fae5; }
#wsAddRule:hover { filter:brightness(1.05); }

  
/* === Login click-through fix === */
#loginView { position: relative; }
#loginView::before,
#loginView::after {
  pointer-events: none !important;  /* overlays må ikke blokere klik */
  z-index: 0;
}
/* Sørg for at selve login-panelet er øverst */
#loginView .login-card,
#loginView .card {
  position: relative;
  z-index: 5 !important;
}


/* === Modern Login Design === */
#loginView{
  position: relative;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #0f1419 0%, #1a2432 50%, #2a3442 100%);
  overflow: hidden;
}

/* Animated background elements */
#loginView::before{
  content:"";
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle at 30% 70%, rgba(37, 99, 235, 0.08) 0%, transparent 50%),
              radial-gradient(circle at 70% 30%, rgba(156, 163, 175, 0.05) 0%, transparent 50%);
  animation: backgroundFloat 20s ease-in-out infinite;
  z-index: 1;
  pointer-events: none;
}

@keyframes backgroundFloat {
  0%, 100% { transform: rotate(0deg) scale(1); }
  50% { transform: rotate(180deg) scale(1.1); }
}

/* Large IBI logo */
.login-logo {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 40px;
  z-index: 10;
  position: relative;
}

.login-logo .logo-smarthome {
  width: 200px;
  height: 140px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
  position: relative;
  animation: logoGlow 3s ease-in-out infinite alternate;
}

@keyframes logoGlow {
  from { filter: drop-shadow(0 10px 20px rgba(229, 231, 235, 0.3)); }
  to { filter: drop-shadow(0 15px 30px rgba(229, 231, 235, 0.5)); }
}

/* SMARTHOME Logo text styling */
.logo-text {
  margin-top: 15px;
  text-align: center;
}

.logo-title {
  font-family: 'Arial', sans-serif;
  font-weight: 900;
  font-size: 24px;
  color: #e5e7eb;
  letter-spacing: 2px;
  margin: 0;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.logo-subtitle {
  font-family: 'Arial', sans-serif;
  font-weight: 400;
  font-size: 16px;
  color: #9ca3af;
  letter-spacing: 1px;
  margin: 0;
  margin-top: 2px;
}

.login-logo h1 {
  font-size: 32px;
  font-weight: 300;
  color: #e5e7eb;
  margin: 0;
  letter-spacing: 2px;
  text-align: center;
}

.login-logo .tagline {
  font-size: 14px;
  color: #9ca3af;
  margin-top: 8px;
  font-weight: 300;
  letter-spacing: 1px;
}

/* Modern login card */
#loginView .card,
#loginView .login-card{
  position: relative;
  z-index: 10;
  background: rgba(17, 24, 39, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(75, 85, 99, 0.3);
  border-radius: 20px;
  padding: 40px;
  min-width: 400px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
}

/* Login signature */
.login-signature {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 15;
  font-size: 12px;
  color: #6b7280;
  opacity: 0.7;
  font-weight: 300;
  letter-spacing: 0.5px;
}

/* Wi-Fi bølger animationer */
.wifi-wave {
  position: absolute;
  top: 8%;
  left: 50%;
  transform: translateX(-50%);
  width: 60%;
  height: 20%;
  background: transparent;
  border-top: 4px solid #00f7ff;
  border-radius: 50%;
  opacity: 0;
  animation: pulse 2s infinite;
}

.wifi-wave:nth-child(2) { 
  top: 16%; 
  width: 80%; 
  animation-delay: 0.4s; 
}

.wifi-wave:nth-child(3) { 
  top: 24%; 
  width: 100%; 
  animation-delay: 0.8s; 
}

/* Glow animation for logo */
@keyframes glow {
  from { filter: drop-shadow(0 0 10px #00f7ff); }
  to { filter: drop-shadow(0 0 30px #00f7ff); }
}

/* Pulse animation for Wi-Fi bølger */
@keyframes pulse {
  0% { opacity: 0; transform: scale(0.8); }
  50% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(1.2); }
}

/* Slide in animation for tekst */
@keyframes slideIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Rule Diagnosis Panel */
.rule-diagnosis {
  margin-top: 12px;
  padding: 12px;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  background: #f9fafb;
  font-size: 13px;
}

.rule-diagnosis h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: #374151;
}

.diag-section {
  margin-bottom: 8px;
}

.diag-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
}

.diag-status {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
}

.diag-status.success {
  background: #10b981;
  color: white;
}

.diag-status.failure {
  background: #ef4444;
  color: white;
}

.diag-status.neutral {
  background: #6b7280;
  color: white;
}

.diag-text {
  flex: 1;
  color: #374151;
}

.diag-value {
  font-family: monospace;
  color: #059669;
  font-weight: bold;
}

.diag-explain {
  margin-top: 8px;
  padding: 8px;
  background: #fef3c7;
  border-radius: 4px;
  border-left: 4px solid #f59e0b;
  font-size: 12px;
  color: #92400e;
}

/* Log Filter Buttons */
.filter-btn {
  padding: 4px 8px;
  font-size: 12px;
  border: 1px solid #d1d5db;
  background: #f9fafb;
  color: #6b7280;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.filter-btn:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

.filter-btn.active {
  background: #3b82f6;
  color: white;
  border-color: #2563eb;
}

.log-entry {
  padding: 2px 0;
  border-bottom: 1px solid #f3f4f6;
}

.log-entry.hidden {
  display: none;
}

.log-timestamp {
  color: #6b7280;
  font-size: 11px;
  margin-right: 8px;
}

.log-type {
  display: inline-block;
  padding: 1px 4px;
  border-radius: 2px;
  font-size: 10px;
  font-weight: bold;
  margin-right: 6px;
}

.log-type.match {
  background: #10b981;
  color: white;
}

.log-type.tick {
  background: #f59e0b;
  color: white;
}

.log-type.activate {
  background: #3b82f6;
  color: white;
}

.log-type.system {
  background: #6b7280;
  color: white;
}


/* === City palette (matches login bg) === */
:root{
  --city-bg-0:#0a1120;     /* deepest navy */
  --city-bg-1:#0d1626;     /* panel navy */
  --city-bg-2:#0f1b2e;     /* header strip */
  --city-line:#90d8ff;     /* cyan arc glow */
  --city-blue:#2aa2ff;     /* electric blue */
  --city-teal:#1f7ed1;     /* teal-ish blue */
  --city-orange:#ff8a3c;   /* windows orange */
  --city-gold:#d4af37;     /* brand gold */
  --city-hair:rgba(255,255,255,.08);
  --city-hair-2:rgba(255,255,255,.12);
}

/* Simulator background depth */
#view-sim{
  position:relative;
  background:
    radial-gradient(1200px 700px at 120% -10%, rgba(42,162,255,.10) 0%, transparent 55%),
    radial-gradient(900px 500px at -20% 0%, rgba(31,126,209,.10) 0%, transparent 60%),
    linear-gradient(180deg, var(--city-bg-0) 0%, #070c18 100%);
  border-radius:12px;
  padding-top:4px;
}

/* Cards + headers */
#view-sim .card{
  background:linear-gradient(180deg, var(--city-bg-1), #0b1423);
  border:1px solid var(--city-hair);
  box-shadow:0 8px 26px rgba(0,0,0,.45);
}
#view-sim .card h2{
  background:linear-gradient(180deg, var(--city-bg-2), #0b1420);
  border-bottom:1px solid var(--city-hair);
}

/* Section accents */
#view-sim .card[data-section="sensors"]{ border-top:3px solid var(--city-blue); }
#view-sim .card[data-section="rules"]  { border-top:3px solid var(--city-orange); }
#view-sim .card[data-section="log"]    { border-top:3px solid var(--city-line); }
#view-sim .card[data-section] h2{
  position:relative;
}
#view-sim .card[data-section] h2::after{
  content:"";
  position:absolute; inset:-1px 0 auto 0; height:2px;
  background: linear-gradient(90deg, rgba(255,255,255,.0), rgba(255,255,255,.18), rgba(255,255,255,.0));
  opacity:.35;
}

/* Buttons tuned to palette */
#view-sim button{ background:#16263a; border-color:#27435f; }
#view-sim button:hover{ filter:brightness(1.08); }
#view-sim .success{ background:linear-gradient(180deg,#1e6e3f,#185836); border-color:#2a9156; }
#view-sim .danger{  background:linear-gradient(180deg,#6b2b2b,#532020); border-color:#934040; }
#view-sim .info{    background:linear-gradient(180deg,#1f4a66,#183a50); border-color:#2c6a91; }

/* KPI tags pop in city colors */
#view-sim .tag{ background:#102131; border-color:#203449; }
#view-sim #lampState.tag{ color:#ffd9b6; border-color:rgba(255,138,60,.4); background:rgba(255,138,60,.10); }
#view-sim #dimmerState.tag{ color:#cfeaff; border-color:rgba(42,162,255,.35); background:rgba(42,162,255,.10); }
#view-sim #fanState.tag{ color:#cfe7ff; border-color:rgba(31,126,209,.35); background:rgba(31,126,209,.10); }

/* Rule rows with subtle striping */
#view-sim .rule:nth-child(odd){ background:linear-gradient(180deg,#0e1624,#0b1320); }
#view-sim .rule:nth-child(even){ background:linear-gradient(180deg,#0c1422,#09101b); }


/* === City palette BOOST (more pop) === */
:root{
  --city-bg-0:#081226;     /* deeper navy */
  --city-bg-1:#0b1a33;     /* card */
  --city-bg-2:#0d223f;     /* header */
  --city-line:#9de0ff;     /* cyan glow */
  --city-blue:#2ab0ff;     /* electric blue+ */
  --city-teal:#1f8fe0;     
  --city-orange:#ff944d;   /* warmer orange */
  --city-gold:#d4af37;
  --city-hair:rgba(255,255,255,.10);
  --city-hair-2:rgba(255,255,255,.16);
}

/* Deeper bg with subtle grid */
#view-sim{
  background:
    radial-gradient(1200px 700px at 120% -10%, rgba(42,176,255,.12) 0%, transparent 55%),
    radial-gradient(900px 500px at -20% 0%, rgba(31,143,224,.12) 0%, transparent 60%),
    linear-gradient(180deg, var(--city-bg-0) 0%, #060c18 100%);
}
#view-sim::before{
  content:""; position:absolute; inset:0; z-index:0; pointer-events:none;
  background-image:
    radial-gradient(circle at 25% 15%, rgba(255,255,255,.04), transparent 40%);
  opacity:.7;
}
/* #view-sim > * { position:relative; z-index:1; } */

/* Cards pop more */
#view-sim .card{
  background:linear-gradient(180deg, var(--city-bg-1), #0a1529);
  border:1px solid var(--city-hair);
  box-shadow:0 10px 28px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.03);
}
#view-sim .card h2{
  background:
    linear-gradient(180deg, var(--city-bg-2), #0a1a34);
  border-bottom:1px solid var(--city-hair);
  letter-spacing:.2px;
}

/* Accents with header glow bars */
#view-sim .card[data-section="sensors"]{ border-top:3px solid var(--city-blue); }
#view-sim .card[data-section="rules"]  { border-top:3px solid var(--city-orange); }
#view-sim .card[data-section="log"]    { border-top:3px solid var(--city-line); }

#view-sim .card[data-section] h2::after{
  content:""; position:absolute; left:10px; right:10px; bottom:-1px; height:2px;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent);
  opacity:.5;
}
#view-sim .card[data-section="sensors"] h2{ box-shadow:inset 0 -1px 0 rgba(42,176,255,.35); }
#view-sim .card[data-section="rules"]   h2{ box-shadow:inset 0 -1px 0 rgba(255,148,77,.35); }
#view-sim .card[data-section="log"]     h2{ box-shadow:inset 0 -1px 0 rgba(157,224,255,.35); }

/* Buttons brighter & responsive */
#view-sim button{
  background:linear-gradient(180deg,#162b44,#13243a);
  border:1px solid #2a4563;
  box-shadow:0 6px 16px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);
}
#view-sim button:hover{ filter:brightness(1.12); transform:translateY(-1px); }
#view-sim button:active{ transform:translateY(0); }

#view-sim .success{ background:linear-gradient(180deg,#1f7f46,#17633a); border-color:#2fa266; }
#view-sim .danger { background:linear-gradient(180deg,#7a3232,#5b2424); border-color:#a24a4a; }
#view-sim .info   { background:linear-gradient(180deg,#20527a,#1a4261); border-color:#2d6fa0; }

/* Inputs focus with cyan line accent */
#view-sim input[type="text"], 
#view-sim input[type="number"], 
#view-sim select, 
#view-sim input[type="time"], 
#view-sim textarea{
  background:linear-gradient(180deg,#0a1426,#091121);
  border:1px solid rgba(255,255,255,.10);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
}
#view-sim input:focus, 
#view-sim select:focus, 
#view-sim textarea:focus{
  outline:none;
  border-color:rgba(42,176,255,.55);
  box-shadow:0 0 0 3px rgba(42,176,255,.20), inset 0 1px 0 rgba(255,255,255,.05);
}

/* KPI badges in palette */
#view-sim .tag{ background:#0e2136; border-color:#203a55; }
#view-sim #lampState.tag{ color:#ffd6b8; border-color:rgba(255,148,77,.5); background:rgba(255,148,77,.12); }
#view-sim #dimmerState.tag{ color:#d8f0ff; border-color:rgba(42,176,255,.5); background:rgba(42,176,255,.12); }
#view-sim #fanState.tag{ color:#d6ecff; border-color:rgba(31,143,224,.5); background:rgba(31,143,224,.12); }

/* Tabs get accent when active */
.tabs button.active{
  background:linear-gradient(180deg,#1b2f4d,#142640);
  border-color:var(--city-hair-2);
  box-shadow:inset 0 -2px 6px rgba(0,0,0,.45), 0 8px 18px rgba(0,0,0,.35);
}

/* Stronger section divider look */
#view-sim .divider{ background:rgba(255,255,255,.08); }


/* === City Theme for Flow (Wiresheet) & Settings === */

/* Extra palette for wiresheet types */
:root{
  --city-violet:#8a5cff;   /* for AND (Cond) */
  --city-green:#10b981;    /* for Rule (samler) */
}

/* FLOW VIEW removed - integrated into home view */

/* LEARNING VIEW - ONLY INLINE STYLES WORK! */

/* Hide Tips & Tricks section on other pages */
#view-sim .tips-section,
#view-settings .tips-section,
#view-sim .card:has(h2:contains("Tips")),
#view-settings .card:has(h2:contains("Tips")) {
  display: none !important;
}

/* Alternative: Hide any card with Tips & Tricks heading on non-learning pages */
#view-sim .card:has(h2:contains("💡")),
#view-settings .card:has(h2:contains("💡")) {
  display: none !important;
}
/* #view-flow styles removed - integrated into home view */

/* Wiresheet canvas */
.ws-canvas{
  background:
    radial-gradient(600px 400px at 30% -10%, rgba(42,176,255,.07) 0%, transparent 60%),
    linear-gradient(180deg,#0a1426,#091121);
  border:1px solid var(--city-hair);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 10px 28px rgba(0,0,0,.45);
}

/* Nodes */
.ws-node{
  background:linear-gradient(180deg,#0f1626,#0b1220);
  border:1px solid var(--city-hair-2);
  box-shadow:0 12px 28px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.04);
}
.ws-head{
  background:linear-gradient(180deg,#0f1d34,#0c1629);
  border-bottom:1px solid var(--city-hair);
}

/* Type accents */
.ws-node.trig { border-color: var(--city-blue); }
.ws-node.trig .ws-head { background:linear-gradient(90deg,#122c4a,#1f4270); color:#dbeafe; }
.ws-node.trig::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background: var(--city-blue); border-radius:12px 0 0 12px; }

.ws-node.cond { border-color: var(--city-violet); }
.ws-node.cond .ws-head { background:linear-gradient(90deg,#3a1b78,#5b32b4); color:#ede9fe; }
.ws-node.cond::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background: var(--city-violet); border-radius:12px 0 0 12px; }

.ws-node.act  { border-color: var(--city-orange); }
.ws-node.act  .ws-head { background:linear-gradient(90deg,#6b3a0a,#b45309); color:#fef3c7; }
.ws-node.act::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background: var(--city-orange); border-radius:12px 0 0 12px; }

.ws-node.rule { border-color: var(--city-green); }
.ws-node.rule .ws-head { background:linear-gradient(90deg,#064e3b,#0b7a5f); color:#d1fae5; }
.ws-node.rule::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background: var(--city-green); border-radius:12px 0 0 12px; }

/* Ports and connections */
.port{ border-color: rgba(255,255,255,.25); background:#0b1118; }
.port.out{ box-shadow:0 0 0 2px rgba(42,176,255,.30), inset 0 0 0 2px rgba(255,255,255,.06); }
.port.in{  box-shadow:0 0 0 2px rgba(16,185,129,.30), inset 0 0 0 2px rgba(255,255,255,.06); }
.ws-wires svg path{
  stroke: rgba(157,224,255,.85);
  filter: drop-shadow(0 0 6px rgba(157,224,255,.5));
}

/* Node inputs */
.ws-body select, .ws-body input[type="text"]{
  background:linear-gradient(180deg,#0a1426,#091121);
  border:1px solid rgba(255,255,255,.10);
  color:#e6e9ee;
}
.ws-body select:focus, .ws-body input[type="text"]:focus{
  outline:none;
  border-color:rgba(42,176,255,.55);
  box-shadow:0 0 0 3px rgba(42,176,255,.20), inset 0 1px 0 rgba(255,255,255,.05);
}

/* Palette buttons at top */
#wsAddTrig { background:linear-gradient(180deg,#123a6b,#0e2c52); border-color:#2ab0ff; color:#dbeafe; }
#wsAddCond { background:linear-gradient(180deg,#46208a,#36196a); border-color:#8a5cff; color:#ede9fe; }
#wsAddAct  { background:linear-gradient(180deg,#9a4b0a,#7c3b08); border-color:#ff944d; color:#fef3c7; }
#wsAddRule { background:linear-gradient(180deg,#0d5b47,#0a4537); border-color:#10b981; color:#d1fae5; }
#wsAddTrig:hover, #wsAddCond:hover, #wsAddAct:hover, #wsAddRule:hover { filter:brightness(1.08); }

/* SETTINGS VIEW */
#view-settings{
  position:relative;
  background:
    radial-gradient(900px 500px at 110% -10%, rgba(42,176,255,.10) 0%, transparent 65%),
    linear-gradient(180deg, var(--city-bg-0), #060c18);
  border-radius:12px;
}
#view-settings .card{
  background:linear-gradient(180deg, var(--city-bg-1), #0a1529);
  border:1px solid var(--city-hair);
  box-shadow:0 10px 28px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.03);
}
#view-settings .card h2{
  background:linear-gradient(180deg, var(--city-bg-2), #0a1a34);
  border-bottom:1px solid var(--city-hair);
}
#view-settings label{ color:#cfe2ff; }
#view-settings input[type="text"], 
#view-settings input[type="number"], 
#view-settings input[type="password"], 
#view-settings input[type="time"], 
#view-settings select, 
#view-settings textarea{
  background:linear-gradient(180deg,#0a1426,#091121);
  border:1px solid rgba(255,255,255,.10);
  color:#e6e9ee;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
}
#view-settings input:focus, 
#view-settings select:focus, 
#view-settings textarea:focus{
  outline:none;
  border-color:rgba(42,176,255,.55);
  box-shadow:0 0 0 3px rgba(42,176,255,.20), inset 0 1px 0 rgba(255,255,255,.05);
}
#view-settings .success{ background:linear-gradient(180deg,#1f7f46,#17633a); border-color:#2fa266; }
#view-settings .danger { background:linear-gradient(180deg,#7a3232,#5b2424); border-color:#a24a4a; }
#view-settings .info   { background:linear-gradient(180deg,#20527a,#1a4261); border-color:#2d6fa0; }

/* TASKS VIEW */
#view-tasks{
  position:relative;
  background:
    radial-gradient(900px 500px at 110% -10%, rgba(42,176,255,.10) 0%, transparent 65%),
    linear-gradient(180deg, var(--city-bg-0), #060c18);
  border-radius:12px;
  padding: 0 !important;
}
#view-tasks .card{
  background:linear-gradient(180deg, var(--city-bg-1), #0a1529);
  border:1px solid var(--city-hair);
  box-shadow:0 10px 28px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.03);
  margin: 0;
  border-radius: 0;
  width: 100%;
}
#view-tasks .card h2{
  background:linear-gradient(180deg, var(--city-bg-2), #0a1a34);
  border-bottom:1px solid var(--city-hair);
}

#view-tasks .card .body {
  padding: 20px 24px;
}



.task-cards {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 32px;
  width: 100%;
  max-width: 100%;
}

.easy-column, .medium-column, .hard-column {
  display: flex;
  flex-direction: column;
  gap: 16px;
  background: rgba(15, 20, 28, 0.4);
  border: 2px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

.easy-column {
  border-color: rgba(16, 185, 129, 0.3) !important;
  background: rgba(16, 185, 129, 0.05) !important;
}

.easy-column::before {
  content: "🟢 Let";
  text-align: center;
  color: #10b981;
  font-weight: 600;
  font-size: 16px;
  margin-bottom: 12px;
  padding: 12px;
  background: rgba(16, 185, 129, 0.1);
  border-radius: 8px;
  border: 1px solid rgba(16, 185, 129, 0.2);
}

.medium-column {
  border-color: rgba(245, 158, 11, 0.3) !important;
  background: rgba(245, 158, 11, 0.05) !important;
}

.medium-column::before {
  content: "🟡 Mellem";
  text-align: center;
  color: #f59e0b;
  font-weight: 600;
  font-size: 16px;
  margin-bottom: 12px;
  padding: 12px;
  background: rgba(245, 158, 11, 0.1);
  border-radius: 8px;
  border: 1px solid rgba(245, 158, 11, 0.2);
}

.hard-column {
  border-color: rgba(239, 68, 68, 0.3) !important;
  background: rgba(239, 68, 68, 0.05) !important;
}

.hard-column::before {
  content: "🔴 Svær";
  text-align: center;
  color: #ef4444;
  font-weight: 600;
  font-size: 16px;
  margin-bottom: 12px;
  padding: 12px;
  background: rgba(239, 68, 68, 0.1);
  border-radius: 8px;
  border: 1px solid rgba(239, 68, 68, 0.2);
}

.task-card {
  background: linear-gradient(180deg, #1e293b, #334155);
  border: 1px solid #475569;
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
}

.task-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  border-color: #60a5fa;
}

.task-card:active {
  transform: translateY(0);
}

.task-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.task-card h4 {
  color: #e5e9f0;
  margin: 0 0 8px 0;
  font-size: 16px;
  font-weight: 600;
}

.task-card p {
  color: #9ca3af;
  margin: 0;
  font-size: 14px;
  line-height: 1.4;
}

.task-details-header {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
}

.task-details-header h2 {
  margin: 0;
}

/* Difficulty badges */
.difficulty {
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.difficulty.easy {
  background: #10b981;
  color: white;
}

.difficulty.medium {
  background: #f59e0b;
  color: white;
}

.difficulty.hard {
  background: #ef4444;
  color: white;
}


/* === Dark dropdowns (match city theme) === */
select {
  background-color: #1c2331;      /* closed select */
  color: #e8edf5;
  border: 1px solid #2e3b4e;
  border-radius: 6px;
  padding: 4px 8px;
}
select:focus {
  outline: none;
  border-color: #2ab0ff;
  box-shadow: 0 0 0 3px rgba(42,176,255,.2);
}

/* Options list (when open) */
select option {
  background-color: #0f1b2e;      /* open list rows */
  color: #e8edf5;
}
select option:checked {
  background-color: #123a6b;
  color: #dbeafe;
}
select option:hover {
  background-color: #2e3b4e;
  color: #fff;
}

/* Support for optgroup headers */
select optgroup {
  background-color: #0f1b2e;
  color: #9fb3c8;
}

/* Disabled option look */
select option:disabled {
  color: #6c7b8a;
  background-color: #0f1b2e;
}


/* === HIGH-CONTRAST TEAL/AMBER RESKIN (forceful overrides) === */
:root{
  --hc-bg:#0b0d10; --hc-panel:#0f1319; --hc-head:#0d1116;
  --hc-hair:rgba(255,255,255,.14); --hc-hair-2:rgba(255,255,255,.22);
  --hc-text:#eef3f8; --hc-muted:#a7b4c5;
  --hc-teal:#00c2a8; --hc-amber:#ffb34d; --hc-blue:#3fb2ff; --hc-red:#ff6666;
}

/* === GOLD & SILVER THEME === */
:root{
  --gold-bg:#0d0d0d; --gold-panel:#1a1a1a; --gold-head:#0f0f0f;
  --gold-hair:rgba(255,215,0,.4); --gold-hair-2:rgba(255,215,0,.6);
  --gold-text:#ffffff; --gold-muted:#e0e0e0;
  --gold-primary:#ffd700; --gold-secondary:#ffed4e; --gold-accent:#daa520;
  --gold-glow:rgba(255,215,0,.3); --gold-bright:#fff200;
  --silver-text:#ffffff; --silver-muted:#f0f0f0;
}

/* === CRIMSON THEME === */
:root{
  --crimson-bg:#0d0d0d; --crimson-panel:#1a1a1a; --crimson-head:#0f0f0f;
  --crimson-hair:rgba(220,20,60,.4); --crimson-hair-2:rgba(220,20,60,.6);
  --crimson-text:#ffffff; --crimson-muted:#e0e0e0;
  --crimson-primary:#dc143c; --crimson-secondary:#ff1744; --crimson-accent:#b71c1c;
  --crimson-glow:rgba(220,20,60,.3); --crimson-bright:#ff4081;
  --crimson-silver-text:#ffffff; --crimson-silver-muted:#f0f0f0;
}
html,body{ background:var(--hc-bg) !important; color:var(--hc-text) !important; }

header{ background:linear-gradient(180deg,var(--hc-head),#0a0d12) !important; border-bottom:1px solid var(--hc-hair) !important; }
.brand .goldtext{ color:#ffd85e !important; text-shadow:0 1px 0 #000, 0 0 10px rgba(255,216,94,.35) !important; }

/* Tabs */
.tabs button{
  background:linear-gradient(180deg,#141a22,#0f151c) !important;
  border:1px solid var(--hc-hair) !important;
  color:var(--hc-text) !important;
  border-radius:12px !important;
  padding: 8px 16px !important;
  font-weight: 500 !important;
  letter-spacing: 0.5px !important;
}

.tabs button:hover {
  background:linear-gradient(180deg,#1a2128,#141a21) !important;
  border-color:var(--hc-hair-2) !important;
  transform: translateY(-1px);
}

.tabs button.active{
  background:linear-gradient(180deg,#1b2430,#131b24) !important;
  box-shadow:0 10px 22px rgba(0,0,0,.5), inset 0 -2px 0 rgba(255,255,255,.06) !important;
  border-color:var(--hc-hair-2) !important;
  transform: translateY(-1px);
}

/* Cards */
.card{
  background:linear-gradient(180deg,var(--hc-panel),#0b0f14) !important;
  border:1px solid var(--hc-hair) !important;
  border-radius:16px !important;
  box-shadow:0 14px 36px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04) !important;
  overflow: hidden;
  position: relative;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow:0 20px 48px rgba(0,0,0,.65), inset 0 1px 0 rgba(255,255,255,.06) !important;
  border-color: var(--hc-hair-2) !important;
}

.card h2{
  background:linear-gradient(180deg,var(--hc-head),#0c1219) !important;
  border-bottom:1px solid var(--hc-hair) !important;
  letter-spacing:.3px !important;
  font-weight: 600;
  font-size: 15px;
  padding: 14px 16px;
  margin: 0;
}

.card .body {
  padding: 16px 18px 18px 18px;
}

/* Section colored top bars */
#view-sim .card[data-section="sensors"]{ border-top:3px solid var(--hc-blue) !important; }
#view-sim .card[data-section="rules"]  { border-top:3px solid var(--hc-amber) !important; }
#view-sim .card[data-section="log"]    { border-top:3px solid var(--hc-teal) !important; }

/* Buttons */
button{
  background:linear-gradient(180deg,#172230,#121a26) !important;
  position: relative;
  overflow: hidden;
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
}

button:active {
  transform: translateY(0);
  transition-duration: 0.1s;
}

/* Button ripple effect */
button::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255,255,255,0.1);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
  pointer-events: none;
}

button:active::before {
  width: 300px;
  height: 300px;
  transition-duration: 0s;
}
/* stray invalid CSS removed:
  border:1px solid rgba(110,150,190,.45) !important;
  color:var(--hc-text) !important;
  border-radius:9px !important;
  box-shadow:0 8px 20px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.05) !important;
*/
button:hover{ filter:brightness(1.15) !important; transform:translateY(-1px) !important; }
button:active{ transform:translateY(0) !important; }
.success{ background:linear-gradient(180deg,#0e6b5e,#0b5448) !important; border-color:rgba(0,194,168,.55) !important; color: #ffffff !important; }
.danger { background:linear-gradient(180deg,#6f2a2a,#541f1f) !important; border-color:rgba(255,102,102,.55) !important; color: #ffffff !important; }
.info   { background:linear-gradient(180deg,#1c4764,#15364b) !important; border-color:rgba(63,178,255,.55) !important; color: #ffffff !important; }

/* Clean styling for PIR og dørkontakt knapper */
#pirOn, #doorOpen {
  background:linear-gradient(180deg,#1c4764,#15364b) !important;
  border-color:rgba(63,178,255,.7) !important;
  color: #ffffff !important;
  font-weight: 600 !important;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;
}

#pirOff, #doorClose {
  background:linear-gradient(180deg,#6f2a2a,#541f1f) !important;
  border-color:rgba(255,102,102,.7) !important;
  color: #ffffff !important;
  font-weight: 600 !important;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;
}

#pirOn:hover, #doorOpen:hover {
  background:linear-gradient(180deg,#205885,#183e57) !important;
  border-color:rgba(63,178,255,.9) !important;
}

#pirOff:hover, #doorClose:hover {
  background:linear-gradient(180deg,#7d3030,#612727) !important;
  border-color:rgba(255,102,102,.9) !important;
}

/* Inputs */
input[type="text"], input[type="number"], input[type="password"], select, input[type="time"], textarea{
  background:linear-gradient(180deg,#0b1219,#091017) !important;
  border:1px solid var(--hc-hair) !important;
  color:var(--hc-text) !important;
  border-radius:10px !important;
  padding:10px 14px !important;
  font-size:13px !important;
  box-shadow:inset 0 2px 4px rgba(0,0,0,.3), 0 1px 0 rgba(255,255,255,.02) !important;
}

input:hover, select:hover, textarea:hover {
  border-color: var(--hc-hair-2) !important;
  background:linear-gradient(180deg,#0d151f,#0a1319) !important;
}

input:focus, select:focus, textarea:focus{
  outline:none !important;
  border-color:rgba(0,194,168,.8) !important;
  box-shadow: 0 0 0 3px rgba(0,194,168,0.15), inset 0 2px 4px rgba(0,0,0,.25) !important;
  background:linear-gradient(180deg,#0f1823,#0c1520) !important;
}

/* KPI tags */
.tag{ background:#0d1a20 !important; border-color:rgba(0,194,168,.35) !important; color:#c8fff3 !important; }

/* View backgrounds */
#view-sim, #view-home, #view-settings{
  background:
    radial-gradient(900px 500px at 110% -10%, rgba(63,178,255,.10) 0%, transparent 65%),
    linear-gradient(180deg, #0a0f16 0%, #090d12 100%) !important;
  border-radius:14px !important;
}

/* Wiresheet canvas & nodes (also fix full-width) */
.ws-canvas{
  background:
    radial-gradient(600px 400px at 30% -10%, rgba(0,194,168,.08) 0%, transparent 60%),
    linear-gradient(180deg,#0b141c,#09121a) !important;
  border:1px solid var(--hc-hair) !important;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.04), 0 12px 30px rgba(0,0,0,.5) !important;
}

/* Moderne Wiresheet Knapper */
.ws-btn{background:#1a2430;border:1px solid #2a3442;color:#e5e9f0;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.2s ease}
.ws-btn:hover{background:#2d3b4f;border-color:#2ab0ff;transform:translateY(-1px);box-shadow:0 2px 8px rgba(42,176,255,0.3)}
.ws-btn:active{transform:translateY(0);box-shadow:0 1px 4px rgba(42,176,255,0.2)}
.ws-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;box-shadow:none}

.ws-btn-primary{background:#2ab0ff;border-color:#2ab0ff;color:white}
.ws-btn-primary:hover{background:#1a8fd9;border-color:#1a8fd9}

.ws-btn-secondary{background:#4b5563;border-color:#6b7280;color:white}
.ws-btn-secondary:hover{background:#374151;border-color:#4b5563}

.ws-btn-success{background:#10b981;border-color:#10b981;color:white}
.ws-btn-success:hover{background:#059669;border-color:#059669}

.ws-btn-danger{background:#ef4444;border-color:#ef4444;color:white}
.ws-btn-danger:hover{background:#dc2626;border-color:#dc2626}

.ws-btn-info{background:#3b82f6;border-color:#3b82f6;color:white}
.ws-btn-info:hover{background:#2563eb;border-color:#2563eb}

.ws-btn-warning{background:#f59e0b;border-color:#f59e0b;color:white}
.ws-btn-warning:hover{background:#d97706;border-color:#d97706}
.ws-node{
  display:inline-block !important;
  min-width:210px !important;
  max-width:280px !important;
  margin:12px !important;
  vertical-align:top !important;
  background:linear-gradient(180deg,#0f1622,#0b111a) !important;
  border:1px solid var(--hc-hair-2) !important;
  border-radius:14px !important;
  box-shadow:0 14px 30px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04) !important;
}
.ws-head{
  background:linear-gradient(180deg,#121b28,#0e1520) !important;
  border-bottom:1px solid var(--hc-hair) !important;
  font-size:12px !important;
  border-radius:14px 14px 0 0 !important;
}

/* Distinct type colors (unchanged roles) */
.ws-node.trig { border-color:#3b82f6 !important; }
.ws-node.trig .ws-head { background:linear-gradient(90deg,#123a6b,#1f4270) !important; color:#dbeafe !important; }
.ws-node.cond { border-color:#8a5cff !important; }
.ws-node.cond .ws-head { background:linear-gradient(90deg,#3a1b78,#5b32b4) !important; color:#ede9fe !important; }
.ws-node.act  { border-color:#ff944d !important; }
.ws-node.act  .ws-head { background:linear-gradient(90deg,#6b3a0a,#b45309) !important; color:#fef3c7 !important; }
.ws-node.rule { border-color:#10b981 !important; }
.ws-node.rule .ws-head { background:linear-gradient(90deg,#064e3b,#0b7a5f) !important; color:#d1fae5 !important; }

/* Ports & wires */
.port{ border-color: rgba(255,255,255,.28) !important; background:#0b1118 !important; }
.port.out{ box-shadow:0 0 0 2px rgba(63,178,255,.35), inset 0 0 0 2px rgba(255,255,255,.06) !important; }
.port.in{  box-shadow:0 0 0 2px rgba(16,185,129,.35), inset 0 0 0 2px rgba(255,255,255,.06) !important; }
.ws-wires svg path{ stroke: rgba(63,178,255,.85) !important; filter: drop-shadow(0 0 6px rgba(63,178,255,.5)) !important; }

/* Login safety */
#loginView::before, #loginView::after{ pointer-events:none !important; }
#loginView .card, #loginView .login-card{ position:relative; z-index: 5 !important; }


/* === Patch: targeted fixes === */
/* Hide the old LUA menu in header only */
#mainApp > header .menu { display: none !important; }

/* Keep appbar hidden until login */
.appbar { display: none; }

/* Remove the yellow 'Simulator' title block in main area */
#mainApp > header .brand { display: none !important; }

/* New LUA bar (scoped classes) */
.lua-bar{ display:flex; align-items:center; gap:10px; }
.lua-dd{ position:relative; }
.lua-dd > button{ background:#1a2430; border:1px solid #2a3442; color:#e5e9f0; border-radius:8px; padding:8px 10px; cursor:pointer; }
.lua-dd > button:hover{ filter:brightness(1.08); }
.lua-list{ position:absolute; left:0; top:110%; display:none; min-width:220px; background:#0f141c; border:1px solid #2a3442; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.45); padding:6px; z-index:9999; margin-left:8px; }
.lua-list.open{ display:block; }
.lua-list button{ display:block; width:100%; text-align:left; background:transparent; border:0; border-radius:8px; padding:10px 12px; color:#e5e9f0; }
.lua-list button:hover{ background:rgba(255,255,255,.06); }


/* === Topbar centering & sizing overrides === */
.appbar { position: relative; }
.appbar .wrap{
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  position: relative;
  max-width: 100% !important;
  padding: 0 40px !important;
}
/* Center brand (logo + text) */
.appbar .brand{
  position: relative !important;
  left: auto !important;
  transform: none !important;
  margin: 0 auto !important;
  gap: 12px !important;
}
/* Enlarge logo + name */
.appbar .brand svg{ height: 52px !important; width: auto !important; }
.appbar .brand .name{ font-size: 1.25rem !important; letter-spacing: .08em !important; font-weight: 900 !important; }

/* Keep nav snug to the right */
.appbar .mainnav{
  position: absolute !important;
  right: 40px !important;
  top: 50% !important;
  transform: translateY(-50%) !important;
  margin: 0 !important;
}

@media (max-width: 900px){
  .appbar .brand svg{ height: 42px !important; }
  .appbar .brand .name{ font-size: 1.05rem !important; }
}


.lua-bar, .lua-dd, .log { overflow: visible !important; }

/* === ONBOARDING SYSTEM === */
.onboarding-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  z-index: 10000;
  display: none;
  backdrop-filter: blur(4px);
}

.onboarding-step {
  position: absolute;
  background: linear-gradient(180deg, rgba(26, 36, 48, 0.6), rgba(15, 20, 28, 0.6));
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  border: 2px solid #2ab0ff;
  border-radius: 12px;
  padding: 16px;
  max-width: 320px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  color: #e5e9f0;
  z-index: 10001;
  animation: onboardingFadeIn 0.3s ease-out;
}

@keyframes onboardingFadeIn {
  from { opacity: 0; transform: scale(0.9) translateY(10px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}

.onboarding-step h3 {
  margin: 0 0 12px 0;
  color: #2ab0ff;
  font-size: 16px;
  font-weight: 600;
}

.onboarding-step p {
  margin: 0 0 16px 0;
  line-height: 1.5;
  font-size: 14px;
}

.onboarding-step .highlight {
  background: rgba(42, 176, 255, 0.15);
  border: 1px solid rgba(42, 176, 255, 0.3);
  border-radius: 6px;
  padding: 8px 12px;
  margin: 8px 0;
  font-family: Consolas, monospace;
  font-size: 12px;
  box-shadow: 0 0 20px rgba(42, 176, 255, 0.3);
  animation: highlightPulse 2s ease-in-out infinite;
}

@keyframes highlightPulse {
  0%, 100% { box-shadow: 0 0 20px rgba(42, 176, 255, 0.3); }
  50% { box-shadow: 0 0 30px rgba(42, 176, 255, 0.5); }
}

.onboarding-step .buttons {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 16px;
}

.onboarding-step .buttons button {
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
}

.onboarding-step .buttons .skip {
  background: #374151;
  color: #9ca3af;
}

.onboarding-step .buttons .next {
  background: #2ab0ff;
  color: white;
}

.onboarding-step .buttons .finish {
  background: #10b981;
  color: white;
}

.onboarding-step .buttons .pause {
  background: #f59e0b;
  color: white;
}

.onboarding-step .progress {
  display: flex;
  gap: 4px;
  margin-bottom: 16px;
}

.onboarding-step .progress .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #374151;
}

.onboarding-step .progress .dot.active {
  background: #2ab0ff;
}

.onboarding-step .progress .dot.completed {
  background: #10b981;
}

/* Welcome screen */
.onboarding-welcome {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(180deg, #1a2430, #0f141c);
  border: 2px solid #2ab0ff;
  border-radius: 16px;
  padding: 40px;
  max-width: 500px;
  text-align: center;
  color: #e5e9f0;
  z-index: 10002;
  box-shadow: 0 24px 48px rgba(0, 0, 0, 0.7);
}

.onboarding-welcome h2 {
  margin: 0 0 16px 0;
  color: #2ab0ff;
  font-size: 24px;
  font-weight: 700;
}

.onboarding-welcome p {
  margin: 0 0 24px 0;
  line-height: 1.6;
  font-size: 16px;
  color: #cbd5e1;
}

.onboarding-welcome .features {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin: 24px 0;
  text-align: left;
}

.onboarding-welcome .feature {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.onboarding-welcome .feature .icon {
  width: 20px;
  height: 20px;
  background: #2ab0ff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: white;
}

.onboarding-welcome .buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 24px;
}

.onboarding-welcome .buttons button {
  padding: 12px 24px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  min-width: 120px;
}

.onboarding-welcome .buttons .skip {
  background: #374151;
  color: #9ca3af;
}

.onboarding-welcome .buttons .start {
  background: #2ab0ff;
  color: white;
}

/* Quick start tasks */
.quick-start {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(180deg, #1a2430, #0f141c);
  border: 2px solid #10b981;
  border-radius: 16px;
  padding: 32px;
  max-width: 600px;
  color: #e5e9f0;
  z-index: 10003;
  box-shadow: 0 24px 48px rgba(0, 0, 0, 0.7);
  max-height: 80vh;
  overflow-y: auto;
}

.quick-start h2 {
  margin: 0 0 20px 0;
  color: #10b981;
  font-size: 20px;
  font-weight: 600;
}

.quick-start .task {
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.2);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
}

.quick-start .task h3 {
  margin: 0 0 8px 0;
  color: #10b981;
  font-size: 16px;
  font-weight: 600;
}

.quick-start .task p {
  margin: 0 0 12px 0;
  font-size: 14px;
  line-height: 1.5;
}

.quick-start .task .case-description {
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 16px;
}

.quick-start .task .case-description h4 {
  margin: 0 0 8px 0;
  color: #3b82f6;
  font-size: 14px;
  font-weight: 600;
}

.quick-start .task .case-description p {
  margin: 0 0 8px 0;
  font-size: 13px;
  line-height: 1.5;
  color: #e5e7eb;
}

.quick-start .task .case-description p:last-child {
  margin-bottom: 0;
}

.quick-start .task .case-description strong {
  color: #3b82f6;
}

.quick-start .task .steps {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 6px;
  padding: 12px;
  font-size: 13px;
  line-height: 1.6;
}

.quick-start .task .steps ol {
  margin: 0;
  padding-left: 20px;
}

.quick-start .task .steps li {
  margin-bottom: 4px;
}

.quick-start .task .difficulty {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  margin-bottom: 8px;
}

.quick-start .task .difficulty.easy {
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
}

.quick-start .task .difficulty.medium {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
}

.quick-start .task .difficulty.hard {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
}

.quick-start .task .task-completed {
  float: right;
  font-size: 20px;
  margin-top: -4px;
}

.quick-start .buttons {
  display: flex;
  gap: 12px;
  justify-content: space-between;
  margin-top: 24px;
  align-items: flex-start;
}

.quick-start .buttons .close {
  background: #374151;
  color: #9ca3af;
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
}

.quick-start .task-buttons {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.quick-start .button-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-width: 120px;
}

.quick-start .button-group h4 {
  margin: 0 0 8px 0;
  color: #9ca3af;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.quick-start .button-group .start-task {
  background: #10b981;
  color: white;
  padding: 8px 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: background-color 0.2s;
}

.quick-start .button-group .start-task:hover {
  background: #059669;
}

/* Task validation feedback */
.task-validation {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(17, 24, 39, 0.95);
  border-radius: 12px;
  padding: 16px 20px;
  max-width: 350px;
  z-index: 9999;
  box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
  display: none;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.task-validation.active {
  border: 2px solid #f59e0b;
}

.task-validation.success {
  border: 2px solid #10b981;
}

.task-validation .header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.task-validation .header .icon {
  font-size: 24px;
}

.task-validation .header h3 {
  margin: 0;
  font-size: 16px;
  color: #f3f4f6;
}

.task-validation .progress {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 4px;
  height: 8px;
  margin-bottom: 12px;
  overflow: hidden;
}

.task-validation .progress-bar {
  height: 100%;
  background: #f59e0b;
  transition: width 0.3s ease;
}

.task-validation.success .progress-bar {
  background: #10b981;
}

.task-validation .criteria {
  font-size: 14px;
  color: #9ca3af;
}

.task-validation .criteria ul {
  margin: 8px 0;
  padding-left: 20px;
}

.task-validation .criteria li {
  margin-bottom: 4px;
}

.task-validation .criteria li.completed {
  color: #10b981;
  text-decoration: line-through;
}

.task-validation .task-steps {
  margin-top: 16px;
  padding-top: 12px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  font-size: 13px;
  color: #9ca3af;
}

.task-validation .task-steps p {
  margin: 0 0 8px 0;
  font-weight: bold;
  color: #e5e7eb;
}

.task-validation .task-steps ol {
  margin: 0;
  padding-left: 18px;
}

.task-validation .task-steps li {
  margin-bottom: 4px;
  line-height: 1.4;
}

.task-validation .success-message {
  text-align: center;
  padding: 20px;
  color: #10b981;
}

.task-validation .success-message .icon {
  font-size: 48px;
  margin-bottom: 12px;
}

.task-validation .success-message h3 {
  margin: 0 0 8px 0;
  font-size: 20px;
}

.task-validation .success-message p {
  margin: 0 0 16px 0;
  color: #9ca3af;
}

.task-validation .success-message .success-buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 16px;
}

.task-validation .success-message button {
  padding: 8px 16px;
  background: #10b981;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

.task-validation .success-message .btn-primary {
  background: #3b82f6;
  font-weight: 500;
}

.task-validation .success-message .btn-primary:hover {
  background: #2563eb;
}

.task-validation .close-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: none;
  border: none;
  color: #6b7280;
  font-size: 20px;
  cursor: pointer;
  padding: 4px;
}

.task-validation .help-toggle-btn {
  position: absolute;
  top: 12px;
  right: 44px;
  background: none;
  border: none;
  color: #9ca3af;
  font-size: 18px;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: background 0.2s ease;
}

.task-validation .help-toggle-btn:hover {
  background: rgba(255, 255, 255, 0.1);
}

.task-validation .help-toggle-btn.active {
  color: #10b981;
}

/* === Læringsside styling === */
.sensor-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.sensor-card {
  background: rgba(31, 41, 55, 0.6);
  border: 1px solid rgba(75, 85, 99, 0.3);
  border-radius: 12px;
  padding: 20px;
  transition: all 0.3s ease;
}

.sensor-card:hover {
  border-color: rgba(59, 130, 246, 0.5);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

.sensor-card h3 {
  color: #3b82f6;
  margin: 0 0 16px 0;
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sensor-info p {
  margin: 8px 0;
  line-height: 1.5;
}

.sensor-info ul {
  margin: 8px 0 16px 20px;
  padding: 0;
}

.sensor-info li {
  margin: 4px 0;
  color: #d1d5db;
}

.examples-section {
  margin: 30px 0;
}

.example-card {
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(75, 85, 99, 0.3);
  border-radius: 10px;
  padding: 20px;
  margin: 20px 0;
}

.example-card h4 {
  color: #10b981;
  margin: 0 0 12px 0;
  font-size: 16px;
}

.rule-example {
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 8px;
  padding: 16px;
  margin: 12px 0;
  font-family: 'Courier New', monospace;
  color: #e5e7eb;
  line-height: 1.6;
}

.tips-section {
  margin: 30px 0;
  padding: 20px;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 10px;
}

.tips-section h3 {
  color: #3b82f6;
  margin: 0 0 16px 0;
}

.tips-section ul {
  margin: 0;
  padding-left: 20px;
}

.tips-section li {
  margin: 8px 0;
  line-height: 1.5;
}

/* === Modal styling === */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  z-index: 20000;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
}

.modal-content {
  background: linear-gradient(180deg, rgba(26, 36, 48, 0.95), rgba(15, 20, 28, 0.95));
  border: 2px solid #2ab0ff;
  border-radius: 16px;
  padding: 0;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  color: #e5e9f0;
  animation: modalFadeIn 0.3s ease-out;
}

@keyframes modalFadeIn {
  from { opacity: 0; transform: scale(0.9) translateY(20px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px 16px 24px;
  border-bottom: 1px solid rgba(75, 85, 99, 0.3);
}

.modal-header h3 {
  margin: 0;
  color: #2ab0ff;
  font-size: 18px;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  color: #6b7280;
  font-size: 24px;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #9ca3af;
}

.modal-body {
  padding: 24px;
}

/* === GOLD & SILVER THEME STYLES === */
body.gold-theme {
  background: linear-gradient(135deg, var(--gold-bg) 0%, #000000 100%) !important;
  color: var(--silver-text) !important;
}

body.gold-theme header {
  background: linear-gradient(180deg, var(--gold-head), #000000) !important;
  border-bottom: 2px solid var(--gold-primary) !important;
  box-shadow: 0 4px 20px var(--gold-glow) !important;
}

body.gold-theme .brand .goldtext {
  color: var(--gold-bright) !important;
  text-shadow: 0 2px 4px #000, 0 0 20px var(--gold-primary), 0 0 30px var(--gold-primary) !important;
  font-weight: 900 !important;
}

body.gold-theme .tabs button {
  background: linear-gradient(180deg, #2a2a2a, #1a1a1a) !important;
  border: 2px solid var(--gold-primary) !important;
  color: var(--gold-primary) !important;
  border-radius: 12px !important;
  padding: 8px 16px !important;
  font-weight: 600 !important;
  letter-spacing: 0.5px !important;
  box-shadow: 0 4px 15px var(--gold-glow) !important;
}

body.gold-theme .tabs button:hover {
  background: linear-gradient(180deg, #3a3a3a, #2a2a2a) !important;
  border-color: var(--gold-bright) !important;
  color: var(--gold-bright) !important;
  transform: translateY(-1px);
  box-shadow: 0 6px 20px var(--gold-glow) !important;
}

body.gold-theme .tabs button.active {
  background: linear-gradient(180deg, var(--gold-primary), var(--gold-secondary)) !important;
  box-shadow: 0 10px 25px var(--gold-glow), inset 0 -2px 0 var(--gold-primary) !important;
  border-color: var(--gold-bright) !important;
  color: #000 !important;
  transform: translateY(-1px);
  font-weight: 700 !important;
}

body.gold-theme .card {
  background: linear-gradient(180deg, #1a1a1a, #0f0f0f) !important;
  border: 3px solid var(--gold-primary) !important;
  border-radius: 16px !important;
  box-shadow: 0 14px 36px rgba(0,0,0,.55), 0 0 30px var(--gold-glow), inset 0 1px 0 var(--gold-primary) !important;
  overflow: hidden;
  position: relative;
}

body.gold-theme .card:hover {
  transform: translateY(-2px);
  box-shadow: 0 20px 48px rgba(0,0,0,.65), 0 0 40px var(--gold-glow), inset 0 1px 0 var(--gold-bright) !important;
  border-color: var(--gold-bright) !important;
}

body.gold-theme .card h2 {
  background: linear-gradient(180deg, var(--gold-primary), var(--gold-secondary)) !important;
  border-bottom: 2px solid var(--gold-primary) !important;
  letter-spacing: .3px !important;
  font-weight: 700;
  font-size: 15px;
  padding: 14px 16px;
  margin: 0;
  color: #000 !important;
  text-shadow: 0 1px 2px rgba(255,255,255,0.3) !important;
}

body.gold-theme .card .body {
  padding: 16px 18px 18px 18px;
}

/* Section colored top bars for gold theme */
body.gold-theme #view-sim .card[data-section="sensors"] { border-top: 3px solid var(--gold-primary) !important; }
body.gold-theme #view-sim .card[data-section="rules"] { border-top: 3px solid var(--gold-secondary) !important; }
body.gold-theme #view-sim .card[data-section="log"] { border-top: 3px solid var(--gold-accent) !important; }

body.gold-theme button {
  background: linear-gradient(180deg, #2a2a2a, #1a1a1a) !important;
  border: 2px solid var(--gold-primary) !important;
  color: var(--gold-primary) !important;
  border-radius: 9px !important;
  box-shadow: 0 8px 20px rgba(0,0,0,.5), 0 0 15px var(--gold-glow), inset 0 1px 0 var(--gold-primary) !important;
  position: relative;
  overflow: hidden;
  font-weight: 600 !important;
}

body.gold-theme button:hover {
  filter: brightness(1.2) !important;
  transform: translateY(-1px) !important;
  border-color: var(--gold-bright) !important;
  color: var(--gold-bright) !important;
  box-shadow: 0 10px 25px rgba(0,0,0,.5), 0 0 25px var(--gold-glow), inset 0 1px 0 var(--gold-bright) !important;
}

body.gold-theme button:active {
  transform: translateY(0) !important;
  transition-duration: 0.1s;
}

body.gold-theme .success {
  background: linear-gradient(180deg, var(--gold-primary), var(--gold-secondary)) !important;
  border-color: var(--gold-primary) !important;
  color: #000 !important;
  font-weight: 700 !important;
}

body.gold-theme .danger {
  background: linear-gradient(180deg, #ff6b6b, #ff5252) !important;
  border-color: #ff6b6b !important;
  color: #fff !important;
  font-weight: 700 !important;
}

body.gold-theme .info {
  background: linear-gradient(180deg, var(--gold-secondary), var(--gold-accent)) !important;
  border-color: var(--gold-secondary) !important;
  color: #000 !important;
  font-weight: 700 !important;
}

body.gold-theme input[type="text"], 
body.gold-theme input[type="number"], 
body.gold-theme input[type="password"], 
body.gold-theme select, 
body.gold-theme input[type="time"], 
body.gold-theme textarea {
  background: linear-gradient(180deg, #1a1a1a, #0f0f0f) !important;
  border: 2px solid var(--gold-primary) !important;
  color: var(--silver-text) !important;
  border-radius: 10px !important;
  padding: 10px 14px !important;
  font-size: 13px !important;
  box-shadow: inset 0 2px 4px rgba(0,0,0,.3), 0 0 10px var(--gold-glow) !important;
}

body.gold-theme input:hover, 
body.gold-theme select:hover, 
body.gold-theme textarea:hover {
  border-color: var(--gold-bright) !important;
  background: linear-gradient(180deg, #2a2a2a, #1f1f1f) !important;
  box-shadow: 0 0 15px var(--gold-glow) !important;
}

body.gold-theme input:focus, 
body.gold-theme select:focus, 
body.gold-theme textarea:focus {
  outline: none !important;
  border-color: var(--gold-bright) !important;
  box-shadow: 0 0 0 3px var(--gold-glow), 0 0 20px var(--gold-glow), inset 0 2px 4px rgba(0,0,0,.25) !important;
  background: linear-gradient(180deg, #2f2f2f, #242424) !important;
}

body.gold-theme .tag {
  background: #1f1f1f !important;
  border-color: rgba(255,215,0,.35) !important;
  color: var(--gold-primary) !important;
}

body.gold-theme #view-sim, 
body.gold-theme #view-home, 
body.gold-theme #view-settings {
  background: radial-gradient(900px 500px at 110% -10%, rgba(255,215,0,.10) 0%, transparent 65%),
              linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%) !important;
  border-radius: 14px !important;
}

body.gold-theme .ws-canvas {
  background: radial-gradient(600px 400px at 30% -10%, rgba(255,215,0,.08) 0%, transparent 60%),
              linear-gradient(180deg, #1f1f1f, #1a1a1a) !important;
  border: 1px solid var(--gold-hair) !important;
  box-shadow: inset 0 1px 0 rgba(255,215,0,.04), 0 12px 30px rgba(0,0,0,.5) !important;
}

body.gold-theme .ws-node {
  background: linear-gradient(180deg, #2a2a2a, #1f1f1f) !important;
  border: 1px solid var(--gold-hair-2) !important;
  border-radius: 14px !important;
  box-shadow: 0 14px 30px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,215,0,.04) !important;
}

body.gold-theme .ws-head {
  background: linear-gradient(180deg, #333333, #2a2a2a) !important;
  border-bottom: 1px solid var(--gold-hair) !important;
  font-size: 12px !important;
  border-radius: 14px 14px 0 0 !important;
  color: var(--gold-primary) !important;
}

/* Task cards in gold theme */
body.gold-theme .task-card {
  background: linear-gradient(180deg, #2a2a2a, #1f1f1f) !important;
  border: 1px solid var(--gold-hair) !important;
  color: var(--silver-text) !important;
}

body.gold-theme .task-card:hover {
  border-color: var(--gold-primary) !important;
  box-shadow: 0 8px 25px rgba(255,215,0,0.2) !important;
}

body.gold-theme .difficulty.easy {
  background: var(--gold-primary) !important;
  color: #000 !important;
}

body.gold-theme .difficulty.medium {
  background: var(--gold-secondary) !important;
  color: #000 !important;
}

body.gold-theme .difficulty.hard {
  background: var(--gold-accent) !important;
  color: #000 !important;
}

/* === CRIMSON THEME STYLES === */
body.crimson-theme {
  background: linear-gradient(135deg, var(--crimson-bg) 0%, #000000 100%) !important;
  color: var(--crimson-silver-text) !important;
}

body.crimson-theme header {
  background: linear-gradient(180deg, var(--crimson-head), #000000) !important;
  border-bottom: 2px solid var(--crimson-primary) !important;
  box-shadow: 0 4px 20px var(--crimson-glow) !important;
}

body.crimson-theme .brand .goldtext {
  color: var(--crimson-bright) !important;
  text-shadow: 0 2px 4px #000, 0 0 20px var(--crimson-primary), 0 0 30px var(--crimson-primary) !important;
  font-weight: 900 !important;
}

body.crimson-theme .tabs button {
  background: linear-gradient(180deg, #2a2a2a, #1a1a1a) !important;
  border: 2px solid var(--crimson-primary) !important;
  color: var(--crimson-primary) !important;
  border-radius: 12px !important;
  padding: 8px 16px !important;
  font-weight: 600 !important;
  letter-spacing: 0.5px !important;
  box-shadow: 0 4px 15px var(--crimson-glow) !important;
}

body.crimson-theme .tabs button:hover {
  background: linear-gradient(180deg, #3a3a3a, #2a2a2a) !important;
  border-color: var(--crimson-bright) !important;
  color: var(--crimson-bright) !important;
  transform: translateY(-1px);
  box-shadow: 0 6px 20px var(--crimson-glow) !important;
}

body.crimson-theme .tabs button.active {
  background: linear-gradient(180deg, var(--crimson-primary), var(--crimson-secondary)) !important;
  box-shadow: 0 10px 25px var(--crimson-glow), inset 0 -2px 0 var(--crimson-primary) !important;
  border-color: var(--crimson-bright) !important;
  color: #000 !important;
  transform: translateY(-1px);
  font-weight: 700 !important;
}

body.crimson-theme .card {
  background: linear-gradient(180deg, #1a1a1a, #0f0f0f) !important;
  border: 3px solid var(--crimson-primary) !important;
  border-radius: 16px !important;
  box-shadow: 0 14px 36px rgba(0,0,0,.55), 0 0 30px var(--crimson-glow), inset 0 1px 0 var(--crimson-primary) !important;
  overflow: hidden;
  position: relative;
}

body.crimson-theme .card:hover {
  transform: translateY(-2px);
  box-shadow: 0 20px 48px rgba(0,0,0,.65), 0 0 40px var(--crimson-glow), inset 0 1px 0 var(--crimson-bright) !important;
  border-color: var(--crimson-bright) !important;
}

body.crimson-theme .card h2 {
  background: linear-gradient(180deg, var(--crimson-primary), var(--crimson-secondary)) !important;
  border-bottom: 2px solid var(--crimson-primary) !important;
  letter-spacing: .3px !important;
  font-weight: 700;
  font-size: 15px;
  padding: 14px 16px;
  margin: 0;
  color: #000 !important;
  text-shadow: 0 1px 2px rgba(255,255,255,0.3) !important;
}

body.crimson-theme .card .body {
  padding: 16px 18px 18px 18px;
}

/* Section colored top bars for crimson theme */
body.crimson-theme #view-sim .card[data-section="sensors"] { border-top: 3px solid var(--crimson-primary) !important; }
body.crimson-theme #view-sim .card[data-section="rules"] { border-top: 3px solid var(--crimson-secondary) !important; }
body.crimson-theme #view-sim .card[data-section="log"] { border-top: 3px solid var(--crimson-accent) !important; }

body.crimson-theme button {
  background: linear-gradient(180deg, #2a2a2a, #1a1a1a) !important;
  border: 2px solid var(--crimson-primary) !important;
  color: var(--crimson-primary) !important;
  border-radius: 9px !important;
  box-shadow: 0 8px 20px rgba(0,0,0,.5), 0 0 15px var(--crimson-glow), inset 0 1px 0 var(--crimson-primary) !important;
  position: relative;
  overflow: hidden;
  font-weight: 600 !important;
}

body.crimson-theme button:hover {
  filter: brightness(1.2) !important;
  transform: translateY(-1px) !important;
  border-color: var(--crimson-bright) !important;
  color: var(--crimson-bright) !important;
  box-shadow: 0 10px 25px rgba(0,0,0,.5), 0 0 25px var(--crimson-glow), inset 0 1px 0 var(--crimson-bright) !important;
}

body.crimson-theme button:active {
  transform: translateY(0) !important;
  transition-duration: 0.1s;
}

body.crimson-theme .success {
  background: linear-gradient(180deg, var(--crimson-primary), var(--crimson-secondary)) !important;
  border-color: var(--crimson-primary) !important;
  color: #000 !important;
  font-weight: 700 !important;
}

body.crimson-theme .danger {
  background: linear-gradient(180deg, #ff6b6b, #ff5252) !important;
  border-color: #ff6b6b !important;
  color: #fff !important;
  font-weight: 700 !important;
}

body.crimson-theme .info {
  background: linear-gradient(180deg, var(--crimson-secondary), var(--crimson-accent)) !important;
  border-color: var(--crimson-secondary) !important;
  color: #000 !important;
  font-weight: 700 !important;
}

body.crimson-theme input[type="text"], 
body.crimson-theme input[type="number"], 
body.crimson-theme input[type="password"], 
body.crimson-theme select, 
body.crimson-theme input[type="time"], 
body.crimson-theme textarea {
  background: linear-gradient(180deg, #1a1a1a, #0f0f0f) !important;
  border: 2px solid var(--crimson-primary) !important;
  color: var(--crimson-silver-text) !important;
  border-radius: 10px !important;
  padding: 10px 14px !important;
  font-size: 13px !important;
  box-shadow: inset 0 2px 4px rgba(0,0,0,.3), 0 0 10px var(--crimson-glow) !important;
}

body.crimson-theme input:hover, 
body.crimson-theme select:hover, 
body.crimson-theme textarea:hover {
  border-color: var(--crimson-bright) !important;
  background: linear-gradient(180deg, #2a2a2a, #1f1f1f) !important;
  box-shadow: 0 0 15px var(--crimson-glow) !important;
}

body.crimson-theme input:focus, 
body.crimson-theme select:focus, 
body.crimson-theme textarea:focus {
  outline: none !important;
  border-color: var(--crimson-bright) !important;
  box-shadow: 0 0 0 3px var(--crimson-glow), 0 0 20px var(--crimson-glow), inset 0 2px 4px rgba(0,0,0,.25) !important;
  background: linear-gradient(180deg, #2f2f2f, #242424) !important;
}

body.crimson-theme .tag {
  background: #1f1f1f !important;
  border-color: rgba(220,20,60,.35) !important;
  color: var(--crimson-primary) !important;
}

body.crimson-theme #view-sim, 
body.crimson-theme #view-home, 
body.crimson-theme #view-settings {
  background: radial-gradient(900px 500px at 110% -10%, rgba(220,20,60,.10) 0%, transparent 65%),
              linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%) !important;
  border-radius: 14px !important;
}

body.crimson-theme .ws-canvas {
  background: radial-gradient(600px 400px at 30% -10%, rgba(220,20,60,.08) 0%, transparent 60%),
              linear-gradient(180deg, #1f1f1f, #1a1a1a) !important;
  border: 1px solid var(--crimson-hair) !important;
  box-shadow: inset 0 1px 0 rgba(220,20,60,.04), 0 12px 30px rgba(0,0,0,.5) !important;
}

body.crimson-theme .ws-node {
  background: linear-gradient(180deg, #2a2a2a, #1f1f1f) !important;
  border: 1px solid var(--crimson-hair-2) !important;
  border-radius: 14px !important;
  box-shadow: 0 14px 30px rgba(0,0,0,.55), inset 0 1px 0 rgba(220,20,60,.04) !important;
}

body.crimson-theme .ws-head {
  background: linear-gradient(180deg, #333333, #2a2a2a) !important;
  border-bottom: 1px solid var(--crimson-hair) !important;
  font-size: 12px !important;
  border-radius: 14px 14px 0 0 !important;
  color: var(--crimson-primary) !important;
}

/* Task cards in crimson theme */
body.crimson-theme .task-card {
  background: linear-gradient(180deg, #2a2a2a, #1f1f1f) !important;
  border: 1px solid var(--crimson-hair) !important;
  color: var(--crimson-silver-text) !important;
}

body.crimson-theme .task-card:hover {
  border-color: var(--crimson-primary) !important;
  box-shadow: 0 8px 25px rgba(220,20,60,0.2) !important;
}

body.crimson-theme .difficulty.easy {
  background: var(--crimson-primary) !important;
  color: #000 !important;
}

body.crimson-theme .difficulty.medium {
  background: var(--crimson-secondary) !important;
  color: #000 !important;
}

body.crimson-theme .difficulty.hard {
  background: var(--crimson-accent) !important;
  color: #000 !important;
}

/* Login background image + translucent card === */

/* Skjul header når login siden vises */
#loginView:not([style*="display: none"]) ~ header,
#loginView:not([style*="display: none"]) + header {
  display: none !important;
}
</style>

  <!-- WebView2-bro -->
  <script>
  (function(){
    let seq = 0;
    const pending = new Map();
    function hasWV2(){ return !!(window.chrome && window.chrome.webview); }
    if (hasWV2()){
      window.chrome.webview.addEventListener('message', (e) => {
        const msg = e.data || {};
        if (msg.replyTo && pending.has(msg.replyTo)) {
          const resolve = pending.get(msg.replyTo);
          pending.delete(msg.replyTo);
          resolve(msg.payload ?? msg);
        }
      });
    }
    window.api = {
      async saveText(defaultName, text){
        if (hasWV2()){
          return await new Promise((resolve) => {
            const id = 'm' + (++seq);
            pending.set(id, (resp) => resolve(resp && resp.path ? resp.path : null));
            window.chrome.webview.postMessage({ id, cmd: 'saveText', defaultName, text });
          });
        }
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([text], {type:'text/plain;charset=utf-8'}));
        a.download = defaultName; a.click();
        return defaultName;
      },
      async openText(){
        if (hasWV2()){
          return await new Promise((resolve) => {
            const id = 'm' + (++seq);
            pending.set(id, (resp) => resolve(resp && resp.ok ? { path: resp.path, text: resp.text } : null));
            window.chrome.webview.postMessage({ id, cmd: 'openText' });
          });
        }
        return null;
      }
    };
  })();
  </script>

<style>
:root{
  --hair:rgba(255,255,255,.12);
  --hair2:rgba(255,255,255,.18);
  --bg:#0f172a;
}
html,body{margin:0;background:var(--bg-primary);color:var(--text-primary);font-family:'Segoe UI',system-ui,Arial,sans-serif;}
    /* Sticky header */
    .appbar{
      position:sticky; top:0; z-index:5000;
      background:var(--bg-secondary);
      border-bottom:1px solid var(--border-color);
      box-shadow:0 2px 8px rgba(0,0,0,.6);
    }
.appbar .wrap{
  max-width:1260px; margin:0 auto;
  padding:10px 14px;
  display:flex; align-items:center; gap:12px;
  background:var(--bg-secondary);
}
.brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.06em; justify-content:flex-start; margin-left: -25%;background:var(--bg-secondary);}
    .brand .name{color:var(--text-primary);}
.mainnav{margin-left:auto; display:flex; gap:8px;background:var(--bg-secondary);}
.mainnav button{
  display:flex; align-items:center; gap:8px;
  background:linear-gradient(180deg,var(--bg-secondary),var(--bg-primary));
  border:1px solid var(--border-color);
  color:var(--text-primary);
  padding:10px 16px; 
  border-radius:12px; 
  cursor:pointer;
  font-weight: 500;
  letter-spacing: 0.3px;
  position: relative;
  overflow: hidden;
}

.mainnav button:hover{
  filter:brightness(1.15);
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.4);
  background:linear-gradient(180deg,var(--accent-color),var(--bg-secondary));
  color:var(--text-primary);
}

.mainnav button.active{
  border-color:var(--accent-color);
  box-shadow:inset 0 -2px 6px rgba(0,0,0,.45), 0 8px 18px rgba(0,0,0,.35);
  color:var(--text-primary);
  transform: translateY(-1px);
}

.mainnav button:active {
  transform: translateY(0);
  transition-duration: 0.1s;
}

/* Accent borders per section */
#view-sim .card, #view-sim [data-card]{ border-top:3px solid #2ab0ff; }
/* #view-flow styles removed - rule builder integrated into home view */
#view-settings .card, #view-settings [data-card]{ border-top:3px solid #fbbf24; }
#view-simulation .card, #view-simulation [data-card]{ border-top:3px solid #8b5cf6; }

/* Hide old top tabs/title if present */
.tabs, .top-tabs, .page-title, h1.page-title-center { display:none !important; }

/* Global polish & micro-interactions */
.row {
  gap: 10px;
}

.grid2, .grid3 {
  gap: 18px;
}

/* Improved typography hierarchy */
h2 {
  font-weight: 600;
  letter-spacing: 0.3px;
}

h3 {
  font-weight: 500;
  letter-spacing: 0.2px;
  margin-top: 0;
  margin-bottom: 12px;
}

/* Smooth scrolling */
html {
  scroll-behavior: smooth;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.15);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.25);
}

/* Enhanced glassmorphism for panels */
.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  pointer-events: none;
}

/* Loading state animation */
@keyframes shimmer {
  0% { background-position: -200px 0; }
  100% { background-position: calc(200px + 100%) 0; }
}

.loading {
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  background-size: 200px 100%;
  animation: shimmer 1.5s infinite;
}

/* SmartHome Simulator Intro Styles */
.logo-container {
  position: relative;
  width: 300px;
}

.logo {
  width: 100%;
  filter: brightness(0) drop-shadow(0 0 0 #00f7ff); /* Starter helt mørkt */
  animation: powerOn 3s ease-in-out forwards, glow 3s infinite alternate 3s;
}

/* Wi-Fi bølger (pulserende) */
.wifi {
  position: absolute;
  top: 8%;
  left: 50%;
  transform: translateX(-50%);
  width: 60%;
  height: 20%;
  background: transparent;
  border-top: 4px solid #00f7ff;
  border-radius: 50%;
  opacity: 0;
  animation: pulse 2s infinite;
  animation-delay: 3s; /* starter først når logoet er "tændt" */
}

.wifi:nth-child(2) { top: 16%; width: 80%; animation-delay: 3.4s; }
.wifi:nth-child(3) { top: 24%; width: 100%; animation-delay: 3.8s; }

/* Login Card */
.login-card {
  margin-top: 40px;
  background: rgba(17, 23, 32, 0.9);
  border: 1px solid rgba(0, 247, 255, 0.3);
  border-radius: 15px;
  backdrop-filter: blur(10px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  opacity: 0;
  animation: fadeIn 1s ease-in forwards;
  animation-delay: 4s;
}

.login-card .body {
  padding: 25px;
}

.login-card h3 {
  margin: 0 0 20px 0;
  font-size: 18px;
  font-weight: 600;
}

.login-card input {
  transition: all 0.3s ease;
}

.login-card input:focus {
  border-color: #00f7ff;
  box-shadow: 0 0 0 3px rgba(0, 247, 255, 0.1);
  outline: none;
}

.login-card button {
  transition: all 0.3s ease;
}

.login-card button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 247, 255, 0.3);
}

/* Signature */
.login-signature {
  margin-top: 20px;
  color: #6b7280;
  font-size: 12px;
  opacity: 0;
  animation: fadeIn 1s ease-in forwards;
  animation-delay: 4.5s;
}

/* Animationer */
@keyframes powerOn {
  0%   { filter: brightness(0) drop-shadow(0 0 0 #00f7ff); }
  50%  { filter: brightness(0.5) drop-shadow(0 0 10px #00f7ff); }
  100% { filter: brightness(1) drop-shadow(0 0 20px #00f7ff); }
}

@keyframes glow {
  0%   { filter: brightness(1) drop-shadow(0 0 20px #00f7ff); }
  100% { filter: brightness(1.2) drop-shadow(0 0 30px #00f7ff); }
}

@keyframes pulse {
  0%   { opacity: 0; transform: translateX(-50%) scale(0.8); }
  50%  { opacity: 1; transform: translateX(-50%) scale(1); }
  100% { opacity: 0; transform: translateX(-50%) scale(1.2); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}
</style>

</head>
<body>

<header class="appbar" style="display: flex;">
  <div class="brand">
    <img src="LOGO.png" alt="SMARTHOME SIMULATOR logo" height="50" style="margin-left: -900px;">
    <span style="color: white; font-size: 24px; margin-left: 10px; font-weight: 500;">Smarthome Simulator</span>
  </div>
  
  <nav class="mainnav">
    <button type="button" data-target="view-forside">🏡 Forside</button>
    <button type="button" data-target="view-sim">📊 Sensorer & Regler</button>
    <button type="button" data-target="view-home">🏠 Smart Home</button>
    <button type="button" data-target="view-learning">📚 Læring</button>
    <button type="button" data-target="view-tasks" title="Kom godt i gang">🚀 Opgaver</button>
    <button type="button" data-target="view-settings">⚙️ Indstillinger</button>
  </nav>
</header>

  <!-- SmartHome Simulator Intro -->
  <div id="loginView" style="display:none;flex-direction:column;align-items:center;justify-content:center;height:100vh;">
    <div class="logo-container">
      <img src="LOGO.png" alt="SmartHome Simulator Logo" class="logo">
      <!-- Wi-Fi bølger (pulserende) -->
      <div class="wifi"></div>
      <div class="wifi"></div>
      <div class="wifi"></div>
    </div>
    
    <!-- Login/Brugeroprettelse Card -->
    <div class="card login-card">
      <div class="body">
        <h3 id="loginTitle" style="text-align:center; margin-bottom:20px; color:#00f7ff;">Opret din brugerkonto</h3>
        <p id="loginSubtitle" style="text-align:center; margin-bottom:20px; color:#9ca3af; font-size:14px;">Opret en konto for at gemme dit fremskridt og opgave-resultater</p>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:6px; color:#9ca3af; font-size:14px;">Brugernavn</label>
          <input id="loginUser" placeholder="Indtast dit brugernavn" autocomplete="username" style="width:100%; padding:10px; border-radius:8px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e9f0;">
        </div>
        
        <div style="margin-bottom:20px;">
          <label style="display:block; margin-bottom:6px; color:#9ca3af; font-size:14px;">Adgangskode</label>
          <input id="loginPass" type="password" placeholder="Indtast din adgangskode" autocomplete="current-password" style="width:100%; padding:10px; border-radius:8px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e9f0;">
        </div>
        
        <button id="btnLogin" class="success" style="width:100%; padding:12px; font-size:16px; border-radius:10px; margin-bottom:12px;">
          🚀 Opret konto & Start Simulator
        </button>
        
        <p id="loginError" style="color:#ef4444; text-align:center; margin-bottom:0; font-size:14px;"></p>
      </div>
    </div>
    
    <!-- Signature -->
    <div class="login-signature">@ Rasmus Jakobsen</div>
  </div>

  <!-- User Registration Modal -->
  <div id="registerModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>👤 Opret ny bruger</h3>
        <button class="modal-close" onclick="closeRegisterModal()">×</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Fornavn</label>
          <input id="regFirstName" placeholder="Indtast fornavn" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Efternavn</label>
          <input id="regLastName" placeholder="Indtast efternavn" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Email</label>
          <input id="regEmail" type="email" placeholder="Indtast email" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Brugernavn</label>
          <input id="regUsername" placeholder="Vælg brugernavn" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Adgangskode</label>
          <input id="regPassword" type="password" placeholder="Vælg adgangskode" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <button id="btnCreateUser" class="success" style="width:100%; padding:12px; font-size:16px; border-radius:12px; margin-bottom:16px;">
          ✅ Opret bruger
        </button>
        
        <p id="registerError" style="color:#ef4444; text-align:center; margin-bottom:16px;"></p>
      </div>
    </div>
  </div>

  <!-- Teacher Login Modal -->
  <div id="teacherLoginModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>👨‍🏫 Lærer Login</h3>
        <button class="modal-close" onclick="closeTeacherLoginModal()">×</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Lærer brugernavn</label>
          <input id="teacherUsername" placeholder="Indtast lærer brugernavn" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Lærer adgangskode</label>
          <input id="teacherPassword" type="password" placeholder="Indtast lærer adgangskode" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Skole ID</label>
          <input id="teacherLoginSchoolId" placeholder="fx: skole1" value="default" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Klasse ID</label>
          <input id="teacherLoginClassId" placeholder="fx: 9a" value="default" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <button id="btnTeacherLoginSubmit" class="success" style="width:100%; padding:12px; font-size:16px; border-radius:12px; margin-bottom:16px;">
          🔓 Log ind som lærer
        </button>
        
        <p id="teacherLoginError" style="color:#ef4444; text-align:center; margin-bottom:16px;"></p>
      </div>
    </div>
  </div>

  <div id="mainApp" style="display:block;">

  <!-- Onboarding System -->
  <div id="onboardingOverlay" class="onboarding-overlay"></div>
  
  <!-- Welcome Screen -->
  <div id="onboardingWelcome" class="onboarding-welcome" style="display:none;">
            <h2>🎉 Velkommen til SmartHome Simulator!</h2>
    <p>Lær at bygge smart home automation med denne interaktive simulator. Du kan teste regler, generere LUA-kode til Fibaro HC3 og se hvordan det hele fungerer sammen.</p>
    
    <div class="features">
      <div class="feature">
        <div class="icon">🏠</div>
        <span>Simulator med sensorer & aktører</span>
      </div>
      <div class="feature">
        <div class="icon">🧩</div>
        <span>Visual Flow Editor (Wiresheet)</span>
      </div>
      <div class="feature">
        <div class="icon">⚡</div>
        <span>LUA-kode generering til HC3</span>
      </div>
      <div class="feature">
        <div class="icon">🚀</div>
        <span>Praktiske opgaver & øvelser</span>
      </div>
      <div class="feature">
        <div class="icon">📚</div>
        <span>Læringsmateriale & guides</span>
      </div>
      <div class="feature">
        <div class="icon">⚙️</div>
        <span>Tilpasningsmuligheder</span>
      </div>
    </div>
    
    <div class="buttons">
      <button class="skip" onclick="skipOnboarding()">Spring over</button>
      <button class="start" onclick="startOnboarding()">Start rundvisning</button>
    </div>
  </div>

  <!-- Task Validation Feedback -->
  <div id="taskValidation" class="task-validation">
    <button class="close-btn" onclick="closeTaskValidation()">×</button>
    <button class="help-toggle-btn" onclick="toggleTaskHelp()" title="Vis/skjul hjælp-trin">💡</button>
    <div id="taskProgress">
      <div class="header">
        <span class="icon">🎯</span>
        <h3 id="taskName">Opgave navn</h3>
      </div>
      <div class="progress">
        <div class="progress-bar" id="taskProgressBar" style="width: 0%"></div>
      </div>
      <div class="criteria">
        <p>Kriterier for at løse opgaven:</p>
        <ul id="taskCriteria">
          <!-- Criteria will be added dynamically -->
        </ul>
      </div>
      <div class="task-steps">
        <p><strong>Trin til at løse opgaven:</strong></p>
        <ol id="taskSteps">
          <!-- Steps will be added dynamically -->
        </ol>
      </div>
    </div>
    <div id="taskSuccess" class="success-message" style="display:none;">
      <div class="icon">🎉</div>
      <h3>Opgave fuldført!</h3>
      <p id="successText">Godt gået! Du har løst opgaven korrekt.</p>
      <div class="success-buttons">
        <button onclick="closeTaskValidation()">Fortsæt</button>
      </div>
    </div>
  </div>

  <!-- Quick Start Tasks -->
  <div id="quickStart" class="quick-start" style="display:none;">
    <h2>🚀 Kom godt i gang</h2>
    
    <div class="task" id="task-ganglys">
      <span class="difficulty easy">Let</span>
      <span class="task-completed" style="display:none;">✅</span>
      <h3>Ganglys Basic</h3>
      <div class="case-description">
        <h4>📋 Case: Automatisk ganglys</h4>
        <p>Du arbejder på et kontor hvor gangene ofte er tomme om aftenen. For at spare energi og sikre sikkerhed, skal du implementere et automatisk ganglys der tænder når der er bevægelse.</p>
        <p><strong>Læringsmål:</strong> Forstå grundlæggende trigger-action logik og hvordan PIR-sensorer fungerer.</p>
      </div>
      <div class="steps">
        <ol>
          <li>Gå til "Simulator" fanen</li>
          <li>Klik "Sæt: Breached" under PIR</li>
          <li>Klik "Aktivér ændringer"</li>
          <li>Gå til "Regler" sektionen</li>
          <li>Vælg "IF PIR bliver Breached" som trigger</li>
          <li>Vælg "THEN Lys → Tænd" som action</li>
          <li>Klik "Tilføj regel"</li>
          <li>Klik "Kør regler (RUN)"</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-doorlight">
      <span class="difficulty medium">Mellem</span>
      <span class="task-completed" style="display:none;">✅</span>
      <h3>Dørlys med tidsbegrænsning</h3>
      <div class="case-description">
        <h4>📋 Case: Natligt dørlys</h4>
        <p>En familie har problemer med at finde vej i mørket om natten når de skal til toilettet. De vil have et lys der automatisk tænder når døren åbnes, men kun mellem 22:00 og 06:00 for at spare energi.</p>
        <p><strong>Læringsmål:</strong> Kombinere sensor-triggers med tidsbetingelser og forstå AND-logik.</p>
      </div>
      <div class="steps">
        <ol>
          <li>Gå til "Z-Wave sensorer" sektionen</li>
          <li>Vælg "Dør-/vindueskontakt" fra dropdown</li>
          <li>Sæt værdi til "Opened"</li>
          <li>Klik "Sæt (buffer)"</li>
          <li>Klik "Aktivér ændringer"</li>
          <li>Gå til "Regler" sektionen</li>
          <li>Vælg "IF Dørkontakt ændres til Opened" som trigger</li>
          <li>Tilføj AND: "Tid mellem" med "22:00-06:00"</li>
          <li>Vælg "THEN Lys → Tænd" som action</li>
          <li>Tilføj regel og test</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-bathroom">
      <span class="difficulty hard">Svær</span>
      <span class="task-completed" style="display:none;">✅</span>
      <h3>Badventilator med fugtighed</h3>
      <div class="case-description">
        <h4>📋 Case: Intelligent badventilator</h4>
        <p>Et badeværelse har problemer med skimmel på grund af høj fugtighed efter bad. Du skal implementere en ventilator der automatisk starter når fugtigheden er høj, men kun når der ikke er nogen i rummet (lavt lys).</p>
        <p><strong>Læringsmål:</strong> Arbejde med numeriske sensorer, kombinere multiple betingelser og forstå miljøbaseret automation.</p>
      </div>
      <div class="steps">
        <ol>
          <li>Gå til "Z-Wave sensorer" sektionen</li>
          <li>Vælg "Fugtighed (%)" fra dropdown</li>
          <li>Sæt værdi til 75</li>
          <li>Klik "Sæt (buffer)"</li>
          <li>Klik "Aktivér ændringer"</li>
          <li>Gå til "Regler" sektionen</li>
          <li>Vælg "IF Fugtighed ≥ (værdi)" som trigger med værdi 75</li>
          <li>Tilføj AND: "Lys (lux) <" med værdi 50</li>
          <li>Vælg "THEN Ventilator → On" som action</li>
          <li>Klik "Tilføj regel"</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-security">
      <span class="difficulty medium">Mellem</span>
      <span class="task-completed" style="display:none;">✅</span>
      <h3>Sikkerhedsalarm</h3>
      <div class="case-description">
        <h4>📋 Case: Hjemmesikkerhed</h4>
        <p>En familie vil have et sikkerhedssystem der aktiverer en alarm når der er bevægelse om natten, men kun når de ikke er hjemme (døren er lukket).</p>
        <p><strong>Læringsmål:</strong> Implementere sikkerhedslogik med multiple sensorer og forstå hvordan man kombinerer forskellige sensorer.</p>
      </div>
      <div class="steps">
        <ol>
          <li>Gå til "Z-Wave sensorer" sektionen</li>
          <li>Vælg "PIR (bevægelse)" fra dropdown og sæt til "Breached"</li>
          <li>Vælg "Dør-/vindueskontakt" fra dropdown og sæt til "Closed"</li>
          <li>Klik "Sæt (buffer)" for begge sensorer</li>
          <li>Klik "Aktivér ændringer"</li>
          <li>Gå til "Regler" sektionen</li>
          <li>Vælg "IF PIR bliver Breached" som trigger</li>
          <li>Tilføj AND: "Dørkontakt = Closed"</li>
          <li>Tilføj AND: "Tid mellem" med "22:00-06:00"</li>
          <li>Vælg "THEN Push (log)" som action</li>
          <li>Tilføj regel og test</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-energy">
      <span class="difficulty hard">Svær</span>
      <span class="task-completed" style="display:none;">✅</span>
      <h3>Energibesparende lys</h3>
      <div class="case-description">
        <h4>📋 Case: Smart energistyring</h4>
        <p>Et kontor vil spare energi ved at have lys der automatisk slukker når der ikke er nogen i rummet, men kun hvis det er lyst udenfor (dagslys).</p>
        <p><strong>Læringsmål:</strong> Implementere kompleks energistyring med multiple betingelser og forstå hvordan man optimerer for både komfort og effektivitet.</p>
      </div>
      <div class="steps">
        <ol>
          <li>Gå til "Z-Wave sensorer" sektionen</li>
          <li>Vælg "PIR (bevægelse)" fra dropdown og sæt til "Safe"</li>
          <li>Vælg "Lys (lux)" fra dropdown og sæt til 800</li>
          <li>Klik "Sæt (buffer)" for begge sensorer</li>
          <li>Klik "Aktivér ændringer"</li>
          <li>Gå til "Regler" sektionen</li>
          <li>Vælg "IF PIR bliver Safe" som trigger</li>
          <li>Tilføj AND: "Lys (lux) >" med værdi 500</li>
          <li>Tilføj AND: "Tid mellem" med "08:00-18:00"</li>
          <li>Vælg "THEN Lys → Off" som action</li>
          <li>Tilføj regel og test</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-comfort">
      <span class="difficulty medium">Mellem</span>
      <span class="task-completed" style="display:none;">✅</span>
      <h3>Komfortstyring</h3>
      <div class="case-description">
        <h4>📋 Case: Optimalt indeklima</h4>
        <p>Et kontor har problemer med tør luft om vinteren. Du skal implementere en løsning der automatisk dæmper lyset når luften er tør og der er mørkt, for at skabe et mere behageligt miljø.</p>
        <p><strong>Læringsmål:</strong> Arbejde med numeriske sensorer og forstå hvordan man skaber behagelige miljøer gennem automation.</p>
      </div>
      <div class="steps">
        <ol>
          <li>Gå til "Z-Wave sensorer" sektionen</li>
          <li>Vælg "Fugtighed (%)" fra dropdown og sæt til 40</li>
          <li>Vælg "Lys (lux)" fra dropdown og sæt til 200</li>
          <li>Klik "Sæt (buffer)" for begge sensorer</li>
          <li>Klik "Aktivér ændringer"</li>
          <li>Gå til "Regler" sektionen</li>
          <li>Vælg "IF Fugtighed < (værdi)" som trigger med værdi 45</li>
          <li>Tilføj AND: "Lys (lux) <" med værdi 300</li>
          <li>Vælg "THEN Dæmper → 30%" som action</li>
          <li>Klik "Tilføj regel"</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-schedule">
      <span class="difficulty easy">Let</span>
      <span class="task-completed" style="display:none;">✅</span>
      <h3>Tidsbaseret automation</h3>
      <div class="case-description">
        <h4>📋 Case: Automatisk morgenstart</h4>
        <p>En familie vil have lys der automatisk tænder kl. 7:00 om morgenen, men kun på hverdage (mandag-fredag) når børnene skal i skole.</p>
        <p><strong>Læringsmål:</strong> Implementere tidsbaseret automation og forstå hvordan man kombinerer tid med ugedage.</p>
      </div>
      <div class="steps">
        <ol>
          <li>Gå til "Regler" sektionen</li>
          <li>Vælg "IF Time = hh:mm" som trigger med værdi "07:00"</li>
          <li>Tilføj AND: "Ugedag i" med værdi "1-5" (mandag-fredag)</li>
          <li>Vælg "THEN Lys → Tænd" som action</li>
          <li>Klik "Tilføj regel"</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-ventilation">
      <span class="difficulty medium">Mellem</span>
      <span class="task-completed" style="display:none;">✅</span>
      <h3>Intelligent ventilation</h3>
      <div class="case-description">
        <h4>📋 Case: Vejrbaseret ventilation</h4>
        <p>Et kontor vil have ventilation der automatisk starter når fugtigheden er høj, men kun hvis det ikke blæser for meget udenfor (for at undgå at blæse varm luft ud).</p>
        <p><strong>Læringsmål:</strong> Kombinere miljøsensorer og forstå hvordan man optimerer ventilation baseret på vejrforhold.</p>
      </div>
      <div class="steps">
        <ol>
          <li>Gå til "Z-Wave sensorer" sektionen</li>
          <li>Vælg "Fugtighed (%)" fra dropdown og sæt til 80</li>
          <li>Vælg "Vind (m/s)" fra dropdown og sæt til 15</li>
          <li>Klik "Sæt (buffer)" for begge sensorer</li>
          <li>Klik "Aktivér ændringer"</li>
          <li>Gå til "Regler" sektionen</li>
          <li>Vælg "IF Fugtighed ≥ (værdi)" som trigger med værdi 70</li>
          <li>Tilføj AND: "Vind <" med værdi 20</li>
          <li>Vælg "THEN Ventilator → On" som action</li>
          <li>Klik "Tilføj regel"</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-alarm">
      <span class="difficulty hard">Svær</span>
      <span class="task-completed" style="display:none;">✅</span>
      <h3>Alarm system</h3>
      <div class="case-description">
        <h4>📋 Case: Avanceret sikkerhed</h4>
        <p>En virksomhed vil have et alarm system der aktiveres når både døren åbnes OG der er bevægelse, men kun når alarmen er aktiveret. Dette for at undgå falske alarmer.</p>
        <p><strong>Læringsmål:</strong> Implementere kompleks sikkerhedslogik med multiple sensorer og forstå hvordan man undgår falske alarmer.</p>
      </div>
      <div class="steps">
        <ol>
          <li>Gå til "Z-Wave sensorer" sektionen</li>
          <li>Vælg "Dør-/vindueskontakt" fra dropdown og sæt til "Opened"</li>
          <li>Vælg "PIR (bevægelse)" fra dropdown og sæt til "Breached"</li>
          <li>Klik "Sæt (buffer)" for begge sensorer</li>
          <li>Klik "Aktivér ændringer"</li>
          <li>Gå til "Regler" sektionen</li>
          <li>Vælg "IF Dørkontakt ændres til Opened" som trigger</li>
          <li>Tilføj AND: "PIR = Breached"</li>
          <li>Tilføj AND: "Alarm = Armed"</li>
          <li>Vælg "THEN Push (log)" som action</li>
          <li>Klik "Tilføj regel"</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-global">
      <span class="difficulty medium">Mellem</span>
      <span class="task-completed" style="display:none;">✅</span>
      <h3>Global variabel styring</h3>
      <div class="case-description">
        <h4>📋 Case: Scene styring</h4>
        <p>En familie vil have et "away mode" der automatisk slukker alle lys når de sætter systemet i "away" tilstand. Dette skal implementeres ved hjælp af globale variabler.</p>
        <p><strong>Læringsmål:</strong> Forstå globale variabler og hvordan man bruger dem til at styre hele systemet med en enkelt indstilling.</p>
      </div>
      <div class="steps">
        <ol>
          <li>Gå til "Regler" sektionen</li>
          <li>Vælg "IF Global name=value" som trigger med værdi "mode=away"</li>
          <li>Vælg "THEN Set Global" som action med værdi "lights=off"</li>
          <li>Klik "Tilføj regel"</li>
        </ol>
      </div>
    </div>
    
    <div class="buttons">
      <button class="close" onclick="closeQuickStart()">Luk</button>
      <div class="task-buttons">
        <div class="button-group">
          <h4>Let</h4>
          <button class="start-task" onclick="startTask('ganglys')">Ganglys</button>
          <button class="start-task" onclick="startTask('schedule')">Tidsstyring</button>
        </div>
        <div class="button-group">
          <h4>Mellem</h4>
          <button class="start-task" onclick="startTask('doorlight')">Dørlys</button>
          <button class="start-task" onclick="startTask('security')">Sikkerhed</button>
          <button class="start-task" onclick="startTask('comfort')">Komfort</button>
          <button class="start-task" onclick="startTask('ventilation')">Ventilation</button>
          <button class="start-task" onclick="startTask('global')">Global</button>
        </div>
        <div class="button-group">
          <h4>Svær</h4>
          <button class="start-task" onclick="startTask('bathroom')">Badventilator</button>
          <button class="start-task" onclick="startTask('energy')">Energistyring</button>
          <button class="start-task" onclick="startTask('alarm')">Alarm</button>
        </div>
      </div>
    </div>
  </div>

  <header>
    <div class="brand"><h1 class="goldtext"> Simulator  </h1></div>
    <div class="top-left">
      <button id="btnTeacherLogin" class="btn-secondary" style="margin-right: 12px; background: #4a5568 !important; color: white !important; border: 1px solid #2d3748 !important; padding: 6px 12px !important; border-radius: 6px !important; font-weight: 500 !important; font-size: 12px !important; box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important; z-index: 9999 !important; position: relative !important; display: block !important;">👨‍🏫 Lærer</button>
      <button id="btnTeacherTab" class="btn-secondary" style="margin-right: 12px; background: #059669 !important; color: white !important; border: 1px solid #047857 !important; padding: 6px 12px !important; border-radius: 6px !important; font-weight: 500 !important; font-size: 12px !important; box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important; z-index: 9999 !important; position: relative !important; display: none !important;">📊 Dashboard</button>
    </div>
    <div class="top-right">
      <div class="menu">
        <button id="btnMenu" aria-haspopup="true" aria-expanded="false" title="LUA-værktøjer">LUA ▾</button>
        <div class="menu-list" id="menuList" role="menu">
          <button id="btnGenLua" role="menuitem">Generér LUA</button>
          <button id="btnCopyLua" role="menuitem">Kopiér LUA</button>
          <button id="btnSaveLua" role="menuitem">Gem LUA som .lua</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Faner -->
  <div class="tabs">
    <button id="tabSim"  class="active">Simulator</button>
    <button id="tabFlow">Flow (beta)</button>
    <button id="tabLearning">📚 Læring</button>
    <button id="tabSettings">Indstillinger</button>

  </div>

  <div class="views">
    <!-- ===== View: Forside ===== -->
    <section id="view-forside" class="view active">
      <div class="wrap" style="position: relative; height: 100vh;">
        <div class="card" style="text-align: center; max-width: 800px; margin: 0 auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
          <h1>🏡 Velkommen til SmartHome Simulator</h1>
          <div class="body">
            <p style="font-size: 18px; margin-bottom: 30px;">En uddannelsesplatform til IoT og hjemmeautomatisering</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0;">
              
              <div class="feature-card" style="padding: 20px; background: rgba(15, 20, 28, 0.8); border-radius: 12px; border: 1px solid #2a3442;">
                <h3>📊 Sensorer & Regler</h3>
                <p>Lær IoT grundlæggende med virtuelle sensorer og automatiseringsregler</p>
                <button onclick="document.querySelector('[data-target=view-sim]').click()" style="background: #2ab0ff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Åbn Sensorer & Regler</button>
              </div>
              
              <div class="feature-card" style="padding: 20px; background: rgba(15, 20, 28, 0.8); border-radius: 12px; border: 1px solid #2a3442;">
                <h3>🏠 Smart Home</h3>
                <p>Design og test avancerede automationsscenarier i et realistisk smart home</p>
                <button onclick="document.querySelector('[data-target=view-home]').click()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Åbn Smart Home</button>
              </div>
              
            </div>
            
            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #2a3442;">
              <h3>📚 Kom godt i gang</h3>
              <p>Nye brugere kan starte med <strong>Opgaver</strong> fanen for guidede øvelser.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== View: Simulator ===== -->
    <section id="view-sim" class="view">
      <div class="wrap">
        <!-- 1) Sensorer -->
        <div class="card" data-section="sensors">
                  <h2 style="display: flex; justify-content: space-between; align-items: center;">
          <span>1) Virtuelle sensorer & tilstande</span>
        </h2>
          <div class="body">
            <!-- Tid & miljø -->
            <div class="section-group">
              <h3 style="margin:0 0 12px 0; color:#f59e0b; font-size:16px; display:flex; align-items:center; gap:8px;">
                <span>⏰</span>
                <span>Tid & miljø</span>
              </h3>
              
              <div class="control-group">
                <label class="has-tip" data-tip="Virtuelt klokkeslæt til 'Time = hh:mm' og 'Tid mellem'.">Klokkeslæt</label>
                <input type="time" id="clock" value="21:30" class="styled-input">
              </div>

              <div class="control-group">
                <label class="has-tip" data-tip="Ugedag (Mon..Sun) – bruges i 'Ugedag i'.">Ugedag</label>
                <select id="weekday" class="styled-input weekday-select">
                  <option>Mon</option><option>Tue</option><option>Wed</option>
                  <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
                </select>
              </div>
            </div>

            <!-- System tilstande -->
            <div class="section-group">
              <h3 style="margin:0 0 12px 0; color:#ef4444; font-size:16px; display:flex; align-items:center; gap:8px;">
                <span>🔒</span>
                <span>System tilstande</span>
              </h3>

              <div class="control-group">
                <label class="has-tip" data-tip="Egne globale variabler (fx mode=night). Brug i AND: 'Global name=value'.">Globale variabler</label>
                <div class="input-row">
                  <input type="text" id="globalName" placeholder="fx mode" class="styled-input">
                  <input type="text" id="globalValue" placeholder="fx night" class="styled-input">
                </div>
                <div class="button-row">
                  <button id="setGlobal" class="info">Sæt (buffer)</button>
                  <button id="clearGlobals" class="danger">Clear alle</button>
                </div>
              </div>
            </div>

            <!-- Aktører -->
            <div class="section-group">
              <h3 style="margin:0 0 12px 0; color:#3b82f6; font-size:16px; display:flex; align-items:center; gap:8px;">
                <span>💡</span>
                <span>Aktører</span>
              </h3>
              
              <div class="kpi">
                <div class="box"><div class="small">Lampe</div><div id="lampState" class="tag">OFF</div></div>
                <div class="box"><div class="small">Dæmper</div><div id="dimmerState" class="tag">0%</div></div>
                <div class="box"><div class="small">Ventilator</div><div id="fanState" class="tag">OFF</div></div>
              </div>

              <div class="control-group">
                <div class="button-row">
                  <button id="turnLampOn">Tænd lampe</button>
                  <button id="turnLampOff">Sluk lampe</button>
                </div>
              </div>

              <div class="control-group has-tip" data-tip="Vælg dæmperniveau 0–100% og tryk 'Sæt'.">
                <label for="dimSel" class="small muted">Dæmper (0–100%)</label>
                <div class="input-row">
                  <select id="dimSel" class="styled-input dimmer-select">
                    <option value="0">0%</option><option value="10">10%</option><option value="20">20%</option>
                    <option value="30" selected>30%</option><option value="40">40%</option><option value="50">50%</option>
                    <option value="60">60%</option><option value="70">70%</option><option value="80">80%</option>
                    <option value="90">90%</option><option value="100">100%</option>
                  </select>
                  <button id="dimSet">Sæt</button>
                </div>
              </div>

              <div class="control-group">
                <div class="button-row">
                  <button id="fanOn">Fan On</button>
                  <button id="fanOff">Fan Off</button>
                </div>
              </div>
            </div>

            <!-- Z-Wave Sensorer -->
            <div class="section-group">
              <h3 style="margin:0 0 12px 0; color:#10b981; font-size:16px; display:flex; align-items:center; gap:8px;">
                <span>📡</span>
                <span>Z-Wave Sensorer</span>
              </h3>
              
              <div class="control-group">
                <p class="small muted" style="margin-bottom: 12px;">Alle Z-Wave-inspirerede sensorer. Vælg type og sæt værdi. Lys/Vind/Fugt mappes direkte til felter. Øvrige bliver globals: sensor.&lt;navn&gt;. Hold mus over 'Binær/Numerisk' for hjælp.</p>
                
                <div id="zwRows"></div>
                <div class="button-row">
                  <button type="button" id="zwAdd" class="info">➕ Tilføj sensor</button>
                </div>
              </div>
            </div>

            <div class="row">
              <button id="applyPending" class="success" title="Anvend bufferede ændringer og kør regler">Aktivér ændringer</button>
              <span class="small muted">Nyeste log nederst • Intet trigges før "Aktivér".</span>
            </div>
          </div>
        </div>

        <!-- 2) Regler -->
        <div class="card" data-section="rules">
          <h2>2) Regler (blok-scener)</h2>
          <div class="body">
            <div class="row">
              <select id="triggerType" title="Vælg trigger (IF)">
                <option value="always">IF (ved aktivering/kørsel)</option>
                <option value="motionBreached">IF PIR bliver Breached</option>
                <option value="motionSafe">IF PIR bliver Safe</option>
                <option value="doorOpened">IF Dørkontakt ændres til Opened</option>
                <option value="timeEquals">IF Klokkeslæt = (hh:mm)</option>
                <option value="humidityAbove">IF Fugtighed ≥ (værdi)</option>
                <option value="humidityBelow">IF Fugtighed < (værdi)</option>
                <option value="globalEqTrig">IF Global name=value</option>
                <option value="sensorEqTrig">IF Sensor (global) = (navn=værdi)</option>
                <option value="sensorGtTrig">IF Sensor (global) > (navn=tal)</option>
                <option value="sensorLtTrig">IF Sensor (global) < (navn=tal)</option>
                <option value="sensorGeTrig">IF Sensor (global) ≥ (navn=tal)</option>
                <option value="sensorLeTrig">IF Sensor (global) ≤ (navn=tal)</option>
              </select>
              <input type="text" id="triggerValue" placeholder="fx sensor.contact=Opened / sensor.temp=21" title="Til global/sensor: navn=værdi (fx sensor.temp=21)">
            </div>

            <div class="row">
              <select id="cond1" title="AND (valgfri)">
                <option value="">AND (valgfri)</option>
                <option value="luxBelow">Lys (lux) <</option>
                <option value="luxAbove">Lys (lux) ></option>
                <option value="humAbove">Fugtighed ≥</option>
                <option value="humBelow">Fugtighed ≤</option>
                <option value="windBelow">Vind <</option>
                <option value="weekdayIn">Ugedag i (Mon,Fri,…)</option>
                <option value="alarmArmed">Alarm = Armed</option>
                <option value="doorClosed">Dørkontakt = Closed</option>
                <option value="globalEq">Global name=value</option>
                <option value="sensorEq">Sensor (global) ==</option>
                <option value="sensorNe">Sensor (global) ≠</option>
                <option value="sensorGt">Sensor (global) ></option>
                <option value="sensorLt">Sensor (global) <</option>
                <option value="sensorGe">Sensor (global) ≥</option>
                <option value="sensorLe">Sensor (global) ≤</option>
                <option value="sensorContains">Sensor (global) contains</option>
                <option value="timeBetween">Tid mellem (HH:MM-HH:MM)</option>
              </select>
              <input type="text" id="cond1Value" placeholder="fx sensor.temp=21 / sensor.smoke=Detected" title="Til sensor/globale: navn=værdi">
            </div>

            <div class="row">
              <select id="cond2" title="AND (valgfri)">
                <option value="">AND (valgfri)</option>
                <option value="luxBelow">Lys (lux) <</option>
                <option value="luxAbove">Lys (lux) ></option>
                <option value="humAbove">Fugtighed ≥</option>
                <option value="humBelow">Fugtighed ≤</option>
                <option value="windBelow">Vind <</option>
                <option value="weekdayIn">Ugedag i (Mon,Fri,…)</option>
                <option value="alarmArmed">Alarm = Armed</option>
                <option value="doorClosed">Dørkontakt = Closed</option>
                <option value="globalEq">Global name=value</option>
                <option value="sensorEq">Sensor (global) ==</option>
                <option value="sensorNe">Sensor (global) ≠</option>
                <option value="sensorGt">Sensor (global) ></option>
                <option value="sensorLt">Sensor (global) <</option>
                <option value="sensorGe">Sensor (global) ≥</option>
                <option value="sensorLe">Sensor (global) ≤</option>
                <option value="sensorContains">Sensor (global) contains</option>
                <option value="timeBetween">Tid mellem (HH:MM-HH:MM)</option>
              </select>
              <input type="text" id="cond2Value" placeholder="fx sensor.mode=night" title="Til sensor/globale: navn=værdi">
            </div>

            <div class="row">
              <select id="action1" title="Vælg handling (THEN)">
                <option value="lightOn">THEN Lys → Tænd</option>
                <option value="lightOff">THEN Lys → Sluk</option>
                <option value="dim30">THEN Dæmper → 30%</option>
                <option value="dim100">THEN Dæmper → 100%</option>
                <option value="fanOn">THEN Ventilator → On</option>
                <option value="fanOff">THEN Ventilator → Off</option>
                <option value="push">THEN Send Push (log)</option>
                <option value="setGlobal">THEN Set Global name=value</option>
                <option value="delayLightOff">THEN Delay (sek) → Lys Off</option>
              </select>
              <input type="text" id="action1Value" placeholder="for push/global/delay">
            </div>

            <div class="row">
              <input type="text" id="ruleName" placeholder="Navn på regel (valgfri)" title="Navngiv din regel – vises i listen og i LUA-kommentar">
            </div>

            <div class="row">
              <button id="addRule" class="success">Tilføj regel</button>
              <button id="clearRules" class="danger">Slet alle</button>
              <button id="saveRules">Gem</button>
              <button id="loadRules">Hent</button>
              <button id="exportRules" title="Gem regler som .json">Eksport</button>
              <input type="file" id="importFile" accept=".json,application/json" style="flex:2">
              <button id="importRules">Import</button>
            </div>
            <div id="rules"></div>
          </div>
                        </div>

                <!-- 3) Log + LUA -->
        <div class="card" data-section="log">
          <h2>3) Log & LUA</h2>
          <div class="body">
            <div class="row">
              <button id="runAll" class="info" title="Kør alle regler mod aktuelle tilstande (RUN)">Kør regler (RUN)</button>
              <button id="runTimeTick" title="Evaluer alle 'Time = hh:mm' regler">Kør "Time Tick" nu</button>
              <button id="clearLog" class="danger" title="Tøm logvinduet">Slet log</button>
              <button id="exportLogCSV" title="Eksporter log som CSV fil">📊 CSV</button>
            </div>
            <div class="row" style="margin-top: 8px; gap: 4px; flex-wrap: wrap;">
              <label style="margin: 0; font-size: 13px; color: #6b7280;">Filter:</label>
              <button id="filterAll" class="filter-btn active" data-filter="all">Alle</button>
              <button id="filterMatch" class="filter-btn" data-filter="match">Matches</button>
              <button id="filterTick" class="filter-btn" data-filter="tick">Time Ticks</button>
              <button id="filterActivate" class="filter-btn" data-filter="activate">Aktivering</button>
              <button id="filterSystem" class="filter-btn" data-filter="system">System</button>
            </div>
            <div class="sp"></div>
            <div id="log" class="log" title="Nyeste nederst." style="height:240px !important; max-height:240px !important; min-height:240px !important; overflow-y:auto !important; overflow-x:hidden !important; word-wrap:break-word !important; box-sizing:border-box !important; position:relative !important;"></div>
            <div class="divider"></div>
            
<div class="lua-bar" id="luaBar">
  <label style="margin:0">LUA-output:</label>
  <div class="lua-dd" id="luaDD">
    <button id="luaBtn" aria-haspopup="true" aria-expanded="false">LUA ▾</button>
    <div class="lua-list" id="luaList" role="menu">
      <button id="luaGen2" role="menuitem">Generér LUA</button>
      <button id="luaCopy2" role="menuitem">Kopiér LUA</button>
      <button id="luaSave2" role="menuitem">Gem LUA som .lua</button>
    </div>
  </div>
</div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
              <div>
                <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-weight: 500; font-size: 14px;">📋 ERKLÆRINGER (Venstre panel i HC3)</label>
                <textarea id="luaOutLeft" spellcheck="false" placeholder="Conditions og triggers kommer her..." style="height: 200px; width: 100%; resize: vertical;"></textarea>
                <button onclick="copyLeftPanel()" style="margin-top: 8px; padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">📋 Kopier venstre panel</button>
              </div>
              <div>
                <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-weight: 500; font-size: 14px;">⚡ HANDLINGER (Højre panel i HC3)</label>
                <textarea id="luaOutRight" spellcheck="false" placeholder="Actions og regler kommer her..." style="height: 200px; width: 100%; resize: vertical;"></textarea>
                <button onclick="copyRightPanel()" style="margin-top: 8px; padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">📋 Kopier højre panel</button>
              </div>
            </div>
            
            <!-- Behold den gamle luaOut for bagudkompatibilitet -->
            <textarea id="luaOut" spellcheck="false" style="display: none;"></textarea>
          </div>
        </div>
      </div>
      <div class="footer small">SmartHome Simulator v2.0 (WebView2 • SPA med faner @Rasmus Jakobsen)</div>
    </section>

        
    <!-- ===== View: Læring ===== -->
    <section id="view-learning" class="view">
      <div class="wrap">
        <div class="card">
          <h2>📡 Sensor Guide</h2>
          <div class="body">
            <div style="margin-bottom: 20px;">
              <label for="sensorSelect" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-weight: 500;">Vælg en sensor:</label>
              <select id="sensorSelect" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(15, 20, 28, 0.8); border: 1px solid #2a3442; color: #e5e9f0; font-size: 14px;">
                <option value="">-- Vælg sensor --</option>
                <option value="pir">PIR (Bevægelsessensor)</option>
                <option value="contact">Dør-/vindueskontakt</option>
                <option value="humidity">Fugtighedssensor</option>
                <option value="lux">Lysmåler (Lux)</option>
                <option value="wind">Vindmåler</option>
                <option value="smoke">Røgalarm</option>
                <option value="leak">Vandlækage</option>
                <option value="co2">CO₂-måler</option>
                <option value="presence">Tilstedeværelsesensor</option>
              </select>
            </div>
            <div id="sensorInfo" style="height: 400px; background: linear-gradient(180deg, rgba(42,176,255,0.1), rgba(42,176,255,0.05)); border-radius: 8px; margin: 20px; padding: 20px; overflow-y: auto; color: #e5e9f0;">
              <div style="text-align: center; color: #9ca3af; font-size: 16px; margin-top: 150px;">
                Vælg en sensor ovenfor for at læse mere
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <h2>📡 Z-Wave Rækkevidde (under udvikling)</h2>
          <div class="body">
            <div style="margin-bottom: 20px;">
              <label for="wallCount" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-weight: 500;">
                🧱 Antal vægge mellem enhederne:
                <span style="color: #9ca3af; font-weight: 400; font-size: 12px; display: block; margin-top: 4px;">
                  Tæl alle vægge, døre og andre barrierer mellem din Z-Wave enhed og hubben
                </span>
              </label>
              <input id="wallCount" type="number" min="0" max="10" value="0" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(15, 20, 28, 0.8); border: 1px solid #2a3442; color: #e5e9f0; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 20px;">
              <label for="wallMaterial" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-weight: 500;">
                🏗️ Væg materiale:
                <span style="color: #9ca3af; font-weight: 400; font-size: 12px; display: block; margin-top: 4px;">
                  Vælg det materiale som flest af dine vægge er lavet af
                </span>
              </label>
              <select id="wallMaterial" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(15, 20, 28, 0.8); border: 1px solid #2a3442; color: #e5e9f0; font-size: 14px;">
                <option value="drywall">Gipsvæg (let) - 3 dB</option>
                <option value="brick">Murstensvæg (medium) - 6 dB</option>
                <option value="wood">Træ (medium) - 5 dB</option>
                <option value="concrete">Beton (tung) - 8 dB</option>
                <option value="metal">Metal (meget tung) - 15 dB</option>
                <option value="glass">Glas (medium) - 4 dB</option>
              </select>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label for="distance" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-weight: 500;">
                📏 Afstand i meter:
                <span style="color: #9ca3af; font-weight: 400; font-size: 12px; display: block; margin-top: 4px;">
                  Luftlinje afstand mellem din Z-Wave enhed og hubben (ikke gåafstand)
                </span>
              </label>
              <input id="distance" type="number" min="1" max="100" value="10" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(15, 20, 28, 0.8); border: 1px solid #2a3442; color: #e5e9f0; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 20px;">
              <label for="middleDevice" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-weight: 500;">
                📡 Mellemenhed type:
                <span style="color: #9ca3af; font-weight: 400; font-size: 12px; display: block; margin-top: 4px;">
                  Er der andre Z-Wave enheder mellem din enhed og hubben?
                </span>
              </label>
              <select id="middleDevice" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(15, 20, 28, 0.8); border: 1px solid #2a3442; color: #e5e9f0; font-size: 14px;">
                <option value="endpoint">Endpoint (ingen forstærkning)</option>
                <option value="repeater">Repeater (forstærker signalet)</option>
              </select>
            </div>
            
            <div style="margin-bottom: 20px;">
              <button id="calculateBtn" style="width: 100%; padding: 12px; border-radius: 8px; background: #2ab0ff; border: none; color: white; font-size: 16px; font-weight: 500; cursor: pointer;">🧮 Beregn Signalstyrke</button>
            </div>
            
            <div id="signalResult" style="height: 300px; background: linear-gradient(180deg, rgba(42,176,255,0.1), rgba(42,176,255,0.05)); border-radius: 8px; margin: 20px; padding: 20px; overflow-y: auto; color: #e5e9f0;">
              <div style="text-align: center; color: #9ca3af; font-size: 16px; margin-top: 120px;">
                Klik på "Beregn Signalstyrke" for at se resultatet
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <h2>📡 Forbindelses Guide</h2>
          <div class="body">
            <div style="margin-bottom: 20px;">
              <label for="connectionSelect" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-weight: 500;">Vælg en forbindelsestype:</label>
              <select id="connectionSelect" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(15, 20, 28, 0.8); border: 1px solid #2a3442; color: #e5e9f0; font-size: 14px;">
                <option value="">-- Vælg forbindelse --</option>
                <option value="wifi">WiFi (IEEE 802.11)</option>
                <option value="bluetooth">Bluetooth (BLE)</option>
                <option value="matter">Matter (Thread/WiFi)</option>
                <option value="thread">Thread (IPv6 mesh)</option>
                <option value="zwave">Z-Wave Plus</option>
                <option value="zigbee">Zigbee (IEEE 802.15.4)</option>
                <option value="433mhz">433 MHz (RF)</option>
                <option value="infrared">Infrarød (IR)</option>
              </select>
            </div>
            <div id="connectionInfo" style="height: 400px; background: linear-gradient(180deg, rgba(42,176,255,0.1), rgba(42,176,255,0.05)); border-radius: 8px; margin: 20px; padding: 20px; overflow-y: auto; color: #e5e9f0;">
              <div style="text-align: center; color: #9ca3af; font-size: 16px; margin-top: 150px;">
                Vælg en forbindelsestype ovenfor for at læse mere
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- ===== View: Indstillinger ===== -->
    <section id="view-settings" class="view">
      <div class="card">
        <h2>⚙️ Indstillinger</h2>
        <div class="body">
          
          <!-- Tema indstillinger -->
          <div class="settings-section">
            <h3>🎨 Udseende</h3>
            <div class="setting-item">
              <label for="themeSelect">Tema</label>
              <select id="themeSelect" class="styled-select">
                <option value="dark">Mørkt tema</option>
                <option value="ocean">Ocean Blue</option>
                <option value="forest">Forest Green</option>
                <option value="sunset">Sunset Orange</option>
                <option value="purple">Purple Night</option>
                                        <option value="ruby">Ruby Red</option>
                        <option value="golden">Golden Yellow</option>
              </select>
              <span class="setting-description">Vælg mellem forskellige temaer. Dit valg gemmes automatisk.</span>
            </div>
          </div>



          <div class="divider"></div>

          <!-- Brugerindstillinger -->
          <div class="settings-section">
            <h3>👤 Bruger</h3>
            <div class="setting-item">
              <label for="setUser">Brugernavn</label>
              <input id="setUser" type="text" placeholder="Indtast nyt brugernavn" class="styled-input">
            </div>
            <div class="setting-item">
              <label for="setPass">Adgangskode</label>
              <input id="setPass" type="password" placeholder="Indtast ny adgangskode" class="styled-input">
            </div>
            <div class="setting-item">
              <button id="btnSaveCreds" class="btn-primary">💾 Gem brugerindstillinger</button>
              <span class="setting-description">Standard er <code>admin</code> / <code>1234</code>, indtil du gemmer nye.</span>
            </div>
            <div class="setting-item">
              <button id="clearStorageBtn" class="btn-danger">🗑️ Ryd localStorage</button>
              <span class="setting-description">Slet alle brugere fra localStorage (kan ikke fortrydes!)</span>
            </div>
          </div>

          <!-- Elev navn (beta) -->
          <div class="settings-section">
            <h3>📝 Dit navn (beta)</h3>
            <div class="setting-item">
              <label for="setFirstName">Fornavn</label>
              <input id="setFirstName" type="text" placeholder="Dit fornavn" class="styled-input">
            </div>
            <div class="setting-item">
              <label for="setLastName">Efternavn</label>
              <input id="setLastName" type="text" placeholder="Dit efternavn" class="styled-input">
            </div>

            
            <div class="setting-item">
              <label for="setSchoolId">Vælg din skole</label>
              <select id="setSchoolId" class="styled-input">
                <option value="">Indlæser skoler...</option>
              </select>
              <span class="setting-description">Vælg den skole du går på</span>
            </div>
            
            <div class="setting-item">
              <label for="setClassId">Vælg din klasse</label>
              <select id="setClassId" class="styled-input">
                <option value="">Vælg først en skole</option>
              </select>
              <span class="setting-description">Vælg den klasse du går i</span>
            </div>
            
            <div class="setting-item">
              <button id="btnSaveName" class="btn-primary">💾 Gem dit navn og klasse</button>
              <span class="setting-description">Dette navn og klasse bruges når du fuldfører opgaver</span>
            </div>
          </div>

          <div class="divider"></div>

          <!-- App indstillinger -->
          <div class="settings-section">
            <h3>🔧 App</h3>
            <div class="setting-item">
              <button id="btnResetOnboarding" class="btn-secondary">🔄 Reset onboarding</button>
              <span class="setting-description">Start forfra med onboarding guiden</span>
            </div>
            <div class="setting-item">
              <button id="btnLogout" class="btn-danger">🚪 Log ud</button>
              <span class="setting-description">Log ud og vis login-skærmen igen</span>
            </div>
          </div>

          <div class="divider"></div>



        </div>
      </div>
    </section>
    
    <!-- ===== View: Opgaver ===== -->
    <section id="view-tasks" class="view">
        
        <!-- Opgave Oversigt -->
        <div class="card">
          <h2>🚀 Vælg en opgave</h2>
          <div class="body">
            <p style="margin-bottom: 20px; color: #9ca3af;">Klik på en opgave for at se detaljer og starte øvelsen.</p>
            
            <div class="task-cards">
              <!-- Let kolonne -->
              <div class="easy-column">
                <div class="task-card" onclick="showTaskDetails('ganglys')">
                  <div class="task-header">
                    <span class="difficulty easy">Let</span>
                    <span class="task-completed" style="display:none;">✅</span>
                  </div>
                  <h4>Ganglys Basic</h4>
                  <p>Automatisk ganglys der tænder ved bevægelse</p>
                </div>
                
                <div class="task-card" onclick="showTaskDetails('schedule')">
                  <div class="task-header">
                    <span class="difficulty easy">Let</span>
                    <span class="task-completed" style="display:none;">✅</span>
                  </div>
                  <h4>Tidsstyring</h4>
                  <p>Automatisk tidsstyring af lys</p>
                </div>
              </div>
              
              <!-- Mellem kolonne -->
              <div class="medium-column">
                <div class="task-card" onclick="showTaskDetails('doorlight')">
                  <div class="task-header">
                    <span class="difficulty medium">Mellem</span>
                    <span class="task-completed" style="display:none;">✅</span>
                  </div>
                  <h4>Dørlys med tidsbegrænsning</h4>
                  <p>Natligt dørlys kun mellem 22:00-06:00</p>
                </div>
                
                <div class="task-card" onclick="showTaskDetails('security')">
                  <div class="task-header">
                    <span class="difficulty medium">Mellem</span>
                    <span class="task-completed" style="display:none;">✅</span>
                  </div>
                  <h4>Sikkerhedsalarm</h4>
                  <p>Bevægelsesalarm om natten</p>
                </div>
                
                <div class="task-card" onclick="showTaskDetails('comfort')">
                  <div class="task-header">
                    <span class="difficulty medium">Mellem</span>
                    <span class="task-completed" style="display:none;">✅</span>
                  </div>
                  <h4>Komfortstyring</h4>
                  <p>Automatisk komfort baseret på miljø</p>
                </div>
                
                <div class="task-card" onclick="showTaskDetails('ventilation')">
                  <div class="task-header">
                    <span class="difficulty medium">Mellem</span>
                    <span class="task-completed" style="display:none;">✅</span>
                  </div>
                  <h4>Intelligent ventilation</h4>
                  <p>Ventilation baseret på fugtighed og bevægelse</p>
                </div>
                
                <div class="task-card" onclick="showTaskDetails('global')">
                  <div class="task-header">
                    <span class="difficulty medium">Mellem</span>
                    <span class="task-completed" style="display:none;">✅</span>
                  </div>
                  <h4>Global variabel styring</h4>
                  <p>System tilstande med globale variabler</p>
                </div>
              </div>
              
              <!-- Svær kolonne -->
              <div class="hard-column">
                <div class="task-card" onclick="showTaskDetails('bathroom')">
                  <div class="task-header">
                    <span class="difficulty hard">Svær</span>
                    <span class="task-completed" style="display:none;">✅</span>
                  </div>
                  <h4>Badventilator med fugtighed</h4>
                  <p>Intelligent badventilator med miljøsensorer</p>
                </div>
                
                <div class="task-card" onclick="showTaskDetails('energy')">
                  <div class="task-header">
                    <span class="difficulty hard">Svær</span>
                    <span class="task-completed" style="display:none;">✅</span>
                  </div>
                  <h4>Energistyring</h4>
                  <p>Smart energibesparelse med multiple betingelser</p>
                </div>
                
                <div class="task-card" onclick="showTaskDetails('alarm')">
                  <div class="task-header">
                    <span class="difficulty hard">Svær</span>
                    <span class="task-completed" style="display:none;">✅</span>
                  </div>
                  <h4>Avanceret alarm</h4>
                  <p>Multi-zone sikkerhed med tidsbaserede regler</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Opgave Detaljer (skjult som standard) -->
        <div id="task-details" class="card" style="display: none;">
          <div class="task-details-header">
            <button onclick="hideTaskDetails()" class="btn-secondary" style="margin-right: 12px;">← Tilbage til oversigt</button>
            <h2 id="task-details-title">Opgave detaljer</h2>
          </div>
          <div class="body" id="task-details-content">
            <!-- Indholdet indsættes dynamisk -->
          </div>
          
          <!-- Start knap -->
          <div class="task-actions" style="padding: 20px 24px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center;">
            <button id="btnStartTask" class="btn-primary" style="margin-right: 12px; padding: 12px 24px; font-size: 16px;">
              🚀 Start Opgave
            </button>
            <button onclick="hideTaskDetails()" class="btn-secondary" style="padding: 12px 24px; font-size: 16px;">
              ❌ Annuller
            </button>
          </div>
          
          <!-- Info om hjælp -->
          <div style="padding: 0 24px 20px 24px; text-align: center; color: #9ca3af; font-size: 14px;">
            💡 <strong>Tip:</strong> Når du starter opgaven, kan du klikke på hjælp-ikonet (💡) i simulator-delen for at se trinene til at løse opgaven.
          </div>
        </div>
        
        <!-- Alle opgave detaljer (skjult) -->
        <div style="display: none;">
          <div class="task" id="task-ganglys">
            <span class="difficulty easy">Let</span>
            <span class="task-completed" style="display:none;">✅</span>
            <h3>Ganglys Basic</h3>
            <div class="case-description">
              <h4>📋 Case: Automatisk ganglys</h4>
              <p>Du arbejder på et kontor hvor gangene ofte er tomme om aftenen. For at spare energi og sikre sikkerhed, skal du implementere et automatisk ganglys der tænder når der er bevægelse.</p>
              <p><strong>Læringsmål:</strong> Forstå grundlæggende trigger-action logik og hvordan PIR-sensorer fungerer.</p>
            </div>
            <div class="steps">
              <ol>
                <li>Gå til "Simulator" fanen</li>
                <li>Klik "Sæt: Breached" under PIR</li>
                <li>Klik "Aktivér ændringer"</li>
                <li>Gå til "Regler" sektionen</li>
                <li>Vælg "IF PIR bliver Breached" som trigger</li>
                <li>Vælg "THEN Lys → Tænd" som action</li>
                <li>Klik "Tilføj regel"</li>
                <li>Klik "Kør regler (RUN)"</li>
              </ol>
            </div>
          </div>
          
          <div class="task" id="task-schedule">
            <span class="difficulty easy">Let</span>
            <span class="task-completed" style="display:none;">✅</span>
            <h3>Tidsstyring</h3>
            <div class="case-description">
              <h4>📋 Case: Automatisk tidsstyring</h4>
              <p>Du skal implementere en simpel tidsstyring der tænder lys på bestemte tidspunkter om morgenen og slukker dem om aftenen.</p>
              <p><strong>Læringsmål:</strong> Forstå tidsbaserede triggers og hvordan man bruger dem til daglig automation.</p>
            </div>
            <div class="steps">
              <ol>
                <li>Gå til "Z-Wave sensorer" sektionen</li>
                <li>Sæt klokkeslæt til 07:00</li>
                <li>Klik "Aktivér ændringer"</li>
                <li>Gå til "Regler" sektionen</li>
                <li>Vælg "IF Time = 07:00" som trigger</li>
                <li>Vælg "THEN Lys → On" som action</li>
                <li>Klik "Tilføj regel"</li>
                <li>Test ved at ændre tiden til 07:00</li>
              </ol>
            </div>
          </div>
          
          <div class="task" id="task-doorlight">
            <span class="difficulty medium">Mellem</span>
            <span class="task-completed" style="display:none;">✅</span>
            <h3>Dørlys med tidsbegrænsning</h3>
            <div class="case-description">
              <h4>📋 Case: Natligt dørlys</h4>
              <p>En familie har problemer med at finde vej i mørket om natten når de skal til toilettet. De vil have et lys der automatisk tænder når døren åbnes, men kun mellem 22:00 og 06:00 for at spare energi.</p>
              <p><strong>Læringsmål:</strong> Kombinere sensor-triggers med tidsbetingelser og forstå AND-logik.</p>
            </div>
            <div class="steps">
              <ol>
                <li>Gå til "Z-Wave sensorer" sektionen</li>
                <li>Vælg "Dør-/vindueskontakt" fra dropdown</li>
                <li>Sæt værdi til "Opened"</li>
                <li>Klik "Sæt (buffer)"</li>
                <li>Klik "Aktivér ændringer"</li>
                <li>Gå til "Regler" sektionen</li>
                <li>Vælg "IF Dørkontakt ændres til Opened" som trigger</li>
                <li>Tilføj AND: "Tid mellem" med "22:00-06:00"</li>
                <li>Vælg "THEN Lys → Tænd" som action</li>
                <li>Tilføj regel og test</li>
              </ol>
            </div>
          </div>
          
          <div class="task" id="task-security">
            <span class="difficulty medium">Mellem</span>
            <span class="task-completed" style="display:none;">✅</span>
            <h3>Sikkerhedsalarm</h3>
            <div class="case-description">
              <h4>📋 Case: Hjemmesikkerhed</h4>
              <p>En familie vil have et sikkerhedssystem der aktiverer en alarm når der er bevægelse om natten, men kun når de ikke er hjemme (døren er lukket).</p>
              <p><strong>Læringsmål:</strong> Implementere sikkerhedslogik med multiple sensorer og forstå hvordan man kombinerer forskellige sensorer.</p>
            </div>
            <div class="steps">
              <ol>
                <li>Gå til "Z-Wave sensorer" sektionen</li>
                <li>Vælg "PIR (bevægelse)" fra dropdown og sæt til "Breached"</li>
                <li>Vælg "Dør-/vindueskontakt" fra dropdown og sæt til "Closed"</li>
                <li>Klik "Sæt (buffer)" for begge sensorer</li>
                <li>Klik "Aktivér ændringer"</li>
                <li>Gå til "Regler" sektionen</li>
                <li>Vælg "IF PIR bliver Breached" som trigger</li>
                <li>Tilføj AND: "Dørkontakt = Closed"</li>
                <li>Tilføj AND: "Tid mellem" med "22:00-06:00"</li>
                <li>Vælg "THEN Push (log)" som action</li>
                <li>Tilføj regel og test</li>
              </ol>
            </div>
          </div>
          
          <div class="task" id="task-comfort">
            <span class="difficulty medium">Mellem</span>
            <span class="task-completed" style="display:none;">✅</span>
            <h3>Komfortstyring</h3>
            <div class="case-description">
              <h4>📋 Case: Automatisk komfort</h4>
              <p>Et kontor har problemer med at holde den rette temperatur og luftkvalitet. Du skal implementere et system der automatisk justerer ventilation og lys baseret på temperatur og fugtighed.</p>
              <p><strong>Læringsmål:</strong> Arbejde med multiple actions og forstå hvordan man optimerer for komfort.</p>
            </div>
            <div class="steps">
              <ol>
                <li>Gå til "Z-Wave sensorer" sektionen</li>
                <li>Sæt temperatur til 25°C og fugtighed til 70%</li>
                <li>Klik "Aktivér ændringer"</li>
                <li>Gå til "Regler" sektionen</li>
                <li>Vælg "IF Temperatur ≥ 25" som trigger</li>
                <li>Tilføj AND: "Fugtighed ≥ 70"</li>
                <li>Vælg "THEN Ventilator → On" som action</li>
                <li>Tilføj AND action: "Dimmer → 50%"</li>
                <li>Klik "Tilføj regel" og test</li>
              </ol>
            </div>
          </div>
          
          <div class="task" id="task-ventilation">
            <span class="difficulty medium">Mellem</span>
            <span class="task-completed" style="display:none;">✅</span>
            <h3>Intelligent ventilation</h3>
            <div class="case-description">
              <h4>📋 Case: Energibesparende ventilation</h4>
              <p>Et køkken har problemer med luftkvalitet efter madlavning. Du skal implementere en ventilator der starter baseret på fugtighed og temperatur, men kun når der er bevægelse i rummet.</p>
              <p><strong>Læringsmål:</strong> Kombinere miljøsensorer med bevægelsessensorer for intelligent automation.</p>
            </div>
            <div class="steps">
              <ol>
                <li>Gå til "Z-Wave sensorer" sektionen</li>
                <li>Sæt fugtighed til 80% og temperatur til 28°C</li>
                <li>Sæt PIR til "Breached"</li>
                <li>Klik "Aktivér ændringer"</li>
                <li>Gå til "Regler" sektionen</li>
                <li>Vælg "IF Fugtighed ≥ 75" som trigger</li>
                <li>Tilføj AND: "Temperatur ≥ 25"</li>
                <li>Tilføj AND: "PIR = Breached"</li>
                <li>Vælg "THEN Ventilator → On" som action</li>
                <li>Klik "Tilføj regel" og test</li>
              </ol>
            </div>
          </div>
          
          <div class="task" id="task-global">
            <span class="difficulty medium">Mellem</span>
            <span class="task-completed" style="display:none;">✅</span>
            <h3>Global variabel styring</h3>
            <div class="case-description">
              <h4>📋 Case: System tilstand</h4>
              <p>Du skal implementere et system der bruger globale variabler til at styre forskellige tilstande i hjemmet, som "away mode" eller "night mode".</p>
              <p><strong>Læringsmål:</strong> Forstå globale variabler og hvordan man bruger dem til at koordinere automationer.</p>
            </div>
            <div class="steps">
              <ol>
                <li>Gå til "Regler" sektionen</li>
                <li>Vælg "IF Global name=value" som trigger med værdi "mode=away"</li>
                <li>Vælg "THEN Set Global" som action med værdi "lights=off"</li>
                <li>Klik "Tilføj regel"</li>
              </ol>
            </div>
          </div>
          
          <div class="task" id="task-bathroom">
            <span class="difficulty hard">Svær</span>
            <span class="task-completed" style="display:none;">✅</span>
            <h3>Badventilator med fugtighed</h3>
            <div class="case-description">
              <h4>📋 Case: Intelligent badventilator</h4>
              <p>Et badeværelse har problemer med skimmel på grund af høj fugtighed efter bad. Du skal implementere en ventilator der automatisk starter når fugtigheden er høj, men kun når der ikke er nogen i rummet (lavt lys).</p>
              <p><strong>Læringsmål:</strong> Arbejde med numeriske sensorer, kombinere multiple betingelser og forstå miljøbaseret automation.</p>
            </div>
            <div class="steps">
              <ol>
                <li>Gå til "Z-Wave sensorer" sektionen</li>
                <li>Vælg "Fugtighed (%)" fra dropdown</li>
                <li>Sæt værdi til 75</li>
                <li>Klik "Sæt (buffer)"</li>
                <li>Klik "Aktivér ændringer"</li>
                <li>Gå til "Regler" sektionen</li>
                <li>Vælg "IF Fugtighed ≥ (værdi)" som trigger med værdi 75</li>
                <li>Tilføj AND: "Lys (lux) <" med værdi 50</li>
                <li>Vælg "THEN Ventilator → On" som action</li>
                <li>Klik "Tilføj regel"</li>
              </ol>
            </div>
          </div>
          
          <div class="task" id="task-energy">
            <span class="difficulty hard">Svær</span>
            <span class="task-completed" style="display:none;">✅</span>
            <h3>Energistyring</h3>
            <div class="case-description">
              <h4>📋 Case: Smart energibesparelse</h4>
              <p>Et hjem vil reducere energiforbruget ved at automatisk slukke unødvendige enheder når der ikke er nogen hjemme, og justere lys baseret på naturligt lys.</p>
              <p><strong>Læringsmål:</strong> Implementere kompleks energistyring med multiple betingelser og actions.</p>
            </div>
            <div class="steps">
              <ol>
                <li>Gå til "Z-Wave sensorer" sektionen</li>
                <li>Sæt PIR til "Safe" (ingen bevægelse)</li>
                <li>Sæt lys til 200 lux (dagslys)</li>
                <li>Klik "Aktivér ændringer"</li>
                <li>Gå til "Regler" sektionen</li>
                <li>Vælg "IF PIR = Safe" som trigger</li>
                <li>Tilføj AND: "Lys ≥ 100" (dagslys)</li>
                <li>Tilføj AND: "Tid mellem" med "08:00-18:00"</li>
                <li>Vælg "THEN Lys → Off" som action</li>
                <li>Tilføj AND action: "Dimmer → 0%"</li>
                <li>Klik "Tilføj regel" og test</li>
              </ol>
            </div>
          </div>
          
          <div class="task" id="task-alarm">
            <span class="difficulty hard">Svær</span>
            <span class="task-completed" style="display:none;">✅</span>
            <h3>Avanceret alarm</h3>
            <div class="case-description">
              <h4>📋 Case: Multi-zone sikkerhed</h4>
              <p>Et stort hjem har brug for et avanceret sikkerhedssystem der kan håndtere forskellige zoner og reagere forskelligt baseret på tidspunkt og zone.</p>
              <p><strong>Læringsmål:</strong> Implementere kompleks sikkerhedslogik med multiple zoner og tidsbaserede regler.</p>
            </div>
            <div class="steps">
              <ol>
                <li>Gå til "Z-Wave sensorer" sektionen</li>
                <li>Sæt PIR til "Breached" og dør til "Opened"</li>
                <li>Sæt klokkeslæt til 23:30</li>
                <li>Klik "Aktivér ændringer"</li>
                <li>Gå til "Regler" sektionen</li>
                <li>Vælg "IF PIR bliver Breached" som trigger</li>
                <li>Tilføj AND: "Dørkontakt = Opened"</li>
                <li>Tilføj AND: "Tid mellem" med "22:00-06:00"</li>
                <li>Vælg "THEN Push (log)" som action</li>
                <li>Tilføj AND action: "Lys → On" (advarsel)</li>
                <li>Klik "Tilføj regel" og test</li>
              </ol>
            </div>
          </div>
            
            <div class="task" id="task-doorlight">
              <span class="difficulty medium">Mellem</span>
              <span class="task-completed" style="display:none;">✅</span>
              <h3>Dørlys med tidsbegrænsning</h3>
              <div class="case-description">
                <h4>📋 Case: Natligt dørlys</h4>
                <p>En familie har problemer med at finde vej i mørket om natten når de skal til toilettet. De vil have et lys der automatisk tænder når døren åbnes, men kun mellem 22:00 og 06:00 for at spare energi.</p>
                <p><strong>Læringsmål:</strong> Kombinere sensor-triggers med tidsbetingelser og forstå AND-logik.</p>
              </div>
              <div class="steps">
                <ol>
                  <li>Gå til "Z-Wave sensorer" sektionen</li>
                  <li>Vælg "Dør-/vindueskontakt" fra dropdown</li>
                  <li>Sæt værdi til "Opened"</li>
                  <li>Klik "Sæt (buffer)"</li>
                  <li>Klik "Aktivér ændringer"</li>
                  <li>Gå til "Regler" sektionen</li>
                  <li>Vælg "IF Dørkontakt ændres til Opened" som trigger</li>
                  <li>Tilføj AND: "Tid mellem" med "22:00-06:00"</li>
                  <li>Vælg "THEN Lys → Tænd" som action</li>
                  <li>Tilføj regel og test</li>
                </ol>
              </div>
            </div>
            
            <div class="task" id="task-bathroom">
              <span class="difficulty hard">Svær</span>
              <span class="task-completed" style="display:none;">✅</span>
              <h3>Badventilator med fugtighed</h3>
              <div class="case-description">
                <h4>📋 Case: Intelligent badventilator</h4>
                <p>Et badeværelse har problemer med skimmel på grund af høj fugtighed efter bad. Du skal implementere en ventilator der automatisk starter når fugtigheden er høj, men kun når der ikke er nogen i rummet (lavt lys).</p>
                <p><strong>Læringsmål:</strong> Arbejde med numeriske sensorer, kombinere multiple betingelser og forstå miljøbaseret automation.</p>
              </div>
              <div class="steps">
                <ol>
                  <li>Gå til "Z-Wave sensorer" sektionen</li>
                  <li>Vælg "Fugtighed (%)" fra dropdown</li>
                  <li>Sæt værdi til 75</li>
                  <li>Klik "Sæt (buffer)"</li>
                  <li>Klik "Aktivér ændringer"</li>
                  <li>Gå til "Regler" sektionen</li>
                  <li>Vælg "IF Fugtighed ≥ (værdi)" som trigger med værdi 75</li>
                  <li>Tilføj AND: "Lys (lux) <" med værdi 50</li>
                  <li>Vælg "THEN Ventilator → On" som action</li>
                  <li>Klik "Tilføj regel"</li>
                </ol>
              </div>
            </div>
            
            <div class="task" id="task-security">
              <span class="difficulty medium">Mellem</span>
              <span class="task-completed" style="display:none;">✅</span>
              <h3>Sikkerhedsalarm</h3>
              <div class="case-description">
                <h4>📋 Case: Hjemmesikkerhed</h4>
                <p>En familie vil have et sikkerhedssystem der aktiverer en alarm når der er bevægelse om natten, men kun når de ikke er hjemme (døren er lukket).</p>
                <p><strong>Læringsmål:</strong> Implementere sikkerhedslogik med multiple sensorer og forstå hvordan man kombinerer forskellige sensorer.</p>
              </div>
              <div class="steps">
                <ol>
                  <li>Gå til "Z-Wave sensorer" sektionen</li>
                  <li>Vælg "PIR (bevægelse)" fra dropdown og sæt til "Breached"</li>
                  <li>Vælg "Dør-/vindueskontakt" fra dropdown og sæt til "Closed"</li>
                  <li>Klik "Sæt (buffer)" for begge sensorer</li>
                  <li>Klik "Aktivér ændringer"</li>
                  <li>Gå til "Regler" sektionen</li>
                  <li>Vælg "IF PIR bliver Breached" som trigger</li>
                  <li>Tilføj AND: "Dørkontakt = Closed"</li>
                  <li>Tilføj AND: "Tid mellem" med "22:00-06:00"</li>
                  <li>Vælg "THEN Push (log)" som action</li>
                  <li>Tilføj regel og test</li>
                </ol>
              </div>
            </div>
            
            <div class="task" id="task-comfort">
              <span class="difficulty medium">Mellem</span>
              <span class="task-completed" style="display:none;">✅</span>
              <h3>Komfortstyring</h3>
              <div class="case-description">
                <h4>📋 Case: Automatisk komfort</h4>
                <p>Et kontor har problemer med at holde den rette temperatur og luftkvalitet. Du skal implementere et system der automatisk justerer ventilation og lys baseret på temperatur og fugtighed.</p>
                <p><strong>Læringsmål:</strong> Arbejde med multiple actions og forstå hvordan man optimerer for komfort.</p>
              </div>
              <div class="steps">
                <ol>
                  <li>Gå til "Z-Wave sensorer" sektionen</li>
                  <li>Sæt temperatur til 25°C og fugtighed til 70%</li>
                  <li>Klik "Aktivér ændringer"</li>
                  <li>Gå til "Regler" sektionen</li>
                  <li>Vælg "IF Temperatur ≥ 25" som trigger</li>
                  <li>Tilføj AND: "Fugtighed ≥ 70"</li>
                  <li>Vælg "THEN Ventilator → On" som action</li>
                  <li>Tilføj AND action: "Dimmer → 50%"</li>
                  <li>Klik "Tilføj regel" og test</li>
                </ol>
              </div>
            </div>
            
            <div class="task" id="task-ventilation">
              <span class="difficulty medium">Mellem</span>
              <span class="task-completed" style="display:none;">✅</span>
              <h3>Intelligent ventilation</h3>
              <div class="case-description">
                <h4>📋 Case: Energibesparende ventilation</h4>
                <p>Et køkken har problemer med luftkvalitet efter madlavning. Du skal implementere en ventilator der starter baseret på fugtighed og temperatur, men kun når der er bevægelse i rummet.</p>
                <p><strong>Læringsmål:</strong> Kombinere miljøsensorer med bevægelsessensorer for intelligent automation.</p>
              </div>
              <div class="steps">
                <ol>
                  <li>Gå til "Z-Wave sensorer" sektionen</li>
                  <li>Sæt fugtighed til 80% og temperatur til 28°C</li>
                  <li>Sæt PIR til "Breached"</li>
                  <li>Klik "Aktivér ændringer"</li>
                  <li>Gå til "Regler" sektionen</li>
                  <li>Vælg "IF Fugtighed ≥ 75" som trigger</li>
                  <li>Tilføj AND: "Temperatur ≥ 25"</li>
                  <li>Tilføj AND: "PIR = Breached"</li>
                  <li>Vælg "THEN Ventilator → On" som action</li>
                  <li>Klik "Tilføj regel" og test</li>
                </ol>
              </div>
            </div>
            
            <div class="task" id="task-global">
              <span class="difficulty medium">Mellem</span>
              <span class="task-completed" style="display:none;">✅</span>
              <h3>Global variabel styring</h3>
              <div class="case-description">
                <h4>📋 Case: System tilstand</h4>
                <p>Du skal implementere et system der bruger globale variabler til at styre forskellige tilstande i hjemmet, som "away mode" eller "night mode".</p>
                <p><strong>Læringsmål:</strong> Forstå globale variabler og hvordan man bruger dem til at koordinere automationer.</p>
              </div>
              <div class="steps">
                <ol>
                  <li>Gå til "Regler" sektionen</li>
                  <li>Vælg "IF Global name=value" som trigger med værdi "mode=away"</li>
                  <li>Vælg "THEN Set Global" som action med værdi "lights=off"</li>
                  <li>Klik "Tilføj regel"</li>
                </ol>
              </div>
            </div>
            
            <div class="task" id="task-energy">
              <span class="difficulty hard">Svær</span>
              <span class="task-completed" style="display:none;">✅</span>
              <h3>Energistyring</h3>
              <div class="case-description">
                <h4>📋 Case: Smart energibesparelse</h4>
                <p>Et hjem vil reducere energiforbruget ved at automatisk slukke unødvendige enheder når der ikke er nogen hjemme, og justere lys baseret på naturligt lys.</p>
                <p><strong>Læringsmål:</strong> Implementere kompleks energistyring med multiple betingelser og actions.</p>
              </div>
              <div class="steps">
                <ol>
                  <li>Gå til "Z-Wave sensorer" sektionen</li>
                  <li>Sæt PIR til "Safe" (ingen bevægelse)</li>
                  <li>Sæt lys til 200 lux (dagslys)</li>
                  <li>Klik "Aktivér ændringer"</li>
                  <li>Gå til "Regler" sektionen</li>
                  <li>Vælg "IF PIR = Safe" som trigger</li>
                  <li>Tilføj AND: "Lys ≥ 100" (dagslys)</li>
                  <li>Tilføj AND: "Tid mellem" med "08:00-18:00"</li>
                  <li>Vælg "THEN Lys → Off" som action</li>
                  <li>Tilføj AND action: "Dimmer → 0%"</li>
                  <li>Klik "Tilføj regel" og test</li>
                </ol>
              </div>
            </div>
            
            <div class="task" id="task-alarm">
              <span class="difficulty hard">Svær</span>
              <span class="task-completed" style="display:none;">✅</span>
              <h3>Avanceret alarm</h3>
              <div class="case-description">
                <h4>📋 Case: Multi-zone sikkerhed</h4>
                <p>Et stort hjem har brug for et avanceret sikkerhedssystem der kan håndtere forskellige zoner og reagere forskelligt baseret på tidspunkt og zone.</p>
                <p><strong>Læringsmål:</strong> Implementere kompleks sikkerhedslogik med multiple zoner og tidsbaserede regler.</p>
              </div>
              <div class="steps">
                <ol>
                  <li>Gå til "Z-Wave sensorer" sektionen</li>
                  <li>Sæt PIR til "Breached" og dør til "Opened"</li>
                  <li>Sæt klokkeslæt til 23:30</li>
                  <li>Klik "Aktivér ændringer"</li>
                  <li>Gå til "Regler" sektionen</li>
                  <li>Vælg "IF PIR bliver Breached" som trigger</li>
                  <li>Tilføj AND: "Dørkontakt = Opened"</li>
                  <li>Tilføj AND: "Tid mellem" med "22:00-06:00"</li>
                  <li>Vælg "THEN Push (log)" som action</li>
                  <li>Tilføj AND action: "Lys → On" (advarsel)</li>
                  <li>Klik "Tilføj regel" og test</li>
                </ol>
              </div>
            </div>
            
            <div class="task" id="task-schedule">
              <span class="difficulty easy">Let</span>
              <span class="task-completed" style="display:none;">✅</span>
              <h3>Tidsstyring</h3>
              <div class="case-description">
                <h4>📋 Case: Automatisk tidsstyring</h4>
                <p>Du skal implementere en simpel tidsstyring der tænder lys på bestemte tidspunkter om morgenen og slukker dem om aftenen.</p>
                <p><strong>Læringsmål:</strong> Forstå tidsbaserede triggers og hvordan man bruger dem til daglig automation.</p>
              </div>
              <div class="steps">
                <ol>
                  <li>Gå til "Z-Wave sensorer" sektionen</li>
                  <li>Sæt klokkeslæt til 07:00</li>
                  <li>Klik "Aktivér ændringer"</li>
                  <li>Gå til "Regler" sektionen</li>
                  <li>Vælg "IF Time = 07:00" som trigger</li>
                  <li>Vælg "THEN Lys → On" som action</li>
                  <li>Klik "Tilføj regel"</li>
                  <li>Test ved at ændre tiden til 07:00</li>
                </ol>
              </div>
            </div>
            
            <div class="buttons">
              <div class="task-buttons">
                <div class="button-group">
                  <h4>Let</h4>
                  <button class="start-task" onclick="startTask('ganglys')">Ganglys</button>
                  <button class="start-task" onclick="startTask('schedule')">Tidsstyring</button>
                </div>
                <div class="button-group">
                  <h4>Mellem</h4>
                  <button class="start-task" onclick="startTask('doorlight')">Dørlys</button>
                  <button class="start-task" onclick="startTask('security')">Sikkerhed</button>
                  <button class="start-task" onclick="startTask('comfort')">Komfort</button>
                  <button class="start-task" onclick="startTask('ventilation')">Ventilation</button>
                  <button class="start-task" onclick="startTask('global')">Global</button>
                </div>
                <div class="button-group">
                  <h4>Svær</h4>
                  <button class="start-task" onclick="startTask('bathroom')">Badventilator</button>
                  <button class="start-task" onclick="startTask('energy')">Energistyring</button>
                  <button class="start-task" onclick="startTask('alarm')">Alarm</button>
                </div>
              </div>
            </div>
          </div>
        </div>
    </section>
    

    
    <!-- ===== View: HOME Smart Home Simulator ===== -->
    <section id="view-home" class="view">
      <div class="wrap">
        <!-- Floor Plan Content -->
        <div id="home-floor-plan" class="home-content">
          <!-- Smart Home Mode Buttons -->
          <div style="
            position: absolute;
            top: 10px;
            left: calc(50% + 30px + 15%);
            z-index: 1000;
            display: flex;
            gap: 8px;
          ">
            <button id="home-floor-plan-btn" style="
              padding: 6px 12px; 
              background: #10b981; 
              color: white; 
              border: none; 
              cursor: pointer; 
              font-size: 12px; 
              border-radius: 4px;
            " onclick="showFloorPlan()">
              🏠 Plantegning
            </button>
            <button id="home-rule-builder-btn" style="
              padding: 6px 12px; 
              background: #2d3b4f; 
              color: #e5e9f0; 
              border: 1px solid #3b495e; 
              cursor: pointer; 
              font-size: 12px; 
              border-radius: 4px;
            " onclick="showRuleBuilder()">
              🧩 Regel Builder
            </button>
          </div>
          <!-- Floor Plan -->
          <div class="floor-plan-background">
            <!-- Smart Home Device Ikoner -->
            
            <!-- Soveværelse -->
            <div class="smart-device light" style="top: 71.2%; left: 75.4%;" data-device="bedroom-light" title="Soveværelse lys">💡</div>
            <div class="smart-device camera" style="top: 26.9%; left: 89.2%;" data-device="entrance-camera" title="Sikkerhedskamera ved hoveddør">📹</div>
            <div class="smart-device window" style="top: 75.1%; left: 87.9%;" data-device="bedroom-window" title="Vindue sensor">🪟</div>
            
            <!-- Balkon -->
            <div class="smart-device camera" style="top: 33.8%; left: 17.1%;" data-device="balcony-camera" title="Udendørs kamera">📹</div>
            <div class="smart-device sensor" style="top: 83.6%; left: 16.3%;" data-device="outdoor-temp" title="Udendørs temperatur">🌡️</div>
            <div class="smart-device window" style="top: 19.7%; left: 19.2%;" data-device="balcony-door" title="Balkondør sensor">🪟</div>
            
            <!-- Stue -->
            <div class="smart-device light" style="top: 61.8%; left: 46.5%;" data-device="living-room-light" title="Stue lys">💡</div>
            <div class="smart-device thermostat" style="top: 82.1%; left: 29.7%;" data-device="thermostat" title="Termostat">🌡️</div>
            <div class="smart-device speaker" style="top: 81.2%; left: 50.5%;" data-device="living-speaker" title="Smart højttaler">🔊</div>
            <div class="smart-device sensor" style="top: 68.7%; left: 7.1%;" data-device="living-motion" title="Bevægelsessensor">👁️</div>
            
            <!-- Spisebord -->
            <div class="smart-device light" style="top: 19.2%; left: 28.8%;" data-device="dining-light" title="Spisebord lys">💡</div>
            
            <!-- Køkken -->
            <div class="smart-device light" style="top: 23.7%; left: 49.8%;" data-device="kitchen-light" title="Køkken lys">💡</div>
            <div class="smart-device sensor" style="top: 43.7%; left: 46.9%;" data-device="motion-kitchen" title="Bevægelsessensor">👁️</div>
            <div class="smart-device smoke" style="top: 8.8%; left: 43.8%;" data-device="smoke-detector" title="Røgdetektor">💨</div>
            
            <!-- Badeværelse -->
            <div class="smart-device light" style="top: 22.1%; left: 69.7%;" data-device="bathroom-light" title="Badeværelse lys">💡</div>
            <div class="smart-device fan" style="top: 32.9%; left: 75.6%;" data-device="bathroom-fan" title="Ventilator">🌪️</div>
            <div class="smart-device sensor" style="top: 14.6%; left: 75.5%;" data-device="humidity-sensor" title="Fugtighedssensor">💧</div>
            
            <!-- Entré -->
            <div class="smart-device lock" style="top: 42.7%; left: 87%;" data-device="front-door" title="Smart dørlås">🔐</div>
            <div class="smart-device sensor" style="top: 29.9%; left: 87.7%;" data-device="entrance-motion" title="Entré bevægelse">👁️</div>
          </div>

          <!-- Control Panel -->
          <div class="smart-home-control-panel">
            <h3>🏠 Smart Home Kontrol</h3>
            
            <div class="control-section">
              <h4>💡 Belysning</h4>
              
              <div class="device-control">
                <div class="device-info">
                  <div class="device-icon">💡</div>
                  <div class="device-name">Soveværelse</div>
                </div>
                <button class="device-toggle" data-device="bedroom-light"></button>
              </div>
              
              <div class="device-control">
                <div class="device-info">
                  <div class="device-icon">💡</div>
                  <div class="device-name">Stue</div>
                </div>
                <button class="device-toggle" data-device="living-room-light"></button>
              </div>
              
              <div class="device-control">
                <div class="device-info">
                  <div class="device-icon">💡</div>
                  <div class="device-name">Spisebord</div>
                </div>
                <button class="device-toggle" data-device="dining-light"></button>
              </div>
              
              <div class="device-control">
                <div class="device-info">
                  <div class="device-icon">💡</div>
                  <div class="device-name">Køkken</div>
                </div>
                <button class="device-toggle" data-device="kitchen-light"></button>
              </div>
              
              <div class="device-control">
                <div class="device-info">
                  <div class="device-icon">💡</div>
                  <div class="device-name">Badeværelse</div>
                </div>
                <button class="device-toggle" data-device="bathroom-light"></button>
              </div>
            </div>

            <div class="control-section">
              <h4>🌡️ Klima</h4>
              
              <div class="device-control climate-control">
                <div class="device-info">
                  <div class="device-icon">🌡️</div>
                  <div class="device-name">Temperatur</div>
                  <div class="temperature-display">
                    <span id="currentTemp">21</span>°C
                  </div>
                </div>
                <div class="temperature-slider-container">
                  <input type="range" class="temperature-slider" id="tempSlider" min="0" max="40" value="21" step="0.5">
                  <div class="temp-labels">
                    <span>0°</span>
                    <span>40°</span>
                  </div>
                </div>
              </div>
              
              <div class="device-control">
                <div class="device-info">
                  <div class="device-icon">🌪️</div>
                  <div class="device-name">Ventilation</div>
                </div>
                <button class="device-toggle" data-device="ventilation"></button>
              </div>
            </div>

            <div class="control-section">
              <h4>🔒 Sikkerhed</h4>
              
              <div class="device-control">
                <div class="device-info">
                  <div class="device-icon">🚨</div>
                  <div class="device-name">Alarm System</div>
                  <div class="security-status" id="alarmStatus">Deaktiveret</div>
                </div>
                <button class="device-toggle security-toggle" data-device="alarm-system"></button>
              </div>
              
              <div class="device-control">
                <div class="device-info">
                  <div class="device-icon">🔐</div>
                  <div class="device-name">Auto-lås døre</div>
                </div>
                <button class="device-toggle" data-device="auto-lock"></button>
              </div>
            </div>

            <div class="control-section">
              <h4>📱 Scenarier</h4>
              
              <div class="scenario-buttons">
                <button class="scenario-btn morning" data-scenario="good-morning">
                  <div class="scenario-icon">🌅</div>
                  <div class="scenario-name">God Morgen</div>
                </button>
                
                <button class="scenario-btn away" data-scenario="leaving-home">
                  <div class="scenario-icon">🏃</div>
                  <div class="scenario-name">Forlader Hjem</div>
                </button>
                
                <button class="scenario-btn evening" data-scenario="good-night">
                  <div class="scenario-icon">🌙</div>
                  <div class="scenario-name">God Nat</div>
                </button>
                
                <button class="scenario-btn home" data-scenario="coming-home">
                  <div class="scenario-icon">🏠</div>
                  <div class="scenario-name">Kommer Hjem</div>
                </button>
              </div>
            </div>

            <div class="control-section">
              <h4>⚙️ Automation</h4>
              
              <div class="automation-status">
                <div class="automation-info">
                  <div class="automation-icon">🤖</div>
                  <div class="automation-text">
                    <div class="automation-name">Smart Regler</div>
                    <div class="automation-count" id="ruleCount">0 aktive regler</div>
                  </div>
                </div>
                <button class="device-toggle" data-device="automation-master" id="automationToggle"></button>
              </div>
              
              <div class="rule-list" id="activeRules">
                <!-- Dynamisk indhold fra wiresheet -->
              </div>
            </div>
          </div>
          
          <!-- Positionerings kontroller (skjult til senere brug) -->
          <div class="position-controls" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 1000; background: rgba(17, 23, 32, 0.9); padding: 15px; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.3);">
            <h4 style="color: #10b981; margin: 0 0 10px 0; font-size: 14px;">📍 Ikon Positionering</h4>
            <button id="toggleDragMode" class="btn-primary" style="margin-bottom: 8px;">🖱️ Aktiver træk-mode</button>
            <button id="lockPositions" class="btn-success" style="display: none;">🔒 Lås positioner</button>
            <p id="dragStatus" style="color: #cbd5e1; font-size: 12px; margin: 5px 0 0 0;">Klik for at aktivere træk</p>
          </div>
          
          <!-- Ingen kontrolpanel - kun plantegning -->
        </div>
        
        <!-- Rule Builder Content (initially hidden) -->
        <div id="home-rule-builder" class="home-content" style="display: none;">
          <!-- Back to Floor Plan Button -->
          <div style="
            position: absolute;
            top: 10px;
            left: calc(20px + 25%);
            z-index: 1000;
          ">
            <button onclick="showFloorPlan()" style="
              padding: 8px 16px; 
              background: #2d3b4f; 
              color: #e5e9f0; 
              border: 1px solid #3b495e; 
              cursor: pointer; 
              font-size: 12px; 
              border-radius: 4px;
              display: flex;
              align-items: center;
              gap: 6px;
            ">
              ← Tilbage til Plantegning
            </button>
          </div>
          
          <div class="card" style="width: 100%; max-width: none;">
            <h3>🧩 Smart Home Regel Builder</h3>
            <div class="body">
              <!-- Simplificeret Wiresheet Toolbar (kun til home) -->
              <div class="ws-toolbar" style="margin-bottom: 12px; padding: 8px; background: rgba(15, 20, 28, 0.8); border-radius: 8px; border: 1px solid #2a3442; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                <!-- Hovedknapper i én række -->
                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                  <!-- Komponenter -->
                  <div style="display: flex; gap: 6px;">
                    <button id="wsAddTrig" class="ws-btn ws-btn-primary" style="padding: 8px 12px; font-size: 12px; min-width: 80px;" title="Tilføj Trigger">⚡ Trigger</button>
                    <button id="wsAddCond" class="ws-btn ws-btn-secondary" style="padding: 8px 12px; font-size: 12px; min-width: 80px;" title="Tilføj AND betingelse">🔗 AND</button>
                    <button id="wsAddAct" class="ws-btn ws-btn-success" style="padding: 8px 12px; font-size: 12px; min-width: 80px;" title="Tilføj Action">🎯 Action</button>
                    <button id="wsAddRule" class="ws-btn ws-btn-info" style="padding: 8px 12px; font-size: 12px; min-width: 80px;" title="Tilføj Rule">📋 Rule</button>
                  </div>
                  
                  <div style="width: 1px; height: 24px; background: #2a3442; margin: 0 4px;"></div>
                  
                  <!-- Værktøjer -->
                  <div style="display: flex; gap: 6px;">
                    <button id="wsUndo" class="ws-btn ws-btn-secondary" style="padding: 8px 12px; font-size: 12px;" disabled title="Undo">↶ Undo</button>
                    <button id="wsRedo" class="ws-btn ws-btn-secondary" style="padding: 8px 12px; font-size: 12px;" disabled title="Redo">↷ Redo</button>
                    <button id="wsCopy" class="ws-btn ws-btn-secondary" style="padding: 8px 12px; font-size: 12px;" title="Kopier">📋 Copy</button>
                    <button id="wsPaste" class="ws-btn ws-btn-secondary" style="padding: 8px 12px; font-size: 12px;" title="Indsæt">📄 Paste</button>
                  </div>
                  
                  <div style="width: 1px; height: 24px; background: #2a3442; margin: 0 4px;"></div>
                  
                  <!-- Hovedhandlinger (forenklet - kun til home) -->
                  <div style="display: flex; gap: 6px;">
                    <button id="wsBuild" class="ws-btn ws-btn-success" style="padding: 8px 12px; font-size: 12px;" title="Build og tilføj regler til Smart Home">🚀 Send til Home</button>
                    <button id="wsClear" class="ws-btn ws-btn-danger" style="padding: 8px 12px; font-size: 12px;" title="Ryd wiresheet">🗑️ Clear</button>
                    <button id="wsSave" class="ws-btn ws-btn-primary" style="padding: 8px 12px; font-size: 12px;" title="Gem">💾 Save</button>
                    <button id="wsLoad" class="ws-btn ws-btn-secondary" style="padding: 8px 12px; font-size: 12px;" title="Hent">📂 Load</button>
                  </div>
                  
                  <div style="margin-left: auto;">
                    <button id="wsValidate" class="ws-btn ws-btn-warning" style="padding: 8px 12px; font-size: 12px;" title="Valider (ikke implementeret)">✅ Validate</button>
                  </div>
                </div>
                
                <!-- Kompakt tip -->
                <div style="padding: 6px 10px; background: rgba(16,185,129,0.1); border-radius: 6px; border-left: 3px solid #10b981; font-size: 12px; color: #9ca3af;">
                  💡 <strong>Smart Home Mode:</strong> Regler bygget her sendes direkte til jeres smart home system. Træk noder og forbind dem for at skabe automationer.
                </div>
              </div>

              <div id="wsCanvas" class="ws-canvas" style="min-height: 800px; width: 100%;">
                <svg id="wsWires" class="ws-wires"></svg>
                <div id="wsNodes" class="ws-nodes"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Ingen footer - kun plantegning -->
        
      </div>
    </section>
    
    <!-- ===== View: Lærer Dashboard ===== -->
    <section id="view-teacher" class="view">
      <div class="wrap">

        <!-- Lærer kontroller -->
        <div class="card">
          <h2>👨‍🏫 Lærer Dashboard</h2>
          <div class="body">
            <div class="settings-section">
              <h3>📊 Data indstillinger</h3>
              <div class="setting-item">
                <label for="teacherSchoolId">Vælg skole</label>
                <select id="teacherSchoolId" class="styled-input">
                  <option value="">Indlæser skoler...</option>
                </select>
              </div>
              <div class="setting-item">
                <label for="teacherClassId">Vælg klasse</label>
                <select id="teacherClassId" class="styled-input">
                  <option value="">Vælg først en skole</option>
                </select>
              </div>
              <div class="setting-item">
                <button id="btnLoadProgress" class="btn-primary">📥 Indlæs elev progress</button>
                <button id="btnExportCSV" class="btn-success">📊 Eksporter CSV</button>
                <button id="btnTeacherLogout" class="btn-danger">👨‍🏫 Log ud som lærer</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Opret ny klasse -->
        <div class="card">
          <h2>🏫 Opret ny klasse</h2>
          <div class="body">
            <div class="settings-section">
              <h3>➕ Ny klasse</h3>
              <div class="setting-item">
                <label for="newSchoolId">Skole ID</label>
                <input id="newSchoolId" type="text" class="styled-input" placeholder="fx: skole1, skole2, etc.">
              </div>
              <div class="setting-item">
                <label for="newClassId">Klasse ID</label>
                <input id="newClassId" type="text" class="styled-input" placeholder="fx: 9a, 10b, etc.">
              </div>
              <div class="setting-item">
                <label for="newClassName">Klasse navn (valgfrit)</label>
                <input id="newClassName" type="text" class="styled-input" placeholder="fx: 9. klasse A, 10. klasse B, etc.">
              </div>
              <div class="setting-item">
                <button id="btnCreateClass" class="btn-primary">🏫 Opret klasse</button>
                <button id="btnSwitchToClass" class="btn-success">🔄 Skift til klasse</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Eksisterende klasser -->
        <div class="card">
          <h2>📚 Eksisterende klasser</h2>
          <div class="body">
            <div style="margin-bottom: 16px;">
              <button id="btnReloadClasses" class="btn-primary" style="margin-right: 8px;">🔄 Genindlæs klasser</button>
              <button id="btnClearClasses" class="btn-danger">🗑️ Ryd alle klasser</button>
            </div>
            <div id="existingClassesList" class="classes-list">
              <p class="muted">Indlæser eksisterende klasser...</p>
            </div>
          </div>
        </div>

        <!-- Elev progress liste -->
        <div class="card">
          <h2>📈 Elev Progress</h2>
          <div class="body">
            <div id="teacherProgressList" class="progress-list">
              <p class="muted">Klik "Indlæs elev progress" for at se data</p>
            </div>
          </div>
        </div>

        <!-- Statistikker -->
        <div class="card">
          <h2>📊 Statistikker</h2>
          <div class="body">
            <div id="teacherStats" class="stats-grid">
              <div class="stat-box">
                <div class="stat-number" id="totalStudents">-</div>
                <div class="stat-label">Elever</div>
              </div>
              <div class="stat-box">
                <div class="stat-number" id="totalTasks">-</div>
                <div class="stat-label">Opgaver</div>
              </div>
              <div class="stat-box">
                <div class="stat-number" id="completionRate">-</div>
                <div class="stat-label">Gennemførelse</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
  </div>

<script>
(function(){
  var $ = function(sel){ return document.querySelector(sel); };
  var logEl = $('#log'), luaOut = $('#luaOut');

  /* Faner - Fjernet gammelt system */


  /* Topbar menu */
  var menu = document.querySelector('.menu');
  $('#btnMenu').onclick = function(){ menu.classList.toggle('open'); this.setAttribute('aria-expanded', menu.classList.contains('open') ? 'true' : 'false'); };
  document.addEventListener('click', function(e){ if(!menu.contains(e.target)) { menu.classList.remove('open'); $('#btnMenu').setAttribute('aria-expanded','false'); } });

  /* State */
  var state   = { motion:false, door:false, lux:100, wind:2, humidity:45, time:'21:30', weekday:'Mon', globals:{}, light:false, dimmer:0, fan:false, alarmArmed:false, alarmHome:false, rules:[] };
  var pending = JSON.parse(JSON.stringify(state));
  window.pending = pending; window.state = state;
  


  function escHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  var lastLogMessage = '';
  var logEntries = [];
  var currentLogFilter = 'all';
  
  /* Simulation Functions */
  window.startSimulation = function() {
    if (window.simulation.enabled) return;
    
    window.simulation.enabled = true;
    window.simulation.startTime = new Date();
    window.simulation.simulationTime = new Date();
    
    // Hent indstillinger
    const speedEl = document.getElementById('simulationSpeed');
    const realisticEl = document.getElementById('realisticPatterns');
    const dayNightEl = document.getElementById('dayNightCycle');
    
    window.simulation.speed = parseInt(speedEl ? speedEl.value : 1) || 1;
    window.simulation.realisticPatterns = realisticEl ? realisticEl.checked : true;
    window.simulation.dayNightCycle = dayNightEl ? dayNightEl.checked : true;
    
    // Start simulation loop
    window.simulation.interval = setInterval(function() {
      updateSimulation();
    }, 1000 / window.simulation.speed); // Opdater hver sekund divideret med hastighed
    
    // Opdater UI
    const enabledEl = document.getElementById('simulationEnabled');
    const startBtn = document.getElementById('btnStartSimulation');
    const stopBtn = document.getElementById('btnStopSimulation');
    const statusEl = document.getElementById('simulationStatus');
    
    if (enabledEl) enabledEl.checked = true;
    if (startBtn) startBtn.disabled = true;
    if (stopBtn) stopBtn.disabled = false;
    if (statusEl) {
      statusEl.style.display = 'block';
      statusEl.classList.add('simulation-active');
    }
    
    log('🎮 Simulation startet med hastighed ' + window.simulation.speed + 'x', 'system');
    addSimulationLogEntry('system', '🎮 Simulation startet med hastighed ' + window.simulation.speed + 'x');
  }
  
  window.stopSimulation = function() {
    if (!window.simulation.enabled) return;
    
    window.simulation.enabled = false;
    clearInterval(window.simulation.interval);
    window.simulation.interval = null;
    
    // Ryd alle auto-reset timere
    if (window.simulation.autoResetTimers) {
      Object.values(window.simulation.autoResetTimers).forEach(timer => {
        clearTimeout(timer);
      });
      window.simulation.autoResetTimers = {};
    }
    
    // Opdater UI
    const enabledEl = document.getElementById('simulationEnabled');
    const startBtn = document.getElementById('btnStartSimulation');
    const stopBtn = document.getElementById('btnStopSimulation');
    const statusEl = document.getElementById('simulationStatus');
    
    if (enabledEl) enabledEl.checked = false;
    if (startBtn) startBtn.disabled = false;
    if (stopBtn) stopBtn.disabled = true;
    if (statusEl) statusEl.classList.remove('simulation-active');
    
    log('⏹️ Simulation stoppet', 'system');
    addSimulationLogEntry('system', '⏹️ Simulation stoppet');
  }
  
  window.resetSimulation = function() {
    stopSimulation();
    
    // Reset til normale værdier
    state.time = '21:30';
    state.weekday = 'Mon';
    state.lux = 100;
    state.humidity = 45;
    state.wind = 2;
    state.temperature = 21.5; // Tilføjet temperatur!
    state.motion = false;
    state.door = false;
    
    // Opdater UI
    const statusEl = document.getElementById('simulationStatus');
    if (statusEl) statusEl.style.display = 'none';
    
    updateAllDisplays();
    updateSimulationDisplay(); // Opdater også simulation dashboard
    
    log('🔄 Simulation reset til normal tilstand', 'system');
    addSimulationLogEntry('system', '🔄 Simulation reset til normal tilstand');
  }
  
  function updateAllDisplays() {
    // Opdater pending state (dette er det vigtigste)
    pending.time = state.time;
    pending.weekday = state.weekday;
    pending.lux = state.lux;
    pending.humidity = state.humidity;
    pending.wind = state.wind;
    pending.temperature = state.temperature; // Tilføjet temperatur!
    pending.motion = state.motion;
    pending.door = state.door;
    
    // Log ændringerne så brugeren kan se dem
    if (window.simulation.enabled) {
      // Kun log når der er faktiske ændringer i sensor status
      if (!window.simulation.lastSensorState) {
        window.simulation.lastSensorState = {
          motion: state.motion,
          door: state.door,
          lux: state.lux,
          humidity: state.humidity,
          wind: state.wind,
          temperature: state.temperature
        };
      }
      
      // Tjek om der er ændringer
      var hasChanges = false;
      if (window.simulation.lastSensorState.motion !== state.motion) {
        log('👤 PIR Status: ' + (state.motion ? 'Breached' : 'Safe'), 'sensor');
        hasChanges = true;
      }
      if (window.simulation.lastSensorState.door !== state.door) {
        log('🚪 Dør Status: ' + (state.door ? 'Opened' : 'Closed'), 'sensor');
        hasChanges = true;
      }
      
      // Log sensor ændringer kun hvis de er betydelige
      if (Math.abs(window.simulation.lastSensorState.lux - state.lux) > 50) {
        log('💡 Lys ændret: ' + state.lux + ' lux', 'sensor');
        hasChanges = true;
      }
      if (Math.abs(window.simulation.lastSensorState.humidity - state.humidity) > 5) {
        log('💧 Fugt ændret: ' + state.humidity + '%', 'sensor');
        hasChanges = true;
      }
      if (Math.abs(window.simulation.lastSensorState.wind - state.wind) > 1) {
        log('🌪️ Vind ændret: ' + state.wind + ' m/s', 'sensor');
        hasChanges = true;
      }
      if (Math.abs(window.simulation.lastSensorState.temperature - state.temperature) > 2) {
        log('🌡️ Temperatur ændret: ' + state.temperature + '°C', 'sensor');
        hasChanges = true;
      }
      
      // Opdater sidste sensor state
      if (hasChanges) {
        window.simulation.lastSensorState = {
          motion: state.motion,
          door: state.door,
          lux: state.lux,
          humidity: state.humidity,
          wind: state.wind,
          temperature: state.temperature
        };
      }
    }
  }
  
  window.updateSimulation = function() {
    if (!window.simulation.enabled) return;
    
    // Opdater simulation tid
    var timeDiff = (Date.now() - window.simulation.startTime.getTime()) * window.simulation.speed;
    window.simulation.simulationTime = new Date(window.simulation.startTime.getTime() + timeDiff);
    
    // Opdater sensor værdier baseret på tid
    if (window.simulation.realisticPatterns) {
      state.lux = window.simulation.getLight(window.simulation.simulationTime);
      state.humidity = Math.round(window.simulation.getHumidity(window.simulation.simulationTime));
      state.wind = Math.round(window.simulation.getWind(window.simulation.simulationTime) * 10) / 10;
      
      // Opdater temperatur (tilføjet!)
      state.temperature = Math.round(window.simulation.getTemperature(window.simulation.simulationTime) * 10) / 10;
      
      // Automatisk alarm system (22:00-06:00)
      var currentHour = window.simulation.simulationTime.getHours();
      if (currentHour >= 22 || currentHour < 6) {
        state.alarmArmed = true;
      } else {
        state.alarmArmed = false;
      }
      
      // Simuler menneskelig aktivitet
      if (Math.random() < 0.005) { // 0.5% chance hver opdatering (reduceret fra 2%)
        state.motion = window.simulation.getMotion(window.simulation.simulationTime);
        if (state.motion) {
          log('👤 PIR sensor aktiveret (simulation)', 'sensor');
          addSimulationLogEntry('sensor', '👤 PIR sensor aktiveret');
        }
      }
      
      if (Math.random() < 0.002) { // 0.2% chance hver opdatering (reduceret fra 1%)
        state.door = window.simulation.getDoorActivity(window.simulation.simulationTime);
        if (state.door) {
          log('🚪 Dør åbnet (simulation)', 'sensor');
          addSimulationLogEntry('sensor', '🚪 Dør åbnet');
        }
      }
    }
    
    // Opdater tid og ugedag
    var hours = window.simulation.simulationTime.getHours();
    var minutes = window.simulation.simulationTime.getMinutes();
    state.time = (hours < 10 ? '0' : '') + hours + ':' + (minutes < 10 ? '0' : '') + minutes;
    
    var weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    state.weekday = weekdays[window.simulation.simulationTime.getDay()];
    
    // Opdater status display
    const timeEl = document.getElementById('simulationTime');
    const sensorEl = document.getElementById('sensorStatus');
    const cycleEl = document.getElementById('cycleStatus');
    
    if (timeEl) timeEl.textContent = state.time;
    if (sensorEl) sensorEl.textContent = window.simulation.realisticPatterns ? 'Realistiske mønstre' : 'Normal';
    if (cycleEl) cycleEl.textContent = window.simulation.dayNightCycle ? 'Dag/nat cyklus' : 'Normal';
    
    // Opdater live sensor værdier i simulation fane
    updateSimulationDisplay();
    
    // Opdater alle displays
    updateAllDisplays();
    
    // Kør regler
    runRules();
  }
  
  window.runRules = function() {
    // Kør alle aktive regler baseret på nuværende state
    if (state.rules && state.rules.length > 0) {
      state.rules.forEach(function(rule, index) {
        try {
          // Tjek om reglen matcher
          if (evaluateRule(rule)) {
            // Tjek cooldown for at undgå spam
            if (!rule.lastExecuted || (Date.now() - rule.lastExecuted) > 5000) { // 5 sekunder cooldown
              // Udfør handlingen
              executeAction(rule);
              log('🎯 Regel #' + (index + 1) + ' aktiveret: ' + rule.action1, 'activate');
              rule.lastExecuted = Date.now(); // Gem tidspunkt for sidste kørsel
              
              // Opdater UI efter regel handling
              updateActorDisplays();
            }
          }
        } catch (e) {
          log('❌ Fejl i regel #' + (index + 1) + ': ' + e.message, 'error');
        }
      });
    }
  }
  
  function evaluateRule(rule) {
    // Tjek trigger
    if (!evaluateTrigger(rule.trigger, rule.triggerValue)) {
      return false;
    }
    
    // Tjek betingelser (AND)
    if (rule.cond1 && !evaluateCondition(rule.cond1, rule.cond1Value)) {
      return false;
    }
    
    if (rule.cond2 && !evaluateCondition(rule.cond2, rule.cond2Value)) {
      return false;
    }
    
    return true;
  }
  
  function evaluateTrigger(trigger, value) {
    switch(trigger) {
      case 'always': return true;
      case 'motionBreached': return state.motion === true;
      case 'motionSafe': return state.motion === false;
      case 'doorOpened': return state.door === true;
      case 'timeEquals': return state.time === value;
      case 'humidityAbove': return state.humidity >= parseFloat(value || 0);
      case 'humidityBelow': return state.humidity <= parseFloat(value || 0);
      case 'luxAbove': return state.lux >= parseFloat(value || 0);
      case 'luxBelow': return state.lux <= parseFloat(value || 0);
      default: return false;
    }
  }
  
  function evaluateCondition(condition, value) {
    switch(condition) {
      case 'luxBelow': return state.lux < parseFloat(value || 0);
      case 'luxAbove': return state.lux > parseFloat(value || 0);
      case 'humAbove': return state.humidity >= parseFloat(value || 0);
      case 'humBelow': return state.humidity <= parseFloat(value || 0);
      case 'windBelow': return state.wind < parseFloat(value || 0);
      case 'weekdayIn': return (value || '').split(',').map(s => s.trim()).includes(state.weekday);
      case 'alarmArmed': return state.alarmArmed === true;
      case 'alarmHome': return state.alarmHome === true;
      default: return false;
    }
  }
  
  function executeAction(rule) {
    switch(rule.action1) {
      case 'lightOn':
        state.light = true;
        log('💡 Lys tændt via regel', 'activate');
        startAutoResetTimer('light', 5000); // Auto-reset efter 5 sekunder
        break;
      case 'lightOff':
        state.light = false;
        log('💡 Lys slukket via regel', 'activate');
        // Stop auto-reset timer hvis den findes
        if (window.simulation.autoResetTimers && window.simulation.autoResetTimers['light']) {
          clearTimeout(window.simulation.autoResetTimers['light']);
          delete window.simulation.autoResetTimers['light'];
        }
        break;
      case 'fanOn':
        state.fan = true;
        log('🌪️ Ventilator tændt via regel', 'activate');
        startAutoResetTimer('fan', 5000); // Auto-reset efter 5 sekunder
        break;
      case 'fanOff':
        state.fan = false;
        log('🌪️ Ventilator slukket via regel', 'activate');
        // Stop auto-reset timer hvis den findes
        if (window.simulation.autoResetTimers && window.simulation.autoResetTimers['fan']) {
          clearTimeout(window.simulation.autoResetTimers['fan']);
          delete window.simulation.autoResetTimers['fan'];
        }
        break;
      case 'push':
        log('📝 Regel log: ' + (rule.action1Value || 'Handling udført'), 'activate');
        break;
      default:
        log('❓ Ukendt handling: ' + rule.action1, 'error');
    }
  }
  
  function log(msg, type){ 
    // Forhindre spam af samme besked
    if (msg === lastLogMessage) return;
    lastLogMessage = msg;
    
    var now = new Date();
    var ts = now.toLocaleTimeString();
    var category = categorizeLogMessage(msg, type);
    var entry = { 
      time: ts, 
      timestamp: now, 
      message: msg, 
      type: type || 'system',
      category: category,
      entity: extractEntity(msg),
      old_value: extractNewValue(msg),
      new_value: extractNewValue(msg)
    };
    logEntries.push(entry);
    
    // Begræns til max 100 entries for bedre historik
    if (logEntries.length > 100) {
      logEntries = logEntries.slice(-80);
    }
    
    // Genopbyg hele log-indholdet
    rebuildLog();
  }
  
  function categorizeLogMessage(msg, type) {
    if (type === 'match') return 'match';
    if (msg.includes('Time tick') || msg.includes('Time Tick')) return 'tick';
    if (msg.includes('AKTIVERET:') || msg.includes('MATCH:')) return 'activate';
    if (msg.includes('PIR') || msg.includes('Lys') || msg.includes('Fan') || msg.includes('Dør')) return 'activate';
    return 'system';
  }
  
  function extractEntity(msg) {
    if (msg.includes('PIR')) return 'PIR';
    if (msg.includes('Lys')) return 'Light';
    if (msg.includes('Fan')) return 'Fan';
    if (msg.includes('Dør')) return 'Door';
    if (msg.includes('Fugt')) return 'Humidity';
    if (msg.includes('Global')) return 'Global';
    return 'System';
  }
  
  function extractOldValue(msg) {
    // Simple pattern matching for old values in "var = old → new" format
    var match = msg.match(/= (.+?) →/);
    return match ? match[1] : '';
  }
  
  function extractNewValue(msg) {
    // Simple pattern matching for new values in "var = old → new" format  
    var match = msg.match(/→ (.+)$/);
    return match ? match[1] : '';
  }
  
  function rebuildLog() {
    logEl.innerHTML = '';
    var filteredEntries = logEntries.filter(function(entry) {
      if (currentLogFilter === 'all') return true;
      return entry.category === currentLogFilter;
    });
    
    filteredEntries.forEach(function(entry) {
      var div = document.createElement('div');
      div.className = 'log-entry';
      
      var timestampSpan = document.createElement('span');
      timestampSpan.className = 'log-timestamp';
      timestampSpan.textContent = entry.time;
      
      var typeSpan = document.createElement('span');
      typeSpan.className = 'log-type ' + entry.category;
      typeSpan.textContent = getCategoryLabel(entry.category);
      
      var messageSpan = document.createElement('span');
      messageSpan.textContent = entry.message;
      
      div.appendChild(timestampSpan);
      div.appendChild(typeSpan);
      div.appendChild(messageSpan);
      
      logEl.appendChild(div);
    });
    
    // Auto-scroll til bunden
    setTimeout(function(){ 
      logEl.scrollTop = logEl.scrollHeight; 
    }, 10);
  }
  
  function getCategoryLabel(category) {
    var labels = {
      'match': 'MATCH',
      'tick': 'TICK',
      'activate': 'ACT',
      'system': 'SYS'
    };
    return labels[category] || 'SYS';
  }
  
  window.log = log; 
  function clearLog(){ logEntries = []; logEl.innerHTML=''; }

  // Log Filter Event Handlers
  document.querySelectorAll('.filter-btn').forEach(function(btn) {
    btn.onclick = function() {
      // Remove active class from all buttons
      document.querySelectorAll('.filter-btn').forEach(function(b) {
        b.classList.remove('active');
      });
      
      // Add active class to clicked button
      this.classList.add('active');
      
      // Update filter and rebuild log
      currentLogFilter = this.getAttribute('data-filter');
      rebuildLog();
    };
  });

  // CSV Export Functionality
  function exportLogToCSV() {
    if (logEntries.length === 0) {
      alert('Ingen log data at eksportere.');
      return;
    }
    
    var csvContent = 'Timestamp,Category,Entity,Message,Old_Value,New_Value\n';
    
    logEntries.forEach(function(entry) {
      var timestamp = entry.timestamp.toISOString();
      var category = entry.category || 'system';
      var entity = entry.entity || 'System';
      var message = '"' + (entry.message || '').replace(/"/g, '""') + '"';
      var oldValue = '"' + (entry.old_value || '').replace(/"/g, '""') + '"';
      var newValue = '"' + (entry.new_value || '').replace(/"/g, '""') + '"';
      
      csvContent += timestamp + ',' + category + ',' + entity + ',' + message + ',' + oldValue + ',' + newValue + '\n';
    });
    
    // Create and download CSV file
    var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
          var fileName = 'smarthome_simulator_log_' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.csv';
    
    if (link.download !== undefined) {
      var url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', fileName);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      log('Log eksporteret til CSV: ' + fileName, 'system');
    } else {
      alert('CSV eksport ikke understøttet i denne browser.');
    }
  }

  // Attach CSV export to button
  $('#exportLogCSV').onclick = exportLogToCSV;

  // Helper function for updating state values
  function ch(k,pretty,fmt){ var ov=state[k], nv=pending[k]; if(JSON.stringify(ov)!==JSON.stringify(nv)){ state[k]=nv; log('AKTIVERET: '+pretty+' = '+(fmt?fmt(nv):nv)); } }
  
  function updateKPI(){ $('#lampState').innerText = state.light ? 'ON' : 'OFF'; $('#dimmerState').innerText = state.dimmer + '%'; $('#fanState').innerText   = state.fan ? 'ON' : 'OFF'; ch('alarmArmed','Alarm.Armed'); ch('alarmHome','Alarm.Home'); }
  function setLight(on){ state.light=!!on; updateKPI(); log('Light → ' + (on?'ON':'OFF')); }
  function setDimmer(v){ v=Math.max(0,Math.min(100,parseInt(v)||0)); state.dimmer=v; state.light=v>0; updateKPI(); log('Dimmer → '+v+'%'); }
  function setFan(on){ state.fan=!!on; updateKPI(); log('Fan → ' + (on?'ON':'OFF')); }

  /* Buffer - nu håndteres alle sensorer via Z-Wave systemet */
  // Gamle hardcodede sensorer er fjernet - brug Z-Wave sensorer i stedet
  $('#clock').onchange=function(){ pending.time=this.value; log('BUFFER: Klokkeslæt = '+pending.time); };
  $('#weekday').onchange=function(){ pending.weekday=this.value; log('BUFFER: Ugedag = '+pending.weekday); };

  $('#setGlobal').onclick=function(){ var k=$('#globalName').value.trim(), v=$('#globalValue').value.trim(); if(!k){ alert('Angiv globalt navn.'); return; } if(!pending.globals) pending.globals={}; pending.globals[k]=v; log('BUFFER: Global '+k+'='+v); };
  $('#clearGlobals').onclick=function(){ pending.globals={}; log('BUFFER: Alle globale variabler nulstilles ved aktivering.'); };

  /* Direkte aktører */
  $('#turnLampOn').onclick=function(){ setLight(true); };
  $('#turnLampOff').onclick=function(){ setLight(false); };
  $('#dimSet').onclick=function(){ setDimmer(parseInt($('#dimSel').value,10)); };
  $('#fanOn').onclick=function(){ setFan(true); };
  $('#fanOff').onclick=function(){ setFan(false); };

  /* Helpers */
  function parseNameValue(s){ s=String(s||''); var i=s.indexOf('='); if(i<0){ var p=s.split(':'); return {name:(p[0]||'').trim(), value:(p.slice(1).join(':')||'').trim()}; } return {name:s.slice(0,i).trim(), value:s.slice(i+1).trim()}; }
  function gget(name){ return (state.globals && state.globals[name]) || ''; }
  function toNum(x){ var n=parseFloat(x); return isNaN(n)?0:n; }

  function setCondHints(selEl, valEl){
    var v = selEl.value, map = {
      '':'værdi','luxBelow':'tal (fx 50)','luxAbove':'tal (fx 200)','humAbove':'procent (fx 65)','humBelow':'procent (fx 35)',
      'windBelow':'m/s (fx 5)','weekdayIn':'liste (fx Mon,Fri)','alarmArmed':'(ingen værdi)','alarmHome':'(ingen værdi)',
      'globalEq':'navn=værdi (fx mode=night)',
      'sensorEq':'navn=værdi (fx sensor.smoke=Detected)','sensorNe':'navn=værdi','sensorGt':'navn=tal','sensorLt':'navn=tal',
      'sensorGe':'navn=tal','sensorLe':'navn=tal','sensorContains':'navn=delstreng','timeBetween':'HH:MM-HH:MM (fx 22:00-06:00)'
    };
            valEl.placeholder = map[v] || 'værdi'; valEl.title = 'Indtast: ' + (map[v] || 'værdi');
  }
  $('#cond1').onchange=function(){ setCondHints(this,$('#cond1Value')); }; $('#cond2').onchange=function(){ setCondHints(this,$('#cond2Value')); };
  setCondHints($('#cond1'),$('#cond1Value')); setCondHints($('#cond2'),$('#cond2Value'));

  function setTrigHint(){ var t=$('#triggerType').value, inp=$('#triggerValue'), map={
    'always':'(ingen værdi)','timeEquals':'hh:mm (fx 07:30)','humidityAbove':'værdi (fx 65)',
    'globalEqTrig':'navn=værdi (fx sensor.mode=night)','sensorEqTrig':'navn=værdi (fx sensor.contact=Opened)',
    'sensorGtTrig':'navn=tal (fx sensor.temp=21)','sensorLtTrig':'navn=tal (fx sensor.temp=21)','sensorGeTrig':'navn=tal','sensorLeTrig':'navn=tal'
  }; inp.placeholder=map[t]||'(kun hvis relevant)'; }
  $('#triggerType').onchange=setTrigHint; setTrigHint();

  /* Regler UI */
  function ruleRow(r,i){
    var name = r.ruleName ? '"'+r.ruleName+'"' : ('#'+(i+1));
    var div=document.createElement('div'); div.className='rule';
    div.innerHTML='<div class="small muted">'+name+'</div>'+
      '<div><span class="tag">'+r.trigger+(r.triggerValue?(' '+r.triggerValue):'')+'</span></div>'+
      '<div style="margin-top:4px;"><span class="tag">'+(r.cond1? r.cond1 : '')+' '+(r.cond1Value||'')+'</span> '+
      '<span class="tag">'+(r.cond2? r.cond2 : '')+' '+(r.cond2Value||'')+'</span></div>'+
      '<div style="margin-top:6px;"><span class="tag">'+r.action1+(r.action1Value?(' '+r.action1Value):'')+'</span></div>'+
      '<div class="row" style="margin-top:6px;"><button data-i="'+i+'" class="delRule danger">Slet</button>'+
      '<button data-i="'+i+'" class="diagRule info" style="margin-left:8px;">🔍 Diagnose</button></div>'+
      '<div id="diag-'+i+'" class="rule-diagnosis" style="display:none;"></div>';
    return div;
  }
  function refreshRules(){ var box=$('#rules'); box.innerHTML=''; for(var i=0;i<state.rules.length;i++) box.appendChild(ruleRow(state.rules[i],i));
    box.querySelectorAll('.delRule').forEach(function(b){ b.onclick=function(){ var idx=parseInt(this.getAttribute('data-i')); state.rules.splice(idx,1); refreshRules(); log('Regel slettet.'); }; });
    box.querySelectorAll('.diagRule').forEach(function(b){ b.onclick=function(){ var idx=parseInt(this.getAttribute('data-i')); toggleDiagnosis(idx); }; });
  }
  window.refreshRules = refreshRules;

  /* Rule Diagnosis System */
  function toggleDiagnosis(ruleIndex) {
    var diagPanel = document.getElementById('diag-' + ruleIndex);
    if (!diagPanel) return;
    
    if (diagPanel.style.display === 'none') {
      generateDiagnosis(ruleIndex);
      diagPanel.style.display = 'block';
    } else {
      diagPanel.style.display = 'none';
    }
  }

  function generateDiagnosis(ruleIndex) {
    var rule = state.rules[ruleIndex];
    if (!rule) return;
    
    var diagPanel = document.getElementById('diag-' + ruleIndex);
    if (!diagPanel) return;
    
    var name = rule.ruleName ? '"' + rule.ruleName + '"' : ('#' + (ruleIndex + 1));
    var html = '<h4>🔍 Diagnose for regel ' + name + '</h4>';
    
    // Check trigger
    var triggerResult = evaluateTriggerForDiag(rule);
    html += '<div class="diag-section">';
    html += '<div class="diag-item">';
    html += '<div class="diag-status ' + (triggerResult.ok ? 'success' : 'failure') + '">';
    html += triggerResult.ok ? '✓' : '✗';
    html += '</div>';
    html += '<div class="diag-text">IF ' + getTriggerDescription(rule.trigger) + '</div>';
    html += '<div class="diag-value">' + triggerResult.description + '</div>';
    html += '</div>';
    if (triggerResult.explain) {
      html += '<div class="diag-explain">' + triggerResult.explain + '</div>';
    }
    html += '</div>';
    
    // Check conditions
    var cond1Result = evaluateConditionForDiag(rule.cond1, rule.cond1Value);
    var cond2Result = evaluateConditionForDiag(rule.cond2, rule.cond2Value);
    var bothOk = cond1Result.ok && cond2Result.ok;
    
    if (rule.cond1 || rule.cond2) {
      html += '<div class="diag-section">';
      
      if (rule.cond1) {
        html += '<div class="diag-item">';
        html += '<div class="diag-status ' + (cond1Result.ok ? 'success' : 'failure') + '">';
        html += cond1Result.ok ? '✓' : '✗';
        html += '</div>';
        html += '<div class="diag-text">AND ' + getConditionDescription(rule.cond1) + '</div>';
        html += '<div class="diag-value">' + cond1Result.description + '</div>';
        html += '</div>';
      }
      
      if (rule.cond2) {
        html += '<div class="diag-item">';
        html += '<div class="diag-status ' + (cond2Result.ok ? 'success' : 'failure') + '">';
        html += cond2Result.ok ? '✓' : '✗';
        html += '</div>';
        html += '<div class="diag-text">AND ' + getConditionDescription(rule.cond2) + '</div>';
        html += '<div class="diag-value">' + cond2Result.description + '</div>';
        html += '</div>';
      }
      
      // Overall AND result
      html += '<div class="diag-item" style="border-top: 1px solid #e5e7eb; padding-top: 8px; margin-top: 8px;">';
      html += '<div class="diag-status ' + (bothOk ? 'success' : 'failure') + '">';
      html += bothOk ? '✓' : '✗';
      html += '</div>';
      html += '<div class="diag-text"><strong>Samlet AND resultat</strong></div>';
      html += '<div class="diag-value">' + (bothOk ? 'OK' : 'FEJL') + '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    // Overall rule result
    var ruleMatches = triggerResult.ok && bothOk;
    html += '<div class="diag-section" style="border-top: 2px solid #e5e7eb; padding-top: 12px;">';
    html += '<div class="diag-item">';
    html += '<div class="diag-status ' + (ruleMatches ? 'success' : 'failure') + '">';
    html += ruleMatches ? '✓' : '✗';
    html += '</div>';
    html += '<div class="diag-text"><strong>THEN ' + getActionDescription(rule.action1) + '</strong></div>';
    html += '<div class="diag-value">' + (ruleMatches ? 'VILLE KØRE' : 'KØRER IKKE') + '</div>';
    html += '</div>';
    
    if (!ruleMatches) {
      var reasons = [];
      if (!triggerResult.ok) reasons.push('Trigger ikke opfyldt');
      if (!cond1Result.ok && rule.cond1) reasons.push('1. betingelse fejler');
      if (!cond2Result.ok && rule.cond2) reasons.push('2. betingelse fejler');
      html += '<div class="diag-explain">Årsag: ' + reasons.join(', ') + '</div>';
    }
    html += '</div>';
    
    diagPanel.innerHTML = html;
  }

  function evaluateTriggerForDiag(rule) {
    switch(rule.trigger) {
      case 'always':
        return { ok: true, description: 'Altid aktiv', explain: null };
      case 'motionBreached':
        var isBreached = state.motion === true;
        return { 
          ok: isBreached, 
          description: 'PIR = ' + (state.motion ? 'Breached' : 'Safe'),
          explain: isBreached ? null : 'PIR sensor skal være aktiveret (Breached) for at trigge'
        };
      case 'motionSafe':
        var isSafe = state.motion === false;
        return { 
          ok: isSafe, 
          description: 'PIR = ' + (state.motion ? 'Breached' : 'Safe'),
          explain: isSafe ? null : 'PIR sensor skal være deaktiveret (Safe) for at trigge'
        };
      case 'doorOpened':
        var isOpen = state.door === true;
        return { 
          ok: isOpen, 
          description: 'Dør = ' + (state.door ? 'Opened' : 'Closed'),
          explain: isOpen ? null : 'Døren skal være åben for at trigge'
        };
      case 'timeEquals':
        var matches = rule.triggerValue === state.time;
        return {
          ok: matches,
          description: 'Tid = ' + state.time + ' (forventet: ' + (rule.triggerValue || 'ikke sat') + ')',
          explain: matches ? null : 'Tiden skal være præcis ' + rule.triggerValue + ' for at trigge'
        };
      case 'humidityAbove':
        var threshold = parseFloat(rule.triggerValue || '0');
        var above = state.humidity >= threshold;
        return {
          ok: above,
          description: 'Fugt = ' + state.humidity + '% (≥ ' + threshold + '%)',
          explain: above ? null : 'Fugtighed skal være ' + threshold + '% eller højere'
        };
      case 'humidityBelow':
        var threshold = parseFloat(rule.triggerValue || '0');
        var below = state.humidity < threshold;
        return {
          ok: below,
          description: 'Fugt = ' + state.humidity + '% (< ' + threshold + '%)',
          explain: below ? null : 'Fugtighed skal være under ' + threshold + '%'
        };
      case 'globalEqTrig':
        var p = parseNameValue(rule.triggerValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig global reference', explain: 'Global navn mangler' };
        var currentVal = gget(p.name);
        var matches = currentVal === p.value;
        return {
          ok: matches,
          description: p.name + ' = "' + currentVal + '" (forventet: "' + p.value + '")',
          explain: matches ? null : 'Global ' + p.name + ' skal være præcis "' + p.value + '"'
        };
      case 'sensorEqTrig':
        var p = parseNameValue(rule.triggerValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = gget(p.name);
        var matches = currentVal === p.value;
        return {
          ok: matches,
          description: p.name + ' = "' + currentVal + '" (forventet: "' + p.value + '")',
          explain: matches ? null : 'Sensor ' + p.name + ' skal være præcis "' + p.value + '"'
        };
      case 'sensorGtTrig':
        var p = parseNameValue(rule.triggerValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var above = currentVal > threshold;
        return {
          ok: above,
          description: p.name + ' = ' + currentVal + ' (> ' + threshold + ')',
          explain: above ? null : 'Sensor ' + p.name + ' skal være større end ' + threshold
        };
      case 'sensorLtTrig':
        var p = parseNameValue(rule.triggerValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var below = currentVal < threshold;
        return {
          ok: below,
          description: p.name + ' = ' + currentVal + ' (< ' + threshold + ')',
          explain: below ? null : 'Sensor ' + p.name + ' skal være mindre end ' + threshold
        };
      case 'sensorGeTrig':
        var p = parseNameValue(rule.triggerValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var aboveOrEqual = currentVal >= threshold;
        return {
          ok: aboveOrEqual,
          description: p.name + ' = ' + currentVal + ' (≥ ' + threshold + ')',
          explain: aboveOrEqual ? null : 'Sensor ' + p.name + ' skal være større end eller lig ' + threshold
        };
      case 'sensorLeTrig':
        var p = parseNameValue(rule.triggerValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var belowOrEqual = currentVal <= threshold;
        return {
          ok: belowOrEqual,
          description: p.name + ' = ' + currentVal + ' (≤ ' + threshold + ')',
          explain: belowOrEqual ? null : 'Sensor ' + p.name + ' skal være mindre end eller lig ' + threshold
        };
      default:
        return { ok: false, description: 'Ukendt trigger type', explain: 'Trigger type "' + rule.trigger + '" ikke understøttet i diagnose' };
    }
  }

  function evaluateConditionForDiag(condType, condValue) {
    if (!condType) return { ok: true, description: '(ingen)', explain: null };
    
    switch(condType) {
      case 'luxBelow':
        var threshold = parseFloat(condValue || '0');
        var below = state.lux < threshold;
        return {
          ok: below,
          description: 'Lys = ' + state.lux + ' (< ' + threshold + ')',
          explain: below ? null : 'Lysniveau skal være under ' + threshold
        };
      case 'luxAbove':
        var threshold = parseFloat(condValue || '0');
        var above = state.lux > threshold;
        return {
          ok: above,
          description: 'Lys = ' + state.lux + ' (> ' + threshold + ')',
          explain: above ? null : 'Lysniveau skal være over ' + threshold
        };
      case 'humAbove':
        var threshold = parseFloat(condValue || '0');
        var above = state.humidity >= threshold;
        return {
          ok: above,
          description: 'Fugt = ' + state.humidity + '% (≥ ' + threshold + '%)',
          explain: above ? null : 'Fugtighed skal være ' + threshold + '% eller højere'
        };
      case 'humBelow':
        var threshold = parseFloat(condValue || '0');
        var below = state.humidity <= threshold;
        return {
          ok: below,
          description: 'Fugt = ' + state.humidity + '% (≤ ' + threshold + '%)',
          explain: below ? null : 'Fugtighed skal være ' + threshold + '% eller lavere'
        };
      case 'windBelow':
        var threshold = parseFloat(condValue || '0');
        var below = state.wind < threshold;
        return {
          ok: below,
          description: 'Vind = ' + state.wind + ' (< ' + threshold + ')',
          explain: below ? null : 'Vindhastighed skal være under ' + threshold
        };
      case 'weekdayIn':
        var allowedDays = (condValue || '').split(',').map(function(s){return s.trim();});
        var matches = allowedDays.includes(state.weekday);
        return {
          ok: matches,
          description: 'Ugedag = ' + state.weekday + ' (i: ' + allowedDays.join(', ') + ')',
          explain: matches ? null : 'Ugedagen skal være en af: ' + allowedDays.join(', ')
        };

      case 'globalEq':
        var parts = (condValue || '').split('=');
        var key = (parts[0] || '').trim();
        var expected = (parts[1] || '').trim();
        if (!key) return { ok: false, description: 'Ugyldig global reference', explain: 'Global navn mangler' };
        var currentVal = (state.globals[key] || '');
        var matches = currentVal === expected;
        return {
          ok: matches,
          description: key + ' = "' + currentVal + '" (forventet: "' + expected + '")',
          explain: matches ? null : 'Global ' + key + ' skal være "' + expected + '"'
        };
      case 'sensorEq':
        var p = parseNameValue(condValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = gget(p.name);
        var matches = currentVal === p.value;
        return {
          ok: matches,
          description: p.name + ' = "' + currentVal + '" (forventet: "' + p.value + '")',
          explain: matches ? null : 'Sensor ' + p.name + ' skal være "' + p.value + '"'
        };
      case 'sensorNe':
        var p = parseNameValue(condValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = gget(p.name);
        var notMatches = currentVal !== p.value;
        return {
          ok: notMatches,
          description: p.name + ' = "' + currentVal + '" (≠ "' + p.value + '")',
          explain: notMatches ? null : 'Sensor ' + p.name + ' skal IKKE være "' + p.value + '"'
        };
      case 'sensorGt':
        var p = parseNameValue(condValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var above = currentVal > threshold;
        return {
          ok: above,
          description: p.name + ' = ' + currentVal + ' (> ' + threshold + ')',
          explain: above ? null : 'Sensor ' + p.name + ' skal være større end ' + threshold
        };
      case 'sensorLt':
        var p = parseNameValue(condValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var below = currentVal < threshold;
        return {
          ok: below,
          description: p.name + ' = ' + currentVal + ' (< ' + threshold + ')',
          explain: below ? null : 'Sensor ' + p.name + ' skal være mindre end ' + threshold
        };
      case 'sensorGe':
        var p = parseNameValue(condValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var aboveOrEqual = currentVal >= threshold;
        return {
          ok: aboveOrEqual,
          description: p.name + ' = ' + currentVal + ' (≥ ' + threshold + ')',
          explain: aboveOrEqual ? null : 'Sensor ' + p.name + ' skal være større end eller lig ' + threshold
        };
      case 'sensorLe':
        var p = parseNameValue(condValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var belowOrEqual = currentVal <= threshold;
        return {
          ok: belowOrEqual,
          description: p.name + ' = ' + currentVal + ' (≤ ' + threshold + ')',
          explain: belowOrEqual ? null : 'Sensor ' + p.name + ' skal være mindre end eller lig ' + threshold
        };
      case 'sensorContains':
        var p = parseNameValue(condValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = String(gget(p.name));
        var contains = currentVal.indexOf(p.value) !== -1;
        return {
          ok: contains,
          description: p.name + ' = "' + currentVal + '" (indeholder "' + p.value + '")',
          explain: contains ? null : 'Sensor ' + p.name + ' skal indeholde "' + p.value + '"'
        };
      case 'timeBetween':
        var inRange = timeBetweenVirtual(state.time, condValue || '');
        return {
          ok: inRange,
          description: 'Tid = ' + state.time + ' (mellem ' + (condValue || 'ikke sat') + ')',
          explain: inRange ? null : 'Tiden skal være mellem ' + condValue
        };
      case 'alarmArmed':
        var armed = state.alarmArmed === true;
        return {
          ok: armed,
          description: 'Alarm = ' + (state.alarmArmed ? 'Armed' : 'Disarmed') + ' (forventet: Armed)',
          explain: armed ? null : 'Alarmen skal være Armed'
        };
      case 'alarmHome':
        var home = state.alarmHome === true;
        return {
          ok: home,
          description: 'Alarm = ' + (state.alarmHome ? 'Home Mode' : 'Away Mode') + ' (forventet: Home Mode)',
          explain: home ? null : 'Alarmen skal være i Home Mode'
        };
      case 'doorClosed':
        var closed = state.door === false;
        return {
          ok: closed,
          description: 'Dør = ' + (state.door ? 'Åben' : 'Lukket') + ' (forventet: Lukket)',
          explain: closed ? null : 'Døren skal være lukket'
        };
      default:
        return { ok: false, description: 'Ukendt condition type', explain: 'Condition type "' + condType + '" ikke understøttet i diagnose' };
    }
  }

  function getTriggerDescription(triggerType) {
    var map = {
      'always': 'Altid',
      'motionBreached': 'PIR → Breached',
      'motionSafe': 'PIR → Safe',
      'doorOpened': 'Dør → Opened',
      'timeEquals': 'Tid =',
      'humidityAbove': 'Fugt ≥',
      'humidityBelow': 'Fugt <',
      'globalEqTrig': 'Global ==',
      'sensorEqTrig': 'Sensor ==',
      'sensorGtTrig': 'Sensor >',
      'sensorLtTrig': 'Sensor <',
      'sensorGeTrig': 'Sensor ≥',
      'sensorLeTrig': 'Sensor ≤'
    };
    return map[triggerType] || triggerType;
  }

  function getConditionDescription(condType) {
    var map = {
      'luxBelow': 'Lys <',
      'luxAbove': 'Lys >',
      'humAbove': 'Fugt ≥',
      'humBelow': 'Fugt ≤',
      'windBelow': 'Vind <',
      'weekdayIn': 'Ugedag i',
      'alarmArmed': 'Alarm = Armed',
      'doorClosed': 'Dørkontakt = Closed',
      'alarmHome': 'Home Mode',
      
      'globalEq': 'Global ==',
      'sensorEq': 'Sensor ==',
      'sensorNe': 'Sensor ≠',
      'sensorGt': 'Sensor >',
      'sensorLt': 'Sensor <',
      'sensorGe': 'Sensor ≥',
      'sensorLe': 'Sensor ≤',
      'sensorContains': 'Sensor contains',
      'timeBetween': 'Tid mellem'
    };
    return map[condType] || condType;
  }

  function getActionDescription(actionType) {
    var map = {
      'lightOn': 'Lys → Tænd',
      'lightOff': 'Lys → Sluk',
      'dim30': 'Dæmper → 30%',
      'dim100': 'Dæmper → 100%',
      'fanOn': 'Ventilator → Tænd',
      'fanOff': 'Ventilator → Sluk',
      'push': 'Send Push',
      'setGlobal': 'Set Global',
      'delayLightOff': 'Delay → Lys Off'
    };
    return map[actionType] || actionType;
  }

  $('#addRule').onclick=function(){ var r={trigger:$('#triggerType').value, triggerValue:$('#triggerValue').value.trim(),
    cond1:$('#cond1').value, cond1Value:$('#cond1Value').value.trim(), cond2:$('#cond2').value, cond2Value:$('#cond2Value').value.trim(),
    action1:$('#action1').value, action1Value:$('#action1Value').value.trim(), ruleName:$('#ruleName').value.trim()};
    state.rules.push(r); refreshRules(); log('Regel tilføjet'+(r.ruleName?': '+r.ruleName:'')); $('#ruleName').value=''; };
  $('#clearRules').onclick=function(){ state.rules=[]; refreshRules(); log('Alle regler slettet.'); };

  /* Storage + import/eksport (WebView2) */
  $('#saveRules').onclick=function(){ try{ localStorage.setItem('hc3_rules', JSON.stringify(state.rules)); log('Regler gemt i localStorage.'); }catch(e){ alert('Kunne ikke gemme: '+e.message); } };
  $('#loadRules').onclick=function(){ try{ var raw=localStorage.getItem('hc3_rules'); if(raw){ state.rules=JSON.parse(raw)||[]; refreshRules(); log('Regler hentet.'); } else alert('Ingen gemte regler.'); }catch(e){ alert('Kunne ikke læse regler: '+e.message); } };

  $('#exportRules').onclick = async function(){
    try{
      var data = JSON.stringify({version:'1.7.3', rules: state.rules}, null, 2);
      var savedPath = await window.api.saveText('hc3_rules.json', data);
      if(savedPath){ log('Regler eksporteret til ' + savedPath); alert('Eksporteret til ' + savedPath); }
    }catch(e){ alert('Eksport fejlede: ' + e.message); }
  };

  $('#importRules').onclick = async function(){
    try{
      var inp = $('#importFile');
      var f   = inp && inp.files && inp.files[0];
      if (f){
        var r = new FileReader();
        r.onload = function(e){
          try{
            var txt   = e.target.result || '';
            var obj   = JSON.parse(txt || '{}');
            var rules = obj.rules || obj || [];
            if(!(rules && rules.length >= 0)) throw new Error('JSON indeholder ikke regler');
            state.rules = rules; refreshRules(); log('Regler importeret fra valgt fil (FileReader).');
          }catch(err){ alert('Import fejlede: ' + err.message); }
        };
        r.readAsText(f);
        return;
      }
      var res = await window.api.openText();
      if(res && res.text){
        var obj   = JSON.parse(res.text || '{}');
        var rules = obj.rules || obj || [];
        if(!(rules && rules.length >= 0)) throw new Error('JSON indeholder ikke regler');
        state.rules = rules; refreshRules(); log('Regler importeret fra ' + (res.path||'(ukendt)'));
      } else {
        alert('Vælg en .json-fil (via knappen eller feltet).');
      }
    }catch(e){ alert('Import fejlede: ' + e.message); }
  };

  /* Tidshjælpere */
  function toMin(hhmm){ var sp=(hhmm||'00:00').split(':'), h=parseInt(sp[0]||'0',10), m=parseInt(sp[1]||'0',10); return h*60+m; }
  function timeBetweenVirtual(currentHHMM, range){ var now=toMin(currentHHMM||'00:00'); var parts=(range||'').split('-'); if(parts.length!==2) return false;
    var a=toMin(parts[0].trim()), b=toMin(parts[1].trim()); return (a<=b)?(now>=a&&now<=b):(now>=a||now<=b); }

  /* AND-betingelser */
  function condOk(kind,val){
    if(!kind) return true; var v=(val||'').trim();
    switch(kind){
      case 'luxBelow': return state.lux < parseFloat(v||'0');
      case 'luxAbove': return state.lux > parseFloat(v||'0');
      case 'humAbove': return state.humidity >= parseFloat(v||'0');
      case 'humBelow': return state.humidity <= parseFloat(v||'0');
      case 'windBelow': return state.wind < parseFloat(v||'0');
      case 'weekdayIn': return v.split(',').map(function(s){return s.trim();}).includes(state.weekday);
      case 'alarmArmed': return state.alarmArmed === true;
      case 'doorClosed': return state.door === false;
      case 'alarmHome': return state.alarmHome === true;
      
      case 'globalEq': { var sp=v.split('='), k=(sp[0]||'').trim(), expect=(sp[1]||'').trim(); return (state.globals[k]||'')===expect; }
      case 'sensorEq': { var p=parseNameValue(v); return gget(p.name)===p.value; }
      case 'sensorNe': { var p2=parseNameValue(v); return gget(p2.name)!==p2.value; }
      case 'sensorGt': { var p3=parseNameValue(v); return toNum(gget(p3.name)) >  toNum(p3.value); }
      case 'sensorLt': { var p4=parseNameValue(v); return toNum(gget(p4.name)) <  toNum(p4.value); }
      case 'sensorGe': { var p5=parseNameValue(v); return toNum(gget(p5.name)) >= toNum(p5.value); }
      case 'sensorLe': { var p6=parseNameValue(v); return toNum(gget(p6.name)) <= toNum(p6.value); }
      case 'sensorContains': { var p7=parseNameValue(v); return String(gget(p7.name)).indexOf(p7.value)!==-1; }
      case 'timeBetween': return timeBetweenVirtual(state.time, v);
      default: return true;
    }
  }
  function bothCondsOk(r){ return condOk(r.cond1, r.cond1Value) && condOk(r.cond2, r.cond2Value); }

  /* Triggers */
  function matchTrigger(rule, firedTrigger){
    if(rule.trigger!==firedTrigger) return false;
    switch(firedTrigger){
      case 'always': return true;
      case 'motionBreached': return state.motion===true;
      case 'motionSafe': return state.motion===false;
      case 'doorOpened': return state.door===true;
      case 'timeEquals': return !!rule.triggerValue && rule.triggerValue===state.time;
      case 'humidityAbove': return state.humidity >= parseFloat((rule.triggerValue||'0').trim());
      case 'humidityBelow': return state.humidity < parseFloat((rule.triggerValue||'0').trim());
      case 'globalEqTrig': { var p=parseNameValue(rule.triggerValue||''); if(!p.name) return false; return gget(p.name)===p.value; }
      case 'sensorEqTrig':  { var p2=parseNameValue(rule.triggerValue||''); if(!p2.name) return false; return gget(p2.name)===p2.value; }
      case 'sensorGtTrig':  { var p3=parseNameValue(rule.triggerValue||''); if(!p3.name) return false; return toNum(gget(p3.name)) >  toNum(p3.value); }
      case 'sensorLtTrig':  { var p4=parseNameValue(rule.triggerValue||''); if(!p4.name) return false; return toNum(gget(p4.name)) <  toNum(p4.value); }
      case 'sensorGeTrig':  { var p5=parseNameValue(rule.triggerValue||''); if(!p5.name) return false; return toNum(gget(p5.name)) >= toNum(p5.value); }
      case 'sensorLeTrig':  { var p6=parseNameValue(rule.triggerValue||''); if(!p6.name) return false; return toNum(gget(p6.name)) <= toNum(p6.value); }
      default: return false;
    }
  }

  function doAction(kind,param){
    switch(kind){
      case 'lightOn': setLight(true); break;
      case 'lightOff': setLight(false); break;
      case 'dim30': setDimmer(30); break;
      case 'dim100': setDimmer(100); break;
      case 'fanOn': setFan(true); break;
      case 'fanOff': setFan(false); break;
      case 'push': log('PUSH: '+(param||'(tom besked)')); break;
      case 'setGlobal': { var sp=(param||'').split('='), k=(sp[0]||'').trim(), v=(sp[1]||'').trim(); if(!k){ log('SetGlobal fejl: mangler name=value'); break; } state.globals[k]=v; log('Global '+k+'='+v); break; }
      case 'delayLightOff': { var sec=Math.max(0, parseInt(param||'0',10)); window.setTimeout(function(){ setLight(false); }, sec*1000); log('Delay '+sec+'s → Light Off planlagt'); break; }
    }
  }

  function evaluate(firedTrigger){
    for(var i=0;i<state.rules.length;i++){
      var r=state.rules[i];
      if(matchTrigger(r,firedTrigger) && bothCondsOk(r)){
        doAction(r.action1, r.action1Value);
        var name = r.ruleName ? '"'+r.ruleName+'"' : ('#'+(i+1));
        log('MATCH: Regel '+name+' → action "'+r.action1+'"', 'match');
      }
    }
  }

  function runAll(){
    for(var i=0;i<state.rules.length;i++){
      var r=state.rules[i], ok=false;
      switch(r.trigger){
        case 'always': ok=true; break;
        case 'motionBreached': ok=(state.motion===true); break;
        case 'motionSafe': ok=(state.motion===false); break;
        case 'doorOpened': ok=(state.door===true); break;
        case 'timeEquals': ok=(!!r.triggerValue && r.triggerValue===state.time); break;
        case 'humidityAbove': ok=(state.humidity >= parseFloat((r.triggerValue||'0').trim())); break;
        case 'humidityBelow': ok=(state.humidity < parseFloat((r.triggerValue||'0').trim())); break;
        case 'globalEqTrig': { var p=parseNameValue(r.triggerValue||''); ok=!!p.name && (gget(p.name)===p.value); break; }
        case 'sensorEqTrig':  { var p2=parseNameValue(r.triggerValue||''); ok=!!p2.name && (gget(p2.name)===p2.value); break; }
        case 'sensorGtTrig':  { var p3=parseNameValue(r.triggerValue||''); ok=!!p3.name && (toNum(gget(p3.name)) >  toNum(p3.value)); break; }
        case 'sensorLtTrig':  { var p4=parseNameValue(r.triggerValue||''); ok=!!p4.name && (toNum(gget(p4.name)) <  toNum(p4.value)); break; }
        case 'sensorGeTrig':  { var p5=parseNameValue(r.triggerValue||''); ok=!!p5.name && (toNum(gget(p5.name)) >= toNum(p5.value)); break; }
        case 'sensorLeTrig':  { var p6=parseNameValue(r.triggerValue||''); ok=!!p6.name && (toNum(gget(p6.name)) <= toNum(p6.value)); break; }
      }
      if(ok && bothCondsOk(r)){
        doAction(r.action1, r.action1Value);
        var name = r.ruleName ? '"'+r.ruleName+'"' : ('#'+(i+1));
        log('MATCH: Regel '+name+' → action "'+r.action1+'"', 'match');
      }
    }
    log('RUN: alle regler evalueret mod aktuelle tilstande.');
  }

  function applyPending(){
    ch('motion','PIR',function(v){return v?'Breached':'Safe';});
    ch('door','Dørkontakt',function(v){return v?'Opened':'Closed';});
    ch('lux','Lys(lux)'); ch('wind','Vind',function(v){return v+' m/s';}); ch('humidity','Fugtighed',function(v){return v+'%';});
            ch('time','Klokkeslæt'); ch('weekday','Ugedag');
    ch('alarmArmed','Alarm.Armed'); ch('alarmHome','Alarm.Home');
    var pg=pending.globals||{}; for(var k in pg){ if(pg.hasOwnProperty(k)){ if((state.globals[k]||'')!==pg[k]){ state.globals[k]=pg[k]; log('AKTIVERET: Global '+k+'='+pg[k]); } } }
    updateKPI(); runAll();
  }

  /* Knapper */
  $('#applyPending').onclick=function(){ applyPending(); };
  $('#runAll').onclick=function(){ runAll(); };
  $('#runTimeTick').onclick=function(){ evaluate('timeEquals'); log('TIME TICK: '+state.time); };
  $('#clearLog').onclick=function(){ clearLog(); };

  /* Z-Wave sensor defs + tooltips */
  var SENSOR_DEFS = {
    'PIR (bevægelse)':     {kind:'binary', key:'pir',        on:'Breached', off:'Safe'},
    'Dør-/vindueskontakt': {kind:'binary', key:'contact',    on:'Opened',   off:'Closed'},
    'Fugtighed (%)':       {kind:'number', key:'humidity',   unit:'%',    step:1,   min:0,   max:100,  mapsTo:'humidity'},
    'Lys (lux)':           {kind:'number', key:'lux',        unit:'lux',  step:1,   min:0,   max:5000, mapsTo:'lux'},
    'Vind (m/s)':          {kind:'number', key:'wind',       unit:'m/s',  step:0.1, min:0,   max:60,   mapsTo:'wind'},
    'Temperatur (°C)':     {kind:'number', key:'temp',       unit:'°C',   step:0.1, min:-30, max:60},
    'Røgalarm':            {kind:'binary', key:'smoke',      on:'Detected', off:'Clear'},
    'Vandlækage':          {kind:'binary', key:'leak',       on:'Wet',     off:'Dry'},
    'CO₂ (ppm)':           {kind:'number', key:'co2',        unit:'ppm',  step:50,  min:300, max:5000},
    'Tilstedeværelse':     {kind:'binary', key:'presence',   on:'Occupied', off:'Vacant'},
    'Alarm (Armed)':       {kind:'binary', key:'alarmArmed', on:'Armed',   off:'Disarmed'},
    'Home Mode':           {kind:'binary', key:'alarmHome',  on:'Home',    off:'Away'},
    
  };
  function makeSensorTip(name){
    var def=SENSOR_DEFS[name]; if(!def) return 'Sensor (global)\nSkriv i Regler: navn=værdi';
    if(def.mapsTo){ if(def.mapsTo==='lux') return ['Lys (lux) – IKKE via Sensor (global)','Brug i Regler:','• AND: "Lys (lux) <" / ">"','Eksempel: AND Lys (lux) < 50'].join('\n');
      if(def.mapsTo==='wind') return ['Vind (m/s) – IKKE via Sensor (global)','Brug i Regler:','• AND: "Vind <"','Eksempel: AND Vind < 5'].join('\n');
      if(def.mapsTo==='humidity') return ['Fugtighed (%) – IKKE via Sensor (global)','Brug i Regler:','• IF Fugtighed ≥ (værdi)','• AND Fugtighed ≤ / ≥','Eksempel: IF Fugtighed ≥ 65'].join('\n'); }
    var key='sensor.'+def.key;
    if(def.kind==='binary') return [name,'Global: '+key,'Værdier: '+def.on+' / '+def.off,'IF: Sensor (global) =','  '+key+'='+def.on,'AND: ==, ≠, contains','  fx '+key+'='+def.off].join('\n');
    var unit=def.unit?(' '+def.unit):''; return [name,'Global: '+key,'Værdi: tal'+unit,'IF: Sensor (global) >, <, ≥, ≤, =','  fx '+key+'=21','AND: >, <, ≥, ≤, ==, ≠'].join('\n');
  }

  function zwMakeRow(container){
    var row=document.createElement('div'); row.className='zw-row';

    var typeSel=document.createElement('select'); typeSel.className='zw-type';
    for(var name in SENSOR_DEFS){ var op=document.createElement('option'); op.value=name; op.text=name; typeSel.appendChild(op); }

    var valWrap=document.createElement('div');
    valWrap.style.display='flex'; valWrap.style.alignItems='center'; valWrap.style.gap='8px'; valWrap.style.flex='0 0 auto';
    var valCtl=null;

    var setBtn=document.createElement('button'); setBtn.textContent='Sæt (buffer)';
    var delBtn=document.createElement('button'); delBtn.textContent='Fjern'; delBtn.className='danger';

    var badge=document.createElement('span');   badge.className='zw-badge has-tip';
    var nameChip=document.createElement('span'); nameChip.className='zw-global';
    var mapsChip=document.createElement('span'); mapsChip.className='zw-maps';

    function updateMeta(){
      var def=SENSOR_DEFS[typeSel.value]; if(!def) return;
      badge.textContent=(def.kind==='binary')?'Binær':'Numerisk';
      var tip=makeSensorTip(typeSel.value); badge.setAttribute('data-tip',tip); badge.title=tip.replace(/\n/g,' • ');
      nameChip.textContent = 'sensor.'+def.key;
      mapsChip.textContent = def.mapsTo ? def.mapsTo : '';
      mapsChip.style.display = def.mapsTo ? 'inline-flex' : 'none';
    }

    function renderValueCtl(){
      valWrap.innerHTML=''; valCtl=null; var def=SENSOR_DEFS[typeSel.value]; if(!def) return;
      if(def.kind==='binary'){
        var onOff=document.createElement('select'); onOff.className='zw-val';
        var o1=document.createElement('option'); o1.value=def.on;  o1.text=def.on;
        var o2=document.createElement('option'); o2.value=def.off; o2.text=def.off;
        onOff.appendChild(o1); onOff.appendChild(o2);
        valCtl=onOff; valWrap.appendChild(onOff);
      } else {
        var inp=document.createElement('input'); inp.className='zw-val'; inp.type='number';
        if(def.step!=null) inp.step=def.step; if(def.min!=null) inp.min=def.min; if(def.max!=null) inp.max=def.max;
        inp.value=def.min!=null?def.min:0; valCtl=inp; valWrap.appendChild(inp);
        if(def.unit){ var unit=document.createElement('span'); unit.className='zw-badge'; unit.textContent=def.unit; valWrap.appendChild(unit); }
      }
      updateMeta();
    }

    typeSel.onchange=function(){ renderValueCtl(); };
    renderValueCtl();

    setBtn.onclick=function(){
      var def=SENSOR_DEFS[typeSel.value]; if(!def) return; var key=def.key;
      if(def.mapsTo){
        var num=parseFloat(valCtl.value); if(isNaN(num)) num=0;
        pending[def.mapsTo]=num;
        log('BUFFER: '+typeSel.value+' → '+num+(def.unit?(' '+def.unit):''));
      } else if(def.kind==='binary'){
        var v=String(valCtl.value||def.off);
        if(!pending.globals) pending.globals={}; pending.globals['sensor.'+key]=v;
        log('BUFFER: Global sensor.'+key+'='+v);
        
        // Special håndtering for PIR og dørkontakt til backward compatibility
        if(key === 'pir') {
          pending.motion = (v === def.on);
        } else if(key === 'contact') {
          pending.door = (v === def.on);
        } else if(key === 'alarmArmed') {
          pending.alarmArmed = (v === def.on);
        } else if(key === 'alarmHome') {
          pending.alarmHome = (v === def.on);
        }
      } else {
        var numv=String(valCtl.value);
        if(!pending.globals) pending.globals={}; pending.globals['sensor.'+key]=numv;
        log('BUFFER: Global sensor.'+key+'='+numv);
      }
    };

    delBtn.onclick=function(){ container.removeChild(row); };

    /* Append-orden: kontroller -> knapper -> metachips (til højre) */
    var metaWrap=document.createElement('div'); metaWrap.className='zw-meta';
    metaWrap.appendChild(nameChip); metaWrap.appendChild(mapsChip); metaWrap.appendChild(badge);

    row.appendChild(typeSel);
    row.appendChild(valWrap);
    row.appendChild(setBtn);
    row.appendChild(delBtn);
    row.appendChild(metaWrap);

    container.appendChild(row);
  }
  window.zwMakeRow=zwMakeRow;

  /* LUA generator */
  function esc(s){ return (s||'').replace(/\\/g,'\\\\').replace(/"/g,'\\"'); }
  function luaForTrigger(r){ function pnv(){ return parseNameValue(r.triggerValue||''); }
    switch(r.trigger){
      case 'always': return 'true';
      case 'motionBreached': return 'fibaro.getValue(MOTION_ID, "value") == "true"';
      case 'motionSafe':     return 'fibaro.getValue(MOTION_ID, "value") == "false"';
      case 'doorOpened':     return 'fibaro.getValue(DOOR_ID, "value") == "true"';
      case 'timeEquals':     return 'os.date("%H:%M") == "'+esc(r.triggerValue||"07:30")+'"';
      case 'humidityAbove':  return '(tonumber(fibaro.getValue(HUM_ID, "value")) or 0) >= '+(parseFloat(r.triggerValue||'0')||0);
      case 'humidityBelow':  return '(tonumber(fibaro.getValue(HUM_ID, "value")) or 0) < '+(parseFloat(r.triggerValue||'0')||0);
      case 'globalEqTrig': { var p=pnv(); return 'fibaro.getGlobalVariable("'+esc(p.name||'')+'") == "'+esc(p.value||'')+'"'; }
      case 'sensorEqTrig':  { var p2=pnv(); return 'fibaro.getGlobalVariable("'+esc(p2.name||'')+'") == "'+esc(p2.value||'')+'"'; }
      case 'sensorGtTrig':  { var p3=pnv(); return '(tonumber(fibaro.getGlobalVariable("'+esc(p3.name||'')+'")) or 0) > '+(parseFloat(p3.value||'0')||0); }
      case 'sensorLtTrig':  { var p4=pnv(); return '(tonumber(fibaro.getGlobalVariable("'+esc(p4.name||'')+'")) or 0) < '+(parseFloat(p4.value||'0')||0); }
      case 'sensorGeTrig':  { var p5=pnv(); return '(tonumber(fibaro.getGlobalVariable("'+esc(p5.name||'')+'")) or 0) >= '+(parseFloat(p5.value||'0')||0); }
      case 'sensorLeTrig':  { var p6=pnv(); return '(tonumber(fibaro.getGlobalVariable("'+esc(p6.name||'')+'")) or 0) <= '+(parseFloat(p6.value||'0')||0); }
      default: return 'true';
    } }
  function luaForCond(kind, val){ var v=(val||'').trim(); function p(){ return parseNameValue(v); }
    switch(kind){
      case 'luxBelow':  return '(tonumber(fibaro.getValue(LUX_ID, "value")) or 0) < '+(parseFloat(v||'0')||0);
      case 'luxAbove':  return '(tonumber(fibaro.getValue(LUX_ID, "value")) or 0) > '+(parseFloat(v||'0')||0);
      case 'humAbove':  return '(tonumber(fibaro.getValue(HUM_ID, "value")) or 0) >= '+(parseFloat(v||'0')||0);
      case 'humBelow':  return '(tonumber(fibaro.getValue(HUM_ID, "value")) or 0) <= '+(parseFloat(v||'0')||0);
      case 'windBelow': return '(tonumber(fibaro.getValue(WIND_ID, "value")) or 0) < '+(parseFloat(v||'0')||0);
      case 'weekdayIn': { var parts=v.split(','), set='{'+parts.map(function(pw){ pw=pw.replace(/"/g,'\\"'); return '["'+pw+'"]=true'; }).join(', ')+'}'; return '(function() local D='+set+'; return D[os.date("%a")] == true end)()'; }
      case 'alarmArmed': return 'fibaro.getGlobalVariable("Alarm") == "Armed"';
      case 'alarmHome': return 'fibaro.getGlobalVariable("HomeMode") == "Home"';
      
      case 'globalEq': { var sp=v.split('='), k=(sp[0]||'mode'), expect=(sp[1]||'night'); return 'fibaro.getGlobalVariable("'+esc(k)+'") == "'+esc(expect)+'"'; }
      case 'sensorEq': { var pp=p(); return 'fibaro.getGlobalVariable("'+esc(pp.name||'')+'") == "'+esc(pp.value||'')+'"'; }
      case 'sensorNe': { var pp2=p(); return 'fibaro.getGlobalVariable("'+esc(pp2.name||'')+'") ~= "'+esc(pp2.value||'')+'"'; }
      case 'sensorGt': { var pp3=p(); return '(tonumber(fibaro.getGlobalVariable("'+esc(pp3.name||'')+'")) or 0) > '+(parseFloat(pp3.value||'0')||0); }
      case 'sensorLt': { var pp4=p(); return '(tonumber(fibaro.getGlobalVariable("'+esc(pp4.name||'')+'")) or 0) < '+(parseFloat(pp4.value||'0')||0); }
      case 'sensorGe': { var pp5=p(); return '(tonumber(fibaro.getGlobalVariable("'+esc(pp5.name||'')+'")) or 0) >= '+(parseFloat(pp5.value||'0')||0); }
      case 'sensorLe': { var pp6=p(); return '(tonumber(fibaro.getGlobalVariable("'+esc(pp6.name||'')+'")) or 0) <= '+(parseFloat(pp6.value||'0')||0); }
      case 'sensorContains': { var pp7=p(); return '(tostring(fibaro.getGlobalVariable("'+esc(pp7.name||'')+'")) or ""):find("'+esc(pp7.value||'')+'",1,true) ~= nil'; }
      case 'timeBetween': return '(function() local expr="'+v.replace(/"/g,'\\"')+'"; local function toMin(s) local h,m=s:match("^(%d%d):(%d%d)$"); h=tonumber(h) or 0; m=tonumber(m) or 0; return h*60+m end local now = toMin(os.date("%H:%M")); local a,b=expr:match("^(%d%d:%d%d)%-(%d%d:%d%d)$"); if not a or not b then return false end local A,B=toMin(a),toMin(b); if A<=B then return now>=A and now<=B else return now>=A or now<=B end end)()';
      default: return 'true';
    } }
  function luaForAction(kind, val){
    switch(kind){
      case 'lightOn':  return 'fibaro.call(LIGHT_ID, "turnOn")';
      case 'lightOff': return 'fibaro.call(LIGHT_ID, "turnOff")';
      case 'dim30':    return 'fibaro.call(DIMMER_ID, "setValue", 30)';
      case 'dim100':   return 'fibaro.call(DIMMER_ID, "setValue", 100)';
      case 'fanOn':    return 'fibaro.call(FAN_ID, "turnOn")';
      case 'fanOff':   return 'fibaro.call(FAN_ID, "turnOff")';
      case 'push':     return '-- Skift til fibaro.alert hvis ønsket\nfibaro.debug("PUSH", "'+String(val||"(tom besked)").replace(/\\/g,'\\\\').replace(/"/g,'\\"')+'")';
      case 'setGlobal':{ var sp=(val||'mode=night').split('='), k=(sp[0]||'mode'), vv=(sp[1]||'night'); return 'fibaro.setGlobalVariable("'+k.replace(/\\/g,'\\\\').replace(/"/g,'\\"')+'", "'+String(vv).replace(/\\/g,'\\\\').replace(/"/g,'\\"')+'")'; }
      case 'delayLightOff': { var sec=Math.max(0, parseInt(val||'0',10)); return 'fibaro.setTimeout('+(sec*1000)+', function() fibaro.call(LIGHT_ID, "turnOff") end)'; }
      default: return '-- (ukendt action)';
    }
  }
  function buildLua(){
    var rules=state.rules||[], body=[];
    for(var i=0;i<rules.length;i++){
      var r=rules[i], parts=[];
      parts.push('-- Regel #'+(i+1)+(r.ruleName?(' "'+r.ruleName.replace(/"/g,'\\\"')+'"'):''));
      parts.push('do'); parts.push('  local ok = ('+luaForTrigger(r)+')');
      if(r.cond1){ parts.push('  ok = ok and ('+luaForCond(r.cond1, r.cond1Value)+')'); }
      if(r.cond2){ parts.push('  ok = ok and ('+luaForCond(r.cond2, r.cond2Value)+')'); }
      parts.push('  if ok then'); parts.push('    '+luaForAction(r.action1, r.action1Value)); parts.push('  end'); parts.push('end');
      body.push(parts.join('\n'));
    }
    var actionsLua=[
      '-- Scene genereret af SmartHome Simulator (v2.0)',
      '-- RET ENHEDS-ID\'er HERUNDER:',
      'local LIGHT_ID, DIMMER_ID, FAN_ID = 123, 123, 456',
      'local MOTION_ID, DOOR_ID = 111, 112',
      'local LUX_ID, HUM_ID, WIND_ID = 113, 114, 115',
      '',
      '-- === Regler ===',
      body.join('\\n\\n'),
      ''
    ].join('\n');

    function condForTrigger(r){
      switch(r.trigger){
        case 'motionBreached': return '{ type="device", id=MOTION_ID, property="value", operator="==", value=true,  isTrigger=true }';
        case 'motionSafe':     return '{ type="device", id=MOTION_ID, property="value", operator="==", value=false, isTrigger=true }';
        case 'doorOpened':     return '{ type="device", id=DOOR_ID,   property="value", operator="==", value=true,  isTrigger=true }';
        case 'timeEquals':     return '{ type="time", operator="==", value="'+(r.triggerValue||"07:30").replace(/"/g,'\\\"')+'", isTrigger=true }';
        case 'humidityAbove':  return '{ type="device", id=HUM_ID,    property="value", operator=">=", value='+(parseFloat(r.triggerValue||"0")||0)+', isTrigger=true }';
        case 'humidityBelow':  return '{ type="device", id=HUM_ID,    property="value", operator="<", value='+(parseFloat(r.triggerValue||"0")||0)+', isTrigger=true }';
        default: return null;
      }
    }
    var condSet={}, condList=[]; for(var j=0;j<rules.length;j++){ var c=condForTrigger(rules[j]); if(c&&!condSet[c]){condSet[c]=1; condList.push(c);} }
    if(condList.length===0){ condList.push('{}'); }
    var decl=['{','  conditions = {','    ' + condList.join(',\\n    '),'  },','  operator = "any"','}'].join('\n');
    
    // Fyld de to separate tekstbokse
    var leftPanel = ['-- === ERKLÆRINGER (venstre panel i HC3) ===', decl].join('\n\n');
    var rightPanel = ['-- === HANDLINGER (højre panel i HC3) ===', actionsLua].join('\n\n');
    
    // Opdater de separate tekstbokse
    var leftTextarea = document.getElementById('luaOutLeft');
    var rightTextarea = document.getElementById('luaOutRight');
    if (leftTextarea) leftTextarea.value = leftPanel;
    if (rightTextarea) rightTextarea.value = rightPanel;
    
    // Behold bagudkompatibilitet med den gamle luaOut
    var combinedOutput = [leftPanel, '', rightPanel].join('\n\n');
    return combinedOutput;
  }
  $('#btnGenLua').onclick=function(){ luaOut.value = buildLua(); log('LUA genereret.'); menu.classList.remove('open'); };
  $('#btnCopyLua').onclick=function(){ 
    try{ 
      // Kopier fra venstre panel (conditions)
      var leftTextarea = document.getElementById('luaOutLeft');
      var rightTextarea = document.getElementById('luaOutRight');
      
      if (leftTextarea && rightTextarea && leftTextarea.value && rightTextarea.value) {
        // Kopier begge paneler
        var combinedText = leftTextarea.value + '\n\n' + rightTextarea.value;
        navigator.clipboard.writeText(combinedText).then(function() {
          log('LUA kopieret (begge paneler).');
        }).catch(function() {
          // Fallback til gammel metode
          luaOut.focus(); 
          luaOut.select(); 
          document.execCommand('copy'); 
          log('LUA kopieret (fallback).');
        });
      } else {
        // Fallback til gammel metode hvis de nye tekstbokse ikke findes
        luaOut.focus(); 
        luaOut.select(); 
        document.execCommand('copy'); 
        log('LUA kopieret (fallback).');
      }
    }catch(e){ 
      alert('Kunne ikke kopiere: '+e.message);
    }
    menu.classList.remove('open'); 
  };
  $('#btnSaveLua').onclick=async function(){
    try{
      // Prøv at få kode fra de nye tekstbokse først
      var leftTextarea = document.getElementById('luaOutLeft');
      var rightTextarea = document.getElementById('luaOutRight');
      
      var code = '';
      if (leftTextarea && rightTextarea && leftTextarea.value && rightTextarea.value) {
        // Brug de separate paneler
        code = leftTextarea.value + '\n\n' + rightTextarea.value;
      } else {
        // Fallback til gammel metode
        code = luaOut.value || '';
      }
      
      if(!code){ alert('Generér LUA først.'); return; }
      var p = await window.api.saveText('hc3_scene.lua', code);
      if(p){ log('LUA gemt: '+p); alert('LUA gemt: '+p); }
    }catch(e){ alert('Kunne ikke gemme LUA: '+e.message);}
    menu.classList.remove('open');
  };
  
  // Funktioner til at kopiere hver panel separat
  window.copyLeftPanel = function() {
    try {
      var leftTextarea = document.getElementById('luaOutLeft');
      if (leftTextarea && leftTextarea.value) {
        navigator.clipboard.writeText(leftTextarea.value).then(function() {
          log('Venstre panel kopieret.');
        }).catch(function() {
          leftTextarea.focus();
          leftTextarea.select();
          document.execCommand('copy');
          log('Venstre panel kopieret (fallback).');
        });
      } else {
        alert('Intet at kopiere. Generér LUA først.');
      }
    } catch(e) {
      alert('Kunne ikke kopiere: ' + e.message);
    }
  };
  
  window.copyRightPanel = function() {
    try {
      var rightTextarea = document.getElementById('luaOutRight');
      if (rightTextarea && rightTextarea.value) {
        navigator.clipboard.writeText(rightTextarea.value).then(function() {
          log('Højre panel kopieret.');
        }).catch(function() {
          rightTextarea.focus();
          rightTextarea.select();
          document.execCommand('copy');
          log('Højre panel kopieret (fallback).');
        });
      } else {
        alert('Intet at kopiere. Generér LUA først.');
      }
    } catch(e) {
      alert('Kunne ikke kopiere: ' + e.message);
    }
  };

  /* Bootstrap-eksempel */
  if(!localStorage.getItem('hc3_rules_bootstrap_173')){
    state.rules.push({trigger:'sensorEqTrig',triggerValue:'sensor.contact=Opened',cond1:'timeBetween',cond1Value:'22:00-06:00',cond2:'',cond2Value:'',action1:'push',action1Value:'DØR ÅBNET OM NATTEN',ruleName:'Dør nat'});
    localStorage.setItem('hc3_rules_bootstrap_173','1');
  }

  /* Init */
  function addZwRow(){ var box = document.getElementById('zwRows'); if (!box){ alert('zwRows mangler'); return; } zwMakeRow(box); log('Ny Z-Wave sensor-række tilføjet.'); }
  document.getElementById('zwAdd').onclick = addZwRow;



  (function(){ 
    refreshRules(); 
    updateKPI(); 
    

    
    log('SmartHome Simulator v2.0 (WebView2 • SPA) klar.'); 
  })();

  // === ONBOARDING SYSTEM ===
  (function(){
    var onboardingSteps = [
      {
        title: 'Velkommen til SmartHome Simulator',
        content: 'Her kan du simulere sensorer og se hvordan de påvirker dine regler. Prøv at gå til "Z-Wave sensorer" sektionen og tilføj en PIR-sensor.',
        target: '#zwAdd',
        position: 'bottom'
      },
      {
        title: 'Aktiver ændringer',
        content: 'Når du ændrer sensorer via Z-Wave systemet, bliver de først "buffered". Klik "Aktivér ændringer" for at anvende dem og køre reglerne.',
        target: '#applyPending',
        position: 'top'
      },
      {
        title: 'Regler sektion',
        content: 'Her bygger du dine automation regler. Vælg en trigger (IF), tilføj betingelser (AND) og vælg en handling (THEN).',
        target: '#triggerType',
        position: 'bottom'
      },
      {
        title: 'Tilføj regel',
        content: 'Når du har konfigureret din regel, klik "Tilføj regel" for at gemme den. Den vises derefter i listen nedenfor.',
        target: '#addRule',
        position: 'top'
      },
      {
        title: 'Kør regler',
        content: 'Klik "Kør regler (RUN)" for at evaluere alle regler mod de aktuelle sensor-tilstande og se resultatet i loggen.',
        target: '#runAll',
        position: 'top'
      },
      {
        title: 'LUA generering for HC3',
        content: 'Åbn LUA-menuen og vælg "Generér LUA" for at få kode til Fibaro Home Center 3. Koden deles op i to paneler: "ERKLÆRINGER" (venstre) og "HANDLINGER" (højre) for nemmere kopiering til HC3.',
        target: '#luaBtn',
        position: 'bottom'
      },
      {
        title: 'Wiresheet Editor',
        content: 'Prøv Wiresheet-fanen for en visuel måde at bygge regler på. Træk noder rundt og forbind dem for at skabe komplekse automationer. Toolbar\'et er blevet optimeret for bedre brugeroplevelse.',
        target: '#tabFlow',
        position: 'bottom'
      },
      {
        title: 'Opgaver & Læring',
        content: 'Besøg "Opgaver" fanen for at få praktiske øvelser og "Læring" fanen for at udforske avancerede koncepter.',
        target: '[data-target="view-tasks"]',
        position: 'bottom'
      },
      {
        title: 'Indstillinger',
        content: 'I Indstillinger kan du tilpasse tema, nulstille onboarding og administrere din brugerkonto.',
        target: '[data-target="view-settings"]',
        position: 'bottom'
      }
    ];

    var currentStep = 0;
    var onboardingActive = false;

    function showOnboardingStep(stepIndex) {
      if (stepIndex >= onboardingSteps.length) {
        finishOnboarding();
        return;
      }

      var step = onboardingSteps[stepIndex];
      var target = document.querySelector(step.target);
      if (!target) {
        showOnboardingStep(stepIndex + 1);
        return;
      }

      var overlay = document.getElementById('onboardingOverlay');
      var stepEl = document.createElement('div');
      stepEl.className = 'onboarding-step';
      
      var progress = '';
      for (var i = 0; i < onboardingSteps.length; i++) {
        var dotClass = i === stepIndex ? 'active' : (i < stepIndex ? 'completed' : '');
        progress += '<div class="dot ' + dotClass + '"></div>';
      }

      var buttonText = stepIndex === onboardingSteps.length - 1 ? 'Afslut' : 'Næste';
      var buttonClass = stepIndex === onboardingSteps.length - 1 ? 'finish' : 'next';

      stepEl.innerHTML = `
        <div class="progress">${progress}</div>
        <h3>${step.title}</h3>
        <p>${step.content}</p>
        <div class="buttons">
          <button class="skip" onclick="skipOnboarding()">Spring over</button>
          <button class="pause" onclick="pauseOnboarding()">⏸️ Pause</button>
          <button class="${buttonClass}" onclick="nextOnboardingStep()">${buttonText}</button>
        </div>
      `;

      overlay.innerHTML = '';
      overlay.appendChild(stepEl);
      overlay.style.display = 'block';

      // Position step near target but avoid covering it
      // Use setTimeout to ensure element is fully rendered
      setTimeout(function() {
        var rect = target.getBoundingClientRect();
        
        // Estimate tooltip size (320px width, ~200px height based on CSS)
        var tooltipWidth = 320;
        var tooltipHeight = 200;
        
        var left, top;
        
        // For Wiresheet tab specifically, always position to the right
        if (step.target === '#tabFlow') {
          // If rect has zero dimensions, use fallback position
          if (rect.width === 0 || rect.height === 0) {
            // Fallback - position in top-right area
            left = window.innerWidth - tooltipWidth - 50;
            top = 100;
          } else {
            left = rect.right + 20;
            top = rect.top + (rect.height / 2) - (tooltipHeight / 2);
          }
        } else {
          // Try to position tooltip to the side of the target
          
          // Check if there's space to the right
          if (rect.right + tooltipWidth + 20 < window.innerWidth) {
            left = rect.right + 20;
            top = rect.top + (rect.height / 2) - (tooltipHeight / 2);
          }
          // Check if there's space to the left
          else if (rect.left - tooltipWidth - 20 > 0) {
            left = rect.left - tooltipWidth - 20;
            top = rect.top + (rect.height / 2) - (tooltipHeight / 2);
          }
          // Check if there's space above
          else if (rect.top - tooltipHeight - 20 > 0) {
            left = rect.left + (rect.width / 2) - (tooltipWidth / 2);
            top = rect.top - tooltipHeight - 20;
          }
          // Default to below
          else {
            left = rect.left + (rect.width / 2) - (tooltipWidth / 2);
            top = rect.bottom + 20;
          }
        }
        
        // Keep within viewport
        left = Math.max(20, Math.min(left, window.innerWidth - tooltipWidth - 20));
        top = Math.max(20, Math.min(top, window.innerHeight - tooltipHeight - 20));
        
        stepEl.style.left = left + 'px';
        stepEl.style.top = top + 'px';
      }, 0);

      // Highlight target with better visibility
      target.style.outline = '4px solid #2ab0ff';
      target.style.outlineOffset = '4px';
      target.style.boxShadow = '0 0 25px rgba(42, 176, 255, 0.6), inset 0 0 10px rgba(42, 176, 255, 0.1)';
      target.style.zIndex = '10000';
      target.style.position = 'relative';
      target.style.backgroundColor = 'rgba(42, 176, 255, 0.05)';
      target.style.borderRadius = '4px';
    }

    function nextOnboardingStep() {
      // Remove highlight from current target
      if (currentStep < onboardingSteps.length) {
        var currentTarget = document.querySelector(onboardingSteps[currentStep].target);
        if (currentTarget) {
          currentTarget.style.outline = '';
          currentTarget.style.outlineOffset = '';
          currentTarget.style.boxShadow = '';
          currentTarget.style.zIndex = '';
          currentTarget.style.position = '';
          currentTarget.style.backgroundColor = '';
          currentTarget.style.borderRadius = '';
        }
      }
      
      currentStep++;
      showOnboardingStep(currentStep);
    }

    function pauseOnboarding() {
      // Hide the tooltip but keep highlights
      var overlay = document.getElementById('onboardingOverlay');
      overlay.style.display = 'none';
      
      // Show resume button
      var resumeBtn = document.createElement('div');
      resumeBtn.id = 'resumeOnboarding';
      resumeBtn.innerHTML = `
        <div style="position: fixed; top: 20px; right: 20px; z-index: 10003; background: #2ab0ff; color: white; padding: 12px 20px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
          ▶️ Fortsæt rundtur
        </div>
      `;
      resumeBtn.onclick = function() {
        document.getElementById('resumeOnboarding').remove();
        overlay.style.display = 'block';
      };
      document.body.appendChild(resumeBtn);
    }

    function skipOnboarding() {
      finishOnboarding();
    }

    function finishOnboarding() {
      // Remove all highlights
      onboardingSteps.forEach(function(step) {
        var target = document.querySelector(step.target);
        if (target) {
          target.style.outline = '';
          target.style.outlineOffset = '';
          target.style.boxShadow = '';
          target.style.zIndex = '';
          target.style.position = '';
          target.style.backgroundColor = '';
          target.style.borderRadius = '';
        }
      });

      // Remove resume button if it exists
      var resumeBtn = document.getElementById('resumeOnboarding');
      if (resumeBtn) {
        resumeBtn.remove();
      }

      document.getElementById('onboardingOverlay').style.display = 'none';
      onboardingActive = false;
      localStorage.setItem('smarthome_simulator.onboarding_completed', 'true');
    }

    function startOnboarding() {
      document.getElementById('onboardingWelcome').style.display = 'none';
      currentStep = 0;
      onboardingActive = true;
      showOnboardingStep(0);
    }



    // Task validation system
    var activeTask = null;
    var taskCriteria = {
      'ganglys': {
        name: 'Ganglys Basic',
        steps: [
          'Gå til "Z-Wave sensorer" sektionen',
          'Vælg "PIR (bevægelse)" fra dropdown',
          'Sæt værdi til "Breached"',
          'Klik "Sæt (buffer)"',
          'Klik "Aktivér ændringer"',
          'Gå til "Regler" sektionen',
          'Vælg "IF PIR bliver Breached" som trigger',
          'Vælg "THEN Lys → Tænd" som action',
          'Klik "Tilføj regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'PIR er aktiveret (Breached + Aktiver ændringer)', check: function() { 
            return window.state && window.state.motion === true; 
          }},
          { id: 'rule', text: 'Regel er oprettet', check: function() { 
            return window.state && window.state.rules && window.state.rules.length > 0; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (PIR bliver Breached)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ return r.trigger === 'motionBreached'; }); 
          }},
          { id: 'action', text: 'Handling er korrekt (lightOn)', check: function() { 
            return window.state && window.state.rules && window.state.rules.length > 0 && 
                   window.state.rules.some(r => r.action1 === 'lightOn'); 
          }}
        ]
      },
      'doorlight': {
        name: 'Dørlys med tidsbegrænsning',
        steps: [
          'Gå til "Z-Wave sensorer" sektionen',
          'Vælg "Dør-/vindueskontakt" fra dropdown',
          'Sæt værdi til "Opened"',
          'Klik "Sæt (buffer)"',
          'Klik "Aktivér ændringer"',
          'Gå til "Regler" sektionen',
          'Vælg "IF Dørkontakt ændres til Opened" som trigger',
          'Tilføj AND: "Tid mellem" med "22:00-06:00"',
          'Vælg "THEN Lys → Tænd" som action',
          'Klik "Tilføj regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'Dørkontakt er aktiveret (Opened + Aktiver ændringer)', check: function() { 
            return window.state && window.state.door === true; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (IF Dørkontakt ændres til Opened)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ return r.trigger === 'doorOpened'; }); 
          }},
          { id: 'timer', text: 'Tidsbetingelse tilføjet (AND: Tid mellem 22:00-06:00)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'doorOpened' && r.cond1 === 'timeBetween' && r.cond1Value && r.cond1Value.includes('22:00') && r.cond1Value.includes('06:00'); 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Lys → Tænd)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'doorOpened' && r.action1 === 'lightOn'; 
            }); 
          }}
        ]
      },
      'bathroom': {
        name: 'Badventilator med fugtighed',
        steps: [
          'Gå til "Z-Wave sensorer" sektionen',
          'Vælg "Fugtighed (%)" fra dropdown',
          'Sæt værdi til 75',
          'Klik "Sæt (buffer)"',
          'Klik "Aktivér ændringer"',
          'Gå til "Regler" sektionen',
          'Vælg "IF Fugtighed ≥ (værdi)" som trigger med værdi 75',
          'Tilføj AND: "Lys (lux) <" med værdi 50',
          'Vælg "THEN Ventilator → On" som action',
          'Klik "Tilføj regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'Fugtighed er sat til 75%', check: function() { 
            return window.state && window.state.humidity >= 75; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (IF Fugtighed ≥ 75)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityAbove' && r.triggerValue && parseFloat(r.triggerValue) >= 75; 
            }); 
          }},
          { id: 'condition', text: 'Betingelse tilføjet (AND: Lys (lux) < 50)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityAbove' && r.cond1 === 'luxBelow' && r.cond1Value && parseFloat(r.cond1Value) <= 50; 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Ventilator → On)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityAbove' && r.action1 === 'fanOn'; 
            }); 
          }}
        ]
      },
      'security': {
        name: 'Sikkerhedsalarm',
        steps: [
          'Gå til "Z-Wave sensorer" sektionen',
          'Vælg "PIR (bevægelse)" fra dropdown og sæt til "Breached"',
          'Vælg "Dør-/vindueskontakt" fra dropdown og sæt til "Closed"',
          'Klik "Sæt (buffer)" for begge sensorer',
          'Klik "Aktivér ændringer"',
          'Gå til "Regler" sektionen',
          'Vælg "IF PIR bliver Breached" som trigger',
          'Tilføj AND: "Dørkontakt = Closed"',
          'Tilføj AND: "Tid mellem" med "22:00-06:00"',
          'Vælg "THEN Push (log)" som action',
          'Klik "Tilføj regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'PIR er Breached og dørkontakt er Closed', check: function() { 
            return window.state && window.state.motion === true && window.state.door === false; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (IF PIR bliver Breached)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ return r.trigger === 'motionBreached'; }); 
          }},
          { id: 'condition1', text: 'Betingelse 1 tilføjet (AND: Dørkontakt = Closed)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'motionBreached' && r.cond1 === 'doorClosed'; 
            }); 
          }},
          { id: 'condition2', text: 'Betingelse 2 tilføjet (AND: Tid mellem 22:00-06:00)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'motionBreached' && r.cond2 === 'timeBetween' && r.cond2Value && r.cond2Value.includes('22:00') && r.cond2Value.includes('06:00'); 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Push log)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'motionBreached' && r.action1 === 'push'; 
            }); 
          }}
        ]
      },
      'energy': {
        name: 'Energibesparende lys',
        steps: [
          'Gå til "Z-Wave sensorer" sektionen',
          'Vælg "PIR (bevægelse)" fra dropdown og sæt til "Safe"',
          'Vælg "Lys (lux)" fra dropdown og sæt til 800',
          'Klik "Sæt (buffer)" for begge sensorer',
          'Klik "Aktivér ændringer"',
          'Gå til "Regler" sektionen',
          'Vælg "IF PIR bliver Safe" som trigger',
          'Tilføj AND: "Lys (lux) >" med værdi 500',
          'Tilføj AND: "Tid mellem" med "08:00-18:00"',
          'Vælg "THEN Lys → Off" som action',
          'Klik "Tilføj regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'PIR er Safe og lys er 800 lux', check: function() { 
            return window.state && window.state.motion === false && window.state.lux >= 800; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (IF PIR bliver Safe)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ return r.trigger === 'motionSafe'; }); 
          }},
          { id: 'condition1', text: 'Betingelse 1 tilføjet (AND: Lys (lux) > 500)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'motionSafe' && r.cond1 === 'luxAbove' && r.cond1Value && parseFloat(r.cond1Value) >= 500; 
            }); 
          }},
          { id: 'condition2', text: 'Betingelse 2 tilføjet (AND: Tid mellem 08:00-18:00)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'motionSafe' && r.cond2 === 'timeBetween' && r.cond2Value && r.cond2Value.includes('08:00') && r.cond2Value.includes('18:00'); 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Lys → Off)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'motionSafe' && r.action1 === 'lightOff'; 
            }); 
          }}
        ]
      },
      'comfort': {
        name: 'Komfortstyring',
        steps: [
          'Gå til "Z-Wave sensorer" sektionen',
          'Vælg "Fugtighed (%)" fra dropdown og sæt til 40',
          'Vælg "Lys (lux)" fra dropdown og sæt til 200',
          'Klik "Sæt (buffer)" for begge sensorer',
          'Klik "Aktivér ændringer"',
          'Gå til "Regler" sektionen',
          'Vælg "IF Fugtighed < (værdi)" som trigger med værdi 45',
          'Tilføj AND: "Lys (lux) <" med værdi 300',
          'Vælg "THEN Dæmper → 30%" som action',
          'Klik "Tilføj regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'Fugtighed er 40% og lys er 200 lux', check: function() { 
            return window.state && window.state.humidity <= 40 && window.state.lux <= 200; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (IF Fugtighed < 45)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityBelow' && r.triggerValue && parseFloat(r.triggerValue) <= 45; 
            }); 
          }},
          { id: 'condition', text: 'Betingelse tilføjet (AND: Lys (lux) < 300)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityBelow' && r.cond1 === 'luxBelow' && r.cond1Value && parseFloat(r.cond1Value) <= 300; 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Dæmper → 30%)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityBelow' && r.action1 === 'dim30'; 
            }); 
          }}
        ]
      },
      'schedule': {
        name: 'Tidsbaseret automation',
        steps: [
          'Gå til "Regler" sektionen',
          'Vælg "IF Time = hh:mm" som trigger med værdi "07:00"',
          'Tilføj AND: "Ugedag i" med værdi "1-5" (mandag-fredag)',
          'Vælg "THEN Lys → Tænd" som action',
          'Klik "Tilføj regel"'
        ],
        criteria: [
          { id: 'trigger', text: 'Trigger er korrekt (IF Time = 07:00)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'timeEquals' && r.triggerValue === '07:00'; 
            }); 
          }},
          { id: 'condition', text: 'Betingelse tilføjet (AND: Ugedag i 1-5)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'timeEquals' && r.cond1 === 'weekdayIn' && r.cond1Value === '1-5'; 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Lys → Tænd)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'timeEquals' && r.action1 === 'lightOn'; 
            }); 
          }}
        ]
      },
      'ventilation': {
        name: 'Intelligent ventilation',
        steps: [
          'Gå til "Z-Wave sensorer" sektionen',
          'Vælg "Fugtighed (%)" fra dropdown og sæt til 80',
          'Vælg "Vind (m/s)" fra dropdown og sæt til 15',
          'Klik "Sæt (buffer)" for begge sensorer',
          'Klik "Aktivér ændringer"',
          'Gå til "Regler" sektionen',
          'Vælg "IF Fugtighed ≥ (værdi)" som trigger med værdi 70',
          'Tilføj AND: "Vind <" med værdi 20',
          'Vælg "THEN Ventilator → On" som action',
          'Klik "Tilføj regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'Fugtighed er 80% og vind er 15 km/t', check: function() { 
            return window.state && window.state.humidity >= 80 && window.state.wind <= 15; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (IF Fugtighed ≥ 70)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityAbove' && r.triggerValue && parseFloat(r.triggerValue) >= 70; 
            }); 
          }},
          { id: 'condition', text: 'Betingelse tilføjet (AND: Vind < 20)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityAbove' && r.cond1 === 'windBelow' && r.cond1Value && parseFloat(r.cond1Value) <= 20; 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Ventilator → On)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityAbove' && r.action1 === 'fanOn'; 
            }); 
          }}
        ]
      },
      'alarm': {
        name: 'Alarm system',
        steps: [
          'Gå til "Z-Wave sensorer" sektionen',
          'Vælg "Dør-/vindueskontakt" fra dropdown og sæt til "Opened"',
          'Vælg "PIR (bevægelse)" fra dropdown og sæt til "Breached"',
          'Klik "Sæt (buffer)" for begge sensorer',
          'Klik "Aktivér ændringer"',
          'Gå til "Regler" sektionen',
          'Vælg "IF Dørkontakt ændres til Opened" som trigger',
          'Tilføj AND: "PIR = Breached"',
          'Tilføj AND: "Alarm = Armed"',
          'Vælg "THEN Push (log)" som action',
          'Klik "Tilføj regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'Dørkontakt er Opened og PIR er Breached', check: function() { 
            return window.state && window.state.door === true && window.state.motion === true; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (IF Dørkontakt ændres til Opened)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ return r.trigger === 'doorOpened'; }); 
          }},
          { id: 'condition1', text: 'Betingelse 1 tilføjet (AND: PIR = Breached)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'doorOpened' && r.cond1 === 'motionBreached'; 
            }); 
          }},
          { id: 'condition2', text: 'Betingelse 2 tilføjet (AND: Alarm = Armed)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'doorOpened' && r.cond2 === 'alarmArmed'; 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Push log)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'doorOpened' && r.action1 === 'push'; 
            }); 
          }}
        ]
      },
      'global': {
        name: 'Global variabel styring',
        steps: [
          'Gå til "Regler" sektionen',
          'Vælg "IF Global name=value" som trigger med værdi "mode=away"',
          'Vælg "THEN Set Global" som action med værdi "lights=off"',
          'Klik "Tilføj regel"'
        ],
        criteria: [
          { id: 'trigger', text: 'Trigger er korrekt (IF Global mode=away)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'globalEqTrig' && r.triggerValue === 'mode=away'; 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Set Global lights=off)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'globalEqTrig' && r.action1 === 'setGlobal' && r.action1Value === 'lights=off'; 
            }); 
          }}
        ]
      }
    };

        function showTaskDetails(taskType) {
      // Skjul oversigten
      document.querySelector('.task-cards').parentElement.parentElement.style.display = 'none';
      
      // Vis detaljerne
      document.getElementById('task-details').style.display = 'block';
      
      // Find opgave indholdet
      var taskElement = document.getElementById('task-' + taskType);
      if (taskElement) {
        var title = taskElement.querySelector('h3').textContent;
        
        // Fjern trinene fra indholdet - kun vis case beskrivelse og læringsmål
        var caseDescription = taskElement.querySelector('.case-description');
        var learningGoal = taskElement.querySelector('.case-description p:last-child');
        
        var content = '';
        if (caseDescription) {
          content += caseDescription.outerHTML;
        }
        if (learningGoal) {
          content += '<div class="learning-goal" style="margin-top: 20px; padding: 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px;">';
          content += '<h4 style="color: #3b82f6; margin: 0 0 8px 0;">🎯 Læringsmål</h4>';
          content += learningGoal.outerHTML;
          content += '</div>';
        }
        
        document.getElementById('task-details-title').textContent = title;
        document.getElementById('task-details-content').innerHTML = content;
        
        // Vis beskrivelse uden at starte opgaven
        
        // Sæt event listener på start-knappen
        document.getElementById('btnStartTask').onclick = function() {
          startTask(taskType);
        };
      }
    }
    
    function hideTaskDetails() {
      // Vis oversigten igen
      document.querySelector('.task-cards').parentElement.parentElement.style.display = 'block';
      
      // Skjul detaljerne
      document.getElementById('task-details').style.display = 'none';
    }
    
    function startTask(taskType) {

        activeTask = taskType;
      
      // Show task validation panel
      showTaskValidation(taskType);
      
      // Switch to simulator view to start the task
      document.querySelector('[data-target="view-sim"]').click();
      
      log('Opgave startet: ' + taskCriteria[taskType].name + ' - Følg trinene i valideringspanelet!');
    }



    function showTaskValidation(taskType) {
      var task = taskCriteria[taskType];
      if (!task) return;

      var validationEl = document.getElementById('taskValidation');
      var nameEl = document.getElementById('taskName');
      var criteriaEl = document.getElementById('taskCriteria');
      
      // Reset state
      validationEl.classList.remove('success');
      validationEl.classList.add('active');
      document.getElementById('taskProgress').style.display = 'block';
      document.getElementById('taskSuccess').style.display = 'none';
      
      // Set task name
      nameEl.textContent = task.name;
      
      // Build criteria list
      criteriaEl.innerHTML = '';
      task.criteria.forEach(function(criterion) {
        var li = document.createElement('li');
        li.id = 'criterion-' + criterion.id;
        li.textContent = criterion.text;
        criteriaEl.appendChild(li);
      });
      
      // Build steps list
      var stepsEl = document.getElementById('taskSteps');
      stepsEl.innerHTML = '';
      if (task.steps) {
        task.steps.forEach(function(step) {
          var li = document.createElement('li');
          li.textContent = step;
          stepsEl.appendChild(li);
        });
      }
      
      // Show panel
      validationEl.style.display = 'block';
      
      // Load help preference
      loadHelpPreference();
      
      // Start validation loop
      if (window.taskValidationInterval) {
        clearInterval(window.taskValidationInterval);
      }
      window.taskValidationInterval = setInterval(validateTask, 500);
    }

    function validateTask() {
      if (!activeTask) return;
      
      var task = taskCriteria[activeTask];
      if (!task) return;
      
      var completed = 0;
      var total = task.criteria.length;
      
      task.criteria.forEach(function(criterion) {
        var li = document.getElementById('criterion-' + criterion.id);
        if (criterion.check()) {
          li.classList.add('completed');
          completed++;
        } else {
          li.classList.remove('completed');
        }
      });
      
      // Update progress bar
      var progress = (completed / total) * 100;
      document.getElementById('taskProgressBar').style.width = progress + '%';
      
      // Check if task is complete
      if (completed === total) {
        completeTask();
      }
    }

    function completeTask() {
      var validationEl = document.getElementById('taskValidation');
      validationEl.classList.remove('active');
      validationEl.classList.add('success');
      
      document.getElementById('taskProgress').style.display = 'none';
      document.getElementById('taskSuccess').style.display = 'block';
      
      // Stop validation loop
      if (window.taskValidationInterval) {
        clearInterval(window.taskValidationInterval);
      }
      
      // Log success
      log('🎉 Opgave fuldført: ' + taskCriteria[activeTask].name + '!');
      
      // Store completion in localStorage
      var completedTasks = JSON.parse(localStorage.getItem('completed_tasks') || '[]');
      if (!completedTasks.includes(activeTask)) {
        completedTasks.push(activeTask);
        localStorage.setItem('completed_tasks', JSON.stringify(completedTasks));
      }
      
      console.log('Opgave fuldført:', taskCriteria[activeTask].name);
      
      // Gem progress i cloud database
      console.log('🔍 Forsøger at gemme progress...');
      const currentUser = getCurrentUser();
      console.log('🔍 Current user:', currentUser);
      
      if (currentUser) {
        console.log('🔍 Bruger fundet, kalder saveUserProgress...');
        const completedAt = new Date().toLocaleDateString('da-DK') + ' ' + new Date().toLocaleTimeString('da-DK');
        
        // currentUser er nu et objekt med .id property
        console.log('🔍 Data til Firebase:', { userId: currentUser.id, taskId: activeTask, taskName: taskCriteria[activeTask].name, completedAt });
        saveUserProgress(currentUser.id, activeTask, taskCriteria[activeTask].name, completedAt, currentUser);
      } else {
        console.log('❌ Ingen bruger fundet - kan ikke gemme progress');
      }
      
      // Opdater tema tilgængelighed efter opgave fuldførelse
      updateThemeAvailability();
    }

    function closeTaskValidation() {
      document.getElementById('taskValidation').style.display = 'none';
      if (window.taskValidationInterval) {
        clearInterval(window.taskValidationInterval);
      }
      activeTask = null;
    }

    // Toggle help steps visibility
    var helpVisible = false;
    function toggleTaskHelp() {
      helpVisible = !helpVisible;
      var stepsEl = document.getElementById('taskSteps').parentNode;
      var toggleBtn = document.querySelector('.help-toggle-btn');
      
      if (helpVisible) {
        stepsEl.style.display = 'block';
        toggleBtn.classList.add('active');
        toggleBtn.title = 'Skjul hjælp-trin';
      } else {
        stepsEl.style.display = 'none';
        toggleBtn.classList.remove('active');
        toggleBtn.title = 'Vis hjælp-trin';
      }
      
      // Gem præference
      localStorage.setItem('task_help_visible', helpVisible);
    }

    // Indlæs gemt præference
    function loadHelpPreference() {
      var saved = localStorage.getItem('task_help_visible');
      if (saved !== null) {
        // Brug gemt præference
        helpVisible = saved === 'true';
      } else {
        // Standard: hjælp er skjult
        helpVisible = false;
      }
      
      // Juster UI til aktuel tilstand
      var stepsEl = document.getElementById('taskSteps').parentNode;
      var toggleBtn = document.querySelector('.help-toggle-btn');
      
      if (helpVisible) {
        stepsEl.style.display = 'block';
        toggleBtn.classList.add('active');
        toggleBtn.title = 'Skjul hjælp-trin';
      } else {
        stepsEl.style.display = 'none';
        toggleBtn.classList.remove('active');
        toggleBtn.title = 'Vis hjælp-trin';
      }
    }

    // Make functions globally available
    window.skipOnboarding = skipOnboarding;
    window.startOnboarding = startOnboarding;
    window.nextOnboardingStep = nextOnboardingStep;
    window.pauseOnboarding = pauseOnboarding;
    
    window.showTaskDetails = showTaskDetails;
    window.hideTaskDetails = hideTaskDetails;
    window.startTask = startTask;
    window.closeTaskValidation = closeTaskValidation;
    window.toggleTaskHelp = toggleTaskHelp;
    
    // Make variables globally available
    window.activeTask = activeTask;
    window.taskCriteria = taskCriteria;
    window.getCurrentUser = getCurrentUser;

    // Check if first time user
    if (!localStorage.getItem('smarthome_simulator.onboarding_completed')) {
      setTimeout(function() {
        document.getElementById('onboardingWelcome').style.display = 'block';
      }, 1000);
    }
  })();


  // === WIRESHEET MVP ===
  (function(){
    var canvas = document.getElementById('wsCanvas');
    if(!canvas) return; // not on this page
    var svg = document.getElementById('wsWires');
    var nodesHost = document.getElementById('wsNodes');

    var WS = {
      seq: 1,
      nodes: {}, // id -> {id,type,subtype,value,x,y,label}
      edges: [],  // {from, to, toPort}
      counters: {trig:1, cond:1, act:1, rule:1},
      // Undo/Redo system
      history: [],
      historyIndex: -1,
      maxHistory: 20,
      // Copy/Paste system
      clipboard: null
    };
    function nid(){ return 'n'+(WS.seq++); }

    // --- Helpers
    function createEl(tag, attrs, parent){
      var el = document.createElement(tag);
      if(attrs){ Object.keys(attrs).forEach(function(k){ if(k==='class'){ el.className=attrs[k]; } else if(k==='text'){ el.textContent=attrs[k]; } else { el.setAttribute(k, attrs[k]); } }); }
      if(parent) parent.appendChild(el);
      return el;
    }
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    // Options
    var TRIG_OPTS = [
      ['always','Ved aktivering'],
      // Bevægelsessensorer
      ['entranceMotion','🚪 Entré bevægelse'],
      ['livingMotion','🛋️ Stue bevægelse'],
      ['kitchenMotion','🍳 Køkken bevægelse'],
      // Døre og vinduer
      ['frontDoorOpened','🔐 Hoveddør åbnet'],
      ['frontDoorClosed','🔐 Hoveddør lukket'],
      ['bedroomWindowOpened','🪟 Soveværelse vindue åbnet'],
      ['balconyDoorOpened','🪟 Balkondør åbnet'],
      // Sensorer
      ['humidityAbove','💧 Fugtighed over'],
      ['humidityBelow','💧 Fugtighed under'],
      ['tempAbove','🌡️ Temperatur over'],
      ['tempBelow','🌡️ Temperatur under'],
      ['smokeDetected','💨 Røg detekteret'],
      // Lys tilstand
      ['bedroomLightOn','💡 Soveværelse lys tændt'],
      ['livingLightOn','💡 Stue lys tændt'],
      ['kitchenLightOn','💡 Køkken lys tændt'],
      ['anyLightOn','💡 Et lys tændt'],
      ['allLightsOff','💡 Alle lys slukket'],
      // Tid
      ['timeEquals','🕐 Tid = hh:mm'],
      ['timeBetween','🕐 Tid mellem'],
      // Alarm system
      ['alarmActivated','🚨 Alarm aktiveret'],
      ['alarmDeactivated','🚨 Alarm deaktiveret'],
      // Generic
      ['globalEqTrig','Global name=value'],
      ['sensorEqTrig','Sensor =='],
      ['sensorGtTrig','Sensor >'],
      ['sensorLtTrig','Sensor <'],
      ['sensorGeTrig','Sensor ≥'],
      ['sensorLeTrig','Sensor ≤']
    ];
    var COND_OPTS = [
      ['','(ingen)'],
      ['luxBelow','Lys <'],['luxAbove','Lys >'],
      ['humAbove','Fugt ≥'],['humBelow','Fugt ≤'],
      ['windBelow','Vind <'],['weekdayIn','Ugedag i'],
      ['alarmArmed','Alarm = Armed'],['alarmHome','Home Mode'],
              ['globalEq','Global name=value'],
      ['sensorEq','Sensor =='],['sensorNe','Sensor ≠'],
      ['sensorGt','Sensor >'],['sensorLt','Sensor <'],
      ['sensorGe','Sensor ≥'],['sensorLe','Sensor ≤'],
      ['sensorContains','Sensor contains'],['timeBetween','Tid mellem']
    ];
    var ACT_OPTS = [
      // Individuelle lamper
      ['bedroomLightOn','💡 Soveværelse lys → Tænd'],
      ['bedroomLightOff','💡 Soveværelse lys → Sluk'],
      ['livingLightOn','💡 Stue lys → Tænd'],
      ['livingLightOff','💡 Stue lys → Sluk'],
      ['diningLightOn','💡 Spisebord lys → Tænd'],
      ['diningLightOff','💡 Spisebord lys → Sluk'],
      ['kitchenLightOn','💡 Køkken lys → Tænd'],
      ['kitchenLightOff','💡 Køkken lys → Sluk'],
      ['bathroomLightOn','💡 Badeværelse lys → Tænd'],
      ['bathroomLightOff','💡 Badeværelse lys → Sluk'],
      // Alle lys
      ['allLightsOn','💡 Alle lys → Tænd'],
      ['allLightsOff','💡 Alle lys → Sluk'],
      // Dæmpere
      ['bedroomDim30','🔅 Soveværelse → 30%'],
      ['bedroomDim100','🔆 Soveværelse → 100%'],
      ['livingDim30','🔅 Stue → 30%'],
      ['livingDim100','🔆 Stue → 100%'],
      // Ventilation
      ['ventilationOn','🌪️ Ventilation → Tænd'],
      ['ventilationOff','🌪️ Ventilation → Sluk'],
      // Dørlås
      ['frontDoorLock','🔐 Hoveddør → Lås'],
      ['frontDoorUnlock','🔐 Hoveddør → Lås op'],
      ['autoLockOn','🔐 Auto-lås → Tænd'],
      ['autoLockOff','🔐 Auto-lås → Sluk'],
      // Alarm system
      ['alarmOn','🚨 Alarm → Aktiver'],
      ['alarmOff','🚨 Alarm → Deaktiver'],
      // Temperatur
      ['tempUp','🌡️ Temperatur → Op (+2°)'],
      ['tempDown','🌡️ Temperatur → Ned (-2°)'],
      ['setTemp5','🌡️ Sæt temperatur → 5° (frysning)'],
      ['setTemp10','🌡️ Sæt temperatur → 10° (koldt)'],
      ['setTemp18','🌡️ Sæt temperatur → 18° (køligt)'],
      ['setTemp21','🌡️ Sæt temperatur → 21° (normalt)'],
      ['setTemp24','🌡️ Sæt temperatur → 24° (varmt)'],
      ['setTemp30','🌡️ Sæt temperatur → 30° (meget varmt)'],
      ['setTemp35','🌡️ Sæt temperatur → 35° (ekstremt varmt)'],
      // Scenarier
      ['scenarioGoodMorning','🌅 Scenarie → God Morgen'],
      ['scenarioLeavingHome','🚗 Scenarie → Forlader Hjem'],
      ['scenarioGoodNight','🌙 Scenarie → God Nat'],
      ['scenarioComingHome','🏠 Scenarie → Kommer Hjem'],
      // Master kontrol
      ['automationOn','🤖 Automation → Tænd'],
      ['automationOff','🤖 Automation → Sluk'],
      // Notifikationer og logs
      ['push','📢 Push (log)'],
      ['pushSecurity','🚨 Sikkerhedsalarm'],
      ['pushWeather','🌤️ Vejr notifikation'],
      // Generic
      ['setGlobal','Set Global'],
      ['delayLightOff','Delay→LightOff'],
      // Legacy (bagudkompatibilitet)
      ['lightOn','Lys → On'],
      ['lightOff','Lys → Off'],
      ['fanOn','Fan → On'],
      ['fanOff','Fan → Off']
    ];
    function phTrigger(k){
      return {'always':'','timeEquals':'hh:mm (07:30)','humidityAbove':'tal (65)','humidityBelow':'tal (40)',
        'tempAbove':'grader (25)','tempBelow':'grader (18)',
        'globalEqTrig':'navn=værdi','sensorEqTrig':'sensor.xx=val',
        'sensorGtTrig':'sensor.xx=21','sensorLtTrig':'sensor.xx=21','sensorGeTrig':'sensor.xx=21','sensorLeTrig':'sensor.xx=21'}[k]||'';
    }
    function phCond(k){
      return {'luxBelow':'tal','luxAbove':'tal','humAbove':'procent','humBelow':'procent','windBelow':'tal',
        'weekdayIn':'Mon,Fri','globalEq':'name=value','sensorEq':'name=value','sensorNe':'name=value',
        'sensorGt':'name=tal','sensorLt':'name=tal','sensorGe':'name=tal','sensorLe':'name=tal',
        'sensorContains':'name=del','timeBetween':'HH:MM-HH:MM'}[k]||'';
    }
    function phAct(k){
      return {'push':'besked','setGlobal':'name=value','delayLightOff':'sekunder'}[k]||'';
    }

    // --- Rendering
    function renderAll(){
      nodesHost.innerHTML='';
      Object.values(WS.nodes).forEach(renderNode);
      renderWires();
      updateLinkLabels();
    }
    function renderNode(n){
      var box = createEl('div', {class:'ws-node '+(n.type==='trig'?'trig':n.type==='cond'?'cond':n.type==='act'?'act':'rule')}, nodesHost);
      box.style.left = (n.x||40)+'px';
      box.style.top  = (n.y||40)+'px';
      box.dataset.id = n.id;

      var head = createEl('div',{class:'ws-head'},box);
      var idEl = createEl('div',{class:'ws-id',text:(n.label||'')},head);
      createEl('div',{class:'type',text:
        n.type==='trig'?'Trigger': n.type==='cond'?'AND': n.type==='act'?'Action':'Rule'
      },head);
      var moveBtn = createEl('button',{class:'ws-btn',text:'Flyt'},head);
      var delBtn  = createEl('button',{class:'ws-btn',text:'Slet'},head);

      var body = createEl('div',{class:'ws-body'},box);
      if(n.type!=='rule'){
        var s = createEl('select',{},body);
        var opts = n.type==='trig'?TRIG_OPTS: n.type==='cond'?COND_OPTS: ACT_OPTS;
        opts.forEach(function(p){ var o=createEl('option',{value:p[0],text:p[1]}); s.appendChild(o); });
        if(n.subtype){ s.value=n.subtype; }
        s.onchange = function(){ n.subtype = this.value; v.placeholder = n.type==='trig'?phTrigger(n.subtype): n.type==='cond'?phCond(n.subtype): phAct(n.subtype); preview(); };

        var v = createEl('input',{type:'text', value:(n.value||''), placeholder: n.type==='trig'?phTrigger(n.subtype): n.type==='cond'?phCond(n.subtype): phAct(n.subtype)}, body);
        v.oninput = function(){ n.value=this.value; preview(); };
      } else {
        // Rule node: input ports summary + preview
        createEl('div',{class:'port-row'}, body).innerHTML = '<span class="port in" data-slot="trigger" title="Trigger in"></span><span class="port-label">Trigger</span>';
        createEl('div',{class:'port-row'}, body).innerHTML = '<span class="port in" data-slot="cond1" title="AND #1 in"></span><span class="port-label">AND #1</span>';
        createEl('div',{class:'port-row'}, body).innerHTML = '<span class="port in" data-slot="cond2" title="AND #2 in"></span><span class="port-label">AND #2</span>';
        createEl('div',{class:'port-row'}, body).innerHTML = '<span class="port in" data-slot="actions" title="Actions in (flere tilladt)"></span><span class="port-label">Actions</span>';
        var name = createEl('input',{type:'text', placeholder:'Regelnavn (valgfri)', value:(n.value||'')}, body);
        name.oninput = function(){ n.value = this.value; preview(); };
        var pv = createEl('div',{class:'ws-preview'}, body); pv.dataset.previewFor=n.id;
      }
      var foot = createEl('div',{class:'ws-foot'},box);
      if(n.type!=='rule'){ createEl('div',{class:'port out',title:'Output (klik for at starte forbindelse)'}, foot); }
      var linkInfo = createEl('div',{class:'ws-links'}, box);
      // events
      delBtn.onclick = function(){
        // remove node + edges
        // Save state before deleting
        saveState();
        
        delete WS.nodes[n.id];
        WS.edges = WS.edges.filter(function(e){ return e.from!==n.id && e.to!==n.id; });
        renderAll(); updateLinkLabels();
      };
      // drag
      (function(){
        var dragging=false, sx=0, sy=0, bx=0, by=0;
        function mdown(ev){
          dragging=true; box.classList.add('dragging');
          sx=ev.clientX; sy=ev.clientY;
          bx=parseInt(box.style.left,10)||0; by=parseInt(box.style.top,10)||0;
          document.addEventListener('mousemove', mmove);
          document.addEventListener('mouseup', mup);
          ev.preventDefault();
        }
        function mmove(ev){
          if(!dragging) return;
          var nx = bx + (ev.clientX - sx);
          var ny = by + (ev.clientY - sy);
          nx = clamp(nx, 0, canvas.clientWidth - box.offsetWidth);
          ny = clamp(ny, 0, canvas.clientHeight - box.offsetHeight);
          box.style.left = nx+'px';
          box.style.top  = ny+'px';
          n.x = nx; n.y = ny;
          renderWires();
        }
        function mup(){
          dragging=false; box.classList.remove('dragging');
          document.removeEventListener('mousemove', mmove);
          document.removeEventListener('mouseup', mup);
          
          // Save state after moving node
          saveState();
        }
        moveBtn.addEventListener('mousedown', mdown);
        head.addEventListener('mousedown', function(e){ if(e.target===head) mdown(e); });
      })();

      // linking
      if(n.type!=='rule'){
        var out = foot.querySelector('.port.out');
        out.addEventListener('click', function(){
          linking.from = n.id;
          linking.active = true;
          window.log('Wires: vælg en Rule-in port for at forbinde.');
        });
      } else {
        body.querySelectorAll('.port.in').forEach(function(pin){
          pin.addEventListener('click', function(){
            if(!linking.active || !linking.from) return;
            var toPort = pin.getAttribute('data-slot')||'';
            if(!allowEdge(linking.from, n.id, toPort)) { window.log('Ugyldig forbindelse.'); return; }
            // enforce capacity on trigger/cond1/cond2 (1 each)
            if(['trigger','cond1','cond2'].includes(toPort)){
              // Save state before removing connection
              saveState();
              
              WS.edges = WS.edges.filter(function(e){ return !(e.to===n.id && e.toPort===toPort); });
            }
            WS.edges.push({from: linking.from, to: n.id, toPort: toPort});
            linking.active=false; linking.from=null;
            
            // Save state for undo after creating connection
            saveState();
            
            renderWires(); updateLinkLabels(); preview();
          });
        });
      }
    }

    function getPortCenter(nodeId, portSel){
      var card = nodesHost.querySelector('.ws-node[data-id="'+nodeId+'"]');
      if(!card) return {x:0,y:0};
      var el = portSel==='out' ? card.querySelector('.port.out') : card.querySelector('.port.in[data-slot="'+portSel+'"]');
      if(!el) return {x:0,y:0};
      var r1 = canvas.getBoundingClientRect();
      var r2 = el.getBoundingClientRect();
      return { x: r2.left - r1.left + r2.width/2, y: r2.top - r1.top + r2.height/2 };
    }
    
    function updateLinkLabels(){
      // For each node, compute link text
      Object.values(WS.nodes).forEach(function(n){
        var card = nodesHost.querySelector('.ws-node[data-id="'+n.id+'"]');
        if(!card) return;
        var footInfo = card.querySelector('.ws-links');
        if(!footInfo) return;
        function lbl(nodeId){
          var nn = WS.nodes[nodeId]; return nn ? (nn.label||nodeId) : nodeId;
        }
        if(n.type!=='rule'){
          var outs = WS.edges.filter(function(e){ return e.from===n.id; });
          if(outs.length===0){ footInfo.textContent = 'Ikke linket'; return; }
          var parts = outs.map(function(e){ return '→ '+lbl(e.to)+' ('+e.toPort+')'; });
          footInfo.textContent = parts.join('  •  ');
        } else {
          // incoming per port
          var t = WS.edges.filter(function(e){ return e.to===n.id && e.toPort==='trigger'; }).map(function(e){return lbl(e.from);}).join(',');
          var c1= WS.edges.filter(function(e){ return e.to===n.id && e.toPort==='cond1'; }).map(function(e){return lbl(e.from);}).join(',');
          var c2= WS.edges.filter(function(e){ return e.to===n.id && e.toPort==='cond2'; }).map(function(e){return lbl(e.from);}).join(',');
          var a = WS.edges.filter(function(e){ return e.to===n.id && e.toPort==='actions'; }).map(function(e){return lbl(e.from);}).join(',');
          footInfo.textContent = 'Trigger: '+(t||'—')+'   •   AND #1: '+(c1||'—')+'   •   AND #2: '+(c2||'—')+'   •   Actions: '+(a||'—');
        }
      });
    }
    function renderWires(){
      svg.innerHTML='';
      WS.edges.forEach(function(e, index){
        var a = getPortCenter(e.from, 'out');
        var b = getPortCenter(e.to, e.toPort);
        var path = createEl('path', { 
          d: cubic(a.x,a.y,b.x,b.y), 
          fill:'none', 
          stroke:'#4f7db8', 
          'stroke-width':'2', 
          'stroke-linecap':'round',
          'data-edge-index': index,
          'cursor': 'pointer'
        }, svg);
        
        // Add click handler to remove wire
        path.addEventListener('click', function(){
          if(confirm('Fjern denne forbindelse?')){
            // Save state before removing
            saveState();
            
            // Remove the edge
            WS.edges.splice(index, 1);
            renderWires();
            updateLinkLabels();
            preview();
            window.log('Forbindelse fjernet');
          }
        });
      });
    }
    function cubic(x1,y1,x2,y2){
      var dx = Math.max(40, Math.abs(x2-x1)/2);
      var c1x = x1 + dx, c1y = y1;
      var c2x = x2 - dx, c2y = y2;
      return 'M '+x1+' '+y1+' C '+c1x+' '+c1y+', '+c2x+' '+c2y+', '+x2+' '+y2;
    }

    var linking = {active:false, from:null};

    function allowEdge(fromId, toId, toPort){
      if(fromId===toId) return false;
      var src = WS.nodes[fromId], dst = WS.nodes[toId];
      if(!src || !dst) return false;
      if(dst.type!=='rule') return false; // only into rule nodes
      if(src.type==='trig' && toPort!=='trigger') return false;
      if(src.type==='cond' && !['cond1','cond2'].includes(toPort)) return false;
      if(src.type==='act'  && toPort!=='actions') return false;
      return true;
    }

    // --- History management
    function saveState() {
      // Remove any states after current index
      WS.history = WS.history.slice(0, WS.historyIndex + 1);
      
      // Save current state
      var state = {
        nodes: JSON.parse(JSON.stringify(WS.nodes)),
        edges: JSON.parse(JSON.stringify(WS.edges)),
        seq: WS.seq
      };
      
      WS.history.push(state);
      WS.historyIndex++;
      
      // Limit history size
      if (WS.history.length > WS.maxHistory) {
        WS.history.shift();
        WS.historyIndex--;
      }
      
      // Update button states
      updateUndoRedoButtons();
    }
    
    function updateUndoRedoButtons() {
      var undoBtn = document.getElementById('wsUndo');
      var redoBtn = document.getElementById('wsRedo');
      
      if (undoBtn) undoBtn.disabled = WS.historyIndex <= 0;
      if (redoBtn) redoBtn.disabled = WS.historyIndex >= WS.history.length - 1;
    }
    
    function undo() {
      if (WS.historyIndex > 0) {
        WS.historyIndex--;
        var state = WS.history[WS.historyIndex];
        WS.nodes = JSON.parse(JSON.stringify(state.nodes));
        WS.edges = JSON.parse(JSON.stringify(state.edges));
        WS.seq = state.seq;
        renderAll();
        updateLinkLabels();
        updateUndoRedoButtons();
        window.log('Undo: Gendannet tidligere tilstand');
      }
    }
    
    function redo() {
      if (WS.historyIndex < WS.history.length - 1) {
        WS.historyIndex++;
        var state = WS.history[WS.historyIndex];
        WS.nodes = JSON.parse(JSON.stringify(state.nodes));
        WS.edges = JSON.parse(JSON.stringify(state.edges));
        WS.seq = state.seq;
        renderAll();
        updateLinkLabels();
        updateUndoRedoButtons();
        window.log('Redo: Gendannet senere tilstand');
      }
    }
    
    // --- Copy/Paste system
    function copySelected() {
      // For now, copy all nodes and edges (can be enhanced to copy only selected)
      var data = {
        nodes: JSON.parse(JSON.stringify(WS.nodes)),
        edges: JSON.parse(JSON.stringify(WS.edges))
      };
      WS.clipboard = data;
      window.log('Kopieret wiresheet til clipboard');
    }
    
    function paste() {
      if (!WS.clipboard) {
        window.log('Intet at indsætte - kopier først noget');
        return;
      }
      
      // Save current state before pasting
      saveState();
      
      // Offset pasted nodes to avoid overlap
      var offsetX = 50;
      var offsetY = 50;
      
      var newNodes = {};
      var nodeIdMap = {};
      
      // Create new nodes with offset
      Object.keys(WS.clipboard.nodes).forEach(function(oldId) {
        var oldNode = WS.clipboard.nodes[oldId];
        var newNode = JSON.parse(JSON.stringify(oldNode));
        newNode.id = nid();
        newNode.x += offsetX;
        newNode.y += offsetY;
        newNodes[newNode.id] = newNode;
        nodeIdMap[oldId] = newNode.id;
      });
      
      // Create new edges with updated IDs
      var newEdges = WS.clipboard.edges.map(function(edge) {
        return {
          from: nodeIdMap[edge.from] || edge.from,
          to: nodeIdMap[edge.to] || edge.to,
          toPort: edge.toPort
        };
      });
      
      // Add to current wiresheet
      Object.assign(WS.nodes, newNodes);
      WS.edges = WS.edges.concat(newEdges);
      
      renderAll();
      updateLinkLabels();
      window.log('Indsat wiresheet fra clipboard');
    }
    
    // --- Add nodes
    function addNode(kind, x, y){
      var n = { id:nid(), type:kind, subtype: (kind==='trig'?'always':''), value:'', x:x||40, y:y||40 };
      // assign short label
      var pref = kind==='trig'?'T': kind==='cond'?'C': kind==='act'?'A':'R';
      n.label = pref + (WS.counters[kind]++);
      WS.nodes[n.id]=n;
      
      // Save state for undo
      saveState();
      
      renderAll(); updateLinkLabels();
      return n;
    }

    // Tool buttons
    var bTrig = document.getElementById('wsAddTrig');
    var bCond = document.getElementById('wsAddCond');
    var bAct  = document.getElementById('wsAddAct');
    var bRule = document.getElementById('wsAddRule');
    var bBuild= document.getElementById('wsBuild');
    var bClear= document.getElementById('wsClear');
    var bSave = document.getElementById('wsSave');
    var bLoad = document.getElementById('wsLoad');
    var wsDestination = document.getElementById('wsDestination');
    var wsDestinationStatus = document.getElementById('wsDestinationStatus');
    
    // New tool buttons
    var bUndo = document.getElementById('wsUndo');
    var bRedo = document.getElementById('wsRedo');
    var bCopy = document.getElementById('wsCopy');
    var bPaste = document.getElementById('wsPaste');

    if(bTrig) bTrig.onclick = function(){ addNode('trig', 40, 60); };
    if(bCond) bCond.onclick = function(){ addNode('cond', 40, 180); };
    if(bAct)  bAct.onclick  = function(){ addNode('act',  40, 300); };
    if(bRule) bRule.onclick = function(){ addNode('rule', 520, 160); };

    // Destination selector
    if(wsDestination && wsDestinationStatus) {
      wsDestination.onchange = function() {
        var destination = this.value;
        if(destination === 'home') {
          wsDestinationStatus.textContent = 'Smart Home automation system';
          wsDestinationStatus.style.color = '#10b981';
        } else {
          wsDestinationStatus.textContent = 'Traditionel simulator';
          wsDestinationStatus.style.color = '#9ca3af';
        }
        console.log('📡 Wiresheet destination changed to:', destination);
      };
    }

    if(bClear) bClear.onclick = function(){
      if(!confirm('Ryd alle noder og forbindelser?')) return;
      
      // Save state before clearing
      saveState();
      
      WS.nodes={}; WS.edges=[]; renderAll(); updateLinkLabels(); window.log('Wiresheet ryddet.');
    };

    if(bSave) bSave.onclick = function(){
      try{
        var obj = {version:'1.0', nodes:WS.nodes, edges:WS.edges, seq:WS.seq};
        localStorage.setItem('hc3_wiresheet_v1', JSON.stringify(obj));
        window.log('Wiresheet gemt lokalt.');
      }catch(e){ alert('Kunne ikke gemme: '+e.message); }
    };
    if(bLoad) bLoad.onclick = function(){
      try{
        var raw = localStorage.getItem('hc3_wiresheet_v1');
        if(!raw){ alert('Ingen wiresheet i localStorage.'); return; }
        var obj = JSON.parse(raw||'{}');
        WS.nodes = obj.nodes||{}; WS.edges = obj.edges||[]; WS.seq = obj.seq||1;
        
        // Save state for undo after loading
        saveState();
        
        renderAll(); updateLinkLabels(); preview();
        window.log('Wiresheet hentet.');
      }catch(e){ alert('Kunne ikke læse: '+e.message); }
    };
    
    // New button handlers
    if(bUndo) bUndo.onclick = undo;
    if(bRedo) bRedo.onclick = redo;
    if(bCopy) bCopy.onclick = copySelected;
    if(bPaste) bPaste.onclick = paste;

    // --- Compile to rules
    function nodeById(id){ return WS.nodes[id]; }
    function incoming(toId, port){ return WS.edges.filter(function(e){ return e.to===toId && (!port || e.toPort===port); }); }

    function compileRule(ruleNode){
      // collect trigger
      var trigE = incoming(ruleNode.id,'trigger')[0];
      if(!trigE) return {ok:false, warn:'Mangler trigger'};
      var trigN = nodeById(trigE.from);
      var cond1E = incoming(ruleNode.id,'cond1')[0];
      var cond2E = incoming(ruleNode.id,'cond2')[0];
      var c1 = cond1E? nodeById(cond1E.from): null;
      var c2 = cond2E? nodeById(cond2E.from): null;
      var actsE = incoming(ruleNode.id,'actions');
      if(actsE.length===0) return {ok:false, warn:'Mangler mindst én action'};
      var acts = actsE.map(function(e){ return nodeById(e.from); });

      var base = {
        trigger: trigN.subtype||'always',
        triggerValue: (trigN.value||'').trim(),
        cond1: c1? (c1.subtype||'') : '',
        cond1Value: c1? (c1.value||'') : '',
        cond2: c2? (c2.subtype||'') : '',
        cond2Value: c2? (c2.value||'') : '',
        ruleName: (ruleNode.value||'').trim()
      };
      // Create one rule with all actions
      var rule = Object.assign({}, base);
      
      // Add all actions to the same rule
      acts.forEach(function(a, index) {
        var actionKey = 'action' + (index + 1);
        var valueKey = actionKey + 'Value';
        rule[actionKey] = a.subtype || 'lightOn';
        rule[valueKey] = (a.value || '').trim();
      });
      
      return {ok: true, rules: [rule]};
    }

    if(bBuild) bBuild.onclick = function(){
      // Wiresheet is now only used in Home mode, so always send to home
      var destination = 'home';
      console.log('🧩 Building wiresheet rules for Smart Home');
      
      var allRules = [];
      Object.values(WS.nodes).filter(function(n){ return n.type==='rule'; }).forEach(function(rn){
        var res = compileRule(rn);
        if(!res.ok){ window.log('Rule#'+rn.id+': '+res.warn); return; }
        allRules = allRules.concat(res.rules);
      });
      
      if(allRules.length === 0){
        alert('Ingen gyldige Rule-noder at bygge.');
        return;
      }
      
      // Always send to Smart Home automation system (since wiresheet is integrated in home tab)
      sendRulesToHome(allRules);
      window.log('Smart Home Rule Builder: '+allRules.length+' regel/r sendt til Smart Home.');
    };

    // === WIRESHEET → HOME AUTOMATION BRIDGE ===
    
    function sendRulesToHome(wiresheetRules) {
      console.log('🌉 Bridge: Converting wiresheet rules to home format...');
      console.log('📥 Wiresheet rules:', wiresheetRules);
      
      // Convert wiresheet rules to home automation format
      var homeRules = wiresheetRules.map(function(rule) {
        return convertWiresheetRuleToHome(rule);
      }).filter(function(rule) {
        return rule !== null; // Filter out rules that couldn't be converted
      });
      
      console.log('📤 Converted home rules:', homeRules);
      
      if(homeRules.length === 0) {
        alert('Ingen regler kunne konverteres til Smart Home format.');
        return;
      }
      
      // Send to home automation system
      if(typeof window.addHomeAutomationRule === 'function') {
        homeRules.forEach(function(homeRule) {
          window.addHomeAutomationRule(homeRule);
        });
        
        // Show success notification
        if(typeof window.showNotification === 'function') {
          window.showNotification('🧩 ' + homeRules.length + ' regel(er) modtaget fra Wiresheet', 'automation');
        }
        
        console.log('✅ Successfully sent', homeRules.length, 'rules to home automation');
      } else {
        console.error('❌ Home automation system not available');
        alert('Smart Home systemet er ikke tilgængeligt. Prøv at gå til Home-fanen først.');
      }
    }
    
    // Convert Danish action text to action codes
    function convertDanishActionToCode(danishText) {
      console.log('🇩🇰 Converting Danish text:', danishText);
      
      // Map Danish text to action codes
      var danishToCode = {
        // Soveværelse lys
        'Soveværelse lys → Tænd': 'bedroomLightOn',
        'Soveværelse lys → Sluk': 'bedroomLightOff',
        'Soveværelse lys → Dæmp 30%': 'bedroomDim30',
        'Soveværelse lys → Dæmp 100%': 'bedroomDim100',
        
        // Stue lys
        'Stue lys → Tænd': 'livingLightOn',
        'Stue lys → Sluk': 'livingLightOff',
        'Stue lys → Dæmp 30%': 'livingDim30',
        'Stue lys → Dæmp 100%': 'livingDim100',
        
        // Spisebord lys
        'Spisebord lys → Tænd': 'diningLightOn',
        'Spisebord lys → Sluk': 'diningLightOff',
        
        // Køkken lys
        'Køkken lys → Tænd': 'kitchenLightOn',
        'Køkken lys → Sluk': 'kitchenLightOff',
        
        // Badeværelse lys
        'Badeværelse lys → Tænd': 'bathroomLightOn',
        'Badeværelse lys → Sluk': 'bathroomLightOff',
        
        // Alle lys
        'Alle lys → Tænd': 'allLightsOn',
        'Alle lys → Sluk': 'allLightsOff',
        
        // Ventilation
        'Ventilation → Tænd': 'ventilationOn',
        'Ventilation → Sluk': 'ventilationOff',
        
        // Dørlås
        'Dørlås → Lås': 'frontDoorLock',
        'Dørlås → Lås op': 'frontDoorUnlock',
        'Auto-lås → Tænd': 'autoLockOn',
        'Auto-lås → Sluk': 'autoLockOff',
        
        // Alarm
        'Alarm → Aktiver': 'alarmOn',
        'Alarm → Deaktiver': 'alarmOff',
        
        // Temperatur
        'Temperatur → Øg': 'tempUp',
        'Temperatur → Sænk': 'tempDown',
        'Temperatur → 18°C': 'setTemp18',
        'Temperatur → 21°C': 'setTemp21',
        'Temperatur → 24°C': 'setTemp24',
        
        // Scenarier
        'God morgen': 'scenarioGoodMorning',
        'Forlad hjem': 'scenarioLeavingHome',
        'God nat': 'scenarioGoodNight',
        'Kom hjem': 'scenarioComingHome',
        
        // Notifikationer
        'Push notifikation': 'push',
        'Sikkerhedsalarm': 'pushSecurity',
        'Vejr opdatering': 'pushWeather'
      };
      
      var actionCode = danishToCode[danishText];
      if (actionCode) {
        console.log('✅ Converted:', danishText, '→', actionCode);
        return actionCode;
      } else {
        console.log('❌ No mapping found for:', danishText);
        return danishText; // Return original if no mapping found
      }
    }

    function convertWiresheetRuleToHome(wiresheetRule) {
      console.log('🔄 Converting rule:', wiresheetRule);
      
      // Map wiresheet internal values to home device IDs
      var triggerMapping = {
        'always': 'entrance-motion',           // "Ved aktivering" 
        'motionBreached': 'entrance-motion',   // "PIR → Breached"
        'motionSafe': 'entrance-motion',       // "PIR → Safe"
        'doorOpened': 'front-door',           // "Dør → Opened"
        'timeEquals': 'time-scheduler',       // "Time = hh:mm"
        'humidityAbove': 'humidity-sensor',   // "Fugt ≥"
        // Nye specifikke triggers
        'entranceMotion': 'entrance-motion',
        'livingMotion': 'living-motion', 
        'kitchenMotion': 'motion-kitchen',
        'frontDoorOpened': 'front-door',
        'frontDoorClosed': 'front-door',
        'bedroomWindowOpened': 'bedroom-window',
        'balconyDoorOpened': 'balcony-door',
        'humidityBelow': 'humidity-sensor',
        'tempAbove': 'thermostat',
        'tempBelow': 'thermostat',
        'smokeDetected': 'smoke-detector',
        'bedroomLightOn': 'bedroom-light',
        'livingLightOn': 'living-room-light',
        'kitchenLightOn': 'kitchen-light',
        'anyLightOn': 'living-room-light',
        'allLightsOff': 'living-room-light',
        'timeBetween': 'time-scheduler',
        'alarmActivated': 'alarm-system',
        'alarmDeactivated': 'alarm-system'
      };
      
      var actionMapping = {
        // Individuelle lamper
        'bedroomLightOn': { device: 'bedroom-light', state: true },
        'bedroomLightOff': { device: 'bedroom-light', state: false },
        'livingLightOn': { device: 'living-room-light', state: true },
        'livingLightOff': { device: 'living-room-light', state: false },
        'diningLightOn': { device: 'dining-light', state: true },
        'diningLightOff': { device: 'dining-light', state: false },
        'kitchenLightOn': { device: 'kitchen-light', state: true },
        'kitchenLightOff': { device: 'kitchen-light', state: false },
        'bathroomLightOn': { device: 'bathroom-light', state: true },
        'bathroomLightOff': { device: 'bathroom-light', state: false },
        // Alle lys og dæmpere
        'allLightsOn': { type: 'allLights', state: true },
        'allLightsOff': { type: 'allLights', state: false },
        'bedroomDim30': { device: 'bedroom-light', state: true },
        'bedroomDim100': { device: 'bedroom-light', state: true },
        'livingDim30': { device: 'living-room-light', state: true },
        'livingDim100': { device: 'living-room-light', state: true },
        // Ventilation (controls both control panel and bathroom-fan icon)
        'ventilationOn': { device: 'ventilation', state: true },
        'ventilationOff': { device: 'ventilation', state: false },
        // Dørlås
        'frontDoorLock': { device: 'front-door', state: true },
        'frontDoorUnlock': { device: 'front-door', state: false },
        'autoLockOn': { device: 'auto-lock', state: true },
        'autoLockOff': { device: 'auto-lock', state: false },
        // Alarm system
        'alarmOn': { device: 'alarm-system', state: true },
        'alarmOff': { device: 'alarm-system', state: false },
        // Temperatur (special handling)
        'tempUp': { type: 'temperature', value: 23 },
        'tempDown': { type: 'temperature', value: 19 },
        'setTemp5': { type: 'temperature', value: 5 },
        'setTemp10': { type: 'temperature', value: 10 },
        'setTemp18': { type: 'temperature', value: 18 },
        'setTemp21': { type: 'temperature', value: 21 },
        'setTemp24': { type: 'temperature', value: 24 },
        'setTemp30': { type: 'temperature', value: 30 },
        'setTemp35': { type: 'temperature', value: 35 },
        // Scenarier
        'scenarioGoodMorning': { type: 'scenario', scenario: 'good-morning' },
        'scenarioLeavingHome': { type: 'scenario', scenario: 'leaving-home' },
        'scenarioGoodNight': { type: 'scenario', scenario: 'good-night' },
        'scenarioComingHome': { type: 'scenario', scenario: 'coming-home' },
        // Master automation
        'automationOn': { device: 'automation-master', state: true },
        'automationOff': { device: 'automation-master', state: false },
        // Notifikationer
        'push': { type: 'notification', message: 'Wiresheet trigger' },
        'pushSecurity': { type: 'notification', message: '🚨 Sikkerhedsalarm aktiveret!' },
        'pushWeather': { type: 'notification', message: '🌤️ Vejr opdatering' },
        // Legacy (bagudkompatibilitet)
        'lightOn': { device: 'living-room-light', state: true },
        'lightOff': { device: 'living-room-light', state: false },
        'dim30': { device: 'living-room-light', state: true },
        'dim100': { device: 'living-room-light', state: true },
        'fanOn': { device: 'ventilation', state: true },
        'fanOff': { device: 'ventilation', state: false },
        'securityOn': { device: 'alarm-system', state: true },
        'securityOff': { device: 'alarm-system', state: false }
      };
      
      // Get trigger device and state
      var triggerDevice = triggerMapping[wiresheetRule.trigger];
      if (!triggerDevice) {
        console.warn('⚠️ Unknown trigger:', wiresheetRule.trigger);
        return null;
      }
      
      // Get all actions (support for multiple actions)
      var actions = [];
      if (wiresheetRule.action1) actions.push(wiresheetRule.action1);
      if (wiresheetRule.action2) actions.push(wiresheetRule.action2);
      if (wiresheetRule.action3) actions.push(wiresheetRule.action3);
      if (wiresheetRule.action4) actions.push(wiresheetRule.action4);
      
      if (actions.length === 0) {
        console.warn('⚠️ No actions found in wiresheet rule');
        return null;
      }
      
      // Build home automation rule
      var homeRule = {
        name: wiresheetRule.ruleName || ('Wiresheet Regel: ' + wiresheetRule.trigger + ' → ' + actions.join(', ')),
        description: 'Automatisk importeret fra Wiresheet',
        enabled: true,
        trigger: createHomeTrigger(wiresheetRule.trigger, triggerDevice, wiresheetRule.triggerValue),
        actions: []
      };
      
      // Add all actions
      actions.forEach(function(actionName, index) {
        console.log('🔍 Processing action:', actionName, 'type:', typeof actionName);
        
        // Convert Danish text to action code if needed
        var actionCode = convertDanishActionToCode(actionName);
        console.log('🔍 Converted action code:', actionCode);
        
        var actionConfig = actionMapping[actionCode];
        if (!actionConfig) {
          console.warn('⚠️ Unknown action:', actionName, '->', actionCode);
          console.log('🔍 Available actions:', Object.keys(actionMapping));
          return;
        }
        
        // Add action based on type
        if (actionConfig.type === 'scenario') {
          homeRule.actions.push({
            type: 'scenario',
            scenario: actionConfig.scenario,
            delay: index * 100 // Small delay between actions
          });
        } else if (actionConfig.type === 'notification') {
          homeRule.actions.push({
            type: 'notification',
            message: actionConfig.message,
            delay: index * 100
          });
        } else if (actionConfig.type === 'allLights') {
          homeRule.actions.push({
            type: 'allLights',
            state: actionConfig.state,
            delay: index * 100
          });
        } else {
          homeRule.actions.push({
            type: 'device',
            device: actionConfig.device,
            state: actionConfig.state,
            delay: index * 100
          });
        }
      });
      
      return homeRule;
    }
    
    function createHomeTrigger(triggerType, deviceId, triggerValue) {
      // Numeric triggers for sensors
      if (triggerType === 'humidityAbove') {
        return {
          type: 'numeric',
          device: deviceId,
          operator: 'greater',
          threshold: parseFloat(triggerValue || 50)
        };
      } else if (triggerType === 'humidityBelow') {
        return {
          type: 'numeric',
          device: deviceId,
          operator: 'less',
          threshold: parseFloat(triggerValue || 50)
        };
      } else if (triggerType === 'tempAbove') {
        return {
          type: 'numeric',
          device: deviceId,
          operator: 'greater',
          threshold: parseFloat(triggerValue || 25)
        };
      } else if (triggerType === 'tempBelow') {
        return {
          type: 'numeric',
          device: deviceId,
          operator: 'less',
          threshold: parseFloat(triggerValue || 18)
        };
      } else {
        // Boolean triggers for switches, motion sensors etc.
        return {
          type: 'boolean',
          device: deviceId,
          state: getTriggerState(triggerType, triggerValue)
        };
      }
    }
    
    function getTriggerState(trigger, value) {
      switch(trigger) {
        case 'always':
        case 'motionBreached':
        case 'entranceMotion':
        case 'livingMotion':
        case 'kitchenMotion':
        case 'doorOpened':
        case 'frontDoorOpened':
        case 'bedroomWindowOpened':
        case 'balconyDoorOpened':
        case 'smokeDetected':
        case 'alarmActivated':
          return true;
        case 'motionSafe':
        case 'frontDoorClosed':
        case 'alarmDeactivated':
          return false;
        case 'bedroomLightOn':
        case 'livingLightOn':
        case 'kitchenLightOn':
        case 'anyLightOn':
          return true;
        case 'allLightsOff':
          return false;
        case 'timeEquals':
        case 'timeBetween':
          return true; // Time triggers are handled differently
        default:
          return true;
      }
    }

    // --- Preview strings under each Rule node
    function preview(){
      Object.values(WS.nodes).filter(function(n){ return n.type==='rule'; }).forEach(function(rn){
        var pv = nodesHost.querySelector('.ws-node[data-id="'+rn.id+'"] .ws-preview');
        if(!pv) return;
        var res = compileRule(rn);
        if(!res.ok){ pv.innerHTML = '<span class="ws-warn">⚠ '+res.warn+'</span>'; return; }
        var lines = res.rules.map(function(rr){
          function label(opts,k){ var m=opts.find(function(x){return x[0]===k;}); return m?m[1]:k; }
          var t = label(TRIG_OPTS, rr.trigger) + (rr.triggerValue?(' '+rr.triggerValue):'');
          var c1 = rr.cond1? ' AND '+label(COND_OPTS, rr.cond1)+(rr.cond1Value?(' '+rr.cond1Value):'') : '';
          var c2 = rr.cond2? ' AND '+label(COND_OPTS, rr.cond2)+(rr.cond2Value?(' '+rr.cond2Value):'') : '';
          var a  = label(ACT_OPTS, rr.action1) + (rr.action1Value?(' '+rr.action1Value):'');
          return 'IF '+t+c1+c2+' THEN '+a + (rr.ruleName?('  • '+rr.ruleName):'');
        });
        pv.textContent = lines.join('\\n');
      });
    }

    // initial
    renderAll(); updateLinkLabels();
    
    // Save initial state
    saveState();
    
    // quick palette
    addNode('trig', 60, 60);
    addNode('cond', 60, 180);
    addNode('act',  60, 300);
    addNode('rule', 520, 160);
  })();
})();

  // === Login & credentials (localStorage) ===
  function getStoredCreds(){
    return { user: localStorage.getItem('simUser') || 'admin', pass: localStorage.getItem('simPass') || '1234' };
  }
  async function tryLogin(u,p){ 
    // Simpel localStorage login
    console.log('🔍 Logger ind med localStorage...');
    const users = JSON.parse(localStorage.getItem('ibi_users') || '[]');
    const registeredUser = users.find(user => user.username === u && user.password === p);
    
    if (registeredUser) {
      // Opdater lastLogin
      registeredUser.lastLogin = new Date().toISOString();
      const userIndex = users.findIndex(user => user.username === u);
      if (userIndex !== -1) {
        users[userIndex] = registeredUser;
        localStorage.setItem('smarthome_simulator_users', JSON.stringify(users));
      }
      return true;
    }
    
    // Ellers tjek standard login
    const c=getStoredCreds(); 
    return (u===c.user && p===c.pass); 
  }
  async function doLogin(){
    console.log('🚀 doLogin function called');
    const u=document.getElementById('loginUser').value.trim();
    const p=document.getElementById('loginPass').value.trim();
    console.log('🔐 Login attempt with user:', u, 'pass length:', p.length);
    
    if (!u || !p) {
      document.getElementById('loginError').innerText='Udfyld både brugernavn og adgangskode.';
      return;
    }
    
    try {
      // Tjek om brugeren allerede eksisterer
      const users = JSON.parse(localStorage.getItem('smarthome_simulator_users') || '[]');
      const existingUser = users.find(user => user.username === u);
      
      if (!existingUser) {
        // Vis loading state for ny bruger
        document.getElementById('loginError').innerText='Opretter bruger og starter simulator...';
        
        // Opret ny bruger med initial data struktur
        const newUser = {
          id: u, // Tilføj .id property
          username: u,
          password: p,
          createdAt: new Date().toISOString(),
          lastLogin: new Date().toISOString(),
          // Initial fremskridt og opgave data
          progress: {
            completedTasks: [],
            currentTask: null,
            totalScore: 0,
            learningPath: 'beginner'
          },
          // Sensor og simulator data
          simulatorData: {
            savedConfigurations: [],
            sensorHistory: [],
            ruleHistory: []
          },
          // Læringshistorik
          learningHistory: {
            completedLessons: [],
            quizResults: [],
            lastActivity: new Date().toISOString()
          }
        };
        
        users.push(newUser);
        localStorage.setItem('smarthome_simulator_users', JSON.stringify(users));
        console.log('✅ Ny bruger oprettet med initial data struktur:', u);
        
        // Opret bruger-specifikke localStorage keys
        localStorage.setItem(`user_${u}_progress`, JSON.stringify(newUser.progress));
        localStorage.setItem(`user_${u}_simulator`, JSON.stringify(newUser.simulatorData));
        localStorage.setItem(`user_${u}_learning`, JSON.stringify(newUser.learningHistory));
        
      } else {
        // Vis loading state for eksisterende bruger
        document.getElementById('loginError').innerText='Logger ind og starter simulator...';
        
        // Tjek om adgangskoden matcher
        if (existingUser.password !== p) {
          document.getElementById('loginError').innerText='Forkert adgangskode for denne bruger.';
          return;
        }
        
        // Opdater lastLogin og sikre at .id property eksisterer
        existingUser.lastLogin = new Date().toISOString();
        if (!existingUser.id) {
          existingUser.id = u; // Tilføj .id hvis den mangler
          console.log('🔧 Tilføjet .id property til eksisterende bruger:', u);
        }
        
        const userIndex = users.findIndex(user => user.username === u);
        if (userIndex !== -1) {
                  users[userIndex] = existingUser;
        localStorage.setItem('smarthome_simulator_users', JSON.stringify(users));
        }
        console.log('✅ Eksisterende bruger logget ind:', u);
        
        // Indlæs bruger-specifikke data
        const userProgress = localStorage.getItem(`user_${u}_progress`);
        const userSimulator = localStorage.getItem(`user_${u}_simulator`);
        const userLearning = localStorage.getItem(`user_${u}_learning`);
        
        if (userProgress) {
          console.log('📊 Indlæst bruger fremskridt:', JSON.parse(userProgress));
        }
        if (userSimulator) {
          console.log('🔧 Indlæst simulator data:', JSON.parse(userSimulator));
        }
        if (userLearning) {
          console.log('📚 Indlæst læringshistorik:', JSON.parse(userLearning));
        }
      }
      
      // Gem brugerinfo lokalt som backup
      localStorage.setItem('simUser', u);
      localStorage.setItem('simPass', p);
      console.log('🔍 localStorage simUser efter gem:', localStorage.getItem('simUser'));
      
      // Tilføj fade-out effekt til intro
      const introView = document.getElementById('loginView');
      introView.style.transition = 'opacity 0.5s ease-out';
      introView.style.opacity = '0';
      
      // Efter fade-out, skjul intro og vis hovedapp
      setTimeout(() => {
        introView.style.display = 'none';
        
        // Vis navigation, tabs og header
        const mainnav = document.querySelector('.mainnav');
        const tabs = document.querySelector('.tabs');
        const header = document.querySelector('header');
        
        if (mainnav) {
          mainnav.style.display = 'flex';
          console.log('✅ Navigation vist igen');
        }
        
        if (tabs) {
          tabs.style.display = 'block';
          console.log('✅ Tabs vist igen');
        }
        
        if (header) {
          header.style.display = 'block';
          header.style.visibility = 'visible';
          header.style.opacity = '1';
          console.log('✅ Header vist igen efter login');
        } else {
          console.log('⚠️ Header element ikke fundet ved login');
        }
        
        // Tilføj fade-in effekt til hovedapp
        const mainApp = document.getElementById('mainApp');
        mainApp.style.opacity = '0';
        mainApp.style.transition = 'opacity 0.5s ease-in';
        
        setTimeout(() => {
          mainApp.style.opacity = '1';
          // Starter altid på login skærm i stedet for at huske sidste tab
          showLoginView();
          
          // Dobbelttjek at header er synlig
          if (header) {
            console.log('🔍 Dobbelttjek header efter show():', header.style.display, header.style.visibility);
          }
        }, 100);
      }, 500);
      
    } catch (error) {
      console.error('Login error:', error);
      document.getElementById('loginError').innerText='Fejl ved login: ' + error.message;
    }
  }
  async function updateCreds(){
    const u=document.getElementById('setUser').value.trim();
    const p=document.getElementById('setPass').value.trim();
    if(u && p){
      try {
        // Opret bruger i localStorage
        console.log('🔍 Opretter bruger i localStorage...');
        
        // Gem brugerdata lokalt
        const users = JSON.parse(localStorage.getItem('smarthome_simulator_users') || '[]');
        users.push({
          username: u,
          password: p,
          createdAt: new Date().toISOString(),
          lastLogin: new Date().toISOString()
        });
        localStorage.setItem('ibi_users', JSON.stringify(users));
        
        alert('✅ Bruger oprettet lokalt: ' + u + '\nDu kan nu logge ind!');
        
        document.getElementById('setUser').value='';
        document.getElementById('setPass').value='';
        
        // Vis ryd localStorage knap
        showClearStorageButton();
      } catch (error) {
        console.error('Fejl ved oprettelse af bruger:', error);
        alert('Fejl ved oprettelse af bruger: ' + error.message);
      }
    } else { 
      alert('Udfyld både brugernavn og adgangskode.'); 
    }
  }
  async function doLogout(){
    console.log('✅ Logger ud fra localStorage');
    
    // Tilføj fade-out effekt til hovedapp
    const mainApp = document.getElementById('mainApp');
    mainApp.style.transition = 'opacity 0.5s ease-out';
    mainApp.style.opacity = '0';
    
          // Efter fade-out, skjul hovedapp og vis intro
      setTimeout(() => {
        // Skjul navigation, tabs og header
        document.querySelector('.mainnav').style.display = 'none';
        document.querySelector('.tabs').style.display = 'none';
        const header = document.querySelector('header');
        if (header) {
          header.style.display = 'none';
          console.log('✅ Header skjult igen ved logout');
        }
        
        // Vis intro med fade-in effekt
        const introView = document.getElementById('loginView');
        introView.style.display = 'flex';
        introView.style.opacity = '0';
        introView.style.transition = 'opacity 0.5s ease-in';
        
        setTimeout(() => {
          introView.style.opacity = '1';
          // Opdater UI baseret på om der er eksisterende brugere
          checkExistingUsers();
        }, 100);
      }, 500);
    
    // Vis lærer login knap igen og skjul dashboard knap
    const btnTeacherLogin = document.getElementById('btnTeacherLogin');
    const btnTeacherTab = document.getElementById('btnTeacherTab');
    
    if(btnTeacherLogin) btnTeacherLogin.style.display = 'block';
    if(btnTeacherTab) btnTeacherTab.style.display = 'none';
    
    // Ryd lærer login status
    localStorage.removeItem('teacher_school_id');
    localStorage.removeItem('teacher_class_id');
  }

  // Start Simulator funktion (opdateret til at bruge doLogin)
  function startSimulator() {
    console.log('🚀 Start Simulator knap klikket - starter login proces...');
    doLogin();
  }

  // Vis login skærm funktion
  function showLoginView() {
    console.log('🔐 Viser login skærm som standard...');
    
    // Skjul navigation, tabs og header
    const mainnav = document.querySelector('.mainnav');
    const tabs = document.querySelector('.tabs');
    const header = document.querySelector('header');
    
    if (mainnav) mainnav.style.display = 'none';
    if (tabs) tabs.style.display = 'none';
    if (header) header.style.display = 'none';
    
    // Vis login view
    const loginView = document.getElementById('loginView');
    if (loginView) {
      loginView.style.display = 'flex';
      loginView.style.opacity = '1';
      
      // Opdater UI baseret på om der er eksisterende brugere
      checkExistingUsers();
      
      console.log('✅ Login skærm vist som standard');
    }
  }

  // Hjælpefunktioner til brugerdata
  // getCurrentUser funktionen er defineret længere nede i filen

  // Tjek om der allerede er brugere i systemet og opdater UI
  function checkExistingUsers() {
    const users = JSON.parse(localStorage.getItem('ibi_users') || '[]');
    const hasUsers = users.length > 0;
    
    const loginTitle = document.getElementById('loginTitle');
    const loginSubtitle = document.getElementById('loginSubtitle');
    const btnLogin = document.getElementById('btnLogin');
    const loginUser = document.getElementById('loginUser');
    const loginPass = document.getElementById('loginPass');
    
    if (hasUsers) {
      // Der er allerede brugere - vis login UI
      loginTitle.textContent = 'Log ind på din konto';
      loginSubtitle.textContent = 'Log ind for at fortsætte hvor du slap';
      btnLogin.textContent = '🔓 Log ind & Start Simulator';
      loginUser.placeholder = 'Indtast dit brugernavn';
      loginPass.placeholder = 'Indtast din adgangskode';
      loginPass.setAttribute('autocomplete', 'current-password');
      console.log('ℹ️ Der er allerede brugere i systemet - viser login UI');
    } else {
      // Ingen brugere endnu - vis brugeroprettelse UI
      loginTitle.textContent = 'Opret din brugerkonto';
      loginSubtitle.textContent = 'Opret en konto for at gemme dit fremskridt og opgave-resultater';
      btnLogin.textContent = '🚀 Opret konto & Start Simulator';
      loginUser.placeholder = 'Vælg et brugernavn';
      loginPass.placeholder = 'Vælg en adgangskode';
      loginPass.setAttribute('autocomplete', 'new-password');
      console.log('ℹ️ Ingen brugere i systemet endnu - viser brugeroprettelse UI');
    }
  }

  function saveUserProgressLocal(progressData) {
    const currentUser = getCurrentUser();
    if (currentUser) {
      const userProgress = JSON.parse(localStorage.getItem(`user_${currentUser}_progress`) || '{}');
      const updatedProgress = { ...userProgress, ...progressData };
      localStorage.setItem(`user_${currentUser}_progress`, JSON.stringify(updatedProgress));
      console.log('💾 Bruger fremskridt gemt lokalt:', updatedProgress);
    }
  }

  function saveUserSimulatorData(simulatorData) {
    const currentUser = getCurrentUser();
    if (currentUser) {
      const userSimulator = JSON.parse(localStorage.getItem(`user_${currentUser}_simulator`) || '{}');
      const updatedSimulator = { ...userSimulator, ...simulatorData };
      localStorage.setItem(`user_${currentUser}_simulator`, JSON.stringify(updatedSimulator));
      console.log('💾 Simulator data gemt:', updatedSimulator);
    }
  }

  function saveUserLearningData(learningData) {
    const currentUser = getCurrentUser();
    if (currentUser) {
      const userLearning = JSON.parse(localStorage.getItem(`user_${currentUser}_learning`) || '{}');
      const updatedLearning = { ...userLearning, ...learningData };
      localStorage.setItem(`user_${currentUser}_learning`, JSON.stringify(updatedLearning));
      console.log('💾 Læringsdata gemt:', updatedLearning);
    }
  }
  // === Login event setup ===
  function setupLoginEvents() {
    console.log('🔑 Setting up login events...');
    
    // Tjek om der allerede er brugere og opdater UI
    checkExistingUsers();
    
    // Login knap
    const btnLogin = document.getElementById('btnLogin');
    if(btnLogin) {
      console.log('✅ Login button found, adding click handler');
      btnLogin.onclick = doLogin;
    } else {
      console.log('ℹ️ Login button not found (may be normal for intro view)');
    }
    
    // Password field Enter key handler
    const loginPass = document.getElementById('loginPass');
    if(loginPass) {
      console.log('✅ Password field found, adding Enter key handler');
      loginPass.addEventListener('keydown', e => { 
        if(e.key === 'Enter') {
          console.log('Enter pressed, attempting login');
          doLogin(); 
        }
      });
    }
    
    // Logout knap (hvis den findes)
    const btnLogout = document.getElementById('btnLogout');
    if(btnLogout) btnLogout.onclick = doLogout;
    
    // Clear localStorage knap
    const clearStorageBtn = document.getElementById('clearStorageBtn');
    if(clearStorageBtn) {
      clearStorageBtn.onclick = clearLocalStorage;
      console.log('✅ Clear localStorage button found and configured');
    }
    
    // Gem brugerindstillinger knap
    const btnSaveCreds = document.getElementById('btnSaveCreds');
    if(btnSaveCreds) {
      btnSaveCreds.onclick = updateCreds;
      console.log('✅ Save credentials button found and configured');
    }
    
    // Opret bruger knap
    const btnCreateUser = document.getElementById('btnCreateUser');
    if(btnCreateUser) {
      btnCreateUser.onclick = createUser;
      console.log('✅ Create user button found and configured');
    }
    
    // Gem elev navn knap
    const btnSaveName = document.getElementById('btnSaveName');
    if(btnSaveName) {
      btnSaveName.onclick = saveStudentName;
      console.log('✅ Save student name button found and configured');
    }
    
    // Lærer logout knap (hvis den findes)
    const btnTeacherLogout = document.getElementById('btnTeacherLogout');
    if(btnTeacherLogout) {
      btnTeacherLogout.onclick = doTeacherLogout;
    }
    
    // Lærer login knap
    const btnTeacherLogin = document.getElementById('btnTeacherLogin');
    if(btnTeacherLogin) {
      btnTeacherLogin.onclick = showTeacherLoginModal;
    }
    
    // Simulation knap
    const btnSimulation = document.getElementById('btnSimulation');
    if(btnSimulation) {
      btnSimulation.onclick = function() {
        // Skjul alle normale faner
        document.querySelector('.tabs').style.display = 'none';
        
        // Skjul alle normale views
        document.querySelectorAll('.view').forEach(view => {
          if (view.id !== 'view-simulation') {
            view.style.display = 'none';
          }
        });
        
        // Vis kun simulation dashboard
        document.getElementById('view-simulation').style.display = 'block';
        document.getElementById('view-simulation').classList.add('active');
        
        // Opdater live sensor værdier med det samme
        updateSimulationDisplay();
        
        console.log('🔧 Simulation dashboard åbnet');
        console.log('🔍 Skiftet til simulation dashboard');
      };
      console.log('✅ Simulation knap fundet og konfigureret');
    }
    
    // Lærer dashboard knap
    const btnTeacherTab = document.getElementById('btnTeacherTab');
    if(btnTeacherTab) {
      btnTeacherTab.onclick = () => {
        // Skjul alle normale faner
        document.querySelector('.tabs').style.display = 'none';
        
        // Skjul alle normale views
        document.querySelectorAll('.view').forEach(view => {
          if (view.id !== 'view-teacher') {
            view.style.display = 'none';
          }
        });
        
        // Vis kun lærer dashboard
        document.getElementById('view-teacher').style.display = 'block';
        document.getElementById('view-teacher').classList.add('active');
        
        console.log('🔍 Skiftet til separat lærer dashboard side');
      };
    }
    
    // Lærer login submit knap
    const btnTeacherLoginSubmit = document.getElementById('btnTeacherLoginSubmit');
    if(btnTeacherLoginSubmit) {
      btnTeacherLoginSubmit.onclick = doTeacherLogin;
    }

    // Klasse administration knapper
    const btnCreateClass = document.getElementById('btnCreateClass');
    if(btnCreateClass) {
      btnCreateClass.onclick = createNewClass;
      console.log('✅ Create class button found and configured');
    }

    const btnSwitchToClass = document.getElementById('btnSwitchToClass');
    if(btnSwitchToClass) {
      btnSwitchToClass.onclick = function() {
        const schoolId = document.getElementById('newSchoolId').value.trim();
        const classId = document.getElementById('newClassId').value.trim();
        
        if (!schoolId || !classId) {
          alert('⚠️ Indtast venligst både Skole ID og Klasse ID!');
          return;
        }
        
        switchToClass(schoolId, classId);
      };
      console.log('✅ Switch to class button found and configured');
    }

    // Klasse administration knapper
    const btnReloadClasses = document.getElementById('btnReloadClasses');
    if(btnReloadClasses) {
      btnReloadClasses.onclick = loadExistingClasses;
      console.log('✅ Reload classes button found and configured');
    }

    const btnClearClasses = document.getElementById('btnClearClasses');
    if(btnClearClasses) {
      btnClearClasses.onclick = clearAllClasses;
      console.log('✅ Clear all classes button found and configured');
    }
    
    // Simulation mode event listeners
    const btnStartSimulation = document.getElementById('btnStartSimulation');
    const btnStopSimulation = document.getElementById('btnStopSimulation');
    const btnResetSimulation = document.getElementById('btnResetSimulation');
    
    if(btnStartSimulation) {
      btnStartSimulation.onclick = startSimulation;
      console.log('✅ Start simulation button found and configured');
    }
    
    if(btnStopSimulation) {
      btnStopSimulation.onclick = stopSimulation;
      console.log('✅ Stop simulation button found and configured');
    }
    
    if(btnResetSimulation) {
      btnResetSimulation.onclick = resetSimulation;
      console.log('✅ Reset simulation button found and configured');
    }
    
    const btnTestRules = document.getElementById('btnTestRules');
    if(btnTestRules) {
      btnTestRules.onclick = function() {
        log('🎯 Tester alle regler med nuværende sensor værdier...', 'system');
        runRules();
        log('✅ Regel test gennemført - tjek loggen for resultater', 'system');
      };
      console.log('✅ Test rules button found and configured');
    }
    
    const btnBackToNormal = document.getElementById('btnBackToNormal');
    if(btnBackToNormal) {
      btnBackToNormal.onclick = function() {
        // Vis alle normale faner igen
        document.querySelector('.tabs').style.display = 'flex';
        
        // Skjul alle views
        document.querySelectorAll('.view').forEach(view => {
          view.style.display = 'none';
        });
        
        // Vis simulator view som standard
        document.getElementById('view-sim').style.display = 'block';
        document.getElementById('view-sim').classList.add('active');
        
        // Gendan tab aktivitet
        document.getElementById('tabSim').classList.add('active');
        document.getElementById('tabFlow').classList.remove('active');
        document.getElementById('tabLearning').classList.remove('active');
        document.getElementById('tabSettings').classList.remove('active');
        
        console.log('🔍 Gået tilbage til simulator');
      };
      console.log('✅ Back to normal button found and configured');
    }
    
    // Simulation indstillinger event listeners
    const simulationEnabled = document.getElementById('simulationEnabled');
    const simulationSpeed = document.getElementById('simulationSpeed');
    const realisticPatterns = document.getElementById('realisticPatterns');
    const dayNightCycle = document.getElementById('dayNightCycle');
    
    if(simulationEnabled) {
      simulationEnabled.onchange = function() {
        if(this.checked) {
          startSimulation();
        } else {
          stopSimulation();
        }
      };
      console.log('✅ Simulation enabled checkbox found and configured');
    }
    
    if(simulationSpeed) {
      simulationSpeed.onchange = function() {
        if(simulation.enabled) {
          // Genstart simulation med ny hastighed
          stopSimulation();
          startSimulation();
        }
      };
      console.log('✅ Simulation speed selector found and configured');
    }
    
    // Lærer dashboard knapper
    const btnLoadProgress = document.getElementById('btnLoadProgress');
    if(btnLoadProgress) {
      btnLoadProgress.onclick = loadTeacherProgress;
    }
    
    const btnExportCSV = document.getElementById('btnExportCSV');
    if(btnExportCSV) {
      btnExportCSV.onclick = () => exportClassData(
        localStorage.getItem('teacher_school_id') || 'default',
        localStorage.getItem('teacher_class_id') || 'default'
      );
    }
    

    

    

  }

  // === Simulation Display Funktioner ===
  function updateSimulationDisplay() {
    // Opdater live sensor værdier i simulation fane
    if (document.getElementById('liveClock')) {
      document.getElementById('liveClock').textContent = state.time;
      document.getElementById('liveDate').textContent = state.weekday;
      document.getElementById('liveLuxDisplay').textContent = state.lux + ' lux';
      document.getElementById('liveHumidityDisplay').textContent = state.humidity + '%';
      document.getElementById('liveWindDisplay').textContent = state.wind + ' m/s';
      document.getElementById('liveMotionDisplay').textContent = state.motion ? 'Breached' : 'Safe';
      document.getElementById('liveDoorDisplay').textContent = state.door ? 'Opened' : 'Closed';
      document.getElementById('liveAlarmDisplay').textContent = state.alarmArmed ? 'Armed' : 'Disarmed';
      
      // Vis temperatur fra state (nu opdateret i simulation)
      if (state.temperature !== undefined) {
        document.getElementById('liveTempDisplay').textContent = state.temperature + '°C';
      } else {
        document.getElementById('liveTempDisplay').textContent = '21.5°C';
      }
      
      // Opdater status tekster
      document.getElementById('liveLightStatus').textContent = state.lux > 500 ? 'Lyst' : state.lux > 100 ? 'Moderat' : 'Mørkt';
      document.getElementById('liveHumidityStatus').textContent = state.humidity > 60 ? 'Fugtigt' : state.humidity < 30 ? 'Tørt' : 'Normal';
      document.getElementById('liveWindStatus').textContent = state.wind > 10 ? 'Stærk' : state.wind > 5 ? 'Moderat' : 'Svag';
      document.getElementById('liveMotionStatus').textContent = state.motion ? 'Bevægelse detekteret!' : 'Ingen bevægelse';
      document.getElementById('liveDoorStatus').textContent = state.door ? 'Åben' : 'Lukket';
      document.getElementById('liveAlarmStatus').textContent = state.alarmArmed ? 'Aktiv' : 'Inaktiv';
      
      if (window.simulation && window.simulation.getTemperature) {
        const temp = window.simulation.getTemperature(new Date());
        document.getElementById('liveTempStatus').textContent = temp > 25 ? 'Varmt' : temp < 18 ? 'Koldt' : 'Normal';
      } else {
        document.getElementById('liveTempStatus').textContent = 'Normal';
      }
      
      // Opdater hastighed status
      if (window.simulation) {
        document.getElementById('speedStatus').textContent = (window.simulation.speed || 1) + 'x';
      } else {
        document.getElementById('speedStatus').textContent = '1x';
      }
      
      // Opdater simulation tid og status
      document.getElementById('simulationTime').textContent = state.time;
      document.getElementById('sensorStatus').textContent = 'Normal';
      document.getElementById('cycleStatus').textContent = 'Normal';
    }
  }
  
  // === Nye Simulation Funktioner ===
  window.testRules = function() {
    log('🎯 Tester alle regler med nuværende sensor værdier...', 'system');
    runRules();
    log('✅ Regel test gennemført - tjek loggen for resultater', 'system');
  }
  
  window.goBackToSimulator = function() {
    // Vis alle normale faner igen
    document.querySelector('.tabs').style.display = 'flex';
    
    // Brug den samme show() funktion som tab-knapperne
    if (window.show) {
      window.show('view-sim');
    } else {
      // Fallback hvis show() ikke er tilgængelig
      // Skjul alle views
      document.querySelectorAll('.view').forEach(view => {
        view.style.display = 'none';
        view.classList.remove('active');
      });
      
      // Vis simulator view som standard
      const simView = document.getElementById('view-sim');
      if (simView) {
        simView.style.display = 'block';
        simView.classList.add('active');
      }
      
      // Gendan tab aktivitet
      const tabSim = document.getElementById('tabSim');
      const tabFlow = document.getElementById('tabFlow');
      const tabLearning = document.getElementById('tabLearning');
      const tabSettings = document.getElementById('tabSettings');
      
      if (tabSim) tabSim.classList.add('active');
      if (tabFlow) tabFlow.classList.remove('active');
      if (tabLearning) tabLearning.classList.remove('active');
      if (tabSettings) tabSettings.classList.remove('active');
    }
    
    console.log('🔍 Gået tilbage til simulator');
  }
  
  window.toggleSimulation = function(checkbox) {
    if(checkbox.checked) {
      startSimulation();
    } else {
      stopSimulation();
    }
  }
  
  window.changeSimulationSpeed = function(select) {
    if(window.simulation.enabled) {
      // Genstart simulation med ny hastighed
      stopSimulation();
      window.simulation.speed = parseInt(select.value) || 1;
      startSimulation();
    }
  }
  
  window.toggleRealisticPatterns = function(checkbox) {
    if(window.simulation) {
      window.simulation.realisticPatterns = checkbox.checked;
    }
  }
  
  window.toggleDayNightCycle = function(checkbox) {
    if(window.simulation) {
      window.simulation.dayNightCycle = checkbox.checked;
    }
  }
  
  // === Simulation Log Funktioner ===
  window.clearSimulationLog = function() {
    const simLog = document.getElementById('simulationLog');
    if (simLog) {
      simLog.innerHTML = '<div class="log-entry system"><span class="log-time">--:--</span><span class="log-type">System</span><span class="log-message">Log ryddet</span></div>';
    }
  }
  
  window.exportSimulationLog = function() {
    const simLog = document.getElementById('simulationLog');
    if (simLog) {
      const logText = simLog.innerText;
      const blob = new Blob([logText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'simulation-log-' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.txt';
      a.click();
      URL.revokeObjectURL(url);
    }
  }
  
  window.filterSimulationLog = function(type) {
    const logEntries = document.querySelectorAll('#simulationLog .log-entry');
    logEntries.forEach(entry => {
      if (type === 'all' || entry.classList.contains(type)) {
        entry.style.display = 'flex';
      } else {
        entry.style.display = 'none';
      }
    });
  }
  
  // Funktion til at tilføje log entries til simulation loggen
  window.addSimulationLogEntry = function(type, message) {
    const simLog = document.getElementById('simulationLog');
    if (simLog) {
      const now = new Date();
      const time = now.toLocaleTimeString('da-DK', { hour: '2-digit', minute: '2-digit' });
      
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${type}`;
      logEntry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-type">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
        <span class="log-message">${message}</span>
      `;
      
      simLog.appendChild(logEntry);
      simLog.scrollTop = simLog.scrollHeight; // Scroll til bunden
      
      // Begræns antal log entries til 100
      if (simLog.children.length > 100) {
        simLog.removeChild(simLog.firstChild);
      }
    }
  }
  
  // === Simulation Dashboard Funktioner ===
  window.showSimulationDashboard = function() {
    // Skjul alle normale faner
    document.querySelector('.tabs').style.display = 'none';
    
    // Skjul alle views
    document.querySelectorAll('.view').forEach(view => {
      view.style.display = 'none';
    });
    
    // Vis simulation view
    document.getElementById('view-simulation').style.display = 'block';
    
    // Opdater simulation display med nuværende værdier
    updateSimulationDisplay();
    
    console.log('🔧 Simulation dashboard åbnet');
    console.log('🔍 Skiftet til simulation dashboard');
  }
  
  // === UI Opdatering Funktioner ===
  function updateActorDisplays() {
    // Opdater lampe status
    const lampStateEl = document.getElementById('lampState');
    if (lampStateEl) {
      lampStateEl.textContent = state.light ? 'ON' : 'OFF';
      lampStateEl.className = 'tag ' + (state.light ? 'active' : 'inactive');
    }
    
    // Opdater ventilator status
    const fanStateEl = document.getElementById('fanState');
    if (fanStateEl) {
      fanStateEl.textContent = state.fan ? 'ON' : 'OFF';
      fanStateEl.className = 'tag ' + (state.fan ? 'active' : 'inactive');
    }
    
    // Opdater dæmper status (hvis den er defineret)
    if (state.dimmer !== undefined) {
      const dimmerStateEl = document.getElementById('dimmerState');
      if (dimmerStateEl) {
        dimmerStateEl.textContent = state.dimmer + '%';
      }
    }
  }
  
  // === Auto-Reset Timer System ===
  function startAutoResetTimer(actorType, delay = 5000) { // 5 sekunder standard
    // Stop eksisterende timer hvis den findes
    if (window.simulation.autoResetTimers && window.simulation.autoResetTimers[actorType]) {
      clearTimeout(window.simulation.autoResetTimers[actorType]);
    }
    
    // Initialiser timers objekt hvis det ikke findes
    if (!window.simulation.autoResetTimers) {
      window.simulation.autoResetTimers = {};
    }
    
    // Start ny timer
    window.simulation.autoResetTimers[actorType] = setTimeout(function() {
      resetActorToDefault(actorType);
    }, delay);
  }
  
  function resetActorToDefault(actorType) {
    switch(actorType) {
      case 'light':
        state.light = false;
        log('💡 Lampe auto-reset til OFF efter 5 sekunder', 'system');
        break;
      case 'fan':
        state.fan = false;
        log('🌪️ Ventilator auto-reset til OFF efter 5 sekunder', 'system');
        break;
      case 'dimmer':
        state.dimmer = 0;
        log('💡 Dæmper auto-reset til 0% efter 5 sekunder', 'system');
        break;
    }
    
    // Opdater UI
    updateActorDisplays();
    
    // Fjern timer fra listen
    if (window.simulation.autoResetTimers) {
      delete window.simulation.autoResetTimers[actorType];
    }
  }
  
  // === Simulation Event Listeners Setup ===
  function setupSimulationEventListeners() {
    console.log('🔧 Sætter simulation event listeners op...');
    
    // Start Simulation knap
    const btnStartSimulation = document.getElementById('btnStartSimulation');
    if(btnStartSimulation) {
      btnStartSimulation.onclick = startSimulation;
      console.log('✅ Start simulation button event listener sat op');
    } else {
      console.log('❌ Start simulation button ikke fundet');
    }
    
    // Stop Simulation knap
    const btnStopSimulation = document.getElementById('btnStopSimulation');
    if(btnStopSimulation) {
      btnStopSimulation.onclick = stopSimulation;
      console.log('✅ Stop simulation button event listener sat op');
    } else {
      console.log('❌ Stop simulation button ikke fundet');
    }
    
    // Reset Simulation knap
    const btnResetSimulation = document.getElementById('btnResetSimulation');
    if(btnResetSimulation) {
      btnResetSimulation.onclick = resetSimulation;
      console.log('✅ Reset simulation button event listener sat op');
    } else {
      console.log('❌ Reset simulation button ikke fundet');
    }
    
    // Test Rules knap
    const btnTestRules = document.getElementById('btnTestRules');
    if(btnTestRules) {
      btnTestRules.onclick = function() {
        log('🎯 Tester alle regler med nuværende sensor værdier...', 'system');
        runRules();
        log('✅ Regel test gennemført - tjek loggen for resultater', 'system');
      };
      console.log('✅ Test rules button event listener sat op');
    } else {
      console.log('❌ Test rules button ikke fundet');
    }
    
    // Back to Normal knap
    const btnBackToNormal = document.getElementById('btnBackToNormal');
    if(btnBackToNormal) {
      btnBackToNormal.onclick = function() {
        // Vis alle normale faner igen
        document.querySelector('.tabs').style.display = 'flex';
        
        // Skjul alle views
        document.querySelectorAll('.view').forEach(view => {
          view.style.display = 'none';
        });
        
        // Vis simulator view som standard
        document.getElementById('view-sim').style.display = 'block';
        document.getElementById('view-sim').classList.add('active');
        
        // Gendan tab aktivitet
        document.getElementById('tabSim').classList.add('active');
        document.getElementById('tabFlow').classList.remove('active');
        document.getElementById('tabLearning').classList.remove('active');
        document.getElementById('tabSettings').classList.remove('active');
        
        console.log('🔍 Gået tilbage til simulator');
      };
      console.log('✅ Back to normal button event listener sat op');
    } else {
      console.log('❌ Back to normal button ikke fundet');
    }
    
    // Simulation indstillinger
    const simulationEnabled = document.getElementById('simulationEnabled');
    if(simulationEnabled) {
      simulationEnabled.onchange = function() {
        if(this.checked) {
          startSimulation();
        } else {
          stopSimulation();
        }
      };
      console.log('✅ Simulation enabled checkbox event listener sat op');
    }
    
    const simulationSpeed = document.getElementById('simulationSpeed');
    if(simulationSpeed) {
      simulationSpeed.onchange = function() {
        if(simulation.enabled) {
          // Genstart simulation med ny hastighed
          stopSimulation();
          startSimulation();
        }
      };
      console.log('✅ Simulation speed selector event listener sat op');
    }
    
    const realisticPatterns = document.getElementById('realisticPatterns');
    if(realisticPatterns) {
      realisticPatterns.onchange = function() {
        if(simulation) {
          simulation.realisticPatterns = this.checked;
        }
      };
      console.log('✅ Realistic patterns checkbox event listener sat op');
    }
    
    const dayNightCycle = document.getElementById('dayNightCycle');
    if(dayNightCycle) {
      dayNightCycle.onchange = function() {
        if(simulation) {
          simulation.dayNightCycle = this.checked;
        }
      };
      console.log('✅ Day/night cycle checkbox event listener sat op');
    }
    
    console.log('🔧 Alle simulation event listeners sat op');
  }

  // === Elev navn funktionalitet ===
  async function saveStudentName() {
    const firstName = document.getElementById('setFirstName').value.trim();
    const lastName = document.getElementById('setLastName').value.trim();
    const schoolId = document.getElementById('setSchoolId').value.trim();
    const classId = document.getElementById('setClassId').value.trim();
    
    if (!firstName || !lastName) {
      alert('Indtast venligst både fornavn og efternavn');
      return;
    }
    
    if (!schoolId || !classId) {
      alert('Indtast venligst både Skole ID og Klasse ID');
      return;
    }
    
    const studentName = {
      firstName: firstName,
      lastName: lastName,
      email: 'ingen@email.dk',
      schoolId: schoolId,
      classId: classId
    };
    
    // Gem elevnavn og klasse lokalt
    localStorage.setItem('student_name', JSON.stringify(studentName));
    
    // Gem også klasse information separat for nem adgang
    localStorage.setItem('student_school_id', schoolId);
    localStorage.setItem('student_class_id', classId);
    
    // Opdater UI
    alert(`✅ Dit navn og klasse er gemt!\n\nNavn: ${firstName} ${lastName}\nSkole: ${schoolId}\nKlasse: ${classId}`);
    
    // Genindlæs navn i felterne
    loadStudentName();
  }
  
  async function loadStudentName() {
    // Hent elevnavn fra localStorage
    const studentName = JSON.parse(localStorage.getItem('student_name') || '{}');
    
    if (studentName.firstName) {
      document.getElementById('setFirstName').value = studentName.firstName;
    }
    if (studentName.lastName) {
      document.getElementById('setLastName').value = studentName.lastName;
    }
    
    // Indlæs skoler og klasser fra Firebase
    await loadSchoolsForStudents();
    
    // Sæt gemte værdier hvis de findes
    if (studentName.schoolId) {
      document.getElementById('setSchoolId').value = studentName.schoolId;
      await loadClassesForSchool(studentName.schoolId);
    }
    if (studentName.classId) {
      document.getElementById('setClassId').value = studentName.classId;
    }
  }
  
  // === Lærer Login funktionalitet ===
  function showTeacherLoginModal() {
    document.getElementById('teacherLoginModal').style.display = 'flex';
  }
  
  function closeTeacherLoginModal() {
    document.getElementById('teacherLoginModal').style.display = 'none';
    document.getElementById('teacherLoginError').textContent = '';
  }
  
  function doTeacherLogin() {
    const username = document.getElementById('teacherUsername').value.trim();
    const password = document.getElementById('teacherPassword').value.trim();
    const schoolId = document.getElementById('teacherLoginSchoolId').value.trim();
    const classId = document.getElementById('teacherLoginClassId').value.trim();
    
    if (!username || !password) {
      document.getElementById('teacherLoginError').textContent = 'Indtast venligst både brugernavn og adgangskode';
      return;
    }
    
    // Credential verification
    const authData = [
      [108,97,101,114,101,114], 
      [73,66,73,50,48,50,52,33],
      [116,101,97,99,104,101,114],
      [83,105,109,117,108,97,116,111,114,50,48,50,52]
    ].map(arr => String.fromCharCode(...arr));
    
    const validLogin = (username === authData[0] && password === authData[1]) || 
                      (username === authData[2] && password === authData[3]);
    
    if (validLogin) {
      // Gem lærer info
      localStorage.setItem('teacher_logged_in', 'true');
      localStorage.setItem('teacher_school_id', schoolId);
      localStorage.setItem('teacher_class_id', classId);
      
      // Skjul lærer login knap og vis dashboard knap
      document.getElementById('btnTeacherLogin').style.display = 'none';
      document.getElementById('btnTeacherTab').style.display = 'inline-block';
      
      // Luk modal
      closeTeacherLoginModal();
      
      // Indlæs elev progress
      loadTeacherProgress();
      
      alert('✅ Logget ind som lærer! Du kan nu se elev progress.');
    } else {
      document.getElementById('teacherLoginError').textContent = 'Forkert brugernavn eller adgangskode';
    }
  }
  
  async function loadTeacherProgress() {
    const schoolId = localStorage.getItem('teacher_school_id') || 'default';
    const classId = localStorage.getItem('teacher_class_id') || 'default';
    
    console.log('🔍 loadTeacherProgress kaldt med:', { schoolId, classId });
    
    // Opdater input felter
    document.getElementById('teacherSchoolId').value = schoolId;
    document.getElementById('teacherClassId').value = classId;
    
    // Indlæs skoler og klasser automatisk
    await loadSchoolsForTeachers();
    
    // Hvis vi kører lokalt, vis lokale data
    if (isLocalEnvironment) {
      console.log('🏠 Kører lokalt - viser lokale data');
      const localProgress = getLocalProgress();
      displayTeacherProgress(localProgress);
      updateTeacherStats(localProgress);
      return;
    }
    
    // Indlæs data fra Firebase
    console.log('🔍 Kalder getClassProgress...');
    getClassProgress(schoolId, classId).then(progress => {
      console.log('🔍 Fik progress data:', progress);
      displayTeacherProgress(progress);
      updateTeacherStats(progress);
    }).catch(error => {
      console.error('❌ Fejl ved indlæs af progress:', error);
    });
  }
  
  function displayTeacherProgress(progress) {
    const container = document.getElementById('teacherProgressList');
    
    if (progress.length === 0) {
      container.innerHTML = '<p class="muted">Ingen elev progress fundet for denne skole/klasse</p>';
      return;
    }
    
    const html = progress.map(item => `
      <div class="progress-item">
        <div class="student-name">${item.userFirstName} ${item.userLastName}</div>
        <div class="task-info">✅ ${item.taskName}</div>
        <div class="timestamp">Fuldført: ${item.completedAt}</div>
      </div>
    `).join('');
    
    container.innerHTML = html;
  }
  
  function updateTeacherStats(progress) {
    // Beregn statistikker
    const uniqueStudents = new Set(progress.map(p => p.userId)).size;
    const totalTasks = progress.length;
    const uniqueTasks = new Set(progress.map(p => p.taskId)).size;
    
    // Opdater UI
    document.getElementById('totalStudents').textContent = uniqueStudents;
    document.getElementById('totalTasks').textContent = totalTasks;
    document.getElementById('completionRate').textContent = uniqueTasks;
  }
  
  function checkTeacherLogin() {
    const isTeacherLoggedIn = localStorage.getItem('teacher_logged_in') === 'true';
    
    if (isTeacherLoggedIn) {
      // Vis lærer dashboard knap
      document.getElementById('btnTeacherTab').style.display = 'inline-block';
      document.getElementById('btnTeacherLogin').style.display = 'none';
      
      // Indlæs elev progress
      loadTeacherProgress();
    } else {
      // Skjul lærer dashboard og knap
      document.getElementById('view-teacher').style.display = 'none';
      document.getElementById('btnTeacherTab').style.display = 'none';
      document.getElementById('btnTeacherLogin').style.display = 'block';
    }
  }
  
  function doTeacherLogout() {
    console.log('🔍 doTeacherLogout kaldt - starter logout process');
    
    // Skjul lærer dashboard
    document.getElementById('view-teacher').style.display = 'none';
    document.getElementById('view-teacher').classList.remove('active');
    console.log('🔍 Lærer dashboard skjult');
    
    // Vis alle normale faner og views igen
    document.querySelector('.tabs').style.display = 'flex';
    document.querySelectorAll('.view').forEach(view => {
      if (view.id !== 'view-teacher') {
        // Brug CSS klasser i stedet for inline styles
        view.style.display = ''; // Fjern inline display style
        view.classList.remove('active'); // Fjern active fra alle views
      }
    });
    
    // Vis lærer login knap igen og skjul dashboard knap
    document.getElementById('btnTeacherLogin').style.display = 'block';
    document.getElementById('btnTeacherTab').style.display = 'none';
    console.log('🔍 Lærer login knap vist igen og dashboard knap skjult');
    
    // Skift til simulator fane og aktiver den
    if (typeof show === 'function') {
      show('view-sim');
      console.log('🔍 Skiftet til simulator fane med show');
    } else {
      // Fallback til manuelt fane skift
      document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('tabSim').classList.add('active');
      
      // Aktiver simulator view og deaktiver alle andre (kun med CSS klasser, ikke display)
      document.querySelectorAll('.view').forEach(view => {
        if (view.id === 'view-sim') {
          view.classList.add('active');
        } else if (view.id !== 'view-teacher') {
          view.classList.remove('active');
        }
      });
      console.log('🔍 Skiftet til simulator fane manuelt (fallback)');
    }
    
    // Ryd lærer login status
    localStorage.removeItem('teacher_logged_in');
    localStorage.removeItem('teacher_school_id');
    localStorage.removeItem('teacher_class_id');
    console.log('🔍 Lærer login status ryddet');
    
    alert('✅ Logget ud som lærer!');
    console.log('🔍 doTeacherLogout færdig');
  }

  // === KLASSE ADMINISTRATION ===
  
  async function createNewClass() {
    const schoolId = document.getElementById('newSchoolId').value.trim();
    const classId = document.getElementById('newClassId').value.trim();
    const className = document.getElementById('newClassName').value.trim();
    
    if (!schoolId || !classId) {
      alert('⚠️ Skole ID og Klasse ID er påkrævet!');
      return;
    }
    
    // Opret klasse objekt
    const newClass = {
      schoolId: schoolId,
      classId: classId,
      className: className || `${schoolId}_${classId}`,
      createdAt: new Date().toISOString(),
      teacherId: localStorage.getItem('teacher_logged_in') === 'true' ? 'teacher' : 'unknown'
    };

    // Tjek Firebase tilladelser først
    let firebaseAvailable = false;
    if (window.db && isFirebaseAvailable) {
      try {
        // Test Firebase tilladelser med en simpel læse-operation
        await window.db.collection('classes').limit(1).get();
        firebaseAvailable = true;
        console.log('✅ Firebase tilladelser OK');
      } catch (permissionError) {
        console.warn('⚠️ Firebase tilladelser mangler:', permissionError.message);
        firebaseAvailable = false;
      }
    }
    
    try {
      // Gem i Firebase hvis tilgængelig
      if (window.db && isFirebaseAvailable) {
        try {
          console.log('🌐 Gemmer klasse i Firebase...');
          await window.db.collection('classes').add(newClass);
          console.log('✅ Klasse gemt i Firebase');
          newClass.firebaseId = true; // Marker som gemt i Firebase
        } catch (firebaseError) {
          console.warn('⚠️ Firebase fejl - bruger localStorage som fallback:', firebaseError.message);
          newClass.firebaseId = false;
        }
      }
      
      // Gem også lokalt som backup
      const existingClasses = JSON.parse(localStorage.getItem('smarthome_classes') || '[]');
      
      // Tjek om klassen allerede eksisterer
      const classExists = existingClasses.some(cls => 
        cls.schoolId === schoolId && cls.classId === classId
      );
      
      if (classExists) {
        alert('⚠️ Denne klasse eksisterer allerede!');
        return;
      }
      
      existingClasses.push(newClass);
      localStorage.setItem('smarthome_classes', JSON.stringify(existingClasses));
      
      // Ryd input felter
      document.getElementById('newSchoolId').value = '';
      document.getElementById('newClassId').value = '';
      document.getElementById('newClassName').value = '';
      
      // Opdater liste over eksisterende klasser
      await loadExistingClasses();
      
      alert(`✅ Klasse "${newClass.className}" oprettet!\n\nSkole: ${schoolId}\nKlasse: ${classId}\n\n${window.db && isFirebaseAvailable ? '🌐 Gemt i skyen' : '💾 Gemt lokalt'}`);
      
      console.log('🏫 Ny klasse oprettet:', newClass);
      
    } catch (error) {
      console.error('❌ Fejl ved oprettelse af klasse:', error);
      alert(`❌ Fejl ved oprettelse af klasse: ${error.message}`);
    }
  }
  
  async function switchToClass(schoolId, classId) {
    // Opdater lærer's nuværende klasse
    localStorage.setItem('teacher_school_id', schoolId);
    localStorage.setItem('teacher_class_id', classId);
    
    // Opdater input felter
    document.getElementById('teacherSchoolId').value = schoolId;
    document.getElementById('newSchoolId').value = schoolId;
    document.getElementById('teacherClassId').value = classId;
    document.getElementById('newClassId').value = classId;
    
    // Opdater lærer dropdown menuer
    await loadSchoolsForTeachers();
    
    // Indlæs elev progress for den nye klasse
    await loadTeacherProgress();
    
    alert(`🔄 Skiftet til klasse: ${schoolId}/${classId}`);
    
    console.log('🔄 Skiftet til klasse:', { schoolId, classId });
  }
  
  async function loadExistingClasses() {
    const container = document.getElementById('existingClassesList');
    container.innerHTML = '<p class="muted">Indlæser klasser...</p>';
    
    try {
      let allClasses = [];
      
      // Hent fra Firebase hvis tilgængelig
      if (window.db && isFirebaseAvailable) {
        console.log('🌐 Henter klasser fra Firebase...');
        try {
          const snapshot = await window.db.collection('classes').get();
          const firebaseClasses = snapshot.docs.map(doc => ({
            ...doc.data(),
            id: doc.id,
            firebaseId: true
          }));
          allClasses = allClasses.concat(firebaseClasses);
          console.log('✅ Hentet', firebaseClasses.length, 'klasser fra Firebase');
        } catch (error) {
          console.warn('⚠️ Kunne ikke hente fra Firebase - bruger kun localStorage:', error.message);
          // Fortsæt med kun localStorage data
        }
      }
      
      // Hent fra localStorage som backup
      const localClasses = JSON.parse(localStorage.getItem('smarthome_classes') || '[]');
      allClasses = allClasses.concat(localClasses);
      
      // Fjern duplikater baseret på schoolId + classId
      const uniqueClasses = [];
      const seen = new Set();
      
      allClasses.forEach(cls => {
        const key = `${cls.schoolId}_${cls.classId}`;
        if (!seen.has(key)) {
          seen.add(key);
          uniqueClasses.push(cls);
        }
      });
      
      if (uniqueClasses.length === 0) {
        container.innerHTML = '<p class="muted">Ingen klasser oprettet endnu</p>';
        return;
      }
      
      // Sorter efter oprettelsesdato (nyeste først)
      uniqueClasses.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      const html = uniqueClasses.map(cls => `
        <div class="class-item" style="
          padding: 12px; 
          background: rgba(15, 20, 28, 0.8); 
          border: 1px solid #2a3442; 
          border-radius: 8px; 
          margin-bottom: 8px;
          display: flex;
          justify-content: space-between;
          align-items: center;
        ">
          <div>
            <strong>${cls.className}</strong><br>
            <small style="color: #9ca3af;">${cls.schoolId} / ${cls.classId}</small><br>
            <small style="color: #6b7280;">Oprettet: ${new Date(cls.createdAt).toLocaleDateString('da-DK')}</small>
            ${cls.id ? '<br><small style="color: #059669;">🌐 Sky</small>' : '<br><small style="color: #6b7280;">💾 Lokal</small>'}
          </div>
          <div>
            <button onclick="switchToClass('${cls.schoolId}', '${cls.classId}')" 
                    style="
                      background: #10b981; 
                      color: white; 
                      border: none; 
                      padding: 6px 12px; 
                      border-radius: 4px; 
                      cursor: pointer;
                      font-size: 12px;
                      margin-right: 8px;
                    ">
              🔄 Skift til
            </button>
            ${cls.id ? `
              <button onclick="deleteClass('${cls.schoolId}', '${cls.classId}', '${cls.id}')" 
                      style="
                        background: #ef4444; 
                        color: white; 
                        border: none; 
                        padding: 6px 12px; 
                        border-radius: 4px; 
                        cursor: pointer;
                        font-size: 12px;
                      ">
                🗑️ Slet
              </button>
            ` : ''}
          </div>
        </div>
      `).join('');
      
      container.innerHTML = html;
      
    } catch (error) {
      console.error('❌ Fejl ved indlæsning af klasser:', error);
      container.innerHTML = '<p class="muted">Fejl ved indlæsning af klasser</p>';
    }
  }

  // Funktion til at rydde alle klasser
  async function clearAllClasses() {
    if (!confirm('⚠️ Er du sikker på at du vil slette ALLE klasser?\n\nDette kan ikke fortrydes og vil påvirke alle brugere!')) {
      return;
    }
    
    try {
      // Slet fra Firebase hvis tilgængelig
      if (window.db && isFirebaseAvailable) {
        try {
          console.log('🌐 Sletter alle klasser fra Firebase...');
          const snapshot = await window.db.collection('classes').get();
          const deletePromises = snapshot.docs.map(doc => doc.ref.delete());
          await Promise.all(deletePromises);
          console.log('✅ Alle klasser slettet fra Firebase');
        } catch (firebaseError) {
          console.warn('⚠️ Firebase fejl ved sletning - fortsætter med lokal sletning:', firebaseError.message);
        }
      }
      
      // Slet fra localStorage
      localStorage.removeItem('smarthome_classes');
      
      // Opdater liste
      await loadExistingClasses();
      
      alert('✅ Alle klasser er slettet!');
      
      console.log('🗑️ Alle klasser slettet');
      
    } catch (error) {
      console.error('❌ Fejl ved sletning af alle klasser:', error);
      alert(`❌ Fejl ved sletning af alle klasser: ${error.message}`);
    }
  }
  
  async function deleteClass(schoolId, classId, firebaseId = null) {
    if (!confirm(`⚠️ Er du sikker på at du vil slette klassen ${schoolId}/${classId}?\n\nDette kan ikke fortrydes!`)) {
      return;
    }
    
    try {
      // Slet fra Firebase hvis tilgængelig
      if (firebaseId && window.db && isFirebaseAvailable) {
        try {
          console.log('🌐 Sletter klasse fra Firebase...');
          await window.db.collection('classes').doc(firebaseId).delete();
          console.log('✅ Klasse slettet fra Firebase');
        } catch (firebaseError) {
          console.warn('⚠️ Firebase fejl ved sletning - fortsætter med lokal sletning:', firebaseError.message);
        }
      }
      
      // Slet fra localStorage
      const existingClasses = JSON.parse(localStorage.getItem('smarthome_classes') || '[]');
      const updatedClasses = existingClasses.filter(cls => 
        !(cls.schoolId === schoolId && cls.classId === classId)
      );
      
      localStorage.setItem('smarthome_classes', JSON.stringify(updatedClasses));
      
      // Opdater liste
      await loadExistingClasses();
      
      alert(`✅ Klasse ${schoolId}/${classId} slettet!`);
      
      console.log('🗑️ Klasse slettet:', { schoolId, classId, firebaseId });
      
    } catch (error) {
      console.error('❌ Fejl ved sletning af klasse:', error);
      alert(`❌ Fejl ved sletning af klasse: ${error.message}`);
    }
  }

  // === LÆRER KLASSE VÆLGER ===
  
  async function loadSchoolsForTeachers() {
    const schoolSelect = document.getElementById('teacherSchoolId');
    const classSelect = document.getElementById('teacherClassId');
    
    if (!schoolSelect || !classSelect) return;
    
    try {
      let allClasses = [];
      
      // Hent fra Firebase hvis tilgængelig
      if (window.db && isFirebaseAvailable) {
        try {
          console.log('🌐 Henter skoler fra Firebase for lærer...');
          const snapshot = await window.db.collection('classes').get();
          const firebaseClasses = snapshot.docs.map(doc => ({
            ...doc.data(),
            id: doc.id
          }));
          allClasses = allClasses.concat(firebaseClasses);
          console.log('✅ Hentet', firebaseClasses.length, 'klasser fra Firebase');
        } catch (error) {
          console.warn('⚠️ Kunne ikke hente fra Firebase - bruger kun localStorage:', error.message);
        }
      }
      
      // Hent fra localStorage som backup
      const localClasses = JSON.parse(localStorage.getItem('smarthome_classes') || '[]');
      allClasses = allClasses.concat(localClasses);
      
      // Fjern duplikater og få unikke skoler
      const uniqueSchools = [...new Set(allClasses.map(cls => cls.schoolId))];
      uniqueSchools.sort(); // Sorter alfabetisk
      
      // Opdater skole dropdown
      schoolSelect.innerHTML = '<option value="">Vælg skole</option>';
      uniqueSchools.forEach(schoolId => {
        const option = document.createElement('option');
        option.value = schoolId;
        option.textContent = schoolId === 'default' ? 'Standard' : schoolId;
        schoolSelect.appendChild(option);
      });
      
      // Tilføj event listener til skole dropdown
      schoolSelect.onchange = function() {
        loadClassesForTeacherSchool(this.value);
      };
      
      // Indlæs gemt skole hvis den findes
      const savedTeacherSchool = localStorage.getItem('teacher_school_id');
      if (savedTeacherSchool) {
        schoolSelect.value = savedTeacherSchool;
        loadClassesForTeacherSchool(savedTeacherSchool);
      }
      
    } catch (error) {
      console.error('❌ Fejl ved indlæsning af skoler for lærer:', error);
      schoolSelect.innerHTML = '<option value="">Fejl ved indlæsning</option>';
    }
  }
  
  async function loadClassesForTeacherSchool(schoolId) {
    const classSelect = document.getElementById('teacherClassId');
    if (!classSelect || !schoolId) return;
    
    try {
      let allClasses = [];
      
      // Hent fra Firebase hvis tilgængelig
      if (window.db && isFirebaseAvailable) {
        try {
          const snapshot = await window.db.collection('classes').get();
          const firebaseClasses = snapshot.docs.map(doc => ({
            ...doc.data(),
            id: doc.id
          }));
          allClasses = allClasses.concat(firebaseClasses);
        } catch (error) {
          console.warn('⚠️ Kunne ikke hente klasser fra Firebase:', error.message);
        }
      }
      
      // Hent fra localStorage som backup
      const localClasses = JSON.parse(localStorage.getItem('smarthome_classes') || '[]');
      allClasses = allClasses.concat(localClasses);
      
      // Filtrer klasser for den valgte skole
      const schoolClasses = allClasses.filter(cls => cls.schoolId === schoolId);
      schoolClasses.sort((a, b) => a.classId.localeCompare(b.classId)); // Sorter alfabetisk
      
      // Opdater klasse dropdown
      classSelect.innerHTML = '<option value="">Vælg klasse</option>';
      schoolClasses.forEach(cls => {
        const option = document.createElement('option');
        option.value = cls.classId;
        option.textContent = cls.classId === 'default' ? 'Standard' : cls.classId;
        if (cls.className && cls.className !== `${cls.schoolId}_${cls.classId}`) {
          option.textContent += ` - ${cls.className}`;
        }
        classSelect.appendChild(option);
      });
      
      // Indlæs gemt klasse hvis den findes
      const savedTeacherClass = localStorage.getItem('teacher_class_id');
      if (savedTeacherClass) {
        classSelect.value = savedTeacherClass;
      }
      
    } catch (error) {
      console.error('❌ Fejl ved indlæsning af klasser for lærer:', error);
      classSelect.innerHTML = '<option value="">Fejl ved indlæsning</option>';
    }
  }

  // === ELEV KLASSE VÆLGER ===
  
  async function loadSchoolsForStudents() {
    const schoolSelect = document.getElementById('setSchoolId');
    const classSelect = document.getElementById('setClassId');
    
    if (!schoolSelect || !classSelect) return;
    
    try {
      let allClasses = [];
      
      // Hent fra Firebase hvis tilgængelig
      if (window.db && isFirebaseAvailable) {
        try {
          console.log('🌐 Henter skoler fra Firebase for elever...');
          const snapshot = await window.db.collection('classes').get();
          const firebaseClasses = snapshot.docs.map(doc => ({
            ...doc.data(),
            id: doc.id
          }));
          allClasses = allClasses.concat(firebaseClasses);
          console.log('✅ Hentet', firebaseClasses.length, 'klasser fra Firebase');
        } catch (error) {
          console.warn('⚠️ Kunne ikke hente fra Firebase - bruger kun localStorage:', error.message);
        }
      }
      
      // Hent fra localStorage som backup
      const localClasses = JSON.parse(localStorage.getItem('smarthome_classes') || '[]');
      allClasses = allClasses.concat(localClasses);
      
      // Fjern duplikater og få unikke skoler
      const uniqueSchools = [...new Set(allClasses.map(cls => cls.schoolId))];
      uniqueSchools.sort(); // Sorter alfabetisk
      
      // Opdater skole dropdown
      schoolSelect.innerHTML = '<option value="">Vælg din skole</option>';
      uniqueSchools.forEach(schoolId => {
        const option = document.createElement('option');
        option.value = schoolId;
        option.textContent = schoolId === 'default' ? 'Standard' : schoolId;
        schoolSelect.appendChild(option);
      });
      
      // Tilføj event listener til skole dropdown
      schoolSelect.onchange = function() {
        loadClassesForSchool(this.value);
      };
      
      // Indlæs gemt skole hvis den findes
      const savedStudent = JSON.parse(localStorage.getItem('student_name') || '{}');
      if (savedStudent.schoolId) {
        schoolSelect.value = savedStudent.schoolId;
        loadClassesForSchool(savedStudent.schoolId);
      }
      
    } catch (error) {
      console.error('❌ Fejl ved indlæsning af skoler:', error);
      schoolSelect.innerHTML = '<option value="">Fejl ved indlæsning</option>';
    }
  }
  
  async function loadClassesForSchool(schoolId) {
    const classSelect = document.getElementById('setClassId');
    if (!classSelect || !schoolId) return;
    
    try {
      let allClasses = [];
      
      // Hent fra Firebase hvis tilgængelig
      if (window.db && isFirebaseAvailable) {
        try {
          const snapshot = await window.db.collection('classes').get();
          const firebaseClasses = snapshot.docs.map(doc => ({
            ...doc.data(),
            id: doc.id
          }));
          allClasses = allClasses.concat(firebaseClasses);
        } catch (error) {
          console.warn('⚠️ Kunne ikke hente klasser fra Firebase:', error.message);
        }
      }
      
      // Hent fra localStorage som backup
      const localClasses = JSON.parse(localStorage.getItem('smarthome_classes') || '[]');
      allClasses = allClasses.concat(localClasses);
      
      // Filtrer klasser for den valgte skole
      const schoolClasses = allClasses.filter(cls => cls.schoolId === schoolId);
      schoolClasses.sort((a, b) => a.classId.localeCompare(b.classId)); // Sorter alfabetisk
      
      // Opdater klasse dropdown
      classSelect.innerHTML = '<option value="">Vælg din klasse</option>';
      schoolClasses.forEach(cls => {
        const option = document.createElement('option');
        option.value = cls.classId;
        option.textContent = cls.classId === 'default' ? 'Standard' : cls.classId;
        if (cls.className && cls.className !== `${cls.schoolId}_${cls.classId}`) {
          option.textContent += ` - ${cls.className}`;
        }
        classSelect.appendChild(option);
      });
      
      // Indlæs gemt klasse hvis den findes
      const savedStudent = JSON.parse(localStorage.getItem('student_name') || '{}');
      if (savedStudent.classId && savedStudent.schoolId === schoolId) {
        classSelect.value = savedStudent.classId;
      }
      
    } catch (error) {
      console.error('❌ Fejl ved indlæsning af klasser:', error);
      classSelect.innerHTML = '<option value="">Fejl ved indlæsning</option>';
    }
  }
  


  // === Firebase konfiguration ===
  console.log('🔍 Firebase konfiguration startet');
  
  // Force 3-column layout for learning page
  function forceLearningLayout() {
    const learningWrap = document.getElementById('learning-wrap');
    if (learningWrap) {
      learningWrap.style.display = 'grid';
      learningWrap.style.gridTemplateColumns = '1fr 1fr 1fr';
      learningWrap.style.gap = '24px';
      learningWrap.style.width = '100%';
      console.log('🔧 Forced 3-column layout for learning page');
    }
  }
  
  // Run when learning page is shown
  document.addEventListener('DOMContentLoaded', function() {
    // Check if we're on learning page
    if (window.location.hash === '#learning' || document.querySelector('#view-learning.active')) {
      setTimeout(forceLearningLayout, 100);
    }
  });
  // Firebase konfiguration (kun til progress tracking)
  const firebaseConfig = {
    apiKey: "AIzaSyCdXnszAUJfkC5uyv9n-kVE2Whv_0vZfLk",
    authDomain: "ibi-simulator-f6ebe.firebaseapp.com",
    projectId: "ibi-simulator-f6ebe",
    storageBucket: "ibi-simulator-f6ebe.firebasestorage.app",
    messagingSenderId: "929875729041",
    appId: "1:929875729041:web:d53f21685b20d63fb73d30",
    measurementId: "G-YR3XWP3RVH"
  };

  // Tjek om vi kører lokalt (file:// eller localhost)
  const isLocalEnvironment = window.location.protocol === 'file:' || 
                           window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1';

  // Tjek om Firebase er tilgængelig og fungerer
  let isFirebaseAvailable = false;
  let firebaseErrorCount = 0;
  const MAX_FIREBASE_ERRORS = 3;

  // Log miljø status
  if (isLocalEnvironment) {
    console.log('🏠 Kører lokalt - Firebase er deaktiveret for at undgå fejl');
    console.log('💡 Opgave fremskridt gemmes kun lokalt i browser');
  } else {
    console.log('🌐 Kører online - Firebase er aktiveret for progress tracking');
  }

  // Funktion til at tjekke Firebase status
  function checkFirebaseStatus() {
    if (isLocalEnvironment) return false;
    
    // Hvis vi har haft for mange fejl, deaktiver Firebase
    if (firebaseErrorCount >= MAX_FIREBASE_ERRORS) {
      console.log('⚠️ For mange Firebase fejl - deaktiverer Firebase og bruger kun localStorage');
      isFirebaseAvailable = false;
      return false;
    }
    
    return isFirebaseAvailable;
  }

  // Funktion til at registrere Firebase fejl
  function registerFirebaseError(error) {
    firebaseErrorCount++;
    console.log(`❌ Firebase fejl #${firebaseErrorCount}/${MAX_FIREBASE_ERRORS}`);
    
    // Log detaljerede fejl oplysninger
    if (error) {
      console.log('🔍 Fejl type:', error.code || 'ukendt');
      console.log('🔍 Fejl besked:', error.message || 'ingen besked');
      console.log('🔍 Fejl detaljer:', error);
      
      // Hvis det er permission-denied, tjek regler
      if (error.code === 'permission-denied') {
        console.log('🚫 Permission denied - tjek Firebase sikkerhedsregler');
        console.log('💡 Gå til Firebase Console → Firestore → Rules');
        console.log('💡 Sørg for at user_progress collection har tilladelse');
      }
    }
    
    if (firebaseErrorCount >= MAX_FIREBASE_ERRORS) {
      console.log('🚫 Firebase deaktiveret på grund af gentagne fejl');
      isFirebaseAvailable = false;
    }
  }

  // Funktion til at vise tema lås op notifikation
  function showThemeUnlockNotification() {
    // Opret notifikation element
    const notification = document.createElement('div');
    notification.className = 'theme-unlock-notification';
    notification.innerHTML = `
      <div class="notification-content">
        <div class="notification-icon">🎨</div>
        <div class="notification-text">
          <div class="notification-title">Yellow Tema Låst Op!</div>
          <div class="notification-subtitle">Du har gennemført alle nemme opgaver</div>
        </div>
        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
      </div>
    `;
    
    // Tilføj til body
    document.body.appendChild(notification);
    
    // Fjern automatisk efter 5 sekunder
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, 5000);
    
    // Log til console
    console.log('🎨 Yellow tema låst op! Gå til indstillinger for at aktivere det.');
  }

  // === HOME SMART HOME SIMULATOR FUNKTIONALITET ===
  
  // Smart Home state
  const smartHomeState = {
    lights: {
      living: false,
      bedroom1: false,
      bedroom2: false,
      kitchen: false
    },
    security: {
      camera: false,
      lock: false
    },
    entertainment: {
      tv: false,
      speaker: false
    },
    climate: {
      temperature: 72
    },
    weather: {
      temperature: 72,
      condition: 'partly-cloudy'
    }
  };

  // Funktion til at vise HOME dashboard
  function showHomeDashboard() {
    // Skjul alle andre views og fjern active klasse
    document.querySelectorAll('.view').forEach(view => {
      view.style.display = 'none';
      view.classList.add('hidden');
      view.classList.remove('active');
    });
    
    // Vis HOME view og tilføj active klasse
    const homeView = document.getElementById('view-home');
    homeView.style.display = 'block';
    homeView.classList.remove('hidden');
    homeView.classList.add('active');
    
    // Opdater tid og vejr
    updateHomeTime();
    updateHomeWeather();
    
    // Opdater alle enheder baseret på state
    updateAllDevices();
    
    // Vis velkomst notifikation
    showHomeWelcomeNotification();
    
    console.log('🏠 HOME dashboard åbnet');
  }
  
  // Funktion til at skjule HOME view helt
  function hideHomeView() {
    const homeView = document.getElementById('view-home');
    if (homeView) {
      homeView.style.display = 'none';
      homeView.classList.add('hidden');
      homeView.classList.remove('active');
      homeView.style.zIndex = '-999';
    }
  }

  // Toggle funktioner for Home fanen
  function showFloorPlan() {
    // Vis plantegning, skjul rule builder
    document.getElementById('home-floor-plan').style.display = 'flex';
    document.getElementById('home-rule-builder').style.display = 'none';
    
    // Opdater toggle knapper
    const floorBtn = document.getElementById('home-floor-plan-btn');
    const ruleBtn = document.getElementById('home-rule-builder-btn');
    
    floorBtn.style.background = '#10b981';
    floorBtn.style.color = 'white';
    floorBtn.style.border = 'none';
    
    ruleBtn.style.background = 'rgba(15, 20, 28, 0.8)';
    ruleBtn.style.color = '#e5e9f0';
    ruleBtn.style.border = '1px solid #2a3442';
    
    console.log('🏠 Floor plan mode activated');
  }

  function showRuleBuilder() {
    // Skjul plantegning, vis rule builder
    document.getElementById('home-floor-plan').style.display = 'none';
    document.getElementById('home-rule-builder').style.display = 'block';
    
    // Opdater toggle knapper
    const floorBtn = document.getElementById('home-floor-plan-btn');
    const ruleBtn = document.getElementById('home-rule-builder-btn');
    
    ruleBtn.style.background = '#10b981';
    ruleBtn.style.color = 'white';
    ruleBtn.style.border = 'none';
    
    floorBtn.style.background = 'rgba(15, 20, 28, 0.8)';
    floorBtn.style.color = '#e5e9f0';
    floorBtn.style.border = '1px solid #2a3442';
    
    console.log('🧩 Rule builder mode activated');
  }

  // Opdater klokkeslæt
  function updateHomeTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', {
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
    
    const timeElement = document.getElementById('homeTime');
    if (timeElement) {
      timeElement.textContent = timeString;
    }
  }

  // Opdater vejr (dummy data)
  function updateHomeWeather() {
    const weatherTemp = document.querySelector('.weather-temp');
    if (weatherTemp) {
      weatherTemp.textContent = `${smartHomeState.weather.temperature}°F`;
    }
  }

  // Opdater alle enheder baseret på state
  function updateAllDevices() {
    // Opdater kontrolpanel
    updateControlPanel();
  }

  // Placeholder funktioner - fjernet da vi ikke har enheder endnu

  // Opdater kontrolpanel
  function updateControlPanel() {
    // Ingen kontrolpanel opdateringer endnu
  }

  // Event listeners for kontrolpanel
  function setupHomeEventListeners() {
    // Ingen event listeners endnu

    // Lys toggles
    Object.keys(smartHomeState.lights).forEach(room => {
      const toggle = document.getElementById(`light${room.charAt(0).toUpperCase() + room.slice(1)}`);
      if (toggle) {
        toggle.addEventListener('change', function() {
          smartHomeState.lights[room] = this.checked;
          updateLightIcon(room, this.checked);
          console.log(`💡 ${room} lys ${this.checked ? 'tændt' : 'slukket'}`);
        });
      }
    });

    // Sikkerhed toggles
    const cameraToggle = document.getElementById('cameraLiving');
    if (cameraToggle) {
      cameraToggle.addEventListener('change', function() {
        smartHomeState.security.camera = this.checked;
        updateSecurityIcon('camera', this.checked);
        console.log(`📹 Kamera ${this.checked ? 'aktiveret' : 'deaktiveret'}`);
      });
    }

    const lockToggle = document.getElementById('lockKitchen');
    if (lockToggle) {
      lockToggle.addEventListener('change', function() {
        smartHomeState.security.lock = this.checked;
        updateSecurityIcon('lock', this.checked);
        console.log(`🔒 Dørlås ${this.checked ? 'låst' : 'ulåst'}`);
      });
    }

    // Underholdning toggles
    const tvToggle = document.getElementById('tvBedroom2');
    if (tvToggle) {
      tvToggle.addEventListener('change', function() {
        smartHomeState.entertainment.tv = this.checked;
        updateEntertainmentIcon('tv', this.checked);
        console.log(`📺 TV ${this.checked ? 'tændt' : 'slukket'}`);
      });
    }

    const speakerToggle = document.getElementById('speakerStudy');
    if (speakerToggle) {
      speakerToggle.addEventListener('change', function() {
        smartHomeState.entertainment.speaker = this.checked;
        updateEntertainmentIcon('speaker', this.checked);
        console.log(`🔊 Højttaler ${this.checked ? 'tændt' : 'slukket'}`);
      });
    }

    // Enhed ikon klik events
    document.querySelectorAll('.device-icon').forEach(icon => {
      icon.addEventListener('click', function() {
        const device = this.dataset.device;
        const room = this.dataset.room;
        
        if (device === 'light') {
          // Toggle lys
          smartHomeState.lights[room] = !smartHomeState.lights[room];
          updateLightIcon(room, smartHomeState.lights[room]);
          
          // Opdater toggle i kontrolpanel
          const toggle = document.getElementById(`light${room.charAt(0).toUpperCase() + room.slice(1)}`);
          if (toggle) toggle.checked = smartHomeState.lights[room];
          
          console.log(`💡 ${room} lys ${smartHomeState.lights[room] ? 'tændt' : 'slukket'} via ikon`);
        }
      });
    });
  }

  // Action button funktioner
  function toggleAllLights() {
    const allLightsOn = Object.values(smartHomeState.lights).every(light => light);
    
    Object.keys(smartHomeState.lights).forEach(room => {
      smartHomeState.lights[room] = !allLightsOn;
      updateLightIcon(room, smartHomeState.lights[room]);
    });
    
    updateControlPanel();
    console.log(`💡 Alle lys ${allLightsOn ? 'slukket' : 'tændt'}`);
  }

  function setNightMode() {
    // Sluk alle lys undtagen ganglys
    Object.keys(smartHomeState.lights).forEach(room => {
      smartHomeState.lights[room] = false;
      updateLightIcon(room, false);
    });
    
    // Aktiver sikkerhed
    smartHomeState.security.camera = true;
    smartHomeState.security.lock = true;
    
    // Sluk underholdning
    smartHomeState.entertainment.tv = false;
    smartHomeState.entertainment.speaker = false;
    
    // Sæt temperatur til nat
    smartHomeState.climate.temperature = 68;
    
    updateAllDevices();
    console.log('🌙 Nat tilstand aktiveret');
  }

  function setAwayMode() {
    // Sluk alle lys
    Object.keys(smartHomeState.lights).forEach(room => {
      smartHomeState.lights[room] = false;
      updateLightIcon(room, false);
    });
    
    // Aktiver sikkerhed
    smartHomeState.security.camera = true;
    smartHomeState.security.lock = true;
    
    // Sluk underholdning
    smartHomeState.entertainment.tv = false;
    smartHomeState.entertainment.speaker = false;
    
    // Sæt temperatur til bort fra hjem
    smartHomeState.climate.temperature = 65;
    
    updateAllDevices();
    console.log('🚪 Bort fra hjem tilstand aktiveret');
  }

  // Start HOME funktionalitet når DOM er klar
  document.addEventListener('DOMContentLoaded', function() {
    setupHomeEventListeners();
    
    // Opdater tid hver minut
    setInterval(updateHomeTime, 60000);
    
    // Simuler vejr ændringer
    setInterval(() => {
      smartHomeState.weather.temperature += Math.random() > 0.5 ? 1 : -1;
      smartHomeState.weather.temperature = Math.max(65, Math.min(85, smartHomeState.weather.temperature));
      updateHomeWeather();
    }, 300000); // Hver 5. minut
  });

  // Vis velkomst notifikation for HOME
  function showHomeWelcomeNotification() {
    const notification = document.createElement('div');
    notification.className = 'home-welcome-notification';
    notification.innerHTML = `
      <div class="notification-content">
        <div class="notification-icon">🏠</div>
        <div class="notification-text">
          <div class="notification-title">Velkommen til Smart Home!</div>
          <div class="notification-subtitle">Klik på ikoner eller brug kontrolpanelet</div>
        </div>
        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
      </div>
    `;
    
    // Tilføj til body
    document.body.appendChild(notification);
    
    // Fjern automatisk efter 4 sekunder
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, 4000);
  }



  // Initialiser Firebase Firestore når DOM er klar
  function initializeFirestore() {
    try {
      // Hvis vi kører lokalt, deaktiver Firebase for at undgå fejl
      if (isLocalEnvironment) {
        console.log('🏠 Kører lokalt - deaktiverer Firebase for at undgå fejl');
        window.db = null;
        return false;
      }
      
      console.log('🔍 Firebase Firestore object tilgængelig:', typeof firebase);
      
      if (typeof firebase === 'undefined') {
        console.error('❌ Firebase SDK ikke indlæst endnu');
        return false;
      }

      console.log('🚀 Initialiserer Firebase Firestore...');
      firebase.initializeApp(firebaseConfig);
      console.log('✅ Firebase app initialiseret');
      
      const db = firebase.firestore();
      console.log('✅ Firestore database klar til progress tracking');
      
      // Gør Firestore tilgængeligt globalt
      window.db = db;
      
      // Marker Firebase som tilgængelig
      isFirebaseAvailable = true;
      
      // Firestore er klar til progress tracking
      console.log('✅ Firestore er klar til progress tracking!');
      
      // Gør clearLocalStorage tilgængelig fra console
      window.clearLocalStorage = clearLocalStorage;
      console.log('💡 Skriv "clearLocalStorage()" i console for at rydde localStorage');
        
      return true;
    } catch (error) {
      console.error('❌ Firebase initialisering fejlede:', error);
      return false;
    }
  }

  // Vent på at DOM og Firebase SDK er klar
  document.addEventListener('DOMContentLoaded', function() {
    // Hvis vi kører lokalt, skip Firebase initialisering
    if (isLocalEnvironment) {
      console.log('🏠 Kører lokalt - skipper Firebase initialisering');
      return;
    }
    
    // Prøv at initialisere Firestore med 100ms forsinkelse
    setTimeout(() => {
      if (!initializeFirestore()) {
        console.log('🔄 Prøver igen om 500ms...');
        setTimeout(initializeFirestore, 500);
      }
    }, 100);
  });

  // === localStorage Management ===
  function showClearStorageButton() {
    const clearButton = document.getElementById('clearStorageBtn');
    if (clearButton) {
      clearButton.style.display = 'block';
      clearButton.onclick = clearLocalStorage;
    }
  }
  
  function clearLocalStorage() {
    if (confirm('⚠️ Er du sikker på at du vil slette ALLE brugere fra localStorage?\n\nDette kan ikke fortrydes!')) {
      // Slet alle bruger-relaterede data
              localStorage.removeItem('smarthome_simulator_users');
      localStorage.removeItem('simUser');
      localStorage.removeItem('simPass');
      localStorage.removeItem('pending_sync');
      localStorage.removeItem('studentNames');
      
      console.log('🗑️ localStorage ryddet for alle brugerdata');
      alert('✅ Alle brugere er slettet fra localStorage!\n\nDu kan nu oprette nye brugere lokalt.');
      
      // Skjul knappen igen
      const clearButton = document.getElementById('clearStorageBtn');
      if (clearButton) {
        clearButton.style.display = 'none';
      }
      
      // Genindlæs siden for at nulstille alt
      location.reload();
    }
  }

  // === Cloud Database funktionalitet ===
           async function saveUserProgress(userId, taskId, taskName, completedAt, currentUser) {
           try {
             console.log('🚀 saveUserProgress kaldt med data:', { userId, taskId, taskName, completedAt, currentUser });
      
      // Hvis vi kører lokalt eller Firebase er deaktiveret, brug kun localStorage
      if (isLocalEnvironment || !checkFirebaseStatus()) {
        console.log('🏠 Kører lokalt eller Firebase deaktiveret - bruger kun localStorage');
        saveToLocalStorage(userId, taskId, taskName, completedAt, currentUser);
        return true;
      }
      
      if (!window.db) {
        console.error('❌ Firebase database ikke tilgængelig - window.db er undefined');
        console.log('🔍 window.db:', window.db);
        console.log('🔍 window.firebase:', window.firebase);
        saveToLocalStorage(userId, taskId, taskName, completedAt, currentUser);
        return false;
      }
      
      console.log('🔍 Firebase database tilgængelig, forsøger at gemme...');
      
                       // Hent elevens klasse information
                       const studentInfo = JSON.parse(localStorage.getItem('student_name') || '{}');
                       const studentSchoolId = studentInfo.schoolId || 'default';
                       const studentClassId = studentInfo.classId || 'default';
                       
                       await window.db.collection('user_progress').add({
          userId: userId,
          userFirstName: currentUser.firstName || 'Ukendt',
          userLastName: currentUser.lastName || 'Bruger',
          userEmail: currentUser.email || 'ingen@email.dk',
          taskId: taskId,
          taskName: taskName,
          completedAt: completedAt,
          timestamp: new Date().toISOString(),
          schoolId: studentSchoolId,
          classId: studentClassId
        });
      console.log('✅ Progress gemt i cloud database');
      return true;
    } catch (error) {
      console.error('❌ Fejl ved gem af progress:', error);
      console.log('🔍 Fejl detaljer:', error.message, error.stack);
      
      // Registrer Firebase fejl
      registerFirebaseError(error);
      
      // Fallback til localStorage hvis cloud fejler
      saveToLocalStorage(userId, taskId, taskName, completedAt, currentUser);
      return false;
    }
  }

           function saveToLocalStorage(userId, taskId, taskName, completedAt, currentUser) {
           // Gem til bruger-specifik localStorage
           const userProgress = JSON.parse(localStorage.getItem(`user_${userId}_progress`) || '{}');
           
           // Tilføj til eksisterende completedTasks hvis de findes
           if (userProgress.completedTasks) {
             userProgress.completedTasks.push({
               taskId: taskId,
               taskName: taskName,
               completedAt: completedAt,
               timestamp: new Date().toISOString()
             });
           } else {
             userProgress.completedTasks = [{
               taskId: taskId,
               taskName: taskName,
               completedAt: completedAt,
               timestamp: new Date().toISOString()
             }];
           }
           
           localStorage.setItem(`user_${userId}_progress`, JSON.stringify(userProgress));
           console.log('💾 Progress gemt lokalt til bruger-specifik storage');
           
           // Opret pending_sync data med elevens navn
           const pendingSync = JSON.parse(localStorage.getItem('pending_sync') || '[]');
           pendingSync.push({
             userId: userId,
             userFirstName: currentUser.firstName || 'Ukendt',
             userLastName: currentUser.lastName || 'Bruger',
             userEmail: currentUser.email || 'ingen@email.dk',
             taskId: taskId,
             taskName: taskName,
             completedAt: completedAt,
             timestamp: new Date().toISOString()
           });
           localStorage.setItem('pending_sync', JSON.stringify(pendingSync));
           console.log('📝 Pending sync data oprettet med elevens navn:', currentUser.firstName, currentUser.lastName);
           
           // Prøv at synce data til cloud hvis online
           if (navigator.onLine && !isLocalEnvironment) {
             console.log('🌐 Online - forsøger at synce pending data');
             setTimeout(() => syncPendingData(), 1000); // Vent 1 sekund før sync
           }
         }

  async function syncPendingData() {
    // Hvis vi kører lokalt, skip sync
    if (isLocalEnvironment) {
      console.log('🏠 Kører lokalt - skipper Firebase sync');
      return;
    }
    
    if (!navigator.onLine) return;
    
    const pendingSync = JSON.parse(localStorage.getItem('pending_sync') || '[]');
    if (pendingSync.length === 0) return;

    console.log('Syncer pending data til cloud...');
    
    for (const item of pendingSync) {
      try {
                     // Hent elevens klasse information
                     const studentInfo = JSON.parse(localStorage.getItem('student_name') || '{}');
                     const studentSchoolId = studentInfo.schoolId || 'default';
                     const studentClassId = studentInfo.classId || 'default';
                     
                     await window.db.collection('user_progress').add({
               userId: item.userId,
               userFirstName: item.userFirstName || 'Ukendt',
               userLastName: item.userLastName || 'Bruger', 
               userEmail: item.userEmail || 'ingen@email.dk',
               taskId: item.taskId,
               taskName: item.taskName,
               completedAt: item.completedAt,
               timestamp: new Date().toISOString(),
               schoolId: studentSchoolId,
               classId: studentClassId,
               syncedFromLocal: true
             });
      } catch (error) {
        console.error('Fejl ved sync af item:', error);
      }
    }
    
    // Ryd pending data efter succesfuld sync
    localStorage.removeItem('pending_sync');
    console.log('Pending data synced til cloud');
  }

  // === Lærer Dashboard funktionalitet ===
  async function getClassProgress(schoolId = 'default', classId = 'default') {
    try {
      // Hvis vi kører lokalt eller Firebase er deaktiveret, returner tom array
      if (isLocalEnvironment || !checkFirebaseStatus()) {
        console.log('🏠 Kører lokalt eller Firebase deaktiveret - returnerer tom array for klassedata');
        return [];
      }
      
      // Tjek om Firebase er tilgængelig
      if (!window.db) {
        console.log('ℹ️ Firebase ikke tilgængelig - returnerer tom array');
        return [];
      }
      
      const snapshot = await window.db.collection('user_progress')
        .where('schoolId', '==', schoolId)
        .where('classId', '==', classId)
        .orderBy('timestamp', 'desc')
        .get();
      
      const progress = [];
      snapshot.forEach(doc => {
        progress.push({ id: doc.id, ...doc.data() });
      });
      
      return progress;
    } catch (error) {
      console.error('Fejl ved hent af klassedata:', error);
      
      // Registrer Firebase fejl
      registerFirebaseError();
      
      return [];
    }
  }

  async function exportClassData(schoolId = 'default', classId = 'default') {
    // Hvis vi kører lokalt, vis besked
    if (isLocalEnvironment) {
      console.log('🏠 Kører lokalt - kan ikke eksportere klassedata');
      alert('Klassedata kan kun eksporteres når applikationen kører online');
      return;
    }
    
    const progress = await getClassProgress(schoolId, classId);
    
    // Tjek om der er data at eksportere
    if (!progress || progress.length === 0) {
      console.log('ℹ️ Ingen data at eksportere');
      alert('Ingen data at eksportere endnu');
      return;
    }
    
    // Opret CSV data
    const csvData = [
      ['Elev Navn', 'Opgave ID', 'Opgave Navn', 'Fuldført Dato', 'Tidspunkt', 'Skole ID', 'Klasse ID'],
      ...progress.map(p => [
        `${p.userFirstName} ${p.userLastName}`,
        p.taskId,
        p.taskName,
        p.completedAt,
        p.timestamp?.toDate?.()?.toLocaleString('da-DK') || p.timestamp,
        p.schoolId,
        p.classId
      ])
    ];
    
    // Download CSV
    const csvContent = csvData.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `klasse_progress_${classId}_${Date.now()}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('Klassedata eksporteret som CSV');
  }

  // === Brugerregistrering funktionalitet ===
  function showRegisterModal() {
    document.getElementById('registerModal').style.display = 'flex';
  }

  function closeRegisterModal() {
    document.getElementById('registerModal').style.display = 'none';
    // Ryd felterne
    document.getElementById('regFirstName').value = '';
    document.getElementById('regLastName').value = '';
    document.getElementById('regEmail').value = '';
    document.getElementById('regUsername').value = '';
    document.getElementById('regPassword').value = '';
    document.getElementById('registerError').innerText = '';
  }

  function createUser() {
    const firstName = document.getElementById('regFirstName').value.trim();
    const lastName = document.getElementById('regLastName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value.trim();
    
    // Validering
    if (!firstName || !lastName || !email || !username || !password) {
      document.getElementById('registerError').innerText = 'Alle felter skal udfyldes!';
      return;
    }
    
    if (password.length < 4) {
      document.getElementById('registerError').innerText = 'Adgangskode skal være mindst 4 tegn!';
      return;
    }
    
    // Tjek om brugernavn allerede eksisterer
    const existingUsers = JSON.parse(localStorage.getItem('smarthome_simulator_users') || '[]');
    if (existingUsers.some(user => user.username === username)) {
      document.getElementById('registerError').innerText = 'Brugernavn findes allerede!';
      return;
    }
    
    // Opret ny bruger
    const newUser = {
      id: Date.now().toString(),
      firstName: firstName,
      lastName: lastName,
      email: email,
      username: username,
      password: password, // I produktion skulle dette hashes
      createdAt: new Date().toISOString(),
      completedTasks: [],
      lastLogin: null
    };
    
    // Gem bruger
    existingUsers.push(newUser);
    localStorage.setItem('smarthome_simulator_users', JSON.stringify(existingUsers));
    
    // Log ind automatisk
    localStorage.setItem('simUser', username);
    localStorage.setItem('simPass', password);
    
    // Luk modal og log ind
    closeRegisterModal();
    document.getElementById('loginUser').value = username;
    document.getElementById('loginPass').value = password;
    doLogin();
    
    console.log('Ny bruger oprettet:', newUser);
  }


  






    function getCurrentUser() {
    const username = localStorage.getItem('simUser');
    console.log('🔍 getCurrentUser - localStorage simUser:', username);
    
    if (!username) {
      console.log('❌ getCurrentUser - ingen username i localStorage');
      return null;
    }

    console.log('🔍 getCurrentUser kaldt med username:', username);

    // Først tjek registrerede brugere
    const users = JSON.parse(localStorage.getItem('smarthome_simulator_users') || '[]');
    const registeredUser = users.find(user => user.username === username);
    if (registeredUser) {
      console.log('🔍 Registreret bruger fundet:', registeredUser);
      return registeredUser;
    }

    // Hvis ikke registreret, returner standard bruger info
    if (username === 'admin') {
      // Tjek om der er gemt et elevnavn
      const studentName = JSON.parse(localStorage.getItem('student_name') || '{}');
      
      const adminUser = {
        id: 'admin',
        firstName: studentName.firstName || 'Admin',
        lastName: studentName.lastName || 'Bruger',
        email: studentName.email || 'admin@smarthomesimulator.dk',
        username: 'admin'
      };
      console.log('🔍 Admin bruger returneret:', adminUser);
      return adminUser;
    }

    // For alle andre brugere (fx Test1), returner standard bruger info
    const studentName = JSON.parse(localStorage.getItem('student_name') || '{}');
    
    const defaultUser = {
      id: username,
      firstName: studentName.firstName || username,
      lastName: studentName.lastName || 'Bruger',
      email: studentName.email || `${username}@smarthomesimulator.dk`,
      username: username
    };
    
    console.log('🔍 Standard bruger returneret for:', username, defaultUser);
    return defaultUser;
  }

  function updateUserTaskCompletion(taskId, taskName) {
    const currentUser = getCurrentUser();
    if (!currentUser) return;
    
    const completedAt = new Date().toISOString();
    
    // Tilføj til brugerens completedTasks hvis ikke allerede der
    if (!currentUser.completedTasks.some(task => task.id === taskId)) {
      currentUser.completedTasks.push({
        id: taskId,
        name: taskName,
        completedAt: completedAt
      });
      
      // Opdater brugerdata
      const users = JSON.parse(localStorage.getItem('smarthome_simulator_users') || '[]');
      const userIndex = users.findIndex(user => user.username === currentUser.username);
      if (userIndex !== -1) {
        users[userIndex] = currentUser;
        localStorage.setItem('smarthome_simulator_users', JSON.stringify(users));
      }
      
      console.log('Opgave fuldført:', taskName, 'for bruger:', currentUser.firstName, currentUser.lastName);
    }
  }

  // === Settings event setup ===
  function setupSettingsEvents() {
    console.log('Setting up settings events...');
    
    // Tema selector
    const themeSelect = document.getElementById('themeSelect');
    if(themeSelect) {
      // Indlæs gemt tema
      const savedTheme = localStorage.getItem('smarthome_simulator.theme') || 'auto';
      themeSelect.value = savedTheme;
      applyTheme(savedTheme);
      
      // Opdater tema dropdown baseret på opgave fremskridt
      updateThemeAvailability();
      
      // Lyt til ændringer
      themeSelect.addEventListener('change', (e) => {
        const theme = e.target.value;
        console.log('Theme changed to:', theme);
        applyTheme(theme);
      });
    }
    
    // Onboarding reset
    const btnResetOnboarding = document.getElementById('btnResetOnboarding');
    if(btnResetOnboarding) {
      btnResetOnboarding.onclick = () => {
        if(confirm('Er du sikker på, at du vil starte forfra med onboarding? Dette vil nulstille alle onboarding trin.')) {
          // Slet alle onboarding-relaterede data
          localStorage.removeItem('smarthome_simulator.onboarding_completed');
          localStorage.removeItem('completed_tasks');
          localStorage.removeItem('task_help_visible');
          localStorage.removeItem('smarthome_simulator.onboarding');
          localStorage.removeItem('smarthome_simulator.completedTasks');
          localStorage.removeItem('smarthome_simulator.onboardingStep');
          
          // Vis bekræftelse
          alert('Onboarding er nulstillet! Siden vil genindlæses for at aktivere onboarding igen.');
          
          // Genindlæs siden
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        }
      };
    }
  }

  // === Tema funktionalitet ===
  function updateThemeAvailability() {
    // Tjek om alle nemme opgaver er gennemført
    const completedTasks = JSON.parse(localStorage.getItem('completed_tasks') || '[]');
    const easyTasks = ['ganglys', 'schedule']; // ID'er for nemme opgaver
    
    // completedTasks er et array af opgave ID'er (ikke objekter)
    const allEasyCompleted = easyTasks.every(taskId => 
      completedTasks.includes(taskId)
    );
    
    // Find Yellow tema option
    const goldOption = themeSelect.querySelector('option[value="gold"]');
    if (goldOption) {
      if (allEasyCompleted) {
        // Alle nemme opgaver gennemført - vis Yellow tema
        goldOption.style.display = 'block';
        goldOption.disabled = false;
        goldOption.textContent = 'Yellow';
        
        // Vis notifikation om at Yellow tema er låst op
        showThemeUnlockNotification();
      } else {
        // Ikke alle nemme opgaver gennemført - skjul Yellow tema
        goldOption.style.display = 'none';
        goldOption.disabled = true;
        
        // Hvis Yellow tema er valgt, skift til mørkt tema
        if (themeSelect.value === 'gold') {
          themeSelect.value = 'dark';
          applyTheme('dark');
        }
      }
    }
  }
  
  function applyTheme(theme) {
    console.log('Applying theme:', theme);
    
    if(theme === 'light') {
      // Automatisk tema - følg system preference
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      console.log('Light theme - system prefers:', prefersDark ? 'dark' : 'light');
      applyTheme(prefersDark ? 'dark' : 'powerful');
      return;
      
    } else if(theme === 'dark') {
      // Mørkt tema - gendan originale CSS variabler
      document.documentElement.style.setProperty('--hc-bg', '#0b0d10');
      document.documentElement.style.setProperty('--hc-panel', '#0f1319');
      document.documentElement.style.setProperty('--hc-head', '#0d1116');
      document.documentElement.style.setProperty('--hc-text', '#eef3f8');
      document.documentElement.style.setProperty('--hc-muted', '#a7b4c5');
      document.documentElement.style.setProperty('--hc-hair', 'rgba(255,255,255,.14)');
      document.documentElement.style.setProperty('--hc-hair-2', 'rgba(255,255,255,.22)');
      
      // Fjern guld tema klasse
      document.body.classList.remove('gold-theme');
      document.body.classList.remove('crimson-theme');
      
    } else if(theme === 'powerful') {
         // Contrast Theme - bruger de specificerede hex koder
         document.documentElement.style.setProperty('--hc-bg', '#212121'); // Mørk grå baggrund
         document.documentElement.style.setProperty('--hc-panel', '#e67514'); // Orange panel baggrund
         document.documentElement.style.setProperty('--hc-head', '#e67514'); // Orange header baggrund
         document.documentElement.style.setProperty('--hc-text', '#D3ECCD'); // Lys grøn tekst
         document.documentElement.style.setProperty('--hc-muted', '#D3ECCD'); // Lys grøn muted tekst
         document.documentElement.style.setProperty('--hc-hair', 'rgba(6,146,62,0.3)'); // Grøn accent med transparency
         document.documentElement.style.setProperty('--hc-hair-2', 'rgba(6,146,62,0.5)'); // Grøn accent med mere transparency
         
         // Fjern guld tema klasse
         document.body.classList.remove('gold-theme');
         document.body.classList.remove('crimson-theme');
      
    } else if(theme === 'gold') {
      // Guld & Sølv tema - tilføj body klasse
      document.body.classList.add('gold-theme');
      document.body.classList.remove('crimson-theme');
      
    } else if(theme === 'crimson') {
      // Crimson tema - tilføj body klasse
      document.body.classList.add('crimson-theme');
      document.body.classList.remove('gold-theme');
      
    } else {
      // Auto - følg system preference
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      console.log('Auto theme - system prefers:', prefersDark ? 'dark' : 'light');
      applyTheme(prefersDark ? 'dark' : 'light');
      return;
    }
    
    // Gem tema valg
    localStorage.setItem('smarthome_simulator.theme', theme);
    console.log('Theme applied and saved:', theme);
  }
  
  // Setup events when DOM is ready
  if(document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      console.log('🔄 DOMContentLoaded - setting up events...');
      setupLoginEvents();
      setupSettingsEvents();
      loadStudentName(); // Indlæs gemt elevnavn
      checkTeacherLogin(); // Tjek om læreren er logget ind
    });
  } else {
    console.log('🔄 DOM already ready - setting up events...');
    setupLoginEvents();
    setupSettingsEvents();
    loadStudentName(); // Indlæs gemt elevnavn
  }

  // Sikre at UI opdateres når siden indlæses
  window.addEventListener('load', () => {
    console.log('🌐 Window loaded - checking existing users...');
    // Vent lidt for at sikre at alle elementer er klar
    setTimeout(() => {
      checkExistingUsers();
    }, 100);
  });

</script>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  console.log('🚀 DOMContentLoaded - Tab system starter...');
  const ids = ['view-forside','view-sim','view-home','view-learning','view-tasks','view-settings'];
  console.log('📋 Tab IDs:', ids);
  
  const buttons = document.querySelectorAll('.mainnav button');
  console.log('🔘 Fandt knapper:', buttons.length);
  
  // Gør show funktionen globalt tilgængelig
  window.show = function(id){
    console.log('🎯 show() kaldt med:', id);
    
    // Håndter body klasse for HOME view overflow
    if (id === 'view-home') {
      document.body.classList.add('home-active');
      console.log('🏠 Tilføjede home-active klasse til body');
    } else {
      document.body.classList.remove('home-active');
      console.log('📄 Fjernede home-active klasse fra body');
    }
    
    // Sikre at header er synlig når vi skifter views
    const header = document.querySelector('header');
    if (header && header.style.display === 'none') {
      header.style.display = 'block';
      console.log('🔧 Header genvist i show() funktionen');
    }
    
    ids.forEach(x => {
      const el = document.getElementById(x);
      if(el){ 
        console.log(`📄 Element ${x}:`, el);
        // Sæt active klasse
        el.classList.toggle('active', x===id);
        // Håndter display style
        if (x === id) {
          el.style.display = 'block';
        } else {
          el.style.display = 'none';
        }
        console.log(`✅ ${x} active klasse:`, el.classList.contains('active'), 'display:', el.style.display);
      } else {
        console.log(`❌ Element ${x} ikke fundet!`);
      }
      const btn = document.querySelector(`.mainnav button[data-target="${x}"]`);
      if(btn){ 
        btn.classList.toggle('active', x===id);
        console.log(`🔘 Knap ${x} active:`, btn.classList.contains('active'));
      }
    });
    try{ localStorage.setItem('smarthome_simulator.activeView', id); }catch(e){}
  }
  
  buttons.forEach(b => {
    console.log('🔗 Tilføjer click event til knap:', b.dataset.target);
    b.addEventListener('click', () => {
      console.log('🖱️ Klik på knap:', b.dataset.target);
      show(b.dataset.target);
    });
  });
  
  // Tjek om brugeren er logget ind først
  const currentUser = localStorage.getItem('simUser');
  if (!currentUser) {
    // Ingen bruger logget ind - vis login siden
    console.log('🔑 Ingen bruger logget ind - viser login siden');
    document.getElementById('loginView').style.display = 'flex';
    // Skjul alle andre views
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
    // Skjul navigation og header
    document.querySelector('.mainnav').style.display = 'none';
    document.querySelector('.tabs').style.display = 'none';
    
    // Skjul header
    const header = document.querySelector('header');
    if (header) {
      header.style.display = 'none';
      console.log('✅ Header skjult på login skærm');
    } else {
      console.log('⚠️ Header element ikke fundet');
    }
    
    // Skjul også alle lærer login knapper specifikt
    const teacherButtons = document.querySelectorAll('button[id*="Teacher"]');
    teacherButtons.forEach(btn => {
      btn.style.display = 'none';
      btn.style.visibility = 'hidden';
    });
    
    // Skjul også knapper med "Lærer" tekst
    const allButtons = document.querySelectorAll('button');
    allButtons.forEach(btn => {
      if (btn.textContent.includes('Lærer')) {
        btn.style.display = 'none';
        btn.style.visibility = 'hidden';
        console.log('✅ Skjult lærer knap:', btn.textContent);
      }
    });
    
    console.log('✅ Alle lærer knapper skjult');
  } else {
    // Bruger er logget ind - start med normal tab
    console.log('✅ Bruger logget ind:', currentUser, '- starter med normal tab');
    let start = null;
    try{ start = localStorage.getItem('smarthome_simulator.activeView'); }catch(e){}
    if(!ids.includes(start)) start = ids[0];
    console.log('🚀 Starter med tab:', start);
    show(start);
  }
  
  // Setup drag and drop for smart devices
  setupSmartDeviceDragAndDrop();
});

// Smart Device Drag and Drop Functionality
function setupSmartDeviceDragAndDrop() {
  const devices = document.querySelectorAll('.smart-device');
  let draggedDevice = null;
  let isDragging = false;
  let startX, startY;
  let originalX, originalY;
  
  devices.forEach(device => {
    // Add right-click context menu for locking/unlocking
    device.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      device.classList.toggle('locked');
      
      if (device.classList.contains('locked')) {
        device.title = device.title + ' (Låst)';
        console.log('🔒 Device locked:', device.dataset.device);
      } else {
        device.title = device.title.replace(' (Låst)', '');
        console.log('🔓 Device unlocked:', device.dataset.device);
      }
    });
    
    // Mouse events for dragging
    device.addEventListener('mousedown', (e) => {
      if (device.classList.contains('locked')) {
        return; // Don't allow dragging if locked
      }
      
      if (e.button === 0) { // Left click only
        isDragging = true;
        draggedDevice = device;
        startX = e.clientX;
        startY = e.clientY;
        
        const rect = device.getBoundingClientRect();
        originalX = rect.left;
        originalY = rect.top;
        
        device.classList.add('dragging');
        device.style.cursor = 'grabbing';
        
        e.preventDefault();
      }
    });
    
    device.addEventListener('mouseup', () => {
      if (draggedDevice) {
        draggedDevice.classList.remove('dragging');
        draggedDevice.style.cursor = '';
        draggedDevice = null;
        isDragging = false;
      }
    });
  });
  
  // Global mouse move and up events
  document.addEventListener('mousemove', (e) => {
    if (isDragging && draggedDevice) {
      const deltaX = e.clientX - startX;
      const deltaY = e.clientY - startY;
      
      const newLeft = originalX + deltaX;
      const newTop = originalY + deltaY;
      
      // Convert to percentage for responsive positioning
      const container = draggedDevice.closest('.floor-plan-background');
      if (container) {
        const containerRect = container.getBoundingClientRect();
        const percentX = ((newLeft - containerRect.left) / containerRect.width) * 100;
        const percentY = ((newTop - containerRect.top) / containerRect.height) * 100;
        
        // Keep within bounds (0-100%)
        const clampedX = Math.max(0, Math.min(100, percentX));
        const clampedY = Math.max(0, Math.min(100, percentY));
        
        draggedDevice.style.left = clampedX + '%';
        draggedDevice.style.top = clampedY + '%';
      }
    }
  });
  
  document.addEventListener('mouseup', () => {
    if (draggedDevice) {
      draggedDevice.classList.remove('dragging');
      draggedDevice.style.cursor = '';
      draggedDevice = null;
      isDragging = false;
    }
  });
}
</script>

<script>
// === LUA bar dropdown (konsolideret) ===
(function(){
  const dd = document.getElementById('luaDD');
  if(!dd) return;
  const btn = document.getElementById('luaBtn');
  const list = document.getElementById('luaList');
  
  if (btn && list){
    btn.addEventListener('click', function(){
      const open = list.classList.toggle('open');
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
    });
    
    // Close dropdown when clicking outside
  document.addEventListener('click', function(e){
      if(!dd.contains(e.target)) { 
      list.classList.remove('open');
      btn.setAttribute('aria-expanded','false');
    }
  });
    
    // Bridge: forward new button clicks to the original hidden ones
    const oldGen  = document.getElementById('btnGenLua');
    const oldCopy = document.getElementById('btnCopyLua');
    const oldSave = document.getElementById('btnSaveLua');
    const nGen  = document.getElementById('luaGen2');
    const nCopy = document.getElementById('luaCopy2');
    const nSave = document.getElementById('luaSave2');
    
    if (nGen && oldGen)  nGen.addEventListener('click',  function(){ oldGen.click();  });
    if (nCopy && oldCopy) nCopy.addEventListener('click', function(){ oldCopy.click(); });
    if (nSave && oldSave) nSave.addEventListener('click', function(){ oldSave.click(); });
  }
})();
</script>

<script>
// === Sensor Guide Funktionalitet ===
(function(){
  const sensorSelect = document.getElementById('sensorSelect');
  const sensorInfo = document.getElementById('sensorInfo');
  
  if (!sensorSelect || !sensorInfo) return;
  
  const sensorData = {
    pir: {
      title: 'PIR (Bevægelsessensor)',
      description: 'Passive Infrared sensor der registrerer bevægelse ved at måle ændringer i infrarød stråling.',
      uses: [
        'Automatisk ganglys når nogen kommer ind',
        'Sikkerhedsalarm når der er uautoriseret bevægelse',
        'Energibesparelse ved at slukke lys når rummet er tomt',
        'Tælle antal personer der går gennem en dør'
      ],
      tips: [
        'Placer sensor i hjørner for bedste dækning',
        'Undgå direkte sollys som kan give falske alarmer',
        'Tjek batteristatus regelmæssigt',
        'Test sensor med forskellige bevægelsesmønstre'
      ]
    },
    contact: {
      title: 'Dør-/vindueskontakt',
      description: 'Magnetisk kontakt der registrerer om en dør eller vindue er åben eller lukket.',
      uses: [
        'Sikkerhedsalarm når døre åbnes om natten',
        'Automatisk lys når døren åbnes',
        'Ventilationsstyring baseret på vindue status',
        'Logging af hvornår døre bruges'
      ],
      tips: [
        'Sørg for at magneten og kontakten er præcist justeret',
        'Undgå metalobjekter i nærheden',
        'Test både åben og lukket tilstand',
        'Kontroller at ledningerne ikke er beskadiget'
      ]
    },
    humidity: {
      title: 'Fugtighedssensor',
      description: 'Måler luftfugtighed i procent og kan bruges til at styre ventilation og undgå skimmel.',
      uses: [
        'Automatisk ventilation når fugtigheden er høj',
        'Skimmelvarsling i kældere og badeværelser',
        'Styring af luftfugtere i tørre rum',
        'Kvalitetskontrol i produktionsfaciliteter'
      ],
      tips: [
        'Placer sensor væk fra direkte vandkilder',
        'Kalibrer sensor regelmæssigt',
        'Tjek for kondens på sensoren',
        'Overvåg både temperatur og fugtighed sammen'
      ]
    },
    lux: {
      title: 'Lysmåler (Lux)',
      description: 'Måler lysstyrke i lux og kan bruges til automatisk lysstyring baseret på dagslys.',
      uses: [
        'Automatisk tænding af lys når det bliver mørkt',
        'Dæmpning af lys baseret på dagslys',
        'Energibesparelse ved at bruge naturligt lys',
        'Styring af væksthuse og dyrehuse'
      ],
      tips: [
        'Placer sensor uden for direkte sollys',
        'Undgå skygger fra træer eller bygninger',
        'Tjek kalibrering med et professionelt luxmeter',
        'Overvåg både morgen og aften for bedste resultater'
      ]
    },
    wind: {
      title: 'Vindmåler',
      description: 'Måler vindhastighed og kan bruges til at styre udendørs systemer og sikkerhed.',
      uses: [
        'Automatisk lukning af markiser ved stærk vind',
        'Sikkerhedsvarsling ved storm',
        'Styring af udendørs belysning',
        'Vejrbaseret ventilation'
      ],
      tips: [
        'Placer sensor højt nok til at undgå forstyrrelser',
        'Undgå skjul fra bygninger eller træer',
        'Tjek for is på vingene om vinteren',
        'Kalibrer med en professionel vindmåler'
      ]
    },
    smoke: {
      title: 'Røgalarm',
      description: 'Detekterer røg og kan give tidlig advarsel om brand og styre sikkerhedssystemer.',
      uses: [
        'Tidlig brandvarsling',
        'Automatisk åbning af branddøre',
        'Styring af ventilationssystemer',
        'Integration med brandalarm systemer'
      ],
      tips: [
        'Test alarmen månedligt',
        'Undgå pladsering i køkken eller badeværelser',
        'Tjek batteristatus regelmæssigt',
        'Placer i hver etage af bygningen'
      ]
    },
    leak: {
      title: 'Vandlækage',
      description: 'Detekterer vand og kan give tidlig advarsel om lækager før de skader bygningen.',
      uses: [
        'Tidlig varsling om vandskader',
        'Automatisk lukning af vandhane',
        'Integration med sikkerhedssystemer',
        'Overvågning af vandinstallationer'
      ],
      tips: [
        'Placer sensor nær vandinstallationer',
        'Tjek for falske alarmer fra kondens',
        'Test med en vanddråbe månedligt',
        'Placer både på gulv og vægge'
      ]
    },
    co2: {
      title: 'CO₂-måler',
      description: 'Måler kuldioxid niveau i luften og kan styre ventilation for bedre indeklima.',
      uses: [
        'Automatisk ventilation når CO₂ er høj',
        'Overvågning af luftkvalitet i kontorer',
        'Styring af luftrenser',
        'Varsling om dårlig luftkvalitet'
      ],
      tips: [
        'Placer sensor i åndedrætshøjde',
        'Undgå direkte åndedræt på sensoren',
        'Kalibrer med friske udendørs luftprøver',
        'Overvåg både dag og nat'
      ]
    },
    presence: {
      title: 'Tilstedeværelsesensor',
      description: 'Avanceret sensor der kan skelne mellem mennesker og dyr, og give mere præcis tilstedeværelsesdetektering.',
      uses: [
        'Præcis tilstedeværelsesdetektering',
        'Automatisk lysstyring i kontorer',
        'Sikkerhedssystemer der ignorerer dyr',
        'Energistyring baseret på faktisk brug'
      ],
      tips: [
        'Placer sensor i strategiske positioner',
        'Undgå pladsering nær vinduer',
        'Test med forskellige typer af bevægelse',
        'Kalibrer sensitiviteten efter behov'
      ]
    }
  };
  
  function updateSensorInfo(sensorType) {
    if (!sensorType || !sensorData[sensorType]) {
      sensorInfo.innerHTML = '<div style="text-align: center; color: #9ca3af; font-size: 16px; margin-top: 150px;">Vælg en sensor ovenfor for at læse mere</div>';
      return;
    }
    
    const sensor = sensorData[sensorType];
    const html = `
      <h3 style="color: #2ab0ff; font-size: 20px; margin-bottom: 16px;">${sensor.title}</h3>
      <p style="color: #e5e9f0; line-height: 1.6; margin-bottom: 20px;">${sensor.description}</p>
      
      <h4 style="color: #10b981; font-size: 16px; margin-bottom: 12px;">🔧 Anvendelser:</h4>
      <ul style="color: #cbd5e1; line-height: 1.6; margin-bottom: 20px; padding-left: 20px;">
        ${sensor.uses.map(use => `<li>${use}</li>`).join('')}
      </ul>
      
      <h4 style="color: #f59e0b; font-size: 16px; margin-bottom: 12px;">💡 Tips & Tricks:</h4>
      <ul style="color: #cbd5e1; line-height: 1.6; padding-left: 20px;">
        ${sensor.tips.map(tip => `<li>${tip}</li>`).join('')}
      </ul>
    `;
    
    sensorInfo.innerHTML = html;
  }
  
  sensorSelect.addEventListener('change', function() {
    updateSensorInfo(this.value);
  });
  
  // Initial state
  updateSensorInfo('');
})();
</script>

<script>
// === Z-Wave Rækkevidde Beregner ===
(function(){
  const wallCount = document.getElementById('wallCount');
  const wallMaterial = document.getElementById('wallMaterial');
  const distance = document.getElementById('distance');
  const middleDevice = document.getElementById('middleDevice');
  const signalResult = document.getElementById('signalResult');
  
  if (!wallCount || !wallMaterial || !distance || !middleDevice || !signalResult) return;
  
  // Materiale dæmpning i dBm
  const materialAttenuation = {
    drywall: 3,    // Gipsvæg
    brick: 6,      // Murstensvæg
    wood: 5,       // Træ
    concrete: 8,   // Beton
    metal: 15,     // Metal
    glass: 4       // Glas
  };
  
  // Z-Wave specifikationer
  const ZWAVE_MIN = -40;  // Minimum signalstyrke (bedste)
  const ZWAVE_MAX = -60;  // Maksimum signalstyrke (dårligste)
  
  function calculateSignalStrength() {
    const walls = parseInt(wallCount.value) || 0;
    const material = wallMaterial.value;
    const dist = parseFloat(distance.value) || 0;
    const deviceType = middleDevice.value;
    
    if (dist === 0) return;
    
    // Beregn Free Space Path Loss (FSPL)
    // Formel: FSPL(dB) = 20 * log10(d) + 31,21
    const fspl = 20 * Math.log10(dist) + 31.21;
    
    // Beregn total dæmpning fra vægge
    const wallAttenuation = walls * materialAttenuation[material];
    
    // Beregn total signaltab
    let totalSignal = fspl + wallAttenuation;
    
    // Juster for mellemenhed type
    if (deviceType === 'repeater') {
      totalSignal -= 10; // Repeater forstærker med ca. 10 dBm
    }
    
    // Konverter til Z-Wave skala (-40 til -60 dBm)
    // Jo højere total signaltab (dB), jo svagere er signalet
    // Z-Wave godkender signaler mellem -40 dBm (bedste) og -60 dBm (minimum)
    
    // Beregn signalstyrke baseret på Z-Wave specifikationer
    // Godkendt rækkevidde: -40 til -60 dBm
    // Fra dokumentet: 20m + 2 gipsvægge = 63.23 dBm → ikke godkendt
    
    // Konverter total signaltab til Z-Wave skala
    // Jo højere total dB værdi, jo svagere signal
    let signalStrength;
    if (totalSignal <= 50) {
      signalStrength = -40; // Meget stærkt (0-15m, få vægge)
    } else if (totalSignal <= 60) {
      signalStrength = -50; // Stærkt (15-20m, få vægge)
    } else if (totalSignal <= 65) {
      signalStrength = -55; // Acceptabelt (20-25m, nogle vægge)
    } else if (totalSignal <= 70) {
      signalStrength = -60; // Svagt (25-30m, flere vægge) - grænse
    } else {
      signalStrength = -70; // Uacceptabelt (30m+, mange vægge) - ikke godkendt
    }
    
    // Begræns til Z-Wave rækkevidde
    const clampedSignal = Math.max(-70, Math.min(-40, signalStrength));
    
    return {
      fspl: fspl,
      wallAttenuation: wallAttenuation,
      totalSignal: totalSignal,
      zwaveSignal: signalStrength,
      clampedSignal: clampedSignal,
      isGood: clampedSignal >= -60, // Godkendt hvis -60 dBm eller bedre
      isExcellent: clampedSignal >= -50
    };
  }
  
  function updateSignalResult() {
    const result = calculateSignalStrength();
    if (!result) return;
    
    const signalColor = result.isGood ? '#10b981' : '#ef4444';
    const signalText = result.isGood ? 'Godkendt' : 'Ikke godkendt';
    const signalIcon = result.isGood ? '✅' : '❌';
    
    const html = `
      <h3 style="color: #2ab0ff; font-size: 20px; margin-bottom: 16px;">📡 Signalstyrke Resultat</h3>
      
      <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <span style="color: #cbd5e1; font-weight: 500;">Status:</span>
          <span style="color: ${signalColor}; font-weight: bold; font-size: 18px;">${signalIcon} ${signalText}</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="color: #cbd5e1;">Signalstyrke:</span>
          <span style="color: ${signalColor}; font-weight: bold;">${result.clampedSignal.toFixed(1)} dBm</span>
        </div>
      </div>
      
      <h4 style="color: #10b981; font-size: 16px; margin-bottom: 12px;">📊 Detaljerede Beregninger:</h4>
      <div style="background: rgba(0,0,0,0.1); border-radius: 6px; padding: 12px; margin-bottom: 16px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="color: #cbd5e1;">FSPL (${distance.value}m):</span>
          <span style="color: #e5e9f0;">${result.fspl.toFixed(2)} dB</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="color: #cbd5e1;">Væg dæmpning:</span>
          <span style="color: #e5e9f0;">${result.wallAttenuation} dB</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                          <span style="color: #cbd5e1;">Total signaltab:</span>
          <span style="color: #e5e9f0;">${result.totalSignal.toFixed(2)} dB</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
          <span style="color: #cbd5e1;">Z-Wave signal:</span>
          <span style="color: #e5e9f0;">${result.zwaveSignal.toFixed(1)} dBm</span>
        </div>
      </div>
      
      <h4 style="color: #f59e0b; font-size: 16px; margin-bottom: 12px;">💡 Anbefalinger:</h4>
      <ul style="color: #cbd5e1; line-height: 1.6; padding-left: 20px;">
        ${result.isGood ? 
          '<li>Signalet er stærkt nok til pålidelig kommunikation</li>' +
          '<li>Ingen yderligere enheder nødvendige</li>' :
          '<li>Signalet er for svagt - overvej at tilføje en repeater</li>' +
          '<li>Reducér afstanden mellem enhederne</li>' +
          '<li>Undgå tunge materialer som beton eller metal</li>'
        }
      </ul>
      
      <div style="margin-top: 20px; padding: 12px; background: rgba(42,176,255,0.1); border-radius: 6px; border-left: 4px solid #2ab0ff;">
        <p style="color: #2ab0ff; font-size: 14px; margin: 0;">
          <strong>Info:</strong> Z-Wave godkender signaler mellem -40 dBm (bedste) og -60 dBm (minimum). 
          Jo højere (mindre negativ) værdi, jo bedre signal.
        </p>
      </div>
    `;
    
    signalResult.innerHTML = html;
  }
  
  // Tilføj event listener til beregn knappen
  const calculateBtn = document.getElementById('calculateBtn');
  if (calculateBtn) {
    calculateBtn.addEventListener('click', function() {
      console.log('🧮 Beregn knap klikket!');
      updateSignalResult();
    });
  }
  
  // Tilføj event listeners til alle input felter for real-time opdatering
  wallCount.addEventListener('input', function() {
    console.log('📏 Vægge ændret til:', this.value);
  });
  wallMaterial.addEventListener('change', function() {
    console.log('🧱 Materiale ændret til:', this.value);
  });
  distance.addEventListener('input', function() {
    console.log('📏 Afstand ændret til:', this.value);
  });
  middleDevice.addEventListener('change', function() {
    console.log('📡 Mellemenhed ændret til:', this.value);
  });
  
  console.log('🚀 Z-Wave beregner initialiseret!');
  console.log('Elementer fundet:', {
    wallCount: !!wallCount,
    wallMaterial: !!wallMaterial,
    distance: !!distance,
    middleDevice: !!middleDevice,
    signalResult: !!signalResult,
    calculateBtn: !!calculateBtn
  });
})();
</script>

<script>
// === Forbindelses Guide Funktionalitet ===
(function(){
  const connectionSelect = document.getElementById('connectionSelect');
  const connectionInfo = document.getElementById('connectionInfo');
  
  if (!connectionSelect || !connectionInfo) return;
  
  const connectionData = {
    wifi: {
      title: 'WiFi (IEEE 802.11)',
      description: 'Højhastigheds trådløs netværksteknologi der bruges til internet og lokale netværk.',
      specs: [
        'Frekvens: 2.4 GHz og 5 GHz',
        'Rækkevidde: 10-50 meter (indendørs)',
        'Hastighed: 54 Mbps - 9.6 Gbps',
        'Strømforbrug: Højt (kræver konstant strøm)'
      ],
      uses: [
        'Smart home hubber og enheder',
        'Kameraer og videodørklokker',
        'Højtydende lydsystemer',
        'Real-time dataoverførsel'
      ],
      pros: [
        'Høj hastighed og båndbredde',
        'God rækkevidde og gennemtrængning',
        'Standardiseret og kompatibel',
        'Internet tilgængelighed'
      ],
      cons: [
        'Højt strømforbrug',
        'Kan blive overbelastet',
        'Sikkerhedsproblemer',
        'Afhængig af router'
      ]
    },
    bluetooth: {
      title: 'Bluetooth (BLE)',
      description: 'Kortafstands trådløs teknologi til personlige områdenetværk med lavt strømforbrug.',
      specs: [
        'Frekvens: 2.4 GHz',
        'Rækkevidde: 1-100 meter (afhængig af klasse)',
        'Hastighed: 1-3 Mbps',
        'Strømforbrug: Meget lavt (BLE)'
      ],
      uses: [
        'Smartphones og tablets',
        'Høretelefoner og højttalere',
        'Fitness trackers og ure',
        'Smart home enheder (nær afstand)'
      ],
      pros: [
        'Meget lavt strømforbrug',
        'Universel kompatibilitet',
        'Let at parre enheder',
        'God til korte afstande'
      ],
      cons: [
        'Begrænset rækkevidde',
        'Lav hastighed',
        'Kan have parringsproblemer',
        'Ikke egnet til mesh netværk'
      ]
    },
    matter: {
      title: 'Matter (Thread/WiFi)',
      description: 'Ny standardiseret smart home protokol der sikrer kompatibilitet mellem forskellige producenter.',
      specs: [
        'Frekvens: 2.4 GHz (Thread) / 2.4/5 GHz (WiFi)',
        'Rækkevidde: 10-50 meter',
        'Hastighed: 250 Kbps (Thread) / 54 Mbps+ (WiFi)',
        'Strømforbrug: Lavt til medium'
      ],
      uses: [
        'Smart home enheder fra alle producenter',
        'Lys, termostater og låse',
        'Sikkerhedsenheder',
        'Fremtidssikret smart home'
      ],
      pros: [
        'Producentuafhængig kompatibilitet',
        'Sikker og pålidelig',
        'Understøtter både Thread og WiFi',
        'Fremtidssikret standard'
      ],
      cons: [
        'Ny teknologi (begrænset enhedsunderstøttelse)',
        'Kræver Matter-certificerede enheder',
        'Kan være dyrere end andre løsninger'
      ]
    },
    thread: {
      title: 'Thread (IPv6 mesh)',
      description: 'IPv6-baseret mesh netværksprotokol designet til smart home og IoT enheder.',
      specs: [
        'Frekvens: 2.4 GHz',
        'Rækkevidde: 10-30 meter per hop',
        'Hastighed: 250 Kbps',
        'Strømforbrug: Lavt'
      ],
      uses: [
        'Smart home sensorer og aktuatore',
        'Mesh netværk med flere hops',
        'Batteridrevne enheder',
        'Industrielle IoT applikationer'
      ],
      pros: [
        'Selvhealende mesh netværk',
        'Lavt strømforbrug',
        'IPv6 kompatibilitet',
        'God rækkevidde gennem hops'
      ],
      cons: [
        'Kræver Thread-certificerede enheder',
        'Begrænset hastighed',
        'Kan have forsinkelser i store netværk'
      ]
    },
    zwave: {
      title: 'Z-Wave Plus',
      description: 'Trådløs protokol specifikt designet til smart home automation med god rækkevidde og pålidelighed.',
      specs: [
        'Frekvens: 868.42 MHz (EU) / 908.42 MHz (US)',
        'Rækkevidde: 30-100 meter (frit felt)',
        'Hastighed: 9.6-100 Kbps',
        'Strømforbrug: Lavt til medium'
      ],
      uses: [
        'Smart home lys og stikkontakter',
        'Sikkerhedssystemer og låse',
        'Termostater og sensorer',
        'Scene og automatisering'
      ],
      pros: [
        'God rækkevidde gennem vægge',
        'Lavt strømforbrug',
        'Mesh netværk med hops',
        'Dedikeret til smart home'
      ],
      cons: [
        'Langsommere end WiFi',
        'Kræver Z-Wave hub',
        'Kan være dyrere end WiFi enheder'
      ]
    },
    zigbee: {
      title: 'Zigbee (IEEE 802.15.4)',
      description: 'Åben standard for trådløse mesh netværk med lavt strømforbrug og god rækkevidde.',
      specs: [
        'Frekvens: 2.4 GHz',
        'Rækkevidde: 10-100 meter',
        'Hastighed: 250 Kbps',
        'Strømforbrug: Lavt'
      ],
      uses: [
        'Smart home lys og stikkontakter',
        'Industrielle sensorer',
        'Medicinske enheder',
        'Landbrugsmonitorering'
      ],
      pros: [
        'Åben standard',
        'Mesh netværk med hops',
        'Lavt strømforbrug',
        'God rækkevidde'
      ],
      cons: [
        'Kan have kompatibilitetsproblemer',
        '2.4 GHz interferens med WiFi',
        'Begrænset hastighed'
      ]
    },
    '433mhz': {
      title: '433 MHz (RF)',
      description: 'Simpel radiofrekvens teknologi der bruges til billige trådløse enheder og fjernbetjening.',
      specs: [
        'Frekvens: 433 MHz',
        'Rækkevidde: 100-1000 meter (frit felt)',
        'Hastighed: 1-10 Kbps',
        'Strømforbrug: Meget lavt'
      ],
      uses: [
        'Garageportåbnere',
        'Vejrstationer og sensorer',
        'Fjernbetjening til TV og AC',
        'Billige smart home enheder'
      ],
      pros: [
        'Meget billig',
        'Lang rækkevidde i frit felt',
        'Meget lavt strømforbrug',
        'Simpel implementering'
      ],
      cons: [
        'Meget lav hastighed',
        'Ingen kryptering',
        'Kan have interferens',
        'Begrænset funktionalitet'
      ]
    },
    infrared: {
      title: 'Infrarød (IR)',
      description: 'Lysbaseret teknologi der bruges til kortafstands kommunikation og fjernbetjening.',
      specs: [
        'Frekvens: 300 GHz - 400 THz',
        'Rækkevidde: 1-10 meter (direkte syn)',
        'Hastighed: 1-4 Mbps',
        'Strømforbrug: Lavt'
      ],
      uses: [
        'TV og AV fjernbetjening',
        'Smart home fjernbetjening',
        'Mobiltelefoner og tablets',
        'Industrielle kontrolsystemer'
      ],
      pros: [
        'Meget billig',
        'Ingen interferens med radiofrekvenser',
        'Sikker (kræver direkte syn)',
        'Lavt strømforbrug'
      ],
      cons: [
        'Kræver direkte syn (ingen barrierer)',
        'Kort rækkevidde',
        'Kan påvirkes af sollys',
        'Begrænset funktionalitet'
      ]
    }
  };
  
  function updateConnectionInfo(connectionType) {
    if (!connectionType || !connectionData[connectionType]) {
      connectionInfo.innerHTML = '<div style="text-align: center; color: #9ca3af; font-size: 16px; margin-top: 150px;">Vælg en forbindelsestype ovenfor for at læse mere</div>';
      return;
    }
    
    const connection = connectionData[connectionType];
    const html = `
      <h3 style="color: #2ab0ff; font-size: 20px; margin-bottom: 16px;">${connection.title}</h3>
      <p style="color: #e5e9f0; line-height: 1.6; margin-bottom: 20px;">${connection.description}</p>
      
      <h4 style="color: #10b981; font-size: 16px; margin-bottom: 12px;">📊 Specifikationer:</h4>
      <ul style="color: #cbd5e1; line-height: 1.6; margin-bottom: 20px; padding-left: 20px;">
        ${connection.specs.map(spec => `<li>${spec}</li>`).join('')}
      </ul>
      
      <h4 style="color: #f59e0b; font-size: 16px; margin-bottom: 12px;">🔧 Anvendelser:</h4>
      <ul style="color: #cbd5e1; line-height: 1.6; margin-bottom: 20px; padding-left: 20px;">
        ${connection.uses.map(use => `<li>${use}</li>`).join('')}
      </ul>
      
      <h4 style="color: #10b981; font-size: 16px; margin-bottom: 12px;">✅ Fordele:</h4>
      <ul style="color: #cbd5e1; line-height: 1.6; margin-bottom: 20px; padding-left: 20px;">
        ${connection.pros.map(pro => `<li>${pro}</li>`).join('')}
      </ul>
      
      <h4 style="color: #ef4444; font-size: 16px; margin-bottom: 12px;">❌ Ulemper:</h4>
      <ul style="color: #cbd5e1; line-height: 1.6; padding-left: 20px;">
        ${connection.cons.map(con => `<li>${con}</li>`).join('')}
      </ul>
    `;
    
    connectionInfo.innerHTML = html;
  }
  
  connectionSelect.addEventListener('change', function() {
    updateConnectionInfo(this.value);
  });
  
  // Initial state
  updateConnectionInfo('');
})();
</script>

<script>
// === DRAG AND DROP FUNCTIONALITY FOR SMART DEVICES ===
let isDragMode = false;
let draggedElement = null;
let offset = { x: 0, y: 0 };

function enableDragMode() {
  isDragMode = true;
  const devices = document.querySelectorAll('.smart-device');
  devices.forEach(device => {
    device.classList.add('draggable');
    device.addEventListener('mousedown', startDrag);
  });
  
  document.getElementById('toggleDragMode').style.display = 'none';
  document.getElementById('lockPositions').style.display = 'block';
  document.getElementById('dragStatus').textContent = 'Træk-mode aktiveret! Træk ikoner til nye positioner';
  document.getElementById('dragStatus').style.color = '#10b981';
}

function disableDragMode() {
  isDragMode = false;
  const devices = document.querySelectorAll('.smart-device');
  devices.forEach(device => {
    device.classList.remove('draggable', 'dragging');
    device.removeEventListener('mousedown', startDrag);
  });
  
  document.getElementById('toggleDragMode').style.display = 'block';
  document.getElementById('lockPositions').style.display = 'none';
  document.getElementById('dragStatus').textContent = 'Klik for at aktivere træk';
  document.getElementById('dragStatus').style.color = '#cbd5e1';
}

function startDrag(e) {
  if (!isDragMode) return;
  
  draggedElement = e.target;
  draggedElement.classList.add('dragging');
  
  const rect = draggedElement.getBoundingClientRect();
  offset.x = e.clientX - rect.left;
  offset.y = e.clientY - rect.top;
  
  document.addEventListener('mousemove', drag);
  document.addEventListener('mouseup', stopDrag);
  e.preventDefault();
}

function drag(e) {
  if (!draggedElement) return;
  
  const parentRect = draggedElement.parentElement.getBoundingClientRect();
  
  let newX = ((e.clientX - offset.x - parentRect.left) / parentRect.width) * 100;
  let newY = ((e.clientY - offset.y - parentRect.top) / parentRect.height) * 100;
  
  // Keep within bounds
  newX = Math.max(0, Math.min(95, newX));
  newY = Math.max(0, Math.min(95, newY));
  
  draggedElement.style.left = newX + '%';
  draggedElement.style.top = newY + '%';
}

function stopDrag() {
  if (draggedElement) {
    draggedElement.classList.remove('dragging');
    draggedElement = null;
  }
  document.removeEventListener('mousemove', drag);
  document.removeEventListener('mouseup', stopDrag);
}

function lockPositions() {
  const devices = document.querySelectorAll('.smart-device');
  const positions = {};
  
  devices.forEach(device => {
    const leftPercent = parseFloat(device.style.left) || 0;
    const topPercent = parseFloat(device.style.top) || 0;
    
    const deviceId = device.getAttribute('data-device');
    positions[deviceId] = {
      top: Math.round(topPercent * 10) / 10,
      left: Math.round(leftPercent * 10) / 10
    };
  });
  
  console.log('🔒 Nye positioner:', positions);
  
  // Vis positions
  let positionText = '📍 Nye CSS positioner:\n\n';
  Object.entries(positions).forEach(([device, pos]) => {
    positionText += `${device}: top: ${pos.top}%; left: ${pos.left}%\n`;
  });
  
  alert(positionText + '\nKopiér disse værdier til konsollen hvis du vil bruge dem.');
  disableDragMode();
}

// Event listeners for drag controls  
document.addEventListener('DOMContentLoaded', function() {
  const toggleBtn = document.getElementById('toggleDragMode');
  const lockBtn = document.getElementById('lockPositions');
  
  if (toggleBtn) {
    toggleBtn.addEventListener('click', enableDragMode);
  }
  
  if (lockBtn) {
    lockBtn.addEventListener('click', lockPositions);
  }
  
  // Setup smart home control functionality
  setupLightControls();
  setupFloorPlanInteraction();
  
  // Initialize sensor visual states - remove any default on/off classes
  const outdoorTempIcon = document.querySelector('.smart-device[data-device="outdoor-temp"]');
  const humidityIcon = document.querySelector('.smart-device[data-device="humidity-sensor"]');
  
  if (outdoorTempIcon) {
    outdoorTempIcon.classList.remove('on', 'off');
  }
  if (humidityIcon) {
    humidityIcon.classList.remove('on', 'off');
  }
  
  updateSensorIcon('outdoor-temp', deviceStates['outdoor-temp']);
  updateSensorIcon('humidity-sensor', deviceStates['humidity-sensor']);
  
  // Sync ventilation states at startup
  deviceStates['bathroom-fan'] = deviceStates['ventilation'];
  updateDeviceIcon('bathroom-fan', deviceStates['ventilation']);
  
  // Initialize default automation rules
  initializeDefaultRules();
  
  // Initialize theme system
  initializeThemeSystem();
  
  console.log('🚀 Smart Home Automation System fully loaded!');
});

// === THEME SYSTEM ===
function initializeThemeSystem() {
  const themeSelect = document.getElementById('themeSelect');
  if (!themeSelect) return;
  
  // Load saved theme from localStorage
  const savedTheme = localStorage.getItem('selectedTheme') || 'dark';
  themeSelect.value = savedTheme;
  applyTheme(savedTheme);
  
  // Add event listener for theme changes
  themeSelect.addEventListener('change', function() {
    const selectedTheme = this.value;
    applyTheme(selectedTheme);
    localStorage.setItem('selectedTheme', selectedTheme);
  });
  
  console.log('🎨 Theme system initialized');
}

function applyTheme(themeName) {
  const body = document.body;
  
  // Remove all existing theme classes
  body.classList.remove('theme-ocean', 'theme-forest', 'theme-sunset', 'theme-purple', 'theme-ruby', 'theme-golden');
  
  // Apply new theme class
  if (themeName !== 'dark') {
    body.classList.add(`theme-${themeName}`);
  }
  
  // Update CSS variables based on theme
  const root = document.documentElement;
  
  // Force a reflow to ensure CSS variables are applied
  root.offsetHeight;
  
  switch(themeName) {
    case 'ocean':
      root.style.setProperty('--bg-primary', 'var(--ocean-bg-primary)');
      root.style.setProperty('--bg-secondary', 'var(--ocean-bg-secondary)');
      root.style.setProperty('--bg-card', 'var(--ocean-bg-card)');
      root.style.setProperty('--text-primary', 'var(--ocean-text-primary)');
      root.style.setProperty('--text-secondary', 'var(--ocean-text-secondary)');
      root.style.setProperty('--border-color', 'var(--ocean-border-color)');
      root.style.setProperty('--accent-color', 'var(--ocean-accent-color)');
      break;
      
    case 'forest':
      root.style.setProperty('--bg-primary', 'var(--forest-bg-primary)');
      root.style.setProperty('--bg-secondary', 'var(--forest-bg-secondary)');
      root.style.setProperty('--bg-card', 'var(--forest-bg-card)');
      root.style.setProperty('--text-primary', 'var(--forest-text-primary)');
      root.style.setProperty('--text-secondary', 'var(--forest-text-secondary)');
      root.style.setProperty('--border-color', 'var(--forest-border-color)');
      root.style.setProperty('--accent-color', 'var(--forest-accent-color)');
      break;
      
    case 'sunset':
      root.style.setProperty('--bg-primary', 'var(--sunset-bg-primary)');
      root.style.setProperty('--bg-secondary', 'var(--sunset-bg-secondary)');
      root.style.setProperty('--bg-card', 'var(--sunset-bg-card)');
      root.style.setProperty('--text-primary', 'var(--sunset-text-primary)');
      root.style.setProperty('--text-secondary', 'var(--sunset-text-secondary)');
      root.style.setProperty('--border-color', 'var(--sunset-border-color)');
      root.style.setProperty('--accent-color', 'var(--sunset-accent-color)');
      break;
      
    case 'purple':
      root.style.setProperty('--bg-primary', 'var(--purple-bg-primary)');
      root.style.setProperty('--bg-secondary', 'var(--purple-bg-secondary)');
      root.style.setProperty('--bg-card', 'var(--purple-bg-card)');
      root.style.setProperty('--text-primary', 'var(--purple-text-primary)');
      root.style.setProperty('--text-secondary', 'var(--purple-text-secondary)');
      root.style.setProperty('--border-color', 'var(--purple-border-color)');
      root.style.setProperty('--accent-color', 'var(--purple-accent-color)');
      break;
      
    case 'ruby':
      root.style.setProperty('--bg-primary', 'var(--ruby-bg-primary)');
      root.style.setProperty('--bg-secondary', 'var(--ruby-bg-secondary)');
      root.style.setProperty('--bg-card', 'var(--ruby-bg-card)');
      root.style.setProperty('--text-primary', 'var(--ruby-text-primary)');
      root.style.setProperty('--text-secondary', 'var(--ruby-text-secondary)');
      root.style.setProperty('--border-color', 'var(--ruby-border-color)');
      root.style.setProperty('--accent-color', 'var(--ruby-accent-color)');
      break;
      
    case 'golden':
      root.style.setProperty('--bg-primary', 'var(--golden-bg-primary)');
      root.style.setProperty('--bg-secondary', 'var(--golden-bg-secondary)');
      root.style.setProperty('--bg-card', 'var(--golden-bg-card)');
      root.style.setProperty('--text-primary', 'var(--golden-text-primary)');
      root.style.setProperty('--text-secondary', 'var(--golden-text-secondary)');
      root.style.setProperty('--border-color', 'var(--golden-border-color)');
      root.style.setProperty('--accent-color', 'var(--golden-accent-color)');
      break;
      
    default: // dark theme
      root.style.setProperty('--bg-primary', '#0f172a');
      root.style.setProperty('--bg-secondary', '#1e293b');
      root.style.setProperty('--bg-card', '#334155');
      root.style.setProperty('--text-primary', '#f1f5f9');
      root.style.setProperty('--text-secondary', '#cbd5e1');
      root.style.setProperty('--border-color', '#475569');
      root.style.setProperty('--accent-color', '#60a5fa');
      break;
  }
  
  console.log('🎨 Theme applied:', themeName);
}

// === SMART HOME CONTROL FUNCTIONALITY ===

// Device states
let deviceStates = {
  // Lights
  'bedroom-light': false,
  'living-room-light': false,
  'dining-light': false,
  'kitchen-light': false,
  'bathroom-light': false,
  
  // Sensors (PIR/Motion)
  'entrance-motion': false,
  'living-motion': false,
  'motion-kitchen': false,
  
  // Cameras
  'entrance-camera': false,
  'balcony-camera': false,
  
  // Windows/Doors
  'bedroom-window': false,
  'balcony-door': false,
  'front-door': false, // true = locked, false = unlocked
  
  // Speakers/Audio
  'living-speaker': false,
  
  // Fans/Ventilation (ventilation controls bathroom-fan)
  'bathroom-fan': false,
  'ventilation': false,
  
  // Safety
  'smoke-detector': false,
  
  // Climate sensors
  'temperature': 21,
  'outdoor-temp': 15,
  'humidity-sensor': 45,
  
  // Security
  'alarm-system': false,
  'auto-lock': false,
  
  // Automation
  'automation-master': true
};

// Smart home automation rules
let automationRules = [];
let activeScenario = null;

function setupLightControls() {
  console.log('🏠 Setting up smart home controls...');
  
  // Setup device toggle buttons
  const toggleButtons = document.querySelectorAll('.device-toggle');
  toggleButtons.forEach(button => {
    const deviceId = button.getAttribute('data-device');
    
    if (deviceId && deviceStates.hasOwnProperty(deviceId)) {
      button.addEventListener('click', function() {
        toggleDevice(deviceId);
      });
      
      // Set initial state
      updateDeviceUI(deviceId, deviceStates[deviceId]);
    }
  });
  
  // Setup temperature slider
  const tempSlider = document.getElementById('tempSlider');
  const currentTempDisplay = document.getElementById('currentTemp');
  
  if (tempSlider && currentTempDisplay) {
    tempSlider.addEventListener('input', function() {
      const newTemp = parseFloat(this.value);
      deviceStates.temperature = newTemp;
      currentTempDisplay.textContent = newTemp;
      
      // Update thermostat icon on floor plan
      updateThermostatIcon(newTemp);
      
      console.log('🌡️ Temperature set to:', newTemp + '°C');
    });
  }
  
  // Setup scenario buttons
  const scenarioButtons = document.querySelectorAll('.scenario-btn');
  scenarioButtons.forEach(button => {
    const scenario = button.getAttribute('data-scenario');
    button.addEventListener('click', function() {
      executeScenario(scenario);
    });
  });
  
  console.log('🏠 Smart home controls ready!', Object.keys(deviceStates).length, 'devices configured');
}

function setupFloorPlanInteraction() {
  console.log('🎮 Setting up floor plan interaction...');
  
  // Get all smart device icons
  const deviceIcons = document.querySelectorAll('.smart-device');
  
  deviceIcons.forEach(icon => {
    const deviceId = icon.getAttribute('data-device');
    
    // Skip thermostat (handled by control panel slider)
    if (deviceId === 'thermostat') {
      console.log('⏭️ Skipping thermostat (handled by control panel):', deviceId);
      return;
    }
    
    // Check if device exists in deviceStates
    if (!deviceStates.hasOwnProperty(deviceId)) {
      console.warn('⚠️ Device not found in deviceStates:', deviceId);
      return;
    }
    
    // Set initial visual state
    updateDeviceIcon(deviceId, deviceStates[deviceId]);
    
    // Add click handler
    icon.addEventListener('click', function(e) {
      // Prevent drag mode interference
      if (icon.classList.contains('draggable')) {
        return;
      }
      
      console.log('🖱️ Floor plan device clicked:', deviceId);
      
      // Special handling for sensors
      if (deviceId === 'outdoor-temp') {
        showTemperatureSensorDialog(deviceId);
      } else if (deviceId === 'humidity-sensor') {
        showHumiditySensorDialog(deviceId);
      } else {
        // Toggle device state for regular devices
        toggleDevice(deviceId);
        
        // Show status notification for regular devices
        showDeviceStatusNotification(deviceId, deviceStates[deviceId]);
      }
      
      // Show click feedback
      icon.style.transform = 'scale(0.95)';
      setTimeout(() => {
        icon.style.transform = '';
      }, 150);
    });
    
    // Add hover effect for clickable devices
    icon.style.cursor = 'pointer';
    
    // Update title based on device type
    if (deviceId === 'outdoor-temp') {
      icon.title = icon.title + ' (Klik for at ændre temperatur)';
    } else if (deviceId === 'humidity-sensor') {
      icon.title = icon.title + ' (Klik for at ændre fugtighed)';
    } else {
      icon.title = icon.title + ' (Klik for at skifte status)';
    }
  });
  
  console.log('✅ Floor plan interaction setup complete');
}

function showTemperatureSensorDialog(deviceId) {
  const currentTemp = deviceStates[deviceId];
  const sensorName = deviceId === 'outdoor-temp' ? 'Udendørs temperatur' : 'Temperatur sensor';
  
  const newTemp = prompt(`🌡️ ${sensorName}\n\nNuværende temperatur: ${currentTemp}°C\n\nIndtast ny temperatur (-20 til 50°C):`, currentTemp);
  
  if (newTemp !== null && !isNaN(newTemp)) {
    const temp = Math.max(-20, Math.min(50, parseFloat(newTemp)));
    deviceStates[deviceId] = temp;
    
    // Update visual feedback
    updateSensorIcon(deviceId, temp);
    
    // Show notification
    showNotification(`🌡️ ${sensorName} sat til ${temp}°C`, 'info');
    
    // Trigger automation rules
    if (deviceStates['automation-master']) {
      checkAutomationTriggers(deviceId, temp);
    }
    
    console.log('🌡️ Temperature sensor updated:', deviceId, temp + '°C');
  }
}

function showHumiditySensorDialog(deviceId) {
  const currentHumidity = deviceStates[deviceId];
  
  const newHumidity = prompt(`💧 Fugtighedssensor\n\nNuværende fugtighed: ${currentHumidity}%\n\nIndtast ny fugtighed (0-100%):`, currentHumidity);
  
  if (newHumidity !== null && !isNaN(newHumidity)) {
    const humidity = Math.max(0, Math.min(100, parseFloat(newHumidity)));
    deviceStates[deviceId] = humidity;
    
    // Update visual feedback
    updateSensorIcon(deviceId, humidity);
    
    // Show notification
    showNotification(`💧 Fugtighedssensor sat til ${humidity}%`, 'info');
    
    // Trigger automation rules
    if (deviceStates['automation-master']) {
      checkAutomationTriggers(deviceId, humidity);
    }
    
    console.log('💧 Humidity sensor updated:', deviceId, humidity + '%');
  }
}

function updateSensorIcon(deviceId, value) {
  const deviceIcon = document.querySelector(`.floor-plan-background .smart-device[data-device="${deviceId}"]`);
  if (deviceIcon) {
    // Add visual feedback based on value ranges
    deviceIcon.classList.remove('sensor-low', 'sensor-normal', 'sensor-high', 'sensor-critical');
    
    if (deviceId === 'outdoor-temp') {
      if (value < -10) {
        deviceIcon.classList.add('sensor-critical'); // Ekstremt koldt - rød pulserende
      } else if (value < 0) {
        deviceIcon.classList.add('sensor-low'); // Koldt - blå
      } else if (value > 35) {
        deviceIcon.classList.add('sensor-critical'); // Ekstremt varmt - rød pulserende
      } else if (value > 28) {
        deviceIcon.classList.add('sensor-high'); // Varmt - orange
      }
      // Mellem 0-28°C = ingen farve (neutral)
    } else if (deviceId === 'humidity-sensor') {
      if (value > 80) {
        deviceIcon.classList.add('sensor-critical'); // Meget høj fugtighed - rød pulserende
      } else if (value > 65) {
        deviceIcon.classList.add('sensor-high'); // Høj fugtighed - orange
      } else if (value < 25) {
        deviceIcon.classList.add('sensor-low'); // Lav fugtighed - blå
      }
      // Mellem 25-65% = ingen farve (neutral)
    }
    
    console.log('🎨 Updated sensor icon:', deviceId, 'value:', value);
  }
}

function toggleDevice(deviceId) {
  console.log('🔧 Toggling device:', deviceId);
  
  // Toggle the state
  deviceStates[deviceId] = !deviceStates[deviceId];
  const isOn = deviceStates[deviceId];
  
  console.log('🔧', deviceId, 'is now:', isOn ? 'ON' : 'OFF');
  console.log('🤖 Automation master state:', deviceStates['automation-master']);
  
  // Update the UI
  updateDeviceUI(deviceId, isOn);
  
  // Update the device icon on the floor plan
  updateDeviceIcon(deviceId, isOn);
  
  // Handle special device logic
  handleSpecialDeviceLogic(deviceId, isOn);
  
  // Trigger automation rules if enabled
  if (deviceStates['automation-master']) {
    console.log('🚀 Triggering automation check for:', deviceId, isOn);
    checkAutomationTriggers(deviceId, isOn);
  } else {
    console.log('⏸️ Automation master is disabled, skipping triggers');
  }
}

function handleSpecialDeviceLogic(deviceId, isOn) {
  switch(deviceId) {
    case 'alarm-system':
      const alarmStatus = document.getElementById('alarmStatus');
      if (alarmStatus) {
        alarmStatus.textContent = isOn ? 'Aktiveret' : 'Deaktiveret';
        alarmStatus.className = 'security-status ' + (isOn ? 'active' : '');
      }
      
      // Visual feedback on floor plan
      if (isOn) {
        showNotification('🚨 Alarm system aktiveret', 'security');
        pulseSecurityDevices();
      } else {
        showNotification('🔓 Alarm system deaktiveret', 'info');
      }
      break;
      
    case 'auto-lock':
      if (isOn) {
        // Lock all doors
        deviceStates['front-door'] = true;
        updateFloorPlanDevice('front-door', true);
        showNotification('🔒 Alle døre låst automatisk', 'security');
      }
      break;
      
    case 'ventilation':
      // Sync ventilation with bathroom-fan on floor plan
      deviceStates['bathroom-fan'] = isOn;
      updateDeviceIcon('bathroom-fan', isOn);
      
      if (isOn) {
        showNotification('🌪️ Ventilation aktiveret', 'success');
      } else {
        showNotification('🌪️ Ventilation stoppet', 'info');
      }
      break;
      
    case 'bathroom-fan':
      // Sync bathroom-fan with ventilation control panel
      deviceStates['ventilation'] = isOn;
      updateDeviceUI('ventilation', isOn);
      break;
      
    case 'automation-master':
      const ruleCount = document.getElementById('ruleCount');
      if (ruleCount) {
        if (isOn) {
          ruleCount.textContent = `${automationRules.length} aktive regler`;
          showNotification('🤖 Automation aktiveret', 'success');
        } else {
          ruleCount.textContent = 'Automation deaktiveret';
          showNotification('⏸️ Automation sat på pause', 'info');
        }
      }
      break;
  }
}

function updateDeviceUI(deviceId, isOn) {
  // Update the toggle button - specifically find the button in the control panel
  const toggleButton = document.querySelector(`.smart-home-control-panel .device-toggle[data-device="${deviceId}"]`);
  if (toggleButton) {
    if (isOn) {
      toggleButton.classList.add('on');
    } else {
      toggleButton.classList.remove('on');
    }
    console.log('🎛️ Device UI updated:', deviceId, isOn ? 'ON' : 'OFF');
  } else {
    console.warn('⚠️ Device toggle not found:', deviceId);
  }
}

// Smart home scenarios
function executeScenario(scenarioId) {
  console.log('🎬 Executing scenario:', scenarioId);
  
  // Clear previous active scenario
  document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.remove('active'));
  
  // Mark current scenario as active
  const scenarioBtn = document.querySelector(`[data-scenario="${scenarioId}"]`);
  if (scenarioBtn) {
    scenarioBtn.classList.add('active');
    
    // Remove active class after animation
    setTimeout(() => {
      scenarioBtn.classList.remove('active');
    }, 2000);
  }
  
  activeScenario = scenarioId;
  
  switch(scenarioId) {
    case 'good-morning':
      executeGoodMorningScenario();
      break;
    case 'leaving-home':
      executeLeavingHomeScenario();
      break;
    case 'good-night':
      executeGoodNightScenario();
      break;
    case 'coming-home':
      executeComingHomeScenario();
      break;
  }
}

function executeGoodMorningScenario() {
  showNotification('🌅 God Morgen rutine startet', 'scenario');
  
  const sequence = [
    () => { setDevice('bedroom-light', true); },
    () => { setDevice('kitchen-light', true); },
    () => { setDevice('dining-light', true); },
    () => { deviceStates.temperature = 22; updateTemperatureUI(); },
    () => { setDevice('ventilation', true); },
    () => { setDevice('alarm-system', false); }
  ];
  
  executeSequence(sequence, 800);
}

function executeLeavingHomeScenario() {
  showNotification('🏃 Forlader hjem rutine startet', 'scenario');
  
  const sequence = [
    () => { setAllLights(false); },
    () => { setDevice('alarm-system', true); },
    () => { setDevice('auto-lock', true); },
    () => { setDevice('ventilation', false); },
    () => { deviceStates.temperature = 18; updateTemperatureUI(); }
  ];
  
  executeSequence(sequence, 600);
}

function executeGoodNightScenario() {
  showNotification('🌙 God Nat rutine startet', 'scenario');
  
  const sequence = [
    () => { setAllLights(false); },
    () => { setDevice('alarm-system', true); },
    () => { setDevice('auto-lock', true); },
    () => { deviceStates.temperature = 19; updateTemperatureUI(); },
    () => { setDevice('ventilation', false); }
  ];
  
  executeSequence(sequence, 1000);
}

function executeComingHomeScenario() {
  showNotification('🏠 Velkommen hjem rutine startet', 'scenario');
  
  const sequence = [
    () => { setDevice('alarm-system', false); },
    () => { setDevice('living-room-light', true); },
    () => { setDevice('kitchen-light', true); },
    () => { deviceStates.temperature = 21; updateTemperatureUI(); },
    () => { setDevice('ventilation', true); }
  ];
  
  executeSequence(sequence, 700);
}

function executeSequence(actions, delay) {
  actions.forEach((action, index) => {
    setTimeout(action, index * delay);
  });
}

function setDevice(deviceId, state) {
  if (deviceStates.hasOwnProperty(deviceId)) {
    console.log('🔧 Setting device via automation:', deviceId, 'to', state);
    deviceStates[deviceId] = state;
    updateDeviceUI(deviceId, state);
    updateDeviceIcon(deviceId, state);
    handleSpecialDeviceLogic(deviceId, state);
    
    // Don't trigger automation rules when set via automation (prevent loops)
    // Only trigger when manually toggled
  }
}

function setAllLights(state) {
  const lightDevices = ['bedroom-light', 'living-room-light', 'dining-light', 'kitchen-light', 'bathroom-light'];
  lightDevices.forEach(deviceId => {
    setDevice(deviceId, state);
  });
}

function updateTemperatureUI() {
  const tempSlider = document.getElementById('tempSlider');
  const currentTempDisplay = document.getElementById('currentTemp');
  
  if (tempSlider) tempSlider.value = deviceStates.temperature;
  if (currentTempDisplay) currentTempDisplay.textContent = deviceStates.temperature;
  
  updateThermostatIcon(deviceStates.temperature);
}

function updateDeviceIcon(deviceId, isOn) {
  // Find the device icon on the floor plan - specifically the smart-device element
  const deviceIcon = document.querySelector(`.floor-plan-background .smart-device[data-device="${deviceId}"]`);
  if (deviceIcon) {
    // Handle special cases for door locks
    if (deviceId === 'front-door') {
      deviceIcon.classList.toggle('on', isOn);  // on = locked
      deviceIcon.classList.toggle('off', !isOn); // off = unlocked
    } else if (deviceId === 'outdoor-temp' || deviceId === 'humidity-sensor') {
      // Sensors don't use on/off - they use value-based classes set by updateSensorIcon
      console.log('🌡️ Sensor icon skipped - managed by updateSensorIcon:', deviceId);
      return;
    } else {
      deviceIcon.classList.toggle('on', isOn);
      deviceIcon.classList.remove('off');
    }
    
    console.log('🎯 Device icon updated:', deviceId, isOn ? 'glowing' : 'normal');
  } else {
    console.warn('⚠️ Device icon not found:', deviceId);
  }
}

function showDeviceStatusNotification(deviceId, isOn) {
  let message = '';
  let type = 'info';
  
  switch(deviceId) {
    // Lights
    case 'bedroom-light':
    case 'living-room-light':
    case 'dining-light':
    case 'kitchen-light':
    case 'bathroom-light':
      const roomName = deviceId.replace('-light', '').replace('-', ' ');
      message = `💡 ${roomName} lys ${isOn ? 'tændt' : 'slukket'}`;
      type = isOn ? 'success' : 'info';
      break;
      
    // Sensors (PIR/Motion)
    case 'entrance-motion':
    case 'living-motion':
    case 'motion-kitchen':
      const sensorLocation = deviceId.replace('-motion', '').replace('motion-', '');
      message = `👁️ ${sensorLocation} bevægelse ${isOn ? 'detekteret' : 'ikke aktiv'}`;
      type = isOn ? 'security' : 'info';
      break;
      
    // Cameras
    case 'entrance-camera':
    case 'balcony-camera':
      const cameraLocation = deviceId.replace('-camera', '');
      message = `📹 ${cameraLocation} kamera ${isOn ? 'optager' : 'standby'}`;
      type = isOn ? 'info' : 'info';
      break;
      
    // Windows/Doors
    case 'bedroom-window':
    case 'balcony-door':
      const windowLocation = deviceId.replace('-window', '').replace('-door', '');
      message = `🪟 ${windowLocation} ${isOn ? 'åben' : 'lukket'}`;
      type = isOn ? 'security' : 'info';
      break;
      
    case 'front-door':
      message = `🔐 Hoveddør ${isOn ? 'låst' : 'ulåst'}`;
      type = isOn ? 'security' : 'success';
      break;
      
    // Audio
    case 'living-speaker':
      message = `🔊 Højttaler ${isOn ? 'tændt' : 'slukket'}`;
      type = isOn ? 'info' : 'info';
      break;
      
    // Fans
    case 'bathroom-fan':
      message = `🌪️ Badeværelse blæser ${isOn ? 'kører' : 'stoppet'}`;
      type = isOn ? 'success' : 'info';
      break;
      
    // Safety
    case 'smoke-detector':
      message = `💨 Røgdetektor ${isOn ? 'ALARM!' : 'normal'}`;
      type = isOn ? 'security' : 'success';
      break;
      
    default:
      message = `🔧 ${deviceId} ${isOn ? 'aktiveret' : 'deaktiveret'}`;
      type = 'info';
  }
  
  showNotification(message, type);
}

// Helper functions for floor plan updates
function updateFloorPlanDevice(deviceId, state) {
  updateDeviceIcon(deviceId, state);
}

function updateThermostatIcon(temperature) {
  const thermostatIcon = document.querySelector('.smart-device[data-device="thermostat"]');
  if (thermostatIcon) {
    // Visual temperature feedback
    if (temperature > 23) {
      thermostatIcon.style.borderColor = '#ef4444'; // Red for hot
    } else if (temperature < 19) {
      thermostatIcon.style.borderColor = '#3b82f6'; // Blue for cold
    } else {
      thermostatIcon.style.borderColor = '#10b981'; // Green for optimal
    }
    
    // Add pulsing effect when temperature changes
    thermostatIcon.style.animation = 'tempPulse 1s ease-in-out';
    setTimeout(() => {
      thermostatIcon.style.animation = '';
    }, 1000);
  }
}

function pulseSecurityDevices() {
  const securityDevices = document.querySelectorAll('.smart-device.camera, .smart-device.sensor, .smart-device.lock');
  securityDevices.forEach((device, index) => {
    setTimeout(() => {
      device.style.animation = 'securityPulse 0.5s ease-in-out';
      setTimeout(() => {
        device.style.animation = '';
      }, 500);
    }, index * 200);
  });
}

// Notification system
function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <div class="notification-content">
      <span class="notification-message">${message}</span>
      <button class="notification-close">×</button>
    </div>
  `;
  
  // Add to page
  document.body.appendChild(notification);
  
  // Auto remove after 4 seconds
  setTimeout(() => {
    notification.classList.add('fade-out');
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 4000);
  
  // Close button functionality
  const closeBtn = notification.querySelector('.notification-close');
  closeBtn.addEventListener('click', () => {
    notification.classList.add('fade-out');
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  });
}

// Automation rule engine
function checkAutomationTriggers(deviceId, state) {
  console.log('🔍 Checking automation triggers for:', deviceId, 'state:', state);
  console.log('🤖 Automation master enabled:', deviceStates['automation-master']);
  console.log('📋 Available rules:', automationRules.length);
  
  if (!deviceStates['automation-master']) {
    console.log('⏸️ Automation master is disabled');
    return;
  }
  
  automationRules.forEach((rule, index) => {
    if (!rule.enabled) return;
    
    const trigger = rule.trigger;
    let ruleTriggered = false;
    
    if (trigger.device === deviceId) {
      if (trigger.type === 'boolean') {
        // Boolean triggers (original logic)
        ruleTriggered = (trigger.state === state);
      } else if (trigger.type === 'numeric') {
        // Numeric triggers for sensors
        const value = parseFloat(state);
        console.log('🔢 Numeric trigger check:', trigger.device, 'current value:', value, 'operator:', trigger.operator, 'threshold:', trigger.threshold);
        switch(trigger.operator) {
          case 'greater':
            ruleTriggered = (value > trigger.threshold);
            break;
          case 'less':
            ruleTriggered = (value < trigger.threshold);
            break;
          case 'equals':
            ruleTriggered = (value === trigger.threshold);
            break;
          case 'between':
            ruleTriggered = (value >= trigger.min && value <= trigger.max);
            break;
        }
        console.log('🎯 Numeric trigger result:', ruleTriggered);
      }
      
      if (ruleTriggered) {
        console.log('✅ Rule triggered:', rule.name, 'by', deviceId, 'with value:', state);
        executeAutomationRule(rule);
      }
    }
  });
}

function executeAutomationRule(rule) {
  console.log('🤖 Executing automation rule:', rule.name);
  console.log('🎯 Rule actions:', rule.actions);
  
  showNotification(`🤖 ${rule.name} aktiveret`, 'automation');
  
  // Execute rule actions
  rule.actions.forEach((action, index) => {
    console.log(`⏰ Scheduling action ${index}:`, action, 'delay:', action.delay || 0);
    
    setTimeout(() => {
      console.log(`▶️ Executing action ${index}:`, action);
      
      if (action.type === 'device') {
        setDevice(action.device, action.state);
      } else if (action.type === 'allLights') {
        setAllLights(action.state);
      } else if (action.type === 'scenario') {
        executeScenario(action.scenario);
      } else if (action.type === 'temperature') {
        deviceStates.temperature = action.value;
        updateTemperatureUI();
      } else if (action.type === 'notification') {
        showNotification(action.message || 'Wiresheet notification', 'automation');
      }
    }, action.delay || 0);
  });
}

function addAutomationRule(rule) {
  automationRules.push(rule);
  updateRuleList();
  updateRuleCount();
  console.log('🤖 Added automation rule:', rule.name);
}

function updateRuleList() {
  const ruleList = document.getElementById('activeRules');
  if (!ruleList) return;
  
  ruleList.innerHTML = '';
  
  automationRules.forEach((rule, index) => {
    const ruleElement = document.createElement('div');
    ruleElement.className = 'rule-item';
    ruleElement.innerHTML = `
      <div class="rule-info">
        <div class="rule-name">${rule.name}</div>
        <div class="rule-description">${rule.description}</div>
      </div>
      <div class="rule-controls">
        <button class="rule-toggle ${rule.enabled ? 'on' : ''}" data-rule-index="${index}"></button>
        <button class="rule-delete" data-rule-index="${index}" title="Slet regel">🗑</button>
      </div>
    `;
    
    // Add toggle functionality
    const toggle = ruleElement.querySelector('.rule-toggle');
    toggle.addEventListener('click', () => {
      rule.enabled = !rule.enabled;
      toggle.classList.toggle('on', rule.enabled);
      console.log('🤖 Rule', rule.name, rule.enabled ? 'enabled' : 'disabled');
      updateRuleCount();
    });
    
    // Add delete functionality
    const deleteBtn = ruleElement.querySelector('.rule-delete');
    deleteBtn.addEventListener('click', () => {
      deleteAutomationRule(index, rule.name);
    });
    
    ruleList.appendChild(ruleElement);
  });
}

function updateRuleCount() {
  const ruleCount = document.getElementById('ruleCount');
  if (ruleCount && deviceStates['automation-master']) {
    const enabledRules = automationRules.filter(rule => rule.enabled).length;
    ruleCount.textContent = `${enabledRules} aktive regler`;
  }
}

function deleteAutomationRule(index, ruleName) {
  console.log('🗑️ Deleting automation rule:', ruleName, 'at index:', index);
  
  // Vis bekræftelses dialog
  const confirmDelete = confirm(`Er du sikker på at du vil slette reglen "${ruleName}"?\n\nDenne handling kan ikke fortrydes.`);
  
  if (confirmDelete) {
    // Fjern reglen fra array
    automationRules.splice(index, 1);
    
    // Opdater UI
    updateRuleList();
    updateRuleCount();
    
    // Vis success notification
    showNotification(`🗑️ Regel "${ruleName}" er slettet`, 'info');
    
    console.log('✅ Rule deleted successfully. Remaining rules:', automationRules.length);
  } else {
    console.log('❌ Rule deletion cancelled by user');
  }
}

// Example automation rules
function initializeDefaultRules() {
  console.log('🏗️ Initializing default automation rules...');
  
  // Prædefinerede regler fjernet - brugere kan nu kun lave deres egne regler
  
  console.log('✅ Default rules initialized:', automationRules.length, 'rules');
}

// === WIRESHEET ↔ HOME AUTOMATION BRIDGE ===

// Global function accessible from wiresheet
window.addHomeAutomationRule = function(rule) {
  console.log('🌉 Bridge: Receiving rule from wiresheet:', rule);
  
  // Set new rules as disabled by default
  rule.enabled = false;
  
  // Add to automation rules
  addAutomationRule(rule);
  
  // Update UI immediately
  updateRuleList();
  updateRuleCount();
  
  console.log('✅ Rule added to home automation system (disabled by default)');
}

// Make other functions globally accessible for wiresheet
window.showNotification = showNotification;

// Function to simulate device triggers for testing
window.simulateDeviceTrigger = function(deviceId, state) {
  console.log('🎮 Simulating device trigger:', deviceId, state);
  
  if (deviceStates['automation-master']) {
    checkAutomationTriggers(deviceId, state);
  } else {
    console.log('⏸️ Automation master is disabled');
  }
}

// Function to test wiresheet integration
window.testWiresheetIntegration = function() {
  console.log('🧪 Testing wiresheet integration...');
  
  // Simulate a wiresheet rule
  var testRule = {
    name: 'Test Wiresheet Regel',
    description: 'Test regel fra wiresheet integration',
    enabled: true,
    trigger: { device: 'entrance-motion', state: true },
    actions: [
      { type: 'device', device: 'kitchen-light', state: true, delay: 0 }
    ]
  };
  
  window.addHomeAutomationRule(testRule);
  showNotification('🧪 Test regel tilføjet fra wiresheet', 'automation');
}
</script>

</body>
</html>
