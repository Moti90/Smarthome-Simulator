<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <title>IBISIMULATOR (WebView2)</title>
  <meta http-equiv="x-ua-compatible" content="IE=edge" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  
  <!-- Firebase Test -->
  <script>
    console.log('üîç Firebase scripts indl√¶st');
    console.log('üîç window.firebase:', typeof window.firebase);
    console.log('üîç firebase object:', typeof firebase);
  </script>

  <style>
    /* Stabil CSS-beregning */
    *, *::before, *::after { box-sizing: border-box; }

    /* Global smooth transitions - exclude wiresheet elements for performance */
    *:not(.ws-node):not(.ws-canvas):not(.ws-wires):not(.ws-nodes):not([class*="ws-"]) {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Performance optimized transitions for specific properties */
    button:not(.ws-node button), .card:not(.ws-canvas .card), .tabs button, input, select, textarea {
      transition: 
        background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1),
        border-color 0.2s cubic-bezier(0.4, 0, 0.2, 1),
        box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
        transform 0.2s cubic-bezier(0.4, 0, 0.2, 1),
        opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Disable transitions for wiresheet elements during drag operations */
    .ws-node, .ws-canvas, .ws-wires, .ws-nodes, [class*="ws-"] {
      transition: none !important;
    }

    .ws-node.dragging, .ws-node.dragging * {
      transition: none !important;
      pointer-events: none;
    }

    html,body{
      font-family:Segoe UI,system-ui,-apple-system,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;
      margin:0;background:#0b0f14;color:#e5e9f0
    }

    header{padding:12px 16px;background:#111720;border-bottom:1px solid #1f2933;display:flex;align-items:center;gap:12px;position:relative}
    .brand{ position:absolute; left:0; right:0; text-align:center; pointer-events:none; }
    .brand .goldtext{ color:#D4AF37; font-weight:700; text-shadow:0 1px 0 #000, 0 0 6px rgba(212,175,55,.5); letter-spacing:0.5px; }
    .top-right{margin-left:auto;display:flex;gap:8px;align-items:center}

    /* Faner (SPA) */
    .tabs{display:flex;gap:8px;margin:8px 16px 0 16px}
    .tabs button{background:#1a2430;border:1px solid #2a3442;color:#e5e9f0;border-radius:8px;padding:6px 10px;cursor:pointer}
    .tabs button.active{background:#2d3b4f}
    .views{padding:8px 16px 16px 16px}
    .view{display:none}
    .view.active{display:block}

    /* 3-kolonne layout inde i Simulator - balanceret plads */
.wrap{display:grid;grid-template-columns:450px 1fr 500px;gap:16px}
    .card{background:#111720;border:1px solid #1f2933;border-radius:10px;overflow:visible}
    .card h2{font-size:14px;margin:0;padding:10px 12px;border-bottom:1px solid #1f2933;background:#0f141c}
    .card .body{padding:10px 12px}

    label{display:block;font-size:12px;margin-top:6px;margin-bottom:4px;color:#cbd5e1}
    input[type="text"], input[type="number"], select, input[type="time"]{width:100%;padding:8px;border-radius:8px;border:1px solid #2a3442;background:#0b1118;color:#e5e9f0;position:relative;z-index:2}
    input[type="file"]{width:100%;padding:6px;border-radius:8px;border:1px solid #2a3442;background:#0b1118;color:#e5e9f0}
    input[type="checkbox"]{transform:scale(1.2)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    @media (max-width: 900px) { .grid2, .grid3 { grid-template-columns: 1fr; } }
    button{background:#2d3b4f;color:#e5e9f0;border:1px solid #3b495e;border-radius:8px;padding:8px 10px;cursor:pointer}
    button:hover{background:#38506c}
    .danger{background:#5b2d2d;border-color:#7a3a3a}
    .success{background:#2d5b3a;border-color:#3a7a4c}
    .info{background:#2d4e5b;border-color:#3a6b7a}
    .muted{opacity:.8}
    .tag{padding:2px 6px;border-radius:6px;background:#1e2936;border:1px solid #2a3442;font-size:11px}
    .rule{border:1px dashed #334155;border-radius:8px;padding:8px;margin-bottom:8px}
    .log{height:240px;overflow:auto;background:#0b1118;border:1px solid #1f2933;border-radius:8px;padding:8px;font-family:Consolas,ui-monospace,Menlo,monospace;font-size:12px;white-space:normal}
    .footer{opacity:.7;padding:8px 16px}
    .small{font-size:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #2a3442;border-radius:999px;background:#0b1118}
    .sp{height:8px}
    .divider{height:1px;background:#1f2933;margin:8px 0}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .kpi .box{background:#0b1118;border:1px solid #1f2933;border-radius:8px;padding:8px;text-align:center}
    textarea{width:100%;height:260px;background:#0b1118;color:#e5e9f0;border:1px solid #1f2933;border-radius:8px;padding:8px;font-family:Consolas,ui-monospace}

    .menu{ position:absolute; right:12px; top:50%; transform:translateY(-50%); z-index:3000; }
    .menu > button{min-width:110px}
    .menu-list{position:absolute;right:0;top:110%;background:#0f141c;border:1px solid #2a3442;border-radius:8px;min-width:220px;display:none;z-index:4000;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .menu-list button{display:block;width:100%;text-align:left;background:transparent;border:0;border-bottom:1px solid #1f2933;padding:10px}
    .menu-list button:last-child{border-bottom:0}
    .menu.open .menu-list{display:block}

    .has-tip{position:relative}
    .has-tip:hover::after{
      content:attr(data-tip); position:absolute; left:auto; right:0; top:-8px; transform:translateY(-100%);
      background:#101821; border:1px solid #2a3442; padding:6px 8px; border-radius:8px;
      color:#e5e9f0; font-size:11px; white-space:pre-wrap; max-width:320px; box-shadow:0 6px 16px rgba(0,0,0,.35);
      pointer-events:none; z-index:1500;
    }
    .log .match{ color:#00d26a; font-weight:600; }

    /* Nye styles for forbedret design */
    .section-group {
      margin-bottom: 16px;
      padding: 8px;
      background: rgba(15, 20, 28, 0.6);
      border: 1px solid #1f2933;
      border-radius: 12px;
    }
    
    .section-group:last-child {
      margin-bottom: 0;
    }
    
    .control-group {
      margin-bottom: 12px;
    }
    
    .control-group:last-child {
      margin-bottom: 0;
    }
    
    .input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .input-row .styled-input {
      flex: 1;
    }
    
    .button-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .styled-input {
      background: rgba(255, 255, 255, 0.95) !important;
      color: #1f2937 !important;
      border: 1px solid #d1d5db !important;
      padding: 10px 12px !important;
      border-radius: 8px !important;
      font-size: 13px !important;
      transition: all 0.2s ease !important;
    }
    
    .styled-input:focus {
      outline: none;
      border-color: #3b82f6 !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    }
    
    .styled-input:hover {
      border-color: #9ca3af !important;
    }

    /* CSS variabler for tema support */
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border-color: #475569;
      --accent-color: #60a5fa;
    }

    /* Indstillinger side styling */
    .settings-section {
      margin-bottom: 24px;
      padding: 20px;
      background: rgba(15, 20, 28, 0.4);
      border: 1px solid #1f2933;
      border-radius: 16px;
      transition: all 0.2s ease;
    }
    
    /* L√¶rer Dashboard styling */
    .progress-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .progress-item {
      background: #0f141c;
      border: 1px solid #1f2933;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }
    .progress-item .student-name {
      font-weight: 600;
      color: #e5e9f0;
      margin-bottom: 4px;
    }
    .progress-item .task-info {
      color: #cbd5e1;
      font-size: 12px;
    }
    .progress-item .timestamp {
      color: #64748b;
      font-size: 11px;
      margin-top: 4px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    .stat-box {
      background: #0f141c;
      border: 1px solid #1f2933;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }
    .stat-number {
      font-size: 24px;
      font-weight: 700;
      color: #10b981;
      margin-bottom: 4px;
    }
    .stat-label {
      color: #cbd5e1;
      font-size: 12px;
    }
    
    .settings-section:hover {
      background: rgba(15, 20, 28, 0.6);
      border-color: #2a3442;
    }
    
    .settings-section h3 {
      margin: 0 0 16px 0;
      color: #e5e9f0;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .setting-item {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .setting-item:last-child {
      margin-bottom: 0;
    }
    
    .setting-item label {
      color: #d1d5db;
      font-weight: 500;
      font-size: 14px;
    }
    
    .setting-description {
      color: #9ca3af;
      font-size: 13px;
      line-height: 1.4;
    }
    
    .styled-select {
      background: rgba(15, 20, 28, 0.8);
      color: #e5e9f0;
      border: 1px solid #2a3442;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .styled-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .styled-select:hover {
      border-color: #4b5563;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #4b5563, #374151);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }
    
    .btn-danger:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    /* Style for ugedag og d√¶mper felter - matcher klokkesl√¶ts boksen */
    .styled-input.weekday-select,
    .styled-input.dimmer-select {
      background: rgba(15, 20, 28, 0.8) !important;
      color: #e5e9f0 !important;
      border: 1px solid #2a3442 !important;
    }

    /* Z-Wave r√¶kker ‚Äì nu med wrap og metachips */
    .zw-row{
      display:flex; align-items:center; gap:8px;
      flex-wrap:wrap; width:100%;
      margin:6px 0;
    }
    .zw-row .zw-type{ flex:1 1 180px; min-width:160px; }
    .zw-row .zw-val{  flex:0 0 120px; }

    .zw-row button{ flex:0 0 auto; }
    .zw-meta{ margin-left:auto; display:flex; gap:8px; }
    .zw-badge{font-size:11px;padding:2px 6px;border:1px solid #2a3442;border-radius:999px;background:#0b1118;opacity:.8}
    .zw-global, .zw-maps{
      font-family:Consolas,ui-monospace,Menlo,monospace;font-size:11px;
      background:#0b1118;border:1px solid #2a3442;border-radius:6px;padding:2px 6px
    }
    .zw-maps::before{ content:"‚Ü¶ "; }
  
/* === WIRESHEET MVP === */
.ws-canvas{
  position:relative; height:560px; background:
    linear-gradient(180deg,#0b1118,#0a0f15 60%);
  border:1px solid #1f2933; border-radius:12px; overflow:hidden;
}
.ws-wires{ position:absolute; inset:0; pointer-events:none }
.ws-nodes{ position:absolute; inset:0; }

.ws-node{
  position:absolute; min-width:200px; max-width:260px;
  background:#0e1520; border:1px solid #1f2933; border-radius:12px;
  box-shadow:0 8px 24px rgba(0,0,0,.25);
  user-select:none;
}
.ws-node.dragging{ opacity:.9; outline:1px dashed #3a4b63 }
.ws-head{
  display:flex; align-items:center; gap:8px; justify-content:space-between;
  padding:8px 10px; background:#0f141c; border-bottom:1px solid #16202c; border-radius:12px 12px 0 0;
  font-size:12px;
}
.ws-head .type{opacity:.85}
.ws-body{ padding:8px 10px; }
.ws-body .row{ margin-bottom:6px }
.ws-body select, .ws-body input[type="text"]{
  width:100%; padding:8px; border-radius:8px; border:1px solid #2a3442;
  background:#0b1118; color:#e5e9f0; font-size:12px;
}

.port{
  width:12px; height:12px; border-radius:50%;
  border:2px solid #2a3442; background:#0b1118;
}
.port.out{ box-shadow:0 0 0 2px rgba(88,131,196,.25); }
.port.in{ box-shadow:0 0 0 2px rgba(88,196,131,.25); }
.port-row{
  display:flex; align-items:center; gap:6px; margin:6px 0;
}
.port-label{ font-size:11px; opacity:.85 }
.ws-foot{ padding:6px 10px; border-top:1px solid #16202c; display:flex; gap:6px; justify-content:flex-end }

/* Node color accents */
.ws-node.trig .ws-head{ color:#bfe8ff }
.ws-node.cond .ws-head{ color:#c8e6ff }
.ws-node.act  .ws-head{ color:#ffe7b3 }
.ws-node.rule .ws-head{ color:#b3ffd3 }
.ws-btn{ background:#1a2430; border:1px solid #2a3442; color:#e5e9f0; border-radius:8px; padding:4px 8px; cursor:pointer; font-size:11px }
.ws-btn:hover{ background:#223247 }

.ws-badge{ font-size:10px; padding:2px 6px; border-radius:999px; border:1px solid #334155; background:#101821; }
.ws-warn{ color:#ffd38a; font-size:11px; }
.ws-ok{ color:#9ee6b8; font-size:11px; }
.ws-preview{ font-family:Consolas,ui-monospace; font-size:11px; opacity:.9; padding:6px 8px; background:#0b1118; border:1px solid #1f2933; border-radius:8px; margin-top:6px }

  
.ws-id{font-weight:600; opacity:.9; margin-right:auto}
.ws-links{font-size:11px; opacity:.8; padding:4px 6px; border-top:1px dashed #223; margin-top:4px}

  
/* === Type colors === */
.ws-node.trig { border-color:#2563eb; }
.ws-node.trig .ws-head { background:linear-gradient(90deg,#1e3a8a,#1e40af); color:#dbeafe; }
.ws-node.trig::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background:#2563eb; border-radius:12px 0 0 12px; }

.ws-node.cond { border-color:#7c3aed; }
.ws-node.cond .ws-head { background:linear-gradient(90deg,#581c87,#6d28d9); color:#ede9fe; }
.ws-node.cond::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background:#7c3aed; border-radius:12px 0 0 12px; }

.ws-node.act  { border-color:#f59e0b; }
.ws-node.act  .ws-head { background:linear-gradient(90deg,#78350f,#b45309); color:#fef3c7; }
.ws-node.act::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background:#f59e0b; border-radius:12px 0 0 12px; }

.ws-node.rule { border-color:#10b981; }
.ws-node.rule .ws-head { background:linear-gradient(90deg,#064e3b,#047857); color:#d1fae5; }
.ws-node.rule::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background:#10b981; border-radius:12px 0 0 12px; }

  
/* Palette buttons farver */
#wsAddTrig { background:#1e40af; border-color:#2563eb; color:#dbeafe; }
#wsAddTrig:hover { filter:brightness(1.05); }
#wsAddCond { background:#6d28d9; border-color:#7c3aed; color:#ede9fe; }
#wsAddCond:hover { filter:brightness(1.05); }
#wsAddAct  { background:#b45309; border-color:#f59e0b; color:#fef3c7; }
#wsAddAct:hover { filter:brightness(1.05); }
#wsAddRule { background:#047857; border-color:#10b981; color:#d1fae5; }
#wsAddRule:hover { filter:brightness(1.05); }

  
/* === Login click-through fix === */
#loginView { position: relative; }
#loginView::before,
#loginView::after {
  pointer-events: none !important;  /* overlays m√• ikke blokere klik */
  z-index: 0;
}
/* S√∏rg for at selve login-panelet er √∏verst */
#loginView .login-card,
#loginView .card {
  position: relative;
  z-index: 5 !important;
}


/* === Modern Login Design === */
#loginView{
  position: relative;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #0f1419 0%, #1a2432 50%, #2a3442 100%);
  overflow: hidden;
}

/* Animated background elements */
#loginView::before{
  content:"";
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle at 30% 70%, rgba(37, 99, 235, 0.08) 0%, transparent 50%),
              radial-gradient(circle at 70% 30%, rgba(156, 163, 175, 0.05) 0%, transparent 50%);
  animation: backgroundFloat 20s ease-in-out infinite;
  z-index: 1;
  pointer-events: none;
}

@keyframes backgroundFloat {
  0%, 100% { transform: rotate(0deg) scale(1); }
  50% { transform: rotate(180deg) scale(1.1); }
}

/* Large IBI logo */
.login-logo {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 40px;
  z-index: 10;
  position: relative;
}

.login-logo .logo-ibi {
  width: 140px;
  height: 120px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
  position: relative;
  animation: logoGlow 3s ease-in-out infinite alternate;
}

@keyframes logoGlow {
  from { filter: drop-shadow(0 10px 20px rgba(0, 194, 168, 0.3)); }
  to { filter: drop-shadow(0 15px 30px rgba(0, 194, 168, 0.5)); }
}

/* IBI Letter styling */
.ibi-letter {
  display: inline-block;
  font-family: 'Arial', sans-serif;
  font-weight: 900;
  font-size: 48px;
  margin: 0 2px;
  position: relative;
}

.ibi-letter.i1,
.ibi-letter.i2 {
  color: #e5e7eb;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.ibi-letter.b {
  color: #e5e7eb;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* Decorative squares */
.ibi-letter.i1::before {
  content: '';
  position: absolute;
  top: -8px;
  left: -8px;
  width: 12px;
  height: 12px;
  background: #00c2a8;
  border-radius: 2px;
  box-shadow: 0 2px 8px rgba(0, 194, 168, 0.4);
}

.ibi-letter.i2::after {
  content: '';
  position: absolute;
  bottom: -8px;
  right: -8px;
  width: 12px;
  height: 12px;
  background: #00c2a8;
  border-radius: 2px;
  box-shadow: 0 2px 8px rgba(0, 194, 168, 0.4);
}

.login-logo h1 {
  font-size: 32px;
  font-weight: 300;
  color: #e5e7eb;
  margin: 0;
  letter-spacing: 2px;
  text-align: center;
}

.login-logo .tagline {
  font-size: 14px;
  color: #9ca3af;
  margin-top: 8px;
  font-weight: 300;
  letter-spacing: 1px;
}

/* Modern login card */
#loginView .card,
#loginView .login-card{
  position: relative;
  z-index: 10;
  background: rgba(17, 24, 39, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(75, 85, 99, 0.3);
  border-radius: 20px;
  padding: 40px;
  min-width: 400px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
}

/* Login signature */
.login-signature {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 15;
  font-size: 12px;
  color: #6b7280;
  opacity: 0.7;
  font-weight: 300;
  letter-spacing: 0.5px;
}

/* Rule Diagnosis Panel */
.rule-diagnosis {
  margin-top: 12px;
  padding: 12px;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  background: #f9fafb;
  font-size: 13px;
}

.rule-diagnosis h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: #374151;
}

.diag-section {
  margin-bottom: 8px;
}

.diag-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
}

.diag-status {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
}

.diag-status.success {
  background: #10b981;
  color: white;
}

.diag-status.failure {
  background: #ef4444;
  color: white;
}

.diag-status.neutral {
  background: #6b7280;
  color: white;
}

.diag-text {
  flex: 1;
  color: #374151;
}

.diag-value {
  font-family: monospace;
  color: #059669;
  font-weight: bold;
}

.diag-explain {
  margin-top: 8px;
  padding: 8px;
  background: #fef3c7;
  border-radius: 4px;
  border-left: 4px solid #f59e0b;
  font-size: 12px;
  color: #92400e;
}

/* Log Filter Buttons */
.filter-btn {
  padding: 4px 8px;
  font-size: 12px;
  border: 1px solid #d1d5db;
  background: #f9fafb;
  color: #6b7280;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.filter-btn:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

.filter-btn.active {
  background: #3b82f6;
  color: white;
  border-color: #2563eb;
}

.log-entry {
  padding: 2px 0;
  border-bottom: 1px solid #f3f4f6;
}

.log-entry.hidden {
  display: none;
}

.log-timestamp {
  color: #6b7280;
  font-size: 11px;
  margin-right: 8px;
}

.log-type {
  display: inline-block;
  padding: 1px 4px;
  border-radius: 2px;
  font-size: 10px;
  font-weight: bold;
  margin-right: 6px;
}

.log-type.match {
  background: #10b981;
  color: white;
}

.log-type.tick {
  background: #f59e0b;
  color: white;
}

.log-type.activate {
  background: #3b82f6;
  color: white;
}

.log-type.system {
  background: #6b7280;
  color: white;
}


/* === City palette (matches login bg) === */
:root{
  --city-bg-0:#0a1120;     /* deepest navy */
  --city-bg-1:#0d1626;     /* panel navy */
  --city-bg-2:#0f1b2e;     /* header strip */
  --city-line:#90d8ff;     /* cyan arc glow */
  --city-blue:#2aa2ff;     /* electric blue */
  --city-teal:#1f7ed1;     /* teal-ish blue */
  --city-orange:#ff8a3c;   /* windows orange */
  --city-gold:#d4af37;     /* brand gold */
  --city-hair:rgba(255,255,255,.08);
  --city-hair-2:rgba(255,255,255,.12);
}

/* Simulator background depth */
#view-sim{
  position:relative;
  background:
    radial-gradient(1200px 700px at 120% -10%, rgba(42,162,255,.10) 0%, transparent 55%),
    radial-gradient(900px 500px at -20% 0%, rgba(31,126,209,.10) 0%, transparent 60%),
    linear-gradient(180deg, var(--city-bg-0) 0%, #070c18 100%);
  border-radius:12px;
  padding-top:4px;
}

/* Cards + headers */
#view-sim .card{
  background:linear-gradient(180deg, var(--city-bg-1), #0b1423);
  border:1px solid var(--city-hair);
  box-shadow:0 8px 26px rgba(0,0,0,.45);
}
#view-sim .card h2{
  background:linear-gradient(180deg, var(--city-bg-2), #0b1420);
  border-bottom:1px solid var(--city-hair);
}

/* Section accents */
#view-sim .card[data-section="sensors"]{ border-top:3px solid var(--city-blue); }
#view-sim .card[data-section="rules"]  { border-top:3px solid var(--city-orange); }
#view-sim .card[data-section="log"]    { border-top:3px solid var(--city-line); }
#view-sim .card[data-section] h2{
  position:relative;
}
#view-sim .card[data-section] h2::after{
  content:"";
  position:absolute; inset:-1px 0 auto 0; height:2px;
  background: linear-gradient(90deg, rgba(255,255,255,.0), rgba(255,255,255,.18), rgba(255,255,255,.0));
  opacity:.35;
}

/* Buttons tuned to palette */
#view-sim button{ background:#16263a; border-color:#27435f; }
#view-sim button:hover{ filter:brightness(1.08); }
#view-sim .success{ background:linear-gradient(180deg,#1e6e3f,#185836); border-color:#2a9156; }
#view-sim .danger{  background:linear-gradient(180deg,#6b2b2b,#532020); border-color:#934040; }
#view-sim .info{    background:linear-gradient(180deg,#1f4a66,#183a50); border-color:#2c6a91; }

/* KPI tags pop in city colors */
#view-sim .tag{ background:#102131; border-color:#203449; }
#view-sim #lampState.tag{ color:#ffd9b6; border-color:rgba(255,138,60,.4); background:rgba(255,138,60,.10); }
#view-sim #dimmerState.tag{ color:#cfeaff; border-color:rgba(42,162,255,.35); background:rgba(42,162,255,.10); }
#view-sim #fanState.tag{ color:#cfe7ff; border-color:rgba(31,126,209,.35); background:rgba(31,126,209,.10); }

/* Rule rows with subtle striping */
#view-sim .rule:nth-child(odd){ background:linear-gradient(180deg,#0e1624,#0b1320); }
#view-sim .rule:nth-child(even){ background:linear-gradient(180deg,#0c1422,#09101b); }


/* === City palette BOOST (more pop) === */
:root{
  --city-bg-0:#081226;     /* deeper navy */
  --city-bg-1:#0b1a33;     /* card */
  --city-bg-2:#0d223f;     /* header */
  --city-line:#9de0ff;     /* cyan glow */
  --city-blue:#2ab0ff;     /* electric blue+ */
  --city-teal:#1f8fe0;     
  --city-orange:#ff944d;   /* warmer orange */
  --city-gold:#d4af37;
  --city-hair:rgba(255,255,255,.10);
  --city-hair-2:rgba(255,255,255,.16);
}

/* Deeper bg with subtle grid */
#view-sim{
  background:
    radial-gradient(1200px 700px at 120% -10%, rgba(42,176,255,.12) 0%, transparent 55%),
    radial-gradient(900px 500px at -20% 0%, rgba(31,143,224,.12) 0%, transparent 60%),
    linear-gradient(180deg, var(--city-bg-0) 0%, #060c18 100%);
}
#view-sim::before{
  content:""; position:absolute; inset:0; z-index:0; pointer-events:none;
  background-image:
    radial-gradient(circle at 25% 15%, rgba(255,255,255,.04), transparent 40%);
  opacity:.7;
}
/* #view-sim > * { position:relative; z-index:1; } */

/* Cards pop more */
#view-sim .card{
  background:linear-gradient(180deg, var(--city-bg-1), #0a1529);
  border:1px solid var(--city-hair);
  box-shadow:0 10px 28px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.03);
}
#view-sim .card h2{
  background:
    linear-gradient(180deg, var(--city-bg-2), #0a1a34);
  border-bottom:1px solid var(--city-hair);
  letter-spacing:.2px;
}

/* Accents with header glow bars */
#view-sim .card[data-section="sensors"]{ border-top:3px solid var(--city-blue); }
#view-sim .card[data-section="rules"]  { border-top:3px solid var(--city-orange); }
#view-sim .card[data-section="log"]    { border-top:3px solid var(--city-line); }

#view-sim .card[data-section] h2::after{
  content:""; position:absolute; left:10px; right:10px; bottom:-1px; height:2px;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent);
  opacity:.5;
}
#view-sim .card[data-section="sensors"] h2{ box-shadow:inset 0 -1px 0 rgba(42,176,255,.35); }
#view-sim .card[data-section="rules"]   h2{ box-shadow:inset 0 -1px 0 rgba(255,148,77,.35); }
#view-sim .card[data-section="log"]     h2{ box-shadow:inset 0 -1px 0 rgba(157,224,255,.35); }

/* Buttons brighter & responsive */
#view-sim button{
  background:linear-gradient(180deg,#162b44,#13243a);
  border:1px solid #2a4563;
  box-shadow:0 6px 16px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);
}
#view-sim button:hover{ filter:brightness(1.12); transform:translateY(-1px); }
#view-sim button:active{ transform:translateY(0); }

#view-sim .success{ background:linear-gradient(180deg,#1f7f46,#17633a); border-color:#2fa266; }
#view-sim .danger { background:linear-gradient(180deg,#7a3232,#5b2424); border-color:#a24a4a; }
#view-sim .info   { background:linear-gradient(180deg,#20527a,#1a4261); border-color:#2d6fa0; }

/* Inputs focus with cyan line accent */
#view-sim input[type="text"], 
#view-sim input[type="number"], 
#view-sim select, 
#view-sim input[type="time"], 
#view-sim textarea{
  background:linear-gradient(180deg,#0a1426,#091121);
  border:1px solid rgba(255,255,255,.10);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
}
#view-sim input:focus, 
#view-sim select:focus, 
#view-sim textarea:focus{
  outline:none;
  border-color:rgba(42,176,255,.55);
  box-shadow:0 0 0 3px rgba(42,176,255,.20), inset 0 1px 0 rgba(255,255,255,.05);
}

/* KPI badges in palette */
#view-sim .tag{ background:#0e2136; border-color:#203a55; }
#view-sim #lampState.tag{ color:#ffd6b8; border-color:rgba(255,148,77,.5); background:rgba(255,148,77,.12); }
#view-sim #dimmerState.tag{ color:#d8f0ff; border-color:rgba(42,176,255,.5); background:rgba(42,176,255,.12); }
#view-sim #fanState.tag{ color:#d6ecff; border-color:rgba(31,143,224,.5); background:rgba(31,143,224,.12); }

/* Tabs get accent when active */
.tabs button.active{
  background:linear-gradient(180deg,#1b2f4d,#142640);
  border-color:var(--city-hair-2);
  box-shadow:inset 0 -2px 6px rgba(0,0,0,.45), 0 8px 18px rgba(0,0,0,.35);
}

/* Stronger section divider look */
#view-sim .divider{ background:rgba(255,255,255,.08); }


/* === City Theme for Flow (Wiresheet) & Settings === */

/* Extra palette for wiresheet types */
:root{
  --city-violet:#8a5cff;   /* for AND (Cond) */
  --city-green:#10b981;    /* for Rule (samler) */
}

/* FLOW VIEW (Wiresheet) */
#view-flow{
  position:relative;
  background:
    radial-gradient(1000px 600px at 120% -10%, rgba(42,176,255,.10) 0%, transparent 60%),
    radial-gradient(800px 500px at -10% 10%, rgba(31,143,224,.10) 0%, transparent 65%),
    linear-gradient(180deg, var(--city-bg-0), #060c18);
  border-radius:12px;
}
#view-flow .card{
  background:linear-gradient(180deg, var(--city-bg-1), #0a1529);
  border:1px solid var(--city-hair);
  box-shadow:0 10px 28px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.03);
}
#view-flow .card h2{
  background:linear-gradient(180deg, var(--city-bg-2), #0a1a34);
  border-bottom:1px solid var(--city-hair);
}

/* Wiresheet canvas */
.ws-canvas{
  background:
    radial-gradient(600px 400px at 30% -10%, rgba(42,176,255,.07) 0%, transparent 60%),
    linear-gradient(180deg,#0a1426,#091121);
  border:1px solid var(--city-hair);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 10px 28px rgba(0,0,0,.45);
}

/* Nodes */
.ws-node{
  background:linear-gradient(180deg,#0f1626,#0b1220);
  border:1px solid var(--city-hair-2);
  box-shadow:0 12px 28px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.04);
}
.ws-head{
  background:linear-gradient(180deg,#0f1d34,#0c1629);
  border-bottom:1px solid var(--city-hair);
}

/* Type accents */
.ws-node.trig { border-color: var(--city-blue); }
.ws-node.trig .ws-head { background:linear-gradient(90deg,#122c4a,#1f4270); color:#dbeafe; }
.ws-node.trig::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background: var(--city-blue); border-radius:12px 0 0 12px; }

.ws-node.cond { border-color: var(--city-violet); }
.ws-node.cond .ws-head { background:linear-gradient(90deg,#3a1b78,#5b32b4); color:#ede9fe; }
.ws-node.cond::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background: var(--city-violet); border-radius:12px 0 0 12px; }

.ws-node.act  { border-color: var(--city-orange); }
.ws-node.act  .ws-head { background:linear-gradient(90deg,#6b3a0a,#b45309); color:#fef3c7; }
.ws-node.act::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background: var(--city-orange); border-radius:12px 0 0 12px; }

.ws-node.rule { border-color: var(--city-green); }
.ws-node.rule .ws-head { background:linear-gradient(90deg,#064e3b,#0b7a5f); color:#d1fae5; }
.ws-node.rule::before { content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background: var(--city-green); border-radius:12px 0 0 12px; }

/* Ports and connections */
.port{ border-color: rgba(255,255,255,.25); background:#0b1118; }
.port.out{ box-shadow:0 0 0 2px rgba(42,176,255,.30), inset 0 0 0 2px rgba(255,255,255,.06); }
.port.in{  box-shadow:0 0 0 2px rgba(16,185,129,.30), inset 0 0 0 2px rgba(255,255,255,.06); }
.ws-wires svg path{
  stroke: rgba(157,224,255,.85);
  filter: drop-shadow(0 0 6px rgba(157,224,255,.5));
}

/* Node inputs */
.ws-body select, .ws-body input[type="text"]{
  background:linear-gradient(180deg,#0a1426,#091121);
  border:1px solid rgba(255,255,255,.10);
  color:#e6e9ee;
}
.ws-body select:focus, .ws-body input[type="text"]:focus{
  outline:none;
  border-color:rgba(42,176,255,.55);
  box-shadow:0 0 0 3px rgba(42,176,255,.20), inset 0 1px 0 rgba(255,255,255,.05);
}

/* Palette buttons at top */
#wsAddTrig { background:linear-gradient(180deg,#123a6b,#0e2c52); border-color:#2ab0ff; color:#dbeafe; }
#wsAddCond { background:linear-gradient(180deg,#46208a,#36196a); border-color:#8a5cff; color:#ede9fe; }
#wsAddAct  { background:linear-gradient(180deg,#9a4b0a,#7c3b08); border-color:#ff944d; color:#fef3c7; }
#wsAddRule { background:linear-gradient(180deg,#0d5b47,#0a4537); border-color:#10b981; color:#d1fae5; }
#wsAddTrig:hover, #wsAddCond:hover, #wsAddAct:hover, #wsAddRule:hover { filter:brightness(1.08); }

/* SETTINGS VIEW */
#view-settings{
  position:relative;
  background:
    radial-gradient(900px 500px at 110% -10%, rgba(42,176,255,.10) 0%, transparent 65%),
    linear-gradient(180deg, var(--city-bg-0), #060c18);
  border-radius:12px;
}
#view-settings .card{
  background:linear-gradient(180deg, var(--city-bg-1), #0a1529);
  border:1px solid var(--city-hair);
  box-shadow:0 10px 28px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.03);
}
#view-settings .card h2{
  background:linear-gradient(180deg, var(--city-bg-2), #0a1a34);
  border-bottom:1px solid var(--city-hair);
}
#view-settings label{ color:#cfe2ff; }
#view-settings input[type="text"], 
#view-settings input[type="number"], 
#view-settings input[type="password"], 
#view-settings input[type="time"], 
#view-settings select, 
#view-settings textarea{
  background:linear-gradient(180deg,#0a1426,#091121);
  border:1px solid rgba(255,255,255,.10);
  color:#e6e9ee;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
}
#view-settings input:focus, 
#view-settings select:focus, 
#view-settings textarea:focus{
  outline:none;
  border-color:rgba(42,176,255,.55);
  box-shadow:0 0 0 3px rgba(42,176,255,.20), inset 0 1px 0 rgba(255,255,255,.05);
}
#view-settings .success{ background:linear-gradient(180deg,#1f7f46,#17633a); border-color:#2fa266; }
#view-settings .danger { background:linear-gradient(180deg,#7a3232,#5b2424); border-color:#a24a4a; }
#view-settings .info   { background:linear-gradient(180deg,#20527a,#1a4261); border-color:#2d6fa0; }


/* === Dark dropdowns (match city theme) === */
select {
  background-color: #1c2331;      /* closed select */
  color: #e8edf5;
  border: 1px solid #2e3b4e;
  border-radius: 6px;
  padding: 4px 8px;
}
select:focus {
  outline: none;
  border-color: #2ab0ff;
  box-shadow: 0 0 0 3px rgba(42,176,255,.2);
}

/* Options list (when open) */
select option {
  background-color: #0f1b2e;      /* open list rows */
  color: #e8edf5;
}
select option:checked {
  background-color: #123a6b;
  color: #dbeafe;
}
select option:hover {
  background-color: #2e3b4e;
  color: #fff;
}

/* Support for optgroup headers */
select optgroup {
  background-color: #0f1b2e;
  color: #9fb3c8;
}

/* Disabled option look */
select option:disabled {
  color: #6c7b8a;
  background-color: #0f1b2e;
}


/* === HIGH-CONTRAST TEAL/AMBER RESKIN (forceful overrides) === */
:root{
  --hc-bg:#0b0d10; --hc-panel:#0f1319; --hc-head:#0d1116;
  --hc-hair:rgba(255,255,255,.14); --hc-hair-2:rgba(255,255,255,.22);
  --hc-text:#eef3f8; --hc-muted:#a7b4c5;
  --hc-teal:#00c2a8; --hc-amber:#ffb34d; --hc-blue:#3fb2ff; --hc-red:#ff6666;
}
html,body{ background:var(--hc-bg) !important; color:var(--hc-text) !important; }

header{ background:linear-gradient(180deg,var(--hc-head),#0a0d12) !important; border-bottom:1px solid var(--hc-hair) !important; }
.brand .goldtext{ color:#ffd85e !important; text-shadow:0 1px 0 #000, 0 0 10px rgba(255,216,94,.35) !important; }

/* Tabs */
.tabs button{
  background:linear-gradient(180deg,#141a22,#0f151c) !important;
  border:1px solid var(--hc-hair) !important;
  color:var(--hc-text) !important;
  border-radius:12px !important;
  padding: 8px 16px !important;
  font-weight: 500 !important;
  letter-spacing: 0.5px !important;
}

.tabs button:hover {
  background:linear-gradient(180deg,#1a2128,#141a21) !important;
  border-color:var(--hc-hair-2) !important;
  transform: translateY(-1px);
}

.tabs button.active{
  background:linear-gradient(180deg,#1b2430,#131b24) !important;
  box-shadow:0 10px 22px rgba(0,0,0,.5), inset 0 -2px 0 rgba(255,255,255,.06) !important;
  border-color:var(--hc-hair-2) !important;
  transform: translateY(-1px);
}

/* Cards */
.card{
  background:linear-gradient(180deg,var(--hc-panel),#0b0f14) !important;
  border:1px solid var(--hc-hair) !important;
  border-radius:16px !important;
  box-shadow:0 14px 36px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04) !important;
  overflow: hidden;
  position: relative;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow:0 20px 48px rgba(0,0,0,.65), inset 0 1px 0 rgba(255,255,255,.06) !important;
  border-color: var(--hc-hair-2) !important;
}

.card h2{
  background:linear-gradient(180deg,var(--hc-head),#0c1219) !important;
  border-bottom:1px solid var(--hc-hair) !important;
  letter-spacing:.3px !important;
  font-weight: 600;
  font-size: 15px;
  padding: 14px 16px;
  margin: 0;
}

.card .body {
  padding: 16px 18px 18px 18px;
}

/* Section colored top bars */
#view-sim .card[data-section="sensors"]{ border-top:3px solid var(--hc-blue) !important; }
#view-sim .card[data-section="rules"]  { border-top:3px solid var(--hc-amber) !important; }
#view-sim .card[data-section="log"]    { border-top:3px solid var(--hc-teal) !important; }

/* Buttons */
button{
  background:linear-gradient(180deg,#172230,#121a26) !important;
  position: relative;
  overflow: hidden;
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
}

button:active {
  transform: translateY(0);
  transition-duration: 0.1s;
}

/* Button ripple effect */
button::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255,255,255,0.1);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
  pointer-events: none;
}

button:active::before {
  width: 300px;
  height: 300px;
  transition-duration: 0s;
}
/* stray invalid CSS removed:
  border:1px solid rgba(110,150,190,.45) !important;
  color:var(--hc-text) !important;
  border-radius:9px !important;
  box-shadow:0 8px 20px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.05) !important;
*/
button:hover{ filter:brightness(1.15) !important; transform:translateY(-1px) !important; }
button:active{ transform:translateY(0) !important; }
.success{ background:linear-gradient(180deg,#0e6b5e,#0b5448) !important; border-color:rgba(0,194,168,.55) !important; color: #ffffff !important; }
.danger { background:linear-gradient(180deg,#6f2a2a,#541f1f) !important; border-color:rgba(255,102,102,.55) !important; color: #ffffff !important; }
.info   { background:linear-gradient(180deg,#1c4764,#15364b) !important; border-color:rgba(63,178,255,.55) !important; color: #ffffff !important; }

/* Clean styling for PIR og d√∏rkontakt knapper */
#pirOn, #doorOpen {
  background:linear-gradient(180deg,#1c4764,#15364b) !important;
  border-color:rgba(63,178,255,.7) !important;
  color: #ffffff !important;
  font-weight: 600 !important;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;
}

#pirOff, #doorClose {
  background:linear-gradient(180deg,#6f2a2a,#541f1f) !important;
  border-color:rgba(255,102,102,.7) !important;
  color: #ffffff !important;
  font-weight: 600 !important;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;
}

#pirOn:hover, #doorOpen:hover {
  background:linear-gradient(180deg,#205885,#183e57) !important;
  border-color:rgba(63,178,255,.9) !important;
}

#pirOff:hover, #doorClose:hover {
  background:linear-gradient(180deg,#7d3030,#612727) !important;
  border-color:rgba(255,102,102,.9) !important;
}

/* Inputs */
input[type="text"], input[type="number"], input[type="password"], select, input[type="time"], textarea{
  background:linear-gradient(180deg,#0b1219,#091017) !important;
  border:1px solid var(--hc-hair) !important;
  color:var(--hc-text) !important;
  border-radius:10px !important;
  padding:10px 14px !important;
  font-size:13px !important;
  box-shadow:inset 0 2px 4px rgba(0,0,0,.3), 0 1px 0 rgba(255,255,255,.02) !important;
}

input:hover, select:hover, textarea:hover {
  border-color: var(--hc-hair-2) !important;
  background:linear-gradient(180deg,#0d151f,#0a1319) !important;
}

input:focus, select:focus, textarea:focus{
  outline:none !important;
  border-color:rgba(0,194,168,.8) !important;
  box-shadow: 0 0 0 3px rgba(0,194,168,0.15), inset 0 2px 4px rgba(0,0,0,.25) !important;
  background:linear-gradient(180deg,#0f1823,#0c1520) !important;
}

/* KPI tags */
.tag{ background:#0d1a20 !important; border-color:rgba(0,194,168,.35) !important; color:#c8fff3 !important; }

/* View backgrounds */
#view-sim, #view-flow, #view-settings{
  background:
    radial-gradient(900px 500px at 110% -10%, rgba(63,178,255,.10) 0%, transparent 65%),
    linear-gradient(180deg, #0a0f16 0%, #090d12 100%) !important;
  border-radius:14px !important;
}

/* Wiresheet canvas & nodes (also fix full-width) */
.ws-canvas{
  background:
    radial-gradient(600px 400px at 30% -10%, rgba(0,194,168,.08) 0%, transparent 60%),
    linear-gradient(180deg,#0b141c,#09121a) !important;
  border:1px solid var(--hc-hair) !important;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.04), 0 12px 30px rgba(0,0,0,.5) !important;
}
.ws-node{
  display:inline-block !important;
  min-width:210px !important;
  max-width:280px !important;
  margin:12px !important;
  vertical-align:top !important;
  background:linear-gradient(180deg,#0f1622,#0b111a) !important;
  border:1px solid var(--hc-hair-2) !important;
  border-radius:14px !important;
  box-shadow:0 14px 30px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04) !important;
}
.ws-head{
  background:linear-gradient(180deg,#121b28,#0e1520) !important;
  border-bottom:1px solid var(--hc-hair) !important;
  font-size:12px !important;
  border-radius:14px 14px 0 0 !important;
}

/* Distinct type colors (unchanged roles) */
.ws-node.trig { border-color:#3b82f6 !important; }
.ws-node.trig .ws-head { background:linear-gradient(90deg,#123a6b,#1f4270) !important; color:#dbeafe !important; }
.ws-node.cond { border-color:#8a5cff !important; }
.ws-node.cond .ws-head { background:linear-gradient(90deg,#3a1b78,#5b32b4) !important; color:#ede9fe !important; }
.ws-node.act  { border-color:#ff944d !important; }
.ws-node.act  .ws-head { background:linear-gradient(90deg,#6b3a0a,#b45309) !important; color:#fef3c7 !important; }
.ws-node.rule { border-color:#10b981 !important; }
.ws-node.rule .ws-head { background:linear-gradient(90deg,#064e3b,#0b7a5f) !important; color:#d1fae5 !important; }

/* Ports & wires */
.port{ border-color: rgba(255,255,255,.28) !important; background:#0b1118 !important; }
.port.out{ box-shadow:0 0 0 2px rgba(63,178,255,.35), inset 0 0 0 2px rgba(255,255,255,.06) !important; }
.port.in{  box-shadow:0 0 0 2px rgba(16,185,129,.35), inset 0 0 0 2px rgba(255,255,255,.06) !important; }
.ws-wires svg path{ stroke: rgba(63,178,255,.85) !important; filter: drop-shadow(0 0 6px rgba(63,178,255,.5)) !important; }

/* Login safety */
#loginView::before, #loginView::after{ pointer-events:none !important; }
#loginView .card, #loginView .login-card{ position:relative; z-index: 5 !important; }


/* === Patch: targeted fixes === */
/* Hide the old LUA menu in header only */
#mainApp > header .menu { display: none !important; }

/* Keep appbar hidden until login */
.appbar { display: none; }

/* Remove the yellow 'Simulator' title block in main area */
#mainApp > header .brand { display: none !important; }

/* New LUA bar (scoped classes) */
.lua-bar{ display:flex; align-items:center; gap:10px; }
.lua-dd{ position:relative; }
.lua-dd > button{ background:#1a2430; border:1px solid #2a3442; color:#e5e9f0; border-radius:8px; padding:8px 10px; cursor:pointer; }
.lua-dd > button:hover{ filter:brightness(1.08); }
.lua-list{ position:absolute; left:0; top:110%; display:none; min-width:220px; background:#0f141c; border:1px solid #2a3442; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.45); padding:6px; z-index:9999; margin-left:8px; }
.lua-list.open{ display:block; }
.lua-list button{ display:block; width:100%; text-align:left; background:transparent; border:0; border-radius:8px; padding:10px 12px; color:#e5e9f0; }
.lua-list button:hover{ background:rgba(255,255,255,.06); }


/* === Topbar centering & sizing overrides === */
.appbar { position: relative; }
.appbar .wrap{
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  position: relative;
  max-width: 100% !important;
  padding: 0 40px !important;
}
/* Center brand (logo + text) */
.appbar .brand{
  position: relative !important;
  left: auto !important;
  transform: none !important;
  margin: 0 auto !important;
  gap: 12px !important;
}
/* Enlarge logo + name */
.appbar .brand svg{ height: 52px !important; width: auto !important; }
.appbar .brand .name{ font-size: 1.25rem !important; letter-spacing: .08em !important; font-weight: 900 !important; }

/* Keep nav snug to the right */
.appbar .mainnav{
  position: absolute !important;
  right: 40px !important;
  top: 50% !important;
  transform: translateY(-50%) !important;
  margin: 0 !important;
}

@media (max-width: 900px){
  .appbar .brand svg{ height: 42px !important; }
  .appbar .brand .name{ font-size: 1.05rem !important; }
}


.lua-bar, .lua-dd, .log { overflow: visible !important; }

/* === ONBOARDING SYSTEM === */
.onboarding-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  z-index: 10000;
  display: none;
  backdrop-filter: blur(4px);
}

.onboarding-step {
  position: absolute;
  background: linear-gradient(180deg, rgba(26, 36, 48, 0.6), rgba(15, 20, 28, 0.6));
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  border: 2px solid #2ab0ff;
  border-radius: 12px;
  padding: 16px;
  max-width: 320px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  color: #e5e9f0;
  z-index: 10001;
  animation: onboardingFadeIn 0.3s ease-out;
}

@keyframes onboardingFadeIn {
  from { opacity: 0; transform: scale(0.9) translateY(10px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}

.onboarding-step h3 {
  margin: 0 0 12px 0;
  color: #2ab0ff;
  font-size: 16px;
  font-weight: 600;
}

.onboarding-step p {
  margin: 0 0 16px 0;
  line-height: 1.5;
  font-size: 14px;
}

.onboarding-step .highlight {
  background: rgba(42, 176, 255, 0.15);
  border: 1px solid rgba(42, 176, 255, 0.3);
  border-radius: 6px;
  padding: 8px 12px;
  margin: 8px 0;
  font-family: Consolas, monospace;
  font-size: 12px;
  box-shadow: 0 0 20px rgba(42, 176, 255, 0.3);
  animation: highlightPulse 2s ease-in-out infinite;
}

@keyframes highlightPulse {
  0%, 100% { box-shadow: 0 0 20px rgba(42, 176, 255, 0.3); }
  50% { box-shadow: 0 0 30px rgba(42, 176, 255, 0.5); }
}

.onboarding-step .buttons {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 16px;
}

.onboarding-step .buttons button {
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
}

.onboarding-step .buttons .skip {
  background: #374151;
  color: #9ca3af;
}

.onboarding-step .buttons .next {
  background: #2ab0ff;
  color: white;
}

.onboarding-step .buttons .finish {
  background: #10b981;
  color: white;
}

.onboarding-step .buttons .pause {
  background: #f59e0b;
  color: white;
}

.onboarding-step .progress {
  display: flex;
  gap: 4px;
  margin-bottom: 16px;
}

.onboarding-step .progress .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #374151;
}

.onboarding-step .progress .dot.active {
  background: #2ab0ff;
}

.onboarding-step .progress .dot.completed {
  background: #10b981;
}

/* Welcome screen */
.onboarding-welcome {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(180deg, #1a2430, #0f141c);
  border: 2px solid #2ab0ff;
  border-radius: 16px;
  padding: 40px;
  max-width: 500px;
  text-align: center;
  color: #e5e9f0;
  z-index: 10002;
  box-shadow: 0 24px 48px rgba(0, 0, 0, 0.7);
}

.onboarding-welcome h2 {
  margin: 0 0 16px 0;
  color: #2ab0ff;
  font-size: 24px;
  font-weight: 700;
}

.onboarding-welcome p {
  margin: 0 0 24px 0;
  line-height: 1.6;
  font-size: 16px;
  color: #cbd5e1;
}

.onboarding-welcome .features {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin: 24px 0;
  text-align: left;
}

.onboarding-welcome .feature {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.onboarding-welcome .feature .icon {
  width: 20px;
  height: 20px;
  background: #2ab0ff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: white;
}

.onboarding-welcome .buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 24px;
}

.onboarding-welcome .buttons button {
  padding: 12px 24px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  min-width: 120px;
}

.onboarding-welcome .buttons .skip {
  background: #374151;
  color: #9ca3af;
}

.onboarding-welcome .buttons .start {
  background: #2ab0ff;
  color: white;
}

/* Quick start tasks */
.quick-start {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(180deg, #1a2430, #0f141c);
  border: 2px solid #10b981;
  border-radius: 16px;
  padding: 32px;
  max-width: 600px;
  color: #e5e9f0;
  z-index: 10003;
  box-shadow: 0 24px 48px rgba(0, 0, 0, 0.7);
  max-height: 80vh;
  overflow-y: auto;
}

.quick-start h2 {
  margin: 0 0 20px 0;
  color: #10b981;
  font-size: 20px;
  font-weight: 600;
}

.quick-start .task {
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.2);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
}

.quick-start .task h3 {
  margin: 0 0 8px 0;
  color: #10b981;
  font-size: 16px;
  font-weight: 600;
}

.quick-start .task p {
  margin: 0 0 12px 0;
  font-size: 14px;
  line-height: 1.5;
}

.quick-start .task .case-description {
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 16px;
}

.quick-start .task .case-description h4 {
  margin: 0 0 8px 0;
  color: #3b82f6;
  font-size: 14px;
  font-weight: 600;
}

.quick-start .task .case-description p {
  margin: 0 0 8px 0;
  font-size: 13px;
  line-height: 1.5;
  color: #e5e7eb;
}

.quick-start .task .case-description p:last-child {
  margin-bottom: 0;
}

.quick-start .task .case-description strong {
  color: #3b82f6;
}

.quick-start .task .steps {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 6px;
  padding: 12px;
  font-size: 13px;
  line-height: 1.6;
}

.quick-start .task .steps ol {
  margin: 0;
  padding-left: 20px;
}

.quick-start .task .steps li {
  margin-bottom: 4px;
}

.quick-start .task .difficulty {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  margin-bottom: 8px;
}

.quick-start .task .difficulty.easy {
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
}

.quick-start .task .difficulty.medium {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
}

.quick-start .task .difficulty.hard {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
}

.quick-start .task .task-completed {
  float: right;
  font-size: 20px;
  margin-top: -4px;
}

.quick-start .buttons {
  display: flex;
  gap: 12px;
  justify-content: space-between;
  margin-top: 24px;
  align-items: flex-start;
}

.quick-start .buttons .close {
  background: #374151;
  color: #9ca3af;
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
}

.quick-start .task-buttons {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.quick-start .button-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-width: 120px;
}

.quick-start .button-group h4 {
  margin: 0 0 8px 0;
  color: #9ca3af;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.quick-start .button-group .start-task {
  background: #10b981;
  color: white;
  padding: 8px 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: background-color 0.2s;
}

.quick-start .button-group .start-task:hover {
  background: #059669;
}

/* Task validation feedback */
.task-validation {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(17, 24, 39, 0.95);
  border-radius: 12px;
  padding: 16px 20px;
  max-width: 350px;
  z-index: 9999;
  box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
  display: none;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.task-validation.active {
  border: 2px solid #f59e0b;
}

.task-validation.success {
  border: 2px solid #10b981;
}

.task-validation .header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.task-validation .header .icon {
  font-size: 24px;
}

.task-validation .header h3 {
  margin: 0;
  font-size: 16px;
  color: #f3f4f6;
}

.task-validation .progress {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 4px;
  height: 8px;
  margin-bottom: 12px;
  overflow: hidden;
}

.task-validation .progress-bar {
  height: 100%;
  background: #f59e0b;
  transition: width 0.3s ease;
}

.task-validation.success .progress-bar {
  background: #10b981;
}

.task-validation .criteria {
  font-size: 14px;
  color: #9ca3af;
}

.task-validation .criteria ul {
  margin: 8px 0;
  padding-left: 20px;
}

.task-validation .criteria li {
  margin-bottom: 4px;
}

.task-validation .criteria li.completed {
  color: #10b981;
  text-decoration: line-through;
}

.task-validation .task-steps {
  margin-top: 16px;
  padding-top: 12px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  font-size: 13px;
  color: #9ca3af;
}

.task-validation .task-steps p {
  margin: 0 0 8px 0;
  font-weight: bold;
  color: #e5e7eb;
}

.task-validation .task-steps ol {
  margin: 0;
  padding-left: 18px;
}

.task-validation .task-steps li {
  margin-bottom: 4px;
  line-height: 1.4;
}

.task-validation .success-message {
  text-align: center;
  padding: 20px;
  color: #10b981;
}

.task-validation .success-message .icon {
  font-size: 48px;
  margin-bottom: 12px;
}

.task-validation .success-message h3 {
  margin: 0 0 8px 0;
  font-size: 20px;
}

.task-validation .success-message p {
  margin: 0 0 16px 0;
  color: #9ca3af;
}

.task-validation .success-message .success-buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 16px;
}

.task-validation .success-message button {
  padding: 8px 16px;
  background: #10b981;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

.task-validation .success-message .btn-primary {
  background: #3b82f6;
  font-weight: 500;
}

.task-validation .success-message .btn-primary:hover {
  background: #2563eb;
}

.task-validation .close-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: none;
  border: none;
  color: #6b7280;
  font-size: 20px;
  cursor: pointer;
  padding: 4px;
}

.task-validation .help-toggle-btn {
  position: absolute;
  top: 12px;
  right: 44px;
  background: none;
  border: none;
  color: #9ca3af;
  font-size: 18px;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: background 0.2s ease;
}

.task-validation .help-toggle-btn:hover {
  background: rgba(255, 255, 255, 0.1);
}

.task-validation .help-toggle-btn.active {
  color: #10b981;
}

/* === Modal styling === */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  z-index: 20000;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
}

.modal-content {
  background: linear-gradient(180deg, rgba(26, 36, 48, 0.95), rgba(15, 20, 28, 0.95));
  border: 2px solid #2ab0ff;
  border-radius: 16px;
  padding: 0;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  color: #e5e9f0;
  animation: modalFadeIn 0.3s ease-out;
}

@keyframes modalFadeIn {
  from { opacity: 0; transform: scale(0.9) translateY(20px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px 16px 24px;
  border-bottom: 1px solid rgba(75, 85, 99, 0.3);
}

.modal-header h3 {
  margin: 0;
  color: #2ab0ff;
  font-size: 18px;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  color: #6b7280;
  font-size: 24px;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #9ca3af;
}

.modal-body {
  padding: 24px;
}

/* === Login background image + translucent card === */
</style>

  <!-- WebView2-bro -->
  <script>
  (function(){
    let seq = 0;
    const pending = new Map();
    function hasWV2(){ return !!(window.chrome && window.chrome.webview); }
    if (hasWV2()){
      window.chrome.webview.addEventListener('message', (e) => {
        const msg = e.data || {};
        if (msg.replyTo && pending.has(msg.replyTo)) {
          const resolve = pending.get(msg.replyTo);
          pending.delete(msg.replyTo);
          resolve(msg.payload ?? msg);
        }
      });
    }
    window.api = {
      async saveText(defaultName, text){
        if (hasWV2()){
          return await new Promise((resolve) => {
            const id = 'm' + (++seq);
            pending.set(id, (resp) => resolve(resp && resp.path ? resp.path : null));
            window.chrome.webview.postMessage({ id, cmd: 'saveText', defaultName, text });
          });
        }
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([text], {type:'text/plain;charset=utf-8'}));
        a.download = defaultName; a.click();
        return defaultName;
      },
      async openText(){
        if (hasWV2()){
          return await new Promise((resolve) => {
            const id = 'm' + (++seq);
            pending.set(id, (resp) => resolve(resp && resp.ok ? { path: resp.path, text: resp.text } : null));
            window.chrome.webview.postMessage({ id, cmd: 'openText' });
          });
        }
        return null;
      }
    };
  })();
  </script>

<style>
:root{
  --hair:rgba(255,255,255,.12);
  --hair2:rgba(255,255,255,.18);
  --bg:#0f172a;
}
html,body{margin:0;background:var(--bg);color:#e2e8f0;font-family:'Segoe UI',system-ui,Arial,sans-serif;}
/* Sticky header */
.appbar{
  position:sticky; top:0; z-index:5000;
  background:#111827;
  border-bottom:1px solid var(--hair);
  box-shadow:0 2px 8px rgba(0,0,0,.6);
}
.appbar .wrap{
  max-width:1260px; margin:0 auto;
  padding:10px 14px;
  display:flex; align-items:center; gap:12px;
}
.brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.06em;}
.brand .name{color:#e6f0ff;}
.mainnav{margin-left:auto; display:flex; gap:8px;}
.mainnav button{
  display:flex; align-items:center; gap:8px;
  background:linear-gradient(180deg,#1f2937,#111827);
  border:1px solid var(--hair);
  color:#dbeafe;
  padding:10px 16px; 
  border-radius:12px; 
  cursor:pointer;
  font-weight: 500;
  letter-spacing: 0.3px;
  position: relative;
  overflow: hidden;
}

.mainnav button:hover{
  filter:brightness(1.15);
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.4);
}

.mainnav button.active{
  border-color:var(--hair2);
  box-shadow:inset 0 -2px 6px rgba(0,0,0,.45), 0 8px 18px rgba(0,0,0,.35);
  color:#fff;
  transform: translateY(-1px);
}

.mainnav button:active {
  transform: translateY(0);
  transition-duration: 0.1s;
}

/* Accent borders per section */
#view-sim .card, #view-sim [data-card]{ border-top:3px solid #2ab0ff; }
#view-flow .card, #view-flow [data-card]{ border-top:3px solid #10b981; }
#view-settings .card, #view-settings [data-card]{ border-top:3px solid #fbbf24; }

/* Hide old top tabs/title if present */
.tabs, .top-tabs, .page-title, h1.page-title-center { display:none !important; }

/* Global polish & micro-interactions */
.row {
  gap: 10px;
}

.grid2, .grid3 {
  gap: 18px;
}

/* Improved typography hierarchy */
h2 {
  font-weight: 600;
  letter-spacing: 0.3px;
}

h3 {
  font-weight: 500;
  letter-spacing: 0.2px;
  margin-top: 0;
  margin-bottom: 12px;
}

/* Smooth scrolling */
html {
  scroll-behavior: smooth;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.15);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.25);
}

/* Enhanced glassmorphism for panels */
.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  pointer-events: none;
}

/* Loading state animation */
@keyframes shimmer {
  0% { background-position: -200px 0; }
  100% { background-position: calc(200px + 100%) 0; }
}

.loading {
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  background-size: 200px 100%;
  animation: shimmer 1.5s infinite;
}
</style>

</head>
<body>

<header class="appbar">
  <div class="wrap">
    <div class="brand">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" height="28" aria-label="IBI logo">
        <defs>
          <linearGradient id="gradLogo" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#2ab0ff"/>
            <stop offset="100%" stop-color="#5bd2ff"/>
          </linearGradient>
        </defs>
        <circle cx="25" cy="25" r="20" fill="url(#gradLogo)"/>
        <polygon points="22,12 32,22 26,22 34,38 18,24 24,24" fill="white"/>
      </svg>
      <span class="name">IBI SIMULATOR</span>
    </div>
    <nav class="mainnav">
      <button type="button" data-target="view-sim">üè† Simulator</button>
      <button type="button" data-target="view-flow">üß© Wiresheet</button>
      <button type="button" data-target="view-settings">‚öôÔ∏è Indstillinger</button>
      <button type="button" onclick="showQuickStart()" title="Kom godt i gang">üöÄ Hj√¶lp</button>
    </nav>
  </div>
</header>

  <!-- Login overlay -->
  <div id="loginView" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;">
    <!-- IBI Logo -->
    <div class="login-logo">
      <div class="logo-ibi">
        <span class="ibi-letter i1">I</span>
        <span class="ibi-letter b">B</span>
        <span class="ibi-letter i2">I</span>
      </div>
    </div>

    <!-- Modern Login Card -->
    <div class="card login-card">
      <div class="body">
        <div style="margin-bottom:24px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Brugernavn</label>
          <input id="loginUser" placeholder="Brugernavn" autocomplete="username" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3);">
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Adgangskode</label>
          <input id="loginPass" type="password" placeholder="Adgangskode" autocomplete="current-password" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3);">
        </div>
        
        <button id="btnLogin" class="success" style="width:100%; padding:12px; font-size:16px; border-radius:12px; margin-bottom:16px;">
          üîì Log ind
        </button>
        
        <button id="btnRegister" class="info" style="width:100%; padding:12px; font-size:16px; border-radius:12px; margin-bottom:16px;">
          üë§ Opret ny bruger
        </button>
        
        <p id="loginError" style="color:#ef4444; text-align:center; margin-bottom:16px;"></p>
        
        <div style="text-align:center; padding:16px; background:rgba(31,41,55,0.3); border-radius:10px; border:1px solid rgba(75,85,99,0.2);">
          <p style="margin:0; font-size:13px; color:#9ca3af;">Standard login:</p>
          <p style="margin:8px 0 0 0; font-size:14px; color:#e5e7eb;"><code style="background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px;">admin</code> / <code style="background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px;">1234</code></p>
      </div>
    </div>
    </div>
    
    <!-- Signature -->
    <div class="login-signature">@ Rasmus Jakobsen</div>
  </div>

  <!-- User Registration Modal -->
  <div id="registerModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üë§ Opret ny bruger</h3>
        <button class="modal-close" onclick="closeRegisterModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Fornavn</label>
          <input id="regFirstName" placeholder="Indtast fornavn" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Efternavn</label>
          <input id="regLastName" placeholder="Indtast efternavn" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Email</label>
          <input id="regEmail" type="email" placeholder="Indtast email" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Brugernavn</label>
          <input id="regUsername" placeholder="V√¶lg brugernavn" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Adgangskode</label>
          <input id="regPassword" type="password" placeholder="V√¶lg adgangskode" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <button id="btnCreateUser" class="success" style="width:100%; padding:12px; font-size:16px; border-radius:12px; margin-bottom:16px;">
          ‚úÖ Opret bruger
        </button>
        
        <p id="registerError" style="color:#ef4444; text-align:center; margin-bottom:16px;"></p>
      </div>
    </div>
  </div>

  <!-- Teacher Login Modal -->
  <div id="teacherLoginModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üë®‚Äçüè´ L√¶rer Login</h3>
        <button class="modal-close" onclick="closeTeacherLoginModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">L√¶rer brugernavn</label>
          <input id="teacherUsername" placeholder="Indtast l√¶rer brugernavn" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">L√¶rer adgangskode</label>
          <input id="teacherPassword" type="password" placeholder="Indtast l√¶rer adgangskode" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Skole ID</label>
          <input id="teacherLoginSchoolId" placeholder="fx: skole1" value="default" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; margin-bottom:8px; color:#9ca3af; font-size:14px;">Klasse ID</label>
          <input id="teacherLoginClassId" placeholder="fx: 9a" value="default" style="width:100%; padding:12px; border-radius:10px; background:rgba(31,41,55,0.8); border:1px solid rgba(75,85,99,0.3); color:#e5e7eb;">
        </div>
        
        <button id="btnTeacherLoginSubmit" class="success" style="width:100%; padding:12px; font-size:16px; border-radius:12px; margin-bottom:16px;">
          üîì Log ind som l√¶rer
        </button>
        
        <p id="teacherLoginError" style="color:#ef4444; text-align:center; margin-bottom:16px;"></p>
      </div>
    </div>
  </div>

  <div id="mainApp" style="display:none;">

  <!-- Onboarding System -->
  <div id="onboardingOverlay" class="onboarding-overlay"></div>
  
  <!-- Welcome Screen -->
  <div id="onboardingWelcome" class="onboarding-welcome" style="display:none;">
    <h2>üéâ Velkommen til IBI Simulator!</h2>
    <p>L√¶r at bygge smart home automation med denne interaktive simulator. Du kan teste regler, generere LUA-kode og se hvordan det hele fungerer sammen.</p>
    
    <div class="features">
      <div class="feature">
        <div class="icon">üè†</div>
        <span>Simulator med sensorer & akt√∏rer</span>
      </div>
      <div class="feature">
        <div class="icon">üß©</div>
        <span>Visual Flow Editor</span>
      </div>
      <div class="feature">
        <div class="icon">‚ö°</div>
        <span>LUA-kode generering</span>
      </div>
      <div class="feature">
        <div class="icon">üìö</div>
        <span>Opgavebank & √∏velser</span>
      </div>
    </div>
    
    <div class="buttons">
      <button class="skip" onclick="skipOnboarding()">Spring over</button>
      <button class="start" onclick="startOnboarding()">Start rundvisning</button>
    </div>
  </div>

  <!-- Task Validation Feedback -->
  <div id="taskValidation" class="task-validation">
    <button class="close-btn" onclick="closeTaskValidation()">√ó</button>
    <button class="help-toggle-btn" onclick="toggleTaskHelp()" title="Vis/skjul hj√¶lp-trin">üí°</button>
    <div id="taskProgress">
      <div class="header">
        <span class="icon">üéØ</span>
        <h3 id="taskName">Opgave navn</h3>
      </div>
      <div class="progress">
        <div class="progress-bar" id="taskProgressBar" style="width: 0%"></div>
      </div>
      <div class="criteria">
        <p>Kriterier for at l√∏se opgaven:</p>
        <ul id="taskCriteria">
          <!-- Criteria will be added dynamically -->
        </ul>
      </div>
      <div class="task-steps">
        <p><strong>Trin til at l√∏se opgaven:</strong></p>
        <ol id="taskSteps">
          <!-- Steps will be added dynamically -->
        </ol>
      </div>
    </div>
    <div id="taskSuccess" class="success-message" style="display:none;">
      <div class="icon">üéâ</div>
      <h3>Opgave fuldf√∏rt!</h3>
      <p id="successText">Godt g√•et! Du har l√∏st opgaven korrekt.</p>
      <div class="success-buttons">
        <button onclick="closeTaskValidation()">Forts√¶t</button>
      </div>
    </div>
  </div>

  <!-- Quick Start Tasks -->
  <div id="quickStart" class="quick-start" style="display:none;">
    <h2>üöÄ Kom godt i gang</h2>
    
    <div class="task" id="task-ganglys">
      <span class="difficulty easy">Let</span>
      <span class="task-completed" style="display:none;">‚úÖ</span>
      <h3>Ganglys Basic</h3>
      <div class="case-description">
        <h4>üìã Case: Automatisk ganglys</h4>
        <p>Du arbejder p√• et kontor hvor gangene ofte er tomme om aftenen. For at spare energi og sikre sikkerhed, skal du implementere et automatisk ganglys der t√¶nder n√•r der er bev√¶gelse.</p>
        <p><strong>L√¶ringsm√•l:</strong> Forst√• grundl√¶ggende trigger-action logik og hvordan PIR-sensorer fungerer.</p>
      </div>
      <div class="steps">
        <ol>
          <li>G√• til "Simulator" fanen</li>
          <li>Klik "S√¶t: Breached" under PIR</li>
          <li>Klik "Aktiv√©r √¶ndringer"</li>
          <li>G√• til "Regler" sektionen</li>
          <li>V√¶lg "IF PIR bliver Breached" som trigger</li>
          <li>V√¶lg "THEN Lys ‚Üí T√¶nd" som action</li>
          <li>Klik "Tilf√∏j regel"</li>
          <li>Klik "K√∏r regler (RUN)"</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-doorlight">
      <span class="difficulty medium">Mellem</span>
      <span class="task-completed" style="display:none;">‚úÖ</span>
      <h3>D√∏rlys med tidsbegr√¶nsning</h3>
      <div class="case-description">
        <h4>üìã Case: Natligt d√∏rlys</h4>
        <p>En familie har problemer med at finde vej i m√∏rket om natten n√•r de skal til toilettet. De vil have et lys der automatisk t√¶nder n√•r d√∏ren √•bnes, men kun mellem 22:00 og 06:00 for at spare energi.</p>
        <p><strong>L√¶ringsm√•l:</strong> Kombinere sensor-triggers med tidsbetingelser og forst√• AND-logik.</p>
      </div>
      <div class="steps">
        <ol>
          <li>G√• til "Z-Wave sensorer" sektionen</li>
          <li>V√¶lg "D√∏r-/vindueskontakt" fra dropdown</li>
          <li>S√¶t v√¶rdi til "Opened"</li>
          <li>Klik "S√¶t (buffer)"</li>
          <li>Klik "Aktiv√©r √¶ndringer"</li>
          <li>G√• til "Regler" sektionen</li>
          <li>V√¶lg "IF D√∏rkontakt √¶ndres til Opened" som trigger</li>
          <li>Tilf√∏j AND: "Tid mellem" med "22:00-06:00"</li>
          <li>V√¶lg "THEN Lys ‚Üí T√¶nd" som action</li>
          <li>Tilf√∏j regel og test</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-bathroom">
      <span class="difficulty hard">Sv√¶r</span>
      <span class="task-completed" style="display:none;">‚úÖ</span>
      <h3>Badventilator med fugtighed</h3>
      <div class="case-description">
        <h4>üìã Case: Intelligent badventilator</h4>
        <p>Et badev√¶relse har problemer med skimmel p√• grund af h√∏j fugtighed efter bad. Du skal implementere en ventilator der automatisk starter n√•r fugtigheden er h√∏j, men kun n√•r der ikke er nogen i rummet (lavt lys).</p>
        <p><strong>L√¶ringsm√•l:</strong> Arbejde med numeriske sensorer, kombinere multiple betingelser og forst√• milj√∏baseret automation.</p>
      </div>
      <div class="steps">
        <ol>
          <li>G√• til "Z-Wave sensorer" sektionen</li>
          <li>V√¶lg "Fugtighed (%)" fra dropdown</li>
          <li>S√¶t v√¶rdi til 75</li>
          <li>Klik "S√¶t (buffer)"</li>
          <li>Klik "Aktiv√©r √¶ndringer"</li>
          <li>G√• til "Regler" sektionen</li>
          <li>V√¶lg "IF Fugtighed ‚â• (v√¶rdi)" som trigger med v√¶rdi 75</li>
          <li>Tilf√∏j AND: "Lys (lux) <" med v√¶rdi 50</li>
          <li>V√¶lg "THEN Ventilator ‚Üí On" som action</li>
          <li>Klik "Tilf√∏j regel"</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-security">
      <span class="difficulty medium">Mellem</span>
      <span class="task-completed" style="display:none;">‚úÖ</span>
      <h3>Sikkerhedsalarm</h3>
      <div class="case-description">
        <h4>üìã Case: Hjemmesikkerhed</h4>
        <p>En familie vil have et sikkerhedssystem der aktiverer en alarm n√•r der er bev√¶gelse om natten, men kun n√•r de ikke er hjemme (d√∏ren er lukket).</p>
        <p><strong>L√¶ringsm√•l:</strong> Implementere sikkerhedslogik med multiple sensorer og forst√• hvordan man kombinerer forskellige sensorer.</p>
      </div>
      <div class="steps">
        <ol>
          <li>G√• til "Z-Wave sensorer" sektionen</li>
          <li>V√¶lg "PIR (bev√¶gelse)" fra dropdown og s√¶t til "Breached"</li>
          <li>V√¶lg "D√∏r-/vindueskontakt" fra dropdown og s√¶t til "Closed"</li>
          <li>Klik "S√¶t (buffer)" for begge sensorer</li>
          <li>Klik "Aktiv√©r √¶ndringer"</li>
          <li>G√• til "Regler" sektionen</li>
          <li>V√¶lg "IF PIR bliver Breached" som trigger</li>
          <li>Tilf√∏j AND: "D√∏rkontakt = Closed"</li>
          <li>Tilf√∏j AND: "Tid mellem" med "22:00-06:00"</li>
          <li>V√¶lg "THEN Push (log)" som action</li>
          <li>Tilf√∏j regel og test</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-energy">
      <span class="difficulty hard">Sv√¶r</span>
      <span class="task-completed" style="display:none;">‚úÖ</span>
      <h3>Energibesparende lys</h3>
      <div class="case-description">
        <h4>üìã Case: Smart energistyring</h4>
        <p>Et kontor vil spare energi ved at have lys der automatisk slukker n√•r der ikke er nogen i rummet, men kun hvis det er lyst udenfor (dagslys).</p>
        <p><strong>L√¶ringsm√•l:</strong> Implementere kompleks energistyring med multiple betingelser og forst√• hvordan man optimerer for b√•de komfort og effektivitet.</p>
      </div>
      <div class="steps">
        <ol>
          <li>G√• til "Z-Wave sensorer" sektionen</li>
          <li>V√¶lg "PIR (bev√¶gelse)" fra dropdown og s√¶t til "Safe"</li>
          <li>V√¶lg "Lys (lux)" fra dropdown og s√¶t til 800</li>
          <li>Klik "S√¶t (buffer)" for begge sensorer</li>
          <li>Klik "Aktiv√©r √¶ndringer"</li>
          <li>G√• til "Regler" sektionen</li>
          <li>V√¶lg "IF PIR bliver Safe" som trigger</li>
          <li>Tilf√∏j AND: "Lys (lux) >" med v√¶rdi 500</li>
          <li>Tilf√∏j AND: "Tid mellem" med "08:00-18:00"</li>
          <li>V√¶lg "THEN Lys ‚Üí Off" som action</li>
          <li>Tilf√∏j regel og test</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-comfort">
      <span class="difficulty medium">Mellem</span>
      <span class="task-completed" style="display:none;">‚úÖ</span>
      <h3>Komfortstyring</h3>
      <div class="case-description">
        <h4>üìã Case: Optimalt indeklima</h4>
        <p>Et kontor har problemer med t√∏r luft om vinteren. Du skal implementere en l√∏sning der automatisk d√¶mper lyset n√•r luften er t√∏r og der er m√∏rkt, for at skabe et mere behageligt milj√∏.</p>
        <p><strong>L√¶ringsm√•l:</strong> Arbejde med numeriske sensorer og forst√• hvordan man skaber behagelige milj√∏er gennem automation.</p>
      </div>
      <div class="steps">
        <ol>
          <li>G√• til "Z-Wave sensorer" sektionen</li>
          <li>V√¶lg "Fugtighed (%)" fra dropdown og s√¶t til 40</li>
          <li>V√¶lg "Lys (lux)" fra dropdown og s√¶t til 200</li>
          <li>Klik "S√¶t (buffer)" for begge sensorer</li>
          <li>Klik "Aktiv√©r √¶ndringer"</li>
          <li>G√• til "Regler" sektionen</li>
          <li>V√¶lg "IF Fugtighed < (v√¶rdi)" som trigger med v√¶rdi 45</li>
          <li>Tilf√∏j AND: "Lys (lux) <" med v√¶rdi 300</li>
          <li>V√¶lg "THEN D√¶mper ‚Üí 30%" som action</li>
          <li>Klik "Tilf√∏j regel"</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-schedule">
      <span class="difficulty easy">Let</span>
      <span class="task-completed" style="display:none;">‚úÖ</span>
      <h3>Tidsbaseret automation</h3>
      <div class="case-description">
        <h4>üìã Case: Automatisk morgenstart</h4>
        <p>En familie vil have lys der automatisk t√¶nder kl. 7:00 om morgenen, men kun p√• hverdage (mandag-fredag) n√•r b√∏rnene skal i skole.</p>
        <p><strong>L√¶ringsm√•l:</strong> Implementere tidsbaseret automation og forst√• hvordan man kombinerer tid med ugedage.</p>
      </div>
      <div class="steps">
        <ol>
          <li>G√• til "Regler" sektionen</li>
          <li>V√¶lg "IF Time = hh:mm" som trigger med v√¶rdi "07:00"</li>
          <li>Tilf√∏j AND: "Ugedag i" med v√¶rdi "1-5" (mandag-fredag)</li>
          <li>V√¶lg "THEN Lys ‚Üí T√¶nd" som action</li>
          <li>Klik "Tilf√∏j regel"</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-ventilation">
      <span class="difficulty medium">Mellem</span>
      <span class="task-completed" style="display:none;">‚úÖ</span>
      <h3>Intelligent ventilation</h3>
      <div class="case-description">
        <h4>üìã Case: Vejrbaseret ventilation</h4>
        <p>Et kontor vil have ventilation der automatisk starter n√•r fugtigheden er h√∏j, men kun hvis det ikke bl√¶ser for meget udenfor (for at undg√• at bl√¶se varm luft ud).</p>
        <p><strong>L√¶ringsm√•l:</strong> Kombinere milj√∏sensorer og forst√• hvordan man optimerer ventilation baseret p√• vejrforhold.</p>
      </div>
      <div class="steps">
        <ol>
          <li>G√• til "Z-Wave sensorer" sektionen</li>
          <li>V√¶lg "Fugtighed (%)" fra dropdown og s√¶t til 80</li>
          <li>V√¶lg "Vind (m/s)" fra dropdown og s√¶t til 15</li>
          <li>Klik "S√¶t (buffer)" for begge sensorer</li>
          <li>Klik "Aktiv√©r √¶ndringer"</li>
          <li>G√• til "Regler" sektionen</li>
          <li>V√¶lg "IF Fugtighed ‚â• (v√¶rdi)" som trigger med v√¶rdi 70</li>
          <li>Tilf√∏j AND: "Vind <" med v√¶rdi 20</li>
          <li>V√¶lg "THEN Ventilator ‚Üí On" som action</li>
          <li>Klik "Tilf√∏j regel"</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-alarm">
      <span class="difficulty hard">Sv√¶r</span>
      <span class="task-completed" style="display:none;">‚úÖ</span>
      <h3>Alarm system</h3>
      <div class="case-description">
        <h4>üìã Case: Avanceret sikkerhed</h4>
        <p>En virksomhed vil have et alarm system der aktiveres n√•r b√•de d√∏ren √•bnes OG der er bev√¶gelse, men kun n√•r alarmen er aktiveret. Dette for at undg√• falske alarmer.</p>
        <p><strong>L√¶ringsm√•l:</strong> Implementere kompleks sikkerhedslogik med multiple sensorer og forst√• hvordan man undg√•r falske alarmer.</p>
      </div>
      <div class="steps">
        <ol>
          <li>G√• til "Z-Wave sensorer" sektionen</li>
          <li>V√¶lg "D√∏r-/vindueskontakt" fra dropdown og s√¶t til "Opened"</li>
          <li>V√¶lg "PIR (bev√¶gelse)" fra dropdown og s√¶t til "Breached"</li>
          <li>Klik "S√¶t (buffer)" for begge sensorer</li>
          <li>Klik "Aktiv√©r √¶ndringer"</li>
          <li>G√• til "Regler" sektionen</li>
          <li>V√¶lg "IF D√∏rkontakt √¶ndres til Opened" som trigger</li>
          <li>Tilf√∏j AND: "PIR = Breached"</li>
          <li>Tilf√∏j AND: "Alarm = Armed"</li>
          <li>V√¶lg "THEN Push (log)" som action</li>
          <li>Klik "Tilf√∏j regel"</li>
        </ol>
      </div>
    </div>
    
    <div class="task" id="task-global">
      <span class="difficulty medium">Mellem</span>
      <span class="task-completed" style="display:none;">‚úÖ</span>
      <h3>Global variabel styring</h3>
      <div class="case-description">
        <h4>üìã Case: Scene styring</h4>
        <p>En familie vil have et "away mode" der automatisk slukker alle lys n√•r de s√¶tter systemet i "away" tilstand. Dette skal implementeres ved hj√¶lp af globale variabler.</p>
        <p><strong>L√¶ringsm√•l:</strong> Forst√• globale variabler og hvordan man bruger dem til at styre hele systemet med en enkelt indstilling.</p>
      </div>
      <div class="steps">
        <ol>
          <li>G√• til "Regler" sektionen</li>
          <li>V√¶lg "IF Global name=value" som trigger med v√¶rdi "mode=away"</li>
          <li>V√¶lg "THEN Set Global" som action med v√¶rdi "lights=off"</li>
          <li>Klik "Tilf√∏j regel"</li>
        </ol>
      </div>
    </div>
    
    <div class="buttons">
      <button class="close" onclick="closeQuickStart()">Luk</button>
      <div class="task-buttons">
        <div class="button-group">
          <h4>Let</h4>
          <button class="start-task" onclick="startTask('ganglys')">Ganglys</button>
          <button class="start-task" onclick="startTask('schedule')">Tidsstyring</button>
        </div>
        <div class="button-group">
          <h4>Mellem</h4>
          <button class="start-task" onclick="startTask('doorlight')">D√∏rlys</button>
          <button class="start-task" onclick="startTask('security')">Sikkerhed</button>
          <button class="start-task" onclick="startTask('comfort')">Komfort</button>
          <button class="start-task" onclick="startTask('ventilation')">Ventilation</button>
          <button class="start-task" onclick="startTask('global')">Global</button>
        </div>
        <div class="button-group">
          <h4>Sv√¶r</h4>
          <button class="start-task" onclick="startTask('bathroom')">Badventilator</button>
          <button class="start-task" onclick="startTask('energy')">Energistyring</button>
          <button class="start-task" onclick="startTask('alarm')">Alarm</button>
        </div>
      </div>
    </div>
  </div>

  <header>
    <div class="brand"><h1 class="goldtext"> Simulator  </h1></div>
    <div class="top-left">
      <button id="btnTeacherLogin" class="btn-secondary" style="margin-right: 12px; background: #4a5568 !important; color: white !important; border: 1px solid #2d3748 !important; padding: 6px 12px !important; border-radius: 6px !important; font-weight: 500 !important; font-size: 12px !important; box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important; z-index: 9999 !important; position: relative !important; display: block !important;">üë®‚Äçüè´ L√¶rer</button>
      <button id="btnTeacherTab" class="btn-secondary" style="margin-right: 12px; background: #059669 !important; color: white !important; border: 1px solid #047857 !important; padding: 6px 12px !important; border-radius: 6px !important; font-weight: 500 !important; font-size: 12px !important; box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important; z-index: 9999 !important; position: relative !important; display: none !important;">üìä Dashboard</button>
    </div>
    <div class="top-right">
      <div class="menu">
        <button id="btnMenu" aria-haspopup="true" aria-expanded="false" title="LUA-v√¶rkt√∏jer">LUA ‚ñæ</button>
        <div class="menu-list" id="menuList" role="menu">
          <button id="btnGenLua" role="menuitem">Gener√©r LUA</button>
          <button id="btnCopyLua" role="menuitem">Kopi√©r LUA</button>
          <button id="btnSaveLua" role="menuitem">Gem LUA som .lua</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Faner -->
  <div class="tabs">
    <button id="tabSim"  class="active">Simulator</button>
    <button id="tabFlow">Flow (beta)</button>
    <button id="tabSettings">Indstillinger</button>

  </div>

  <div class="views">
    <!-- ===== View: Simulator ===== -->
    <section id="view-sim" class="view active">
      <div class="wrap">
        <!-- 1) Sensorer -->
        <div class="card" data-section="sensors">
          <h2>1) Virtuelle sensorer & tilstande</h2>
          <div class="body">
            <!-- Tid & milj√∏ -->
            <div class="section-group">
              <h3 style="margin:0 0 12px 0; color:#f59e0b; font-size:16px; display:flex; align-items:center; gap:8px;">
                <span>‚è∞</span>
                <span>Tid & milj√∏</span>
              </h3>
              
              <div class="control-group">
                <label class="has-tip" data-tip="Virtuelt klokkesl√¶t til 'Time = hh:mm' og 'Tid mellem'.">Klokkesl√¶t</label>
                <input type="time" id="clock" value="21:30" class="styled-input">
              </div>

              <div class="control-group">
                <label class="has-tip" data-tip="Ugedag (Mon..Sun) ‚Äì bruges i 'Ugedag i'.">Ugedag</label>
                <select id="weekday" class="styled-input weekday-select">
                  <option>Mon</option><option>Tue</option><option>Wed</option>
                  <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
                </select>
              </div>
            </div>

            <!-- System tilstande -->
            <div class="section-group">
              <h3 style="margin:0 0 12px 0; color:#ef4444; font-size:16px; display:flex; align-items:center; gap:8px;">
                <span>üîí</span>
                <span>System tilstande</span>
              </h3>

              <div class="control-group">
                <label class="has-tip" data-tip="Egne globale variabler (fx mode=night). Brug i AND: 'Global name=value'.">Globale variabler</label>
                <div class="input-row">
                  <input type="text" id="globalName" placeholder="fx mode" class="styled-input">
                  <input type="text" id="globalValue" placeholder="fx night" class="styled-input">
                </div>
                <div class="button-row">
                  <button id="setGlobal" class="info">S√¶t (buffer)</button>
                  <button id="clearGlobals" class="danger">Clear alle</button>
                </div>
              </div>
            </div>

            <!-- Akt√∏rer -->
            <div class="section-group">
              <h3 style="margin:0 0 12px 0; color:#3b82f6; font-size:16px; display:flex; align-items:center; gap:8px;">
                <span>üí°</span>
                <span>Akt√∏rer</span>
              </h3>
              
              <div class="kpi">
                <div class="box"><div class="small">Lampe</div><div id="lampState" class="tag">OFF</div></div>
                <div class="box"><div class="small">D√¶mper</div><div id="dimmerState" class="tag">0%</div></div>
                <div class="box"><div class="small">Ventilator</div><div id="fanState" class="tag">OFF</div></div>
              </div>

              <div class="control-group">
                <div class="button-row">
                  <button id="turnLampOn">T√¶nd lampe</button>
                  <button id="turnLampOff">Sluk lampe</button>
                </div>
              </div>

              <div class="control-group has-tip" data-tip="V√¶lg d√¶mperniveau 0‚Äì100% og tryk 'S√¶t'.">
                <label for="dimSel" class="small muted">D√¶mper (0‚Äì100%)</label>
                <div class="input-row">
                  <select id="dimSel" class="styled-input dimmer-select">
                    <option value="0">0%</option><option value="10">10%</option><option value="20">20%</option>
                    <option value="30" selected>30%</option><option value="40">40%</option><option value="50">50%</option>
                    <option value="60">60%</option><option value="70">70%</option><option value="80">80%</option>
                    <option value="90">90%</option><option value="100">100%</option>
                  </select>
                  <button id="dimSet">S√¶t</button>
                </div>
              </div>

              <div class="control-group">
                <div class="button-row">
                  <button id="fanOn">Fan On</button>
                  <button id="fanOff">Fan Off</button>
                </div>
              </div>
            </div>

            <!-- Z-Wave Sensorer -->
            <div class="section-group">
              <h3 style="margin:0 0 12px 0; color:#10b981; font-size:16px; display:flex; align-items:center; gap:8px;">
                <span>üì°</span>
                <span>Z-Wave Sensorer</span>
              </h3>
              
              <div class="control-group">
                <p class="small muted" style="margin-bottom: 12px;">Alle Z-Wave-inspirerede sensorer. V√¶lg type og s√¶t v√¶rdi. Lys/Vind/Fugt mappes direkte til felter. √òvrige bliver globals: sensor.&lt;navn&gt;. Hold mus over 'Bin√¶r/Numerisk' for hj√¶lp.</p>
                
                <div id="zwRows"></div>
                <div class="button-row">
                  <button type="button" id="zwAdd" class="info">‚ûï Tilf√∏j sensor</button>
                </div>
              </div>
            </div>

            <div class="row">
              <button id="applyPending" class="success" title="Anvend bufferede √¶ndringer og k√∏r regler">Aktiv√©r √¶ndringer</button>
              <span class="small muted">Nyeste log nederst ‚Ä¢ Intet trigges f√∏r "Aktiv√©r".</span>
            </div>
          </div>
        </div>

        <!-- 2) Regler -->
        <div class="card" data-section="rules">
          <h2>2) Regler (blok-scener)</h2>
          <div class="body">
            <div class="row">
              <select id="triggerType" title="V√¶lg trigger (IF)">
                <option value="always">IF (ved aktivering/k√∏rsel)</option>
                <option value="motionBreached">IF PIR bliver Breached</option>
                <option value="motionSafe">IF PIR bliver Safe</option>
                <option value="doorOpened">IF D√∏rkontakt √¶ndres til Opened</option>
                <option value="timeEquals">IF Klokkesl√¶t = (hh:mm)</option>
                <option value="humidityAbove">IF Fugtighed ‚â• (v√¶rdi)</option>
                <option value="globalEqTrig">IF Global name=value</option>
                <option value="sensorEqTrig">IF Sensor (global) = (navn=v√¶rdi)</option>
                <option value="sensorGtTrig">IF Sensor (global) > (navn=tal)</option>
                <option value="sensorLtTrig">IF Sensor (global) < (navn=tal)</option>
                <option value="sensorGeTrig">IF Sensor (global) ‚â• (navn=tal)</option>
                <option value="sensorLeTrig">IF Sensor (global) ‚â§ (navn=tal)</option>
              </select>
              <input type="text" id="triggerValue" placeholder="fx sensor.contact=Opened / sensor.temp=21" title="Til global/sensor: navn=v√¶rdi (fx sensor.temp=21)">
            </div>

            <div class="row">
              <select id="cond1" title="AND (valgfri)">
                <option value="">AND (valgfri)</option>
                <option value="luxBelow">Lys (lux) <</option>
                <option value="luxAbove">Lys (lux) ></option>
                <option value="humAbove">Fugtighed ‚â•</option>
                <option value="humBelow">Fugtighed ‚â§</option>
                <option value="windBelow">Vind <</option>
                <option value="weekdayIn">Ugedag i (Mon,Fri,‚Ä¶)</option>
                <option value="alarmArmed">Alarm = Armed</option>
                <option value="globalEq">Global name=value</option>
                <option value="sensorEq">Sensor (global) ==</option>
                <option value="sensorNe">Sensor (global) ‚â†</option>
                <option value="sensorGt">Sensor (global) ></option>
                <option value="sensorLt">Sensor (global) <</option>
                <option value="sensorGe">Sensor (global) ‚â•</option>
                <option value="sensorLe">Sensor (global) ‚â§</option>
                <option value="sensorContains">Sensor (global) contains</option>
                <option value="timeBetween">Tid mellem (HH:MM-HH:MM)</option>
              </select>
              <input type="text" id="cond1Value" placeholder="fx sensor.temp=21 / sensor.smoke=Detected" title="Til sensor/globale: navn=v√¶rdi">
            </div>

            <div class="row">
              <select id="cond2" title="AND (valgfri)">
                <option value="">AND (valgfri)</option>
                <option value="luxBelow">Lys (lux) <</option>
                <option value="luxAbove">Lys (lux) ></option>
                <option value="humAbove">Fugtighed ‚â•</option>
                <option value="humBelow">Fugtighed ‚â§</option>
                <option value="windBelow">Vind <</option>
                <option value="weekdayIn">Ugedag i (Mon,Fri,‚Ä¶)</option>
                <option value="alarmArmed">Alarm = Armed</option>
                <option value="globalEq">Global name=value</option>
                <option value="sensorEq">Sensor (global) ==</option>
                <option value="sensorNe">Sensor (global) ‚â†</option>
                <option value="sensorGt">Sensor (global) ></option>
                <option value="sensorLt">Sensor (global) <</option>
                <option value="sensorGe">Sensor (global) ‚â•</option>
                <option value="sensorLe">Sensor (global) ‚â§</option>
                <option value="sensorContains">Sensor (global) contains</option>
                <option value="timeBetween">Tid mellem (HH:MM-HH:MM)</option>
              </select>
              <input type="text" id="cond2Value" placeholder="fx sensor.mode=night" title="Til sensor/globale: navn=v√¶rdi">
            </div>

            <div class="row">
              <select id="action1" title="V√¶lg handling (THEN)">
                <option value="lightOn">THEN Lys ‚Üí T√¶nd</option>
                <option value="lightOff">THEN Lys ‚Üí Sluk</option>
                <option value="dim30">THEN D√¶mper ‚Üí 30%</option>
                <option value="dim100">THEN D√¶mper ‚Üí 100%</option>
                <option value="fanOn">THEN Ventilator ‚Üí On</option>
                <option value="fanOff">THEN Ventilator ‚Üí Off</option>
                <option value="push">THEN Send Push (log)</option>
                <option value="setGlobal">THEN Set Global name=value</option>
                <option value="delayLightOff">THEN Delay (sek) ‚Üí Lys Off</option>
              </select>
              <input type="text" id="action1Value" placeholder="for push/global/delay">
            </div>

            <div class="row">
              <input type="text" id="ruleName" placeholder="Navn p√• regel (valgfri)" title="Navngiv din regel ‚Äì vises i listen og i LUA-kommentar">
            </div>

            <div class="row">
              <button id="addRule" class="success">Tilf√∏j regel</button>
              <button id="clearRules" class="danger">Slet alle</button>
              <button id="saveRules">Gem</button>
              <button id="loadRules">Hent</button>
              <button id="exportRules" title="Gem regler som .json">Eksport</button>
              <input type="file" id="importFile" accept=".json,application/json" style="flex:2">
              <button id="importRules">Import</button>
            </div>
            <div id="rules"></div>
          </div>
                        </div>

                <!-- 3) Log + LUA -->
        <div class="card" data-section="log">
          <h2>3) Log & LUA</h2>
          <div class="body">
            <div class="row">
              <button id="runAll" class="info" title="K√∏r alle regler mod aktuelle tilstande (RUN)">K√∏r regler (RUN)</button>
              <button id="runTimeTick" title="Evaluer alle 'Time = hh:mm' regler">K√∏r "Time Tick" nu</button>
              <button id="clearLog" class="danger" title="T√∏m logvinduet">Slet log</button>
              <button id="exportLogCSV" title="Eksporter log som CSV fil">üìä CSV</button>
            </div>
            <div class="row" style="margin-top: 8px; gap: 4px; flex-wrap: wrap;">
              <label style="margin: 0; font-size: 13px; color: #6b7280;">Filter:</label>
              <button id="filterAll" class="filter-btn active" data-filter="all">Alle</button>
              <button id="filterMatch" class="filter-btn" data-filter="match">Matches</button>
              <button id="filterTick" class="filter-btn" data-filter="tick">Time Ticks</button>
              <button id="filterActivate" class="filter-btn" data-filter="activate">Aktivering</button>
              <button id="filterSystem" class="filter-btn" data-filter="system">System</button>
            </div>
            <div class="sp"></div>
            <div id="log" class="log" title="Nyeste nederst." style="height:240px !important; max-height:240px !important; min-height:240px !important; overflow-y:auto !important; overflow-x:hidden !important; word-wrap:break-word !important; box-sizing:border-box !important; position:relative !important;"></div>
            <div class="divider"></div>
            
<div class="lua-bar" id="luaBar">
  <label style="margin:0">LUA-output:</label>
  <div class="lua-dd" id="luaDD">
    <button id="luaBtn" aria-haspopup="true" aria-expanded="false">LUA ‚ñæ</button>
    <div class="lua-list" id="luaList" role="menu">
      <button id="luaGen2" role="menuitem">Gener√©r LUA</button>
      <button id="luaCopy2" role="menuitem">Kopi√©r LUA</button>
      <button id="luaSave2" role="menuitem">Gem LUA som .lua</button>
    </div>
  </div>
</div>

            <textarea id="luaOut" spellcheck="false" placeholder="√Öbn menuen 'LUA ‚ñæ' og v√¶lg 'Gener√©r LUA'." style="height: 260px;"></textarea>
          </div>
        </div>
      </div>
      <div class="footer small">Beta v1 (WebView2 ‚Ä¢ SPA med faner @Rasmus Jakobsen)</div>
    </section>

    <!-- ===== View: Flow (beta) ===== -->
<section id="view-flow" class="view">
  <div class="card">
    <h2>Flow (beta) ‚Äî Wiresheet MVP</h2>
    <div class="body">
      <div class="row" style="margin-bottom:8px;flex-wrap:wrap;gap:8px">
        <button id="wsAddTrig">+ Trigger</button>
        <button id="wsAddCond">+ AND</button>
        <button id="wsAddAct">+ Action</button>
        <button id="wsAddRule" class="info">+ Rule (samler)</button>
        <span class="small muted" style="margin-left:auto">Tip: Tr√¶k noder rundt, klik en <span class="tag">‚óè out</span> og derefter en <span class="tag">in ‚óè</span> p√• Rule for at forbinde.</span>
      </div>
      <div class="row" style="margin-bottom:8px;flex-wrap:wrap;gap:8px">
        <button id="wsBuild" class="success">Build ‚Üí Tilf√∏j regler</button>
        <button id="wsClear" class="danger">Ryd wiresheet</button>
        <button id="wsSave">Gem (local)</button>
        <button id="wsLoad">Hent (local)</button>
      </div>

      <div id="wsCanvas" class="ws-canvas">
        <svg id="wsWires" class="ws-wires"></svg>
        <div id="wsNodes" class="ws-nodes"></div>
      </div>
    </div>
  </div>
</section>
  
    <!-- ===== View: Indstillinger ===== -->
    <section id="view-settings" class="view">
      <div class="card">
        <h2>‚öôÔ∏è Indstillinger</h2>
        <div class="body">
          
          <!-- Tema indstillinger -->
          <div class="settings-section">
            <h3>üé® Udseende</h3>
            <div class="setting-item">
              <label for="themeSelect">Tema</label>
              <select id="themeSelect" class="styled-select">
                <option value="auto">Automatisk (f√∏lger system)</option>

                <option value="dark">M√∏rkt tema</option>
                <option value="powerful">Contrast Theme</option>
              </select>
              <span class="setting-description">V√¶lg mellem m√∏rkt eller contrast tema</span>
            </div>
          </div>



          <div class="divider"></div>

          <!-- Brugerindstillinger -->
          <div class="settings-section">
            <h3>üë§ Bruger</h3>
            <div class="setting-item">
              <label for="setUser">Brugernavn</label>
              <input id="setUser" type="text" placeholder="Indtast nyt brugernavn" class="styled-input">
            </div>
            <div class="setting-item">
              <label for="setPass">Adgangskode</label>
              <input id="setPass" type="password" placeholder="Indtast ny adgangskode" class="styled-input">
            </div>
            <div class="setting-item">
              <button id="btnSaveCreds" class="btn-primary">üíæ Gem brugerindstillinger</button>
              <span class="setting-description">Standard er <code>admin</code> / <code>1234</code>, indtil du gemmer nye.</span>
            </div>
          </div>

          <!-- Elev navn (beta) -->
          <div class="settings-section">
            <h3>üìù Dit navn (beta)</h3>
            <div class="setting-item">
              <label for="setFirstName">Fornavn</label>
              <input id="setFirstName" type="text" placeholder="Dit fornavn" class="styled-input">
            </div>
            <div class="setting-item">
              <label for="setLastName">Efternavn</label>
              <input id="setLastName" type="text" placeholder="Dit efternavn" class="styled-input">
            </div>
            <div class="setting-item">
              <label for="setEmail">Email (valgfrit)</label>
              <input id="setEmail" type="email" placeholder="din@email.dk" class="styled-input">
            </div>
            <div class="setting-item">
              <button id="btnSaveName" class="btn-primary">üíæ Gem dit navn</button>
              <span class="setting-description">Dette navn bruges n√•r du fuldf√∏rer opgaver (beta test)</span>
            </div>
          </div>

          <div class="divider"></div>

          <!-- App indstillinger -->
          <div class="settings-section">
            <h3>üîß App</h3>
            <div class="setting-item">
              <button id="btnResetOnboarding" class="btn-secondary">üîÑ Reset onboarding</button>
              <span class="setting-description">Start forfra med onboarding guiden</span>
            </div>
                      <div class="setting-item">
            <button id="btnLogout" class="btn-danger">üö™ Log ud</button>
            <span class="setting-description">Log ud og vis login-sk√¶rmen igen</span>
          </div>

          </div>

        </div>
      </div>
    </section>
    
    <!-- ===== View: L√¶rer Dashboard ===== -->
    <section id="view-teacher" class="view">
      <div class="wrap">
        <!-- L√¶rer kontroller -->
        <div class="card">
          <h2>üë®‚Äçüè´ L√¶rer Dashboard</h2>
          <div class="body">
            <div class="settings-section">
              <h3>üìä Data indstillinger</h3>
              <div class="setting-item">
                <label for="teacherSchoolId">Skole ID</label>
                <input id="teacherSchoolId" type="text" value="default" class="styled-input" placeholder="fx: default, skole1, etc.">
              </div>
              <div class="setting-item">
                <label for="teacherClassId">Klasse ID</label>
                <input id="teacherClassId" type="text" value="default" class="styled-input" placeholder="fx: default, 9a, etc.">
              </div>
              <div class="setting-item">
                <button id="btnLoadProgress" class="btn-primary">üì• Indl√¶s elev progress</button>
                <button id="btnExportCSV" class="btn-success">üìä Eksporter CSV</button>
                <button id="btnTeacherLogout" class="btn-danger">üë®‚Äçüè´ Log ud som l√¶rer</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Elev progress liste -->
        <div class="card">
          <h2>üìà Elev Progress</h2>
          <div class="body">
            <div id="teacherProgressList" class="progress-list">
              <p class="muted">Klik "Indl√¶s elev progress" for at se data</p>
            </div>
          </div>
        </div>

        <!-- Statistikker -->
        <div class="card">
          <h2>üìä Statistikker</h2>
          <div class="body">
            <div id="teacherStats" class="stats-grid">
              <div class="stat-box">
                <div class="stat-number" id="totalStudents">-</div>
                <div class="stat-label">Elever</div>
              </div>
              <div class="stat-box">
                <div class="stat-number" id="totalTasks">-</div>
                <div class="stat-label">Opgaver</div>
              </div>
              <div class="stat-box">
                <div class="stat-number" id="completionRate">-</div>
                <div class="stat-label">Gennemf√∏relse</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
  </div>

<script>
(function(){
  var $ = function(sel){ return document.querySelector(sel); };
  var logEl = $('#log'), luaOut = $('#luaOut');

  /* Faner */
  function setTab(which){
    $('#tabSim').classList.toggle('active', which==='sim');
    $('#tabFlow').classList.toggle('active', which==='flow');
    $('#tabSettings').classList.toggle('active', which==='settings');

    $('#view-sim').classList.toggle('active', which==='sim');
    $('#view-flow').classList.toggle('active', which==='flow');
    $('#view-settings').classList.toggle('active', which==='settings');

  }
  $('#tabSim').onclick = ()=>setTab('sim');
  $('#tabFlow').onclick = ()=>setTab('flow');
  $('#tabSettings').onclick = ()=>setTab('settings');


  /* Topbar menu */
  var menu = document.querySelector('.menu');
  $('#btnMenu').onclick = function(){ menu.classList.toggle('open'); this.setAttribute('aria-expanded', menu.classList.contains('open') ? 'true' : 'false'); };
  document.addEventListener('click', function(e){ if(!menu.contains(e.target)) { menu.classList.remove('open'); $('#btnMenu').setAttribute('aria-expanded','false'); } });

  /* State */
  var state   = { motion:false, door:false, lux:100, wind:2, humidity:45, time:'21:30', weekday:'Mon', globals:{}, light:false, dimmer:0, fan:false, alarmArmed:false, alarmHome:false, rules:[] };
  var pending = JSON.parse(JSON.stringify(state));
  window.pending = pending; window.state = state;

  function escHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  var lastLogMessage = '';
  var logEntries = [];
  var currentLogFilter = 'all';
  
  function log(msg, type){ 
    // Forhindre spam af samme besked
    if (msg === lastLogMessage) return;
    lastLogMessage = msg;
    
    var now = new Date();
    var ts = now.toLocaleTimeString();
    var category = categorizeLogMessage(msg, type);
    var entry = { 
      time: ts, 
      timestamp: now, 
      message: msg, 
      type: type || 'system',
      category: category,
      entity: extractEntity(msg),
      old_value: extractOldValue(msg),
      new_value: extractNewValue(msg)
    };
    logEntries.push(entry);
    
    // Begr√¶ns til max 100 entries for bedre historik
    if (logEntries.length > 100) {
      logEntries = logEntries.slice(-80);
    }
    
    // Genopbyg hele log-indholdet
    rebuildLog();
  }
  
  function categorizeLogMessage(msg, type) {
    if (type === 'match') return 'match';
    if (msg.includes('Time tick') || msg.includes('Time Tick')) return 'tick';
    if (msg.includes('AKTIVERET:') || msg.includes('MATCH:')) return 'activate';
    if (msg.includes('PIR') || msg.includes('Lys') || msg.includes('Fan') || msg.includes('D√∏r')) return 'activate';
    return 'system';
  }
  
  function extractEntity(msg) {
    if (msg.includes('PIR')) return 'PIR';
    if (msg.includes('Lys')) return 'Light';
    if (msg.includes('Fan')) return 'Fan';
    if (msg.includes('D√∏r')) return 'Door';
    if (msg.includes('Fugt')) return 'Humidity';
    if (msg.includes('Global')) return 'Global';
    return 'System';
  }
  
  function extractOldValue(msg) {
    // Simple pattern matching for old values in "var = old ‚Üí new" format
    var match = msg.match(/= (.+?) ‚Üí/);
    return match ? match[1] : '';
  }
  
  function extractNewValue(msg) {
    // Simple pattern matching for new values in "var = old ‚Üí new" format  
    var match = msg.match(/‚Üí (.+)$/);
    return match ? match[1] : '';
  }
  
  function rebuildLog() {
    logEl.innerHTML = '';
    var filteredEntries = logEntries.filter(function(entry) {
      if (currentLogFilter === 'all') return true;
      return entry.category === currentLogFilter;
    });
    
    filteredEntries.forEach(function(entry) {
      var div = document.createElement('div');
      div.className = 'log-entry';
      
      var timestampSpan = document.createElement('span');
      timestampSpan.className = 'log-timestamp';
      timestampSpan.textContent = entry.time;
      
      var typeSpan = document.createElement('span');
      typeSpan.className = 'log-type ' + entry.category;
      typeSpan.textContent = getCategoryLabel(entry.category);
      
      var messageSpan = document.createElement('span');
      messageSpan.textContent = entry.message;
      
      div.appendChild(timestampSpan);
      div.appendChild(typeSpan);
      div.appendChild(messageSpan);
      
      logEl.appendChild(div);
    });
    
    // Auto-scroll til bunden
    setTimeout(function(){ 
      logEl.scrollTop = logEl.scrollHeight; 
    }, 10);
  }
  
  function getCategoryLabel(category) {
    var labels = {
      'match': 'MATCH',
      'tick': 'TICK',
      'activate': 'ACT',
      'system': 'SYS'
    };
    return labels[category] || 'SYS';
  }
  
  window.log = log; 
  function clearLog(){ logEntries = []; logEl.innerHTML=''; }

  // Log Filter Event Handlers
  document.querySelectorAll('.filter-btn').forEach(function(btn) {
    btn.onclick = function() {
      // Remove active class from all buttons
      document.querySelectorAll('.filter-btn').forEach(function(b) {
        b.classList.remove('active');
      });
      
      // Add active class to clicked button
      this.classList.add('active');
      
      // Update filter and rebuild log
      currentLogFilter = this.getAttribute('data-filter');
      rebuildLog();
    };
  });

  // CSV Export Functionality
  function exportLogToCSV() {
    if (logEntries.length === 0) {
      alert('Ingen log data at eksportere.');
      return;
    }
    
    var csvContent = 'Timestamp,Category,Entity,Message,Old_Value,New_Value\n';
    
    logEntries.forEach(function(entry) {
      var timestamp = entry.timestamp.toISOString();
      var category = entry.category || 'system';
      var entity = entry.entity || 'System';
      var message = '"' + (entry.message || '').replace(/"/g, '""') + '"';
      var oldValue = '"' + (entry.old_value || '').replace(/"/g, '""') + '"';
      var newValue = '"' + (entry.new_value || '').replace(/"/g, '""') + '"';
      
      csvContent += timestamp + ',' + category + ',' + entity + ',' + message + ',' + oldValue + ',' + newValue + '\n';
    });
    
    // Create and download CSV file
    var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
    var fileName = 'ibi_simulator_log_' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.csv';
    
    if (link.download !== undefined) {
      var url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', fileName);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      log('Log eksporteret til CSV: ' + fileName, 'system');
    } else {
      alert('CSV eksport ikke underst√∏ttet i denne browser.');
    }
  }

  // Attach CSV export to button
  $('#exportLogCSV').onclick = exportLogToCSV;

  // Helper function for updating state values
  function ch(k,pretty,fmt){ var ov=state[k], nv=pending[k]; if(JSON.stringify(ov)!==JSON.stringify(nv)){ state[k]=nv; log('AKTIVERET: '+pretty+' = '+(fmt?fmt(nv):nv)); } }
  
  function updateKPI(){ $('#lampState').innerText = state.light ? 'ON' : 'OFF'; $('#dimmerState').innerText = state.dimmer + '%'; $('#fanState').innerText   = state.fan ? 'ON' : 'OFF'; ch('alarmArmed','Alarm.Armed'); ch('alarmHome','Alarm.Home'); }
  function setLight(on){ state.light=!!on; updateKPI(); log('Light ‚Üí ' + (on?'ON':'OFF')); }
  function setDimmer(v){ v=Math.max(0,Math.min(100,parseInt(v)||0)); state.dimmer=v; state.light=v>0; updateKPI(); log('Dimmer ‚Üí '+v+'%'); }
  function setFan(on){ state.fan=!!on; updateKPI(); log('Fan ‚Üí ' + (on?'ON':'OFF')); }

  /* Buffer - nu h√•ndteres alle sensorer via Z-Wave systemet */
  // Gamle hardcodede sensorer er fjernet - brug Z-Wave sensorer i stedet
  $('#clock').onchange=function(){ pending.time=this.value; log('BUFFER: Klokkesl√¶t = '+pending.time); };
  $('#weekday').onchange=function(){ pending.weekday=this.value; log('BUFFER: Ugedag = '+pending.weekday); };

  $('#setGlobal').onclick=function(){ var k=$('#globalName').value.trim(), v=$('#globalValue').value.trim(); if(!k){ alert('Angiv globalt navn.'); return; } if(!pending.globals) pending.globals={}; pending.globals[k]=v; log('BUFFER: Global '+k+'='+v); };
  $('#clearGlobals').onclick=function(){ pending.globals={}; log('BUFFER: Alle globale variabler nulstilles ved aktivering.'); };

  /* Direkte akt√∏rer */
  $('#turnLampOn').onclick=function(){ setLight(true); };
  $('#turnLampOff').onclick=function(){ setLight(false); };
  $('#dimSet').onclick=function(){ setDimmer(parseInt($('#dimSel').value,10)); };
  $('#fanOn').onclick=function(){ setFan(true); };
  $('#fanOff').onclick=function(){ setFan(false); };

  /* Helpers */
  function parseNameValue(s){ s=String(s||''); var i=s.indexOf('='); if(i<0){ var p=s.split(':'); return {name:(p[0]||'').trim(), value:(p.slice(1).join(':')||'').trim()}; } return {name:s.slice(0,i).trim(), value:s.slice(i+1).trim()}; }
  function gget(name){ return (state.globals && state.globals[name]) || ''; }
  function toNum(x){ var n=parseFloat(x); return isNaN(n)?0:n; }

  function setCondHints(selEl, valEl){
    var v = selEl.value, map = {
      '':'v√¶rdi','luxBelow':'tal (fx 50)','luxAbove':'tal (fx 200)','humAbove':'procent (fx 65)','humBelow':'procent (fx 35)',
      'windBelow':'m/s (fx 5)','weekdayIn':'liste (fx Mon,Fri)','alarmArmed':'(ingen v√¶rdi)','alarmHome':'(ingen v√¶rdi)',
      'globalEq':'navn=v√¶rdi (fx mode=night)',
      'sensorEq':'navn=v√¶rdi (fx sensor.smoke=Detected)','sensorNe':'navn=v√¶rdi','sensorGt':'navn=tal','sensorLt':'navn=tal',
      'sensorGe':'navn=tal','sensorLe':'navn=tal','sensorContains':'navn=delstreng','timeBetween':'HH:MM-HH:MM (fx 22:00-06:00)'
    };
            valEl.placeholder = map[v] || 'v√¶rdi'; valEl.title = 'Indtast: ' + (map[v] || 'v√¶rdi');
  }
  $('#cond1').onchange=function(){ setCondHints(this,$('#cond1Value')); }; $('#cond2').onchange=function(){ setCondHints(this,$('#cond2Value')); };
  setCondHints($('#cond1'),$('#cond1Value')); setCondHints($('#cond2'),$('#cond2Value'));

  function setTrigHint(){ var t=$('#triggerType').value, inp=$('#triggerValue'), map={
    'always':'(ingen v√¶rdi)','timeEquals':'hh:mm (fx 07:30)','humidityAbove':'v√¶rdi (fx 65)',
    'globalEqTrig':'navn=v√¶rdi (fx sensor.mode=night)','sensorEqTrig':'navn=v√¶rdi (fx sensor.contact=Opened)',
    'sensorGtTrig':'navn=tal (fx sensor.temp=21)','sensorLtTrig':'navn=tal (fx sensor.temp=21)','sensorGeTrig':'navn=tal','sensorLeTrig':'navn=tal'
  }; inp.placeholder=map[t]||'(kun hvis relevant)'; }
  $('#triggerType').onchange=setTrigHint; setTrigHint();

  /* Regler UI */
  function ruleRow(r,i){
    var name = r.ruleName ? '"'+r.ruleName+'"' : ('#'+(i+1));
    var div=document.createElement('div'); div.className='rule';
    div.innerHTML='<div class="small muted">'+name+'</div>'+
      '<div><span class="tag">'+r.trigger+(r.triggerValue?(' '+r.triggerValue):'')+'</span></div>'+
      '<div style="margin-top:4px;"><span class="tag">'+(r.cond1? r.cond1 : '')+' '+(r.cond1Value||'')+'</span> '+
      '<span class="tag">'+(r.cond2? r.cond2 : '')+' '+(r.cond2Value||'')+'</span></div>'+
      '<div style="margin-top:6px;"><span class="tag">'+r.action1+(r.action1Value?(' '+r.action1Value):'')+'</span></div>'+
      '<div class="row" style="margin-top:6px;"><button data-i="'+i+'" class="delRule danger">Slet</button>'+
      '<button data-i="'+i+'" class="diagRule info" style="margin-left:8px;">üîç Diagnose</button></div>'+
      '<div id="diag-'+i+'" class="rule-diagnosis" style="display:none;"></div>';
    return div;
  }
  function refreshRules(){ var box=$('#rules'); box.innerHTML=''; for(var i=0;i<state.rules.length;i++) box.appendChild(ruleRow(state.rules[i],i));
    box.querySelectorAll('.delRule').forEach(function(b){ b.onclick=function(){ var idx=parseInt(this.getAttribute('data-i')); state.rules.splice(idx,1); refreshRules(); log('Regel slettet.'); }; });
    box.querySelectorAll('.diagRule').forEach(function(b){ b.onclick=function(){ var idx=parseInt(this.getAttribute('data-i')); toggleDiagnosis(idx); }; });
  }
  window.refreshRules = refreshRules;

  /* Rule Diagnosis System */
  function toggleDiagnosis(ruleIndex) {
    var diagPanel = document.getElementById('diag-' + ruleIndex);
    if (!diagPanel) return;
    
    if (diagPanel.style.display === 'none') {
      generateDiagnosis(ruleIndex);
      diagPanel.style.display = 'block';
    } else {
      diagPanel.style.display = 'none';
    }
  }

  function generateDiagnosis(ruleIndex) {
    var rule = state.rules[ruleIndex];
    if (!rule) return;
    
    var diagPanel = document.getElementById('diag-' + ruleIndex);
    if (!diagPanel) return;
    
    var name = rule.ruleName ? '"' + rule.ruleName + '"' : ('#' + (ruleIndex + 1));
    var html = '<h4>üîç Diagnose for regel ' + name + '</h4>';
    
    // Check trigger
    var triggerResult = evaluateTriggerForDiag(rule);
    html += '<div class="diag-section">';
    html += '<div class="diag-item">';
    html += '<div class="diag-status ' + (triggerResult.ok ? 'success' : 'failure') + '">';
    html += triggerResult.ok ? '‚úì' : '‚úó';
    html += '</div>';
    html += '<div class="diag-text">IF ' + getTriggerDescription(rule.trigger) + '</div>';
    html += '<div class="diag-value">' + triggerResult.description + '</div>';
    html += '</div>';
    if (triggerResult.explain) {
      html += '<div class="diag-explain">' + triggerResult.explain + '</div>';
    }
    html += '</div>';
    
    // Check conditions
    var cond1Result = evaluateConditionForDiag(rule.cond1, rule.cond1Value);
    var cond2Result = evaluateConditionForDiag(rule.cond2, rule.cond2Value);
    var bothOk = cond1Result.ok && cond2Result.ok;
    
    if (rule.cond1 || rule.cond2) {
      html += '<div class="diag-section">';
      
      if (rule.cond1) {
        html += '<div class="diag-item">';
        html += '<div class="diag-status ' + (cond1Result.ok ? 'success' : 'failure') + '">';
        html += cond1Result.ok ? '‚úì' : '‚úó';
        html += '</div>';
        html += '<div class="diag-text">AND ' + getConditionDescription(rule.cond1) + '</div>';
        html += '<div class="diag-value">' + cond1Result.description + '</div>';
        html += '</div>';
      }
      
      if (rule.cond2) {
        html += '<div class="diag-item">';
        html += '<div class="diag-status ' + (cond2Result.ok ? 'success' : 'failure') + '">';
        html += cond2Result.ok ? '‚úì' : '‚úó';
        html += '</div>';
        html += '<div class="diag-text">AND ' + getConditionDescription(rule.cond2) + '</div>';
        html += '<div class="diag-value">' + cond2Result.description + '</div>';
        html += '</div>';
      }
      
      // Overall AND result
      html += '<div class="diag-item" style="border-top: 1px solid #e5e7eb; padding-top: 8px; margin-top: 8px;">';
      html += '<div class="diag-status ' + (bothOk ? 'success' : 'failure') + '">';
      html += bothOk ? '‚úì' : '‚úó';
      html += '</div>';
      html += '<div class="diag-text"><strong>Samlet AND resultat</strong></div>';
      html += '<div class="diag-value">' + (bothOk ? 'OK' : 'FEJL') + '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    // Overall rule result
    var ruleMatches = triggerResult.ok && bothOk;
    html += '<div class="diag-section" style="border-top: 2px solid #e5e7eb; padding-top: 12px;">';
    html += '<div class="diag-item">';
    html += '<div class="diag-status ' + (ruleMatches ? 'success' : 'failure') + '">';
    html += ruleMatches ? '‚úì' : '‚úó';
    html += '</div>';
    html += '<div class="diag-text"><strong>THEN ' + getActionDescription(rule.action1) + '</strong></div>';
    html += '<div class="diag-value">' + (ruleMatches ? 'VILLE K√òRE' : 'K√òRER IKKE') + '</div>';
    html += '</div>';
    
    if (!ruleMatches) {
      var reasons = [];
      if (!triggerResult.ok) reasons.push('Trigger ikke opfyldt');
      if (!cond1Result.ok && rule.cond1) reasons.push('1. betingelse fejler');
      if (!cond2Result.ok && rule.cond2) reasons.push('2. betingelse fejler');
      html += '<div class="diag-explain">√Örsag: ' + reasons.join(', ') + '</div>';
    }
    html += '</div>';
    
    diagPanel.innerHTML = html;
  }

  function evaluateTriggerForDiag(rule) {
    switch(rule.trigger) {
      case 'always':
        return { ok: true, description: 'Altid aktiv', explain: null };
      case 'motionBreached':
        var isBreached = state.motion === true;
        return { 
          ok: isBreached, 
          description: 'PIR = ' + (state.motion ? 'Breached' : 'Safe'),
          explain: isBreached ? null : 'PIR sensor skal v√¶re aktiveret (Breached) for at trigge'
        };
      case 'motionSafe':
        var isSafe = state.motion === false;
        return { 
          ok: isSafe, 
          description: 'PIR = ' + (state.motion ? 'Breached' : 'Safe'),
          explain: isSafe ? null : 'PIR sensor skal v√¶re deaktiveret (Safe) for at trigge'
        };
      case 'doorOpened':
        var isOpen = state.door === true;
        return { 
          ok: isOpen, 
          description: 'D√∏r = ' + (state.door ? 'Opened' : 'Closed'),
          explain: isOpen ? null : 'D√∏ren skal v√¶re √•ben for at trigge'
        };
      case 'timeEquals':
        var matches = rule.triggerValue === state.time;
        return {
          ok: matches,
          description: 'Tid = ' + state.time + ' (forventet: ' + (rule.triggerValue || 'ikke sat') + ')',
          explain: matches ? null : 'Tiden skal v√¶re pr√¶cis ' + rule.triggerValue + ' for at trigge'
        };
      case 'humidityAbove':
        var threshold = parseFloat(rule.triggerValue || '0');
        var above = state.humidity >= threshold;
        return {
          ok: above,
          description: 'Fugt = ' + state.humidity + '% (‚â• ' + threshold + '%)',
          explain: above ? null : 'Fugtighed skal v√¶re ' + threshold + '% eller h√∏jere'
        };
      case 'globalEqTrig':
        var p = parseNameValue(rule.triggerValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig global reference', explain: 'Global navn mangler' };
        var currentVal = gget(p.name);
        var matches = currentVal === p.value;
        return {
          ok: matches,
          description: p.name + ' = "' + currentVal + '" (forventet: "' + p.value + '")',
          explain: matches ? null : 'Global ' + p.name + ' skal v√¶re pr√¶cis "' + p.value + '"'
        };
      case 'sensorEqTrig':
        var p = parseNameValue(rule.triggerValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = gget(p.name);
        var matches = currentVal === p.value;
        return {
          ok: matches,
          description: p.name + ' = "' + currentVal + '" (forventet: "' + p.value + '")',
          explain: matches ? null : 'Sensor ' + p.name + ' skal v√¶re pr√¶cis "' + p.value + '"'
        };
      case 'sensorGtTrig':
        var p = parseNameValue(rule.triggerValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var above = currentVal > threshold;
        return {
          ok: above,
          description: p.name + ' = ' + currentVal + ' (> ' + threshold + ')',
          explain: above ? null : 'Sensor ' + p.name + ' skal v√¶re st√∏rre end ' + threshold
        };
      case 'sensorLtTrig':
        var p = parseNameValue(rule.triggerValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var below = currentVal < threshold;
        return {
          ok: below,
          description: p.name + ' = ' + currentVal + ' (< ' + threshold + ')',
          explain: below ? null : 'Sensor ' + p.name + ' skal v√¶re mindre end ' + threshold
        };
      case 'sensorGeTrig':
        var p = parseNameValue(rule.triggerValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var aboveOrEqual = currentVal >= threshold;
        return {
          ok: aboveOrEqual,
          description: p.name + ' = ' + currentVal + ' (‚â• ' + threshold + ')',
          explain: aboveOrEqual ? null : 'Sensor ' + p.name + ' skal v√¶re st√∏rre end eller lig ' + threshold
        };
      case 'sensorLeTrig':
        var p = parseNameValue(rule.triggerValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var belowOrEqual = currentVal <= threshold;
        return {
          ok: belowOrEqual,
          description: p.name + ' = ' + currentVal + ' (‚â§ ' + threshold + ')',
          explain: belowOrEqual ? null : 'Sensor ' + p.name + ' skal v√¶re mindre end eller lig ' + threshold
        };
      default:
        return { ok: false, description: 'Ukendt trigger type', explain: 'Trigger type "' + rule.trigger + '" ikke underst√∏ttet i diagnose' };
    }
  }

  function evaluateConditionForDiag(condType, condValue) {
    if (!condType) return { ok: true, description: '(ingen)', explain: null };
    
    switch(condType) {
      case 'luxBelow':
        var threshold = parseFloat(condValue || '0');
        var below = state.lux < threshold;
        return {
          ok: below,
          description: 'Lys = ' + state.lux + ' (< ' + threshold + ')',
          explain: below ? null : 'Lysniveau skal v√¶re under ' + threshold
        };
      case 'luxAbove':
        var threshold = parseFloat(condValue || '0');
        var above = state.lux > threshold;
        return {
          ok: above,
          description: 'Lys = ' + state.lux + ' (> ' + threshold + ')',
          explain: above ? null : 'Lysniveau skal v√¶re over ' + threshold
        };
      case 'humAbove':
        var threshold = parseFloat(condValue || '0');
        var above = state.humidity >= threshold;
        return {
          ok: above,
          description: 'Fugt = ' + state.humidity + '% (‚â• ' + threshold + '%)',
          explain: above ? null : 'Fugtighed skal v√¶re ' + threshold + '% eller h√∏jere'
        };
      case 'humBelow':
        var threshold = parseFloat(condValue || '0');
        var below = state.humidity <= threshold;
        return {
          ok: below,
          description: 'Fugt = ' + state.humidity + '% (‚â§ ' + threshold + '%)',
          explain: below ? null : 'Fugtighed skal v√¶re ' + threshold + '% eller lavere'
        };
      case 'windBelow':
        var threshold = parseFloat(condValue || '0');
        var below = state.wind < threshold;
        return {
          ok: below,
          description: 'Vind = ' + state.wind + ' (< ' + threshold + ')',
          explain: below ? null : 'Vindhastighed skal v√¶re under ' + threshold
        };
      case 'weekdayIn':
        var allowedDays = (condValue || '').split(',').map(function(s){return s.trim();});
        var matches = allowedDays.includes(state.weekday);
        return {
          ok: matches,
          description: 'Ugedag = ' + state.weekday + ' (i: ' + allowedDays.join(', ') + ')',
          explain: matches ? null : 'Ugedagen skal v√¶re en af: ' + allowedDays.join(', ')
        };

      case 'globalEq':
        var parts = (condValue || '').split('=');
        var key = (parts[0] || '').trim();
        var expected = (parts[1] || '').trim();
        if (!key) return { ok: false, description: 'Ugyldig global reference', explain: 'Global navn mangler' };
        var currentVal = (state.globals[key] || '');
        var matches = currentVal === expected;
        return {
          ok: matches,
          description: key + ' = "' + currentVal + '" (forventet: "' + expected + '")',
          explain: matches ? null : 'Global ' + key + ' skal v√¶re "' + expected + '"'
        };
      case 'sensorEq':
        var p = parseNameValue(condValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = gget(p.name);
        var matches = currentVal === p.value;
        return {
          ok: matches,
          description: p.name + ' = "' + currentVal + '" (forventet: "' + p.value + '")',
          explain: matches ? null : 'Sensor ' + p.name + ' skal v√¶re "' + p.value + '"'
        };
      case 'sensorNe':
        var p = parseNameValue(condValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = gget(p.name);
        var notMatches = currentVal !== p.value;
        return {
          ok: notMatches,
          description: p.name + ' = "' + currentVal + '" (‚â† "' + p.value + '")',
          explain: notMatches ? null : 'Sensor ' + p.name + ' skal IKKE v√¶re "' + p.value + '"'
        };
      case 'sensorGt':
        var p = parseNameValue(condValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var above = currentVal > threshold;
        return {
          ok: above,
          description: p.name + ' = ' + currentVal + ' (> ' + threshold + ')',
          explain: above ? null : 'Sensor ' + p.name + ' skal v√¶re st√∏rre end ' + threshold
        };
      case 'sensorLt':
        var p = parseNameValue(condValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var below = currentVal < threshold;
        return {
          ok: below,
          description: p.name + ' = ' + currentVal + ' (< ' + threshold + ')',
          explain: below ? null : 'Sensor ' + p.name + ' skal v√¶re mindre end ' + threshold
        };
      case 'sensorGe':
        var p = parseNameValue(condValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var aboveOrEqual = currentVal >= threshold;
        return {
          ok: aboveOrEqual,
          description: p.name + ' = ' + currentVal + ' (‚â• ' + threshold + ')',
          explain: aboveOrEqual ? null : 'Sensor ' + p.name + ' skal v√¶re st√∏rre end eller lig ' + threshold
        };
      case 'sensorLe':
        var p = parseNameValue(condValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = toNum(gget(p.name));
        var threshold = toNum(p.value);
        var belowOrEqual = currentVal <= threshold;
        return {
          ok: belowOrEqual,
          description: p.name + ' = ' + currentVal + ' (‚â§ ' + threshold + ')',
          explain: belowOrEqual ? null : 'Sensor ' + p.name + ' skal v√¶re mindre end eller lig ' + threshold
        };
      case 'sensorContains':
        var p = parseNameValue(condValue || '');
        if (!p.name) return { ok: false, description: 'Ugyldig sensor reference', explain: 'Sensor navn mangler' };
        var currentVal = String(gget(p.name));
        var contains = currentVal.indexOf(p.value) !== -1;
        return {
          ok: contains,
          description: p.name + ' = "' + currentVal + '" (indeholder "' + p.value + '")',
          explain: contains ? null : 'Sensor ' + p.name + ' skal indeholde "' + p.value + '"'
        };
      case 'timeBetween':
        var inRange = timeBetweenVirtual(state.time, condValue || '');
        return {
          ok: inRange,
          description: 'Tid = ' + state.time + ' (mellem ' + (condValue || 'ikke sat') + ')',
          explain: inRange ? null : 'Tiden skal v√¶re mellem ' + condValue
        };
      default:
        return { ok: false, description: 'Ukendt condition type', explain: 'Condition type "' + condType + '" ikke underst√∏ttet i diagnose' };
    }
  }

  function getTriggerDescription(triggerType) {
    var map = {
      'always': 'Altid',
      'motionBreached': 'PIR ‚Üí Breached',
      'motionSafe': 'PIR ‚Üí Safe',
      'doorOpened': 'D√∏r ‚Üí Opened',
      'timeEquals': 'Tid =',
      'humidityAbove': 'Fugt ‚â•',
      'globalEqTrig': 'Global ==',
      'sensorEqTrig': 'Sensor ==',
      'sensorGtTrig': 'Sensor >',
      'sensorLtTrig': 'Sensor <',
      'sensorGeTrig': 'Sensor ‚â•',
      'sensorLeTrig': 'Sensor ‚â§'
    };
    return map[triggerType] || triggerType;
  }

  function getConditionDescription(condType) {
    var map = {
      'luxBelow': 'Lys <',
      'luxAbove': 'Lys >',
      'humAbove': 'Fugt ‚â•',
      'humBelow': 'Fugt ‚â§',
      'windBelow': 'Vind <',
      'weekdayIn': 'Ugedag i',
      'alarmArmed': 'Alarm = Armed',
      'alarmHome': 'Home Mode',
      
      'globalEq': 'Global ==',
      'sensorEq': 'Sensor ==',
      'sensorNe': 'Sensor ‚â†',
      'sensorGt': 'Sensor >',
      'sensorLt': 'Sensor <',
      'sensorGe': 'Sensor ‚â•',
      'sensorLe': 'Sensor ‚â§',
      'sensorContains': 'Sensor contains',
      'timeBetween': 'Tid mellem'
    };
    return map[condType] || condType;
  }

  function getActionDescription(actionType) {
    var map = {
      'lightOn': 'Lys ‚Üí T√¶nd',
      'lightOff': 'Lys ‚Üí Sluk',
      'dim30': 'D√¶mper ‚Üí 30%',
      'dim100': 'D√¶mper ‚Üí 100%',
      'fanOn': 'Ventilator ‚Üí T√¶nd',
      'fanOff': 'Ventilator ‚Üí Sluk',
      'push': 'Send Push',
      'setGlobal': 'Set Global',
      'delayLightOff': 'Delay ‚Üí Lys Off'
    };
    return map[actionType] || actionType;
  }

  $('#addRule').onclick=function(){ var r={trigger:$('#triggerType').value, triggerValue:$('#triggerValue').value.trim(),
    cond1:$('#cond1').value, cond1Value:$('#cond1Value').value.trim(), cond2:$('#cond2').value, cond2Value:$('#cond2Value').value.trim(),
    action1:$('#action1').value, action1Value:$('#action1Value').value.trim(), ruleName:$('#ruleName').value.trim()};
    state.rules.push(r); refreshRules(); log('Regel tilf√∏jet'+(r.ruleName?': '+r.ruleName:'')); $('#ruleName').value=''; };
  $('#clearRules').onclick=function(){ state.rules=[]; refreshRules(); log('Alle regler slettet.'); };

  /* Storage + import/eksport (WebView2) */
  $('#saveRules').onclick=function(){ try{ localStorage.setItem('hc3_rules', JSON.stringify(state.rules)); log('Regler gemt i localStorage.'); }catch(e){ alert('Kunne ikke gemme: '+e.message); } };
  $('#loadRules').onclick=function(){ try{ var raw=localStorage.getItem('hc3_rules'); if(raw){ state.rules=JSON.parse(raw)||[]; refreshRules(); log('Regler hentet.'); } else alert('Ingen gemte regler.'); }catch(e){ alert('Kunne ikke l√¶se regler: '+e.message); } };

  $('#exportRules').onclick = async function(){
    try{
      var data = JSON.stringify({version:'1.7.3', rules: state.rules}, null, 2);
      var savedPath = await window.api.saveText('hc3_rules.json', data);
      if(savedPath){ log('Regler eksporteret til ' + savedPath); alert('Eksporteret til ' + savedPath); }
    }catch(e){ alert('Eksport fejlede: ' + e.message); }
  };

  $('#importRules').onclick = async function(){
    try{
      var inp = $('#importFile');
      var f   = inp && inp.files && inp.files[0];
      if (f){
        var r = new FileReader();
        r.onload = function(e){
          try{
            var txt   = e.target.result || '';
            var obj   = JSON.parse(txt || '{}');
            var rules = obj.rules || obj || [];
            if(!(rules && rules.length >= 0)) throw new Error('JSON indeholder ikke regler');
            state.rules = rules; refreshRules(); log('Regler importeret fra valgt fil (FileReader).');
          }catch(err){ alert('Import fejlede: ' + err.message); }
        };
        r.readAsText(f);
        return;
      }
      var res = await window.api.openText();
      if(res && res.text){
        var obj   = JSON.parse(res.text || '{}');
        var rules = obj.rules || obj || [];
        if(!(rules && rules.length >= 0)) throw new Error('JSON indeholder ikke regler');
        state.rules = rules; refreshRules(); log('Regler importeret fra ' + (res.path||'(ukendt)'));
      } else {
        alert('V√¶lg en .json-fil (via knappen eller feltet).');
      }
    }catch(e){ alert('Import fejlede: ' + e.message); }
  };

  /* Tidshj√¶lpere */
  function toMin(hhmm){ var sp=(hhmm||'00:00').split(':'), h=parseInt(sp[0]||'0',10), m=parseInt(sp[1]||'0',10); return h*60+m; }
  function timeBetweenVirtual(currentHHMM, range){ var now=toMin(currentHHMM||'00:00'); var parts=(range||'').split('-'); if(parts.length!==2) return false;
    var a=toMin(parts[0].trim()), b=toMin(parts[1].trim()); return (a<=b)?(now>=a&&now<=b):(now>=a||now<=b); }

  /* AND-betingelser */
  function condOk(kind,val){
    if(!kind) return true; var v=(val||'').trim();
    switch(kind){
      case 'luxBelow': return state.lux < parseFloat(v||'0');
      case 'luxAbove': return state.lux > parseFloat(v||'0');
      case 'humAbove': return state.humidity >= parseFloat(v||'0');
      case 'humBelow': return state.humidity <= parseFloat(v||'0');
      case 'windBelow': return state.wind < parseFloat(v||'0');
      case 'weekdayIn': return v.split(',').map(function(s){return s.trim();}).includes(state.weekday);
      case 'alarmArmed': return state.alarmArmed === true;
      case 'alarmHome': return state.alarmHome === true;
      
      case 'globalEq': { var sp=v.split('='), k=(sp[0]||'').trim(), expect=(sp[1]||'').trim(); return (state.globals[k]||'')===expect; }
      case 'sensorEq': { var p=parseNameValue(v); return gget(p.name)===p.value; }
      case 'sensorNe': { var p2=parseNameValue(v); return gget(p2.name)!==p2.value; }
      case 'sensorGt': { var p3=parseNameValue(v); return toNum(gget(p3.name)) >  toNum(p3.value); }
      case 'sensorLt': { var p4=parseNameValue(v); return toNum(gget(p4.name)) <  toNum(p4.value); }
      case 'sensorGe': { var p5=parseNameValue(v); return toNum(gget(p5.name)) >= toNum(p5.value); }
      case 'sensorLe': { var p6=parseNameValue(v); return toNum(gget(p6.name)) <= toNum(p6.value); }
      case 'sensorContains': { var p7=parseNameValue(v); return String(gget(p7.name)).indexOf(p7.value)!==-1; }
      case 'timeBetween': return timeBetweenVirtual(state.time, v);
      default: return true;
    }
  }
  function bothCondsOk(r){ return condOk(r.cond1, r.cond1Value) && condOk(r.cond2, r.cond2Value); }

  /* Triggers */
  function matchTrigger(rule, firedTrigger){
    if(rule.trigger!==firedTrigger) return false;
    switch(firedTrigger){
      case 'always': return true;
      case 'motionBreached': return state.motion===true;
      case 'motionSafe': return state.motion===false;
      case 'doorOpened': return state.door===true;
      case 'timeEquals': return !!rule.triggerValue && rule.triggerValue===state.time;
      case 'humidityAbove': return state.humidity >= parseFloat((rule.triggerValue||'0').trim());
      case 'globalEqTrig': { var p=parseNameValue(rule.triggerValue||''); if(!p.name) return false; return gget(p.name)===p.value; }
      case 'sensorEqTrig':  { var p2=parseNameValue(rule.triggerValue||''); if(!p2.name) return false; return gget(p2.name)===p2.value; }
      case 'sensorGtTrig':  { var p3=parseNameValue(rule.triggerValue||''); if(!p3.name) return false; return toNum(gget(p3.name)) >  toNum(p3.value); }
      case 'sensorLtTrig':  { var p4=parseNameValue(rule.triggerValue||''); if(!p4.name) return false; return toNum(gget(p4.name)) <  toNum(p4.value); }
      case 'sensorGeTrig':  { var p5=parseNameValue(rule.triggerValue||''); if(!p5.name) return false; return toNum(gget(p5.name)) >= toNum(p5.value); }
      case 'sensorLeTrig':  { var p6=parseNameValue(rule.triggerValue||''); if(!p6.name) return false; return toNum(gget(p6.name)) <= toNum(p6.value); }
      default: return false;
    }
  }

  function doAction(kind,param){
    switch(kind){
      case 'lightOn': setLight(true); break;
      case 'lightOff': setLight(false); break;
      case 'dim30': setDimmer(30); break;
      case 'dim100': setDimmer(100); break;
      case 'fanOn': setFan(true); break;
      case 'fanOff': setFan(false); break;
      case 'push': log('PUSH: '+(param||'(tom besked)')); break;
      case 'setGlobal': { var sp=(param||'').split('='), k=(sp[0]||'').trim(), v=(sp[1]||'').trim(); if(!k){ log('SetGlobal fejl: mangler name=value'); break; } state.globals[k]=v; log('Global '+k+'='+v); break; }
      case 'delayLightOff': { var sec=Math.max(0, parseInt(param||'0',10)); window.setTimeout(function(){ setLight(false); }, sec*1000); log('Delay '+sec+'s ‚Üí Light Off planlagt'); break; }
    }
  }

  function evaluate(firedTrigger){
    for(var i=0;i<state.rules.length;i++){
      var r=state.rules[i];
      if(matchTrigger(r,firedTrigger) && bothCondsOk(r)){
        doAction(r.action1, r.action1Value);
        var name = r.ruleName ? '"'+r.ruleName+'"' : ('#'+(i+1));
        log('MATCH: Regel '+name+' ‚Üí action "'+r.action1+'"', 'match');
      }
    }
  }

  function runAll(){
    for(var i=0;i<state.rules.length;i++){
      var r=state.rules[i], ok=false;
      switch(r.trigger){
        case 'always': ok=true; break;
        case 'motionBreached': ok=(state.motion===true); break;
        case 'motionSafe': ok=(state.motion===false); break;
        case 'doorOpened': ok=(state.door===true); break;
        case 'timeEquals': ok=(!!r.triggerValue && r.triggerValue===state.time); break;
        case 'humidityAbove': ok=(state.humidity >= parseFloat((r.triggerValue||'0').trim())); break;
        case 'globalEqTrig': { var p=parseNameValue(r.triggerValue||''); ok=!!p.name && (gget(p.name)===p.value); break; }
        case 'sensorEqTrig':  { var p2=parseNameValue(r.triggerValue||''); ok=!!p2.name && (gget(p2.name)===p2.value); break; }
        case 'sensorGtTrig':  { var p3=parseNameValue(r.triggerValue||''); ok=!!p3.name && (toNum(gget(p3.name)) >  toNum(p3.value)); break; }
        case 'sensorLtTrig':  { var p4=parseNameValue(r.triggerValue||''); ok=!!p4.name && (toNum(gget(p4.name)) <  toNum(p4.value)); break; }
        case 'sensorGeTrig':  { var p5=parseNameValue(r.triggerValue||''); ok=!!p5.name && (toNum(gget(p5.name)) >= toNum(p5.value)); break; }
        case 'sensorLeTrig':  { var p6=parseNameValue(r.triggerValue||''); ok=!!p6.name && (toNum(gget(p6.name)) <= toNum(p6.value)); break; }
      }
      if(ok && bothCondsOk(r)){
        doAction(r.action1, r.action1Value);
        var name = r.ruleName ? '"'+r.ruleName+'"' : ('#'+(i+1));
        log('MATCH: Regel '+name+' ‚Üí action "'+r.action1+'"', 'match');
      }
    }
    log('RUN: alle regler evalueret mod aktuelle tilstande.');
  }

  function applyPending(){
    ch('motion','PIR',function(v){return v?'Breached':'Safe';});
    ch('door','D√∏rkontakt',function(v){return v?'Opened':'Closed';});
    ch('lux','Lys(lux)'); ch('wind','Vind',function(v){return v+' m/s';}); ch('humidity','Fugtighed',function(v){return v+'%';});
            ch('time','Klokkesl√¶t'); ch('weekday','Ugedag');
    ch('alarmArmed','Alarm.Armed'); ch('alarmHome','Alarm.Home');
    var pg=pending.globals||{}; for(var k in pg){ if(pg.hasOwnProperty(k)){ if((state.globals[k]||'')!==pg[k]){ state.globals[k]=pg[k]; log('AKTIVERET: Global '+k+'='+pg[k]); } } }
    updateKPI(); runAll();
  }

  /* Knapper */
  $('#applyPending').onclick=function(){ applyPending(); };
  $('#runAll').onclick=function(){ runAll(); };
  $('#runTimeTick').onclick=function(){ evaluate('timeEquals'); log('TIME TICK: '+state.time); };
  $('#clearLog').onclick=function(){ clearLog(); };

  /* Z-Wave sensor defs + tooltips */
  var SENSOR_DEFS = {
    'PIR (bev√¶gelse)':     {kind:'binary', key:'pir',        on:'Breached', off:'Safe'},
    'D√∏r-/vindueskontakt': {kind:'binary', key:'contact',    on:'Opened',   off:'Closed'},
    'Fugtighed (%)':       {kind:'number', key:'humidity',   unit:'%',    step:1,   min:0,   max:100,  mapsTo:'humidity'},
    'Lys (lux)':           {kind:'number', key:'lux',        unit:'lux',  step:1,   min:0,   max:5000, mapsTo:'lux'},
    'Vind (m/s)':          {kind:'number', key:'wind',       unit:'m/s',  step:0.1, min:0,   max:60,   mapsTo:'wind'},
    'Temperatur (¬∞C)':     {kind:'number', key:'temp',       unit:'¬∞C',   step:0.1, min:-30, max:60},
    'R√∏galarm':            {kind:'binary', key:'smoke',      on:'Detected', off:'Clear'},
    'Vandl√¶kage':          {kind:'binary', key:'leak',       on:'Wet',     off:'Dry'},
    'CO‚ÇÇ (ppm)':           {kind:'number', key:'co2',        unit:'ppm',  step:50,  min:300, max:5000},
    'Tilstedev√¶relse':     {kind:'binary', key:'presence',   on:'Occupied', off:'Vacant'},
    'Alarm (Armed)':       {kind:'binary', key:'alarmArmed', on:'Armed',   off:'Disarmed'},
    'Home Mode':           {kind:'binary', key:'alarmHome',  on:'Home',    off:'Away'},
    
  };
  function makeSensorTip(name){
    var def=SENSOR_DEFS[name]; if(!def) return 'Sensor (global)\nSkriv i Regler: navn=v√¶rdi';
    if(def.mapsTo){ if(def.mapsTo==='lux') return ['Lys (lux) ‚Äì IKKE via Sensor (global)','Brug i Regler:','‚Ä¢ AND: "Lys (lux) <" / ">"','Eksempel: AND Lys (lux) < 50'].join('\n');
      if(def.mapsTo==='wind') return ['Vind (m/s) ‚Äì IKKE via Sensor (global)','Brug i Regler:','‚Ä¢ AND: "Vind <"','Eksempel: AND Vind < 5'].join('\n');
      if(def.mapsTo==='humidity') return ['Fugtighed (%) ‚Äì IKKE via Sensor (global)','Brug i Regler:','‚Ä¢ IF Fugtighed ‚â• (v√¶rdi)','‚Ä¢ AND Fugtighed ‚â§ / ‚â•','Eksempel: IF Fugtighed ‚â• 65'].join('\n'); }
    var key='sensor.'+def.key;
    if(def.kind==='binary') return [name,'Global: '+key,'V√¶rdier: '+def.on+' / '+def.off,'IF: Sensor (global) =','  '+key+'='+def.on,'AND: ==, ‚â†, contains','  fx '+key+'='+def.off].join('\n');
    var unit=def.unit?(' '+def.unit):''; return [name,'Global: '+key,'V√¶rdi: tal'+unit,'IF: Sensor (global) >, <, ‚â•, ‚â§, =','  fx '+key+'=21','AND: >, <, ‚â•, ‚â§, ==, ‚â†'].join('\n');
  }

  function zwMakeRow(container){
    var row=document.createElement('div'); row.className='zw-row';

    var typeSel=document.createElement('select'); typeSel.className='zw-type';
    for(var name in SENSOR_DEFS){ var op=document.createElement('option'); op.value=name; op.text=name; typeSel.appendChild(op); }

    var valWrap=document.createElement('div');
    valWrap.style.display='flex'; valWrap.style.alignItems='center'; valWrap.style.gap='8px'; valWrap.style.flex='0 0 auto';
    var valCtl=null;

    var setBtn=document.createElement('button'); setBtn.textContent='S√¶t (buffer)';
    var delBtn=document.createElement('button'); delBtn.textContent='Fjern'; delBtn.className='danger';

    var badge=document.createElement('span');   badge.className='zw-badge has-tip';
    var nameChip=document.createElement('span'); nameChip.className='zw-global';
    var mapsChip=document.createElement('span'); mapsChip.className='zw-maps';

    function updateMeta(){
      var def=SENSOR_DEFS[typeSel.value]; if(!def) return;
      badge.textContent=(def.kind==='binary')?'Bin√¶r':'Numerisk';
      var tip=makeSensorTip(typeSel.value); badge.setAttribute('data-tip',tip); badge.title=tip.replace(/\n/g,' ‚Ä¢ ');
      nameChip.textContent = 'sensor.'+def.key;
      mapsChip.textContent = def.mapsTo ? def.mapsTo : '';
      mapsChip.style.display = def.mapsTo ? 'inline-flex' : 'none';
    }

    function renderValueCtl(){
      valWrap.innerHTML=''; valCtl=null; var def=SENSOR_DEFS[typeSel.value]; if(!def) return;
      if(def.kind==='binary'){
        var onOff=document.createElement('select'); onOff.className='zw-val';
        var o1=document.createElement('option'); o1.value=def.on;  o1.text=def.on;
        var o2=document.createElement('option'); o2.value=def.off; o2.text=def.off;
        onOff.appendChild(o1); onOff.appendChild(o2);
        valCtl=onOff; valWrap.appendChild(onOff);
      } else {
        var inp=document.createElement('input'); inp.className='zw-val'; inp.type='number';
        if(def.step!=null) inp.step=def.step; if(def.min!=null) inp.min=def.min; if(def.max!=null) inp.max=def.max;
        inp.value=def.min!=null?def.min:0; valCtl=inp; valWrap.appendChild(inp);
        if(def.unit){ var unit=document.createElement('span'); unit.className='zw-badge'; unit.textContent=def.unit; valWrap.appendChild(unit); }
      }
      updateMeta();
    }

    typeSel.onchange=function(){ renderValueCtl(); };
    renderValueCtl();

    setBtn.onclick=function(){
      var def=SENSOR_DEFS[typeSel.value]; if(!def) return; var key=def.key;
      if(def.mapsTo){
        var num=parseFloat(valCtl.value); if(isNaN(num)) num=0;
        pending[def.mapsTo]=num;
        log('BUFFER: '+typeSel.value+' ‚Üí '+num+(def.unit?(' '+def.unit):''));
      } else if(def.kind==='binary'){
        var v=String(valCtl.value||def.off);
        if(!pending.globals) pending.globals={}; pending.globals['sensor.'+key]=v;
        log('BUFFER: Global sensor.'+key+'='+v);
        
        // Special h√•ndtering for PIR og d√∏rkontakt til backward compatibility
        if(key === 'pir') {
          pending.motion = (v === def.on);
        } else if(key === 'contact') {
          pending.door = (v === def.on);
        } else if(key === 'alarmArmed') {
          pending.alarmArmed = (v === def.on);
        } else if(key === 'alarmHome') {
          pending.alarmHome = (v === def.on);
        }
      } else {
        var numv=String(valCtl.value);
        if(!pending.globals) pending.globals={}; pending.globals['sensor.'+key]=numv;
        log('BUFFER: Global sensor.'+key+'='+numv);
      }
    };

    delBtn.onclick=function(){ container.removeChild(row); };

    /* Append-orden: kontroller -> knapper -> metachips (til h√∏jre) */
    var metaWrap=document.createElement('div'); metaWrap.className='zw-meta';
    metaWrap.appendChild(nameChip); metaWrap.appendChild(mapsChip); metaWrap.appendChild(badge);

    row.appendChild(typeSel);
    row.appendChild(valWrap);
    row.appendChild(setBtn);
    row.appendChild(delBtn);
    row.appendChild(metaWrap);

    container.appendChild(row);
  }
  window.zwMakeRow=zwMakeRow;

  /* LUA generator */
  function esc(s){ return (s||'').replace(/\\/g,'\\\\').replace(/"/g,'\\"'); }
  function luaForTrigger(r){ function pnv(){ return parseNameValue(r.triggerValue||''); }
    switch(r.trigger){
      case 'always': return 'true';
      case 'motionBreached': return 'fibaro.getValue(MOTION_ID, "value") == "true"';
      case 'motionSafe':     return 'fibaro.getValue(MOTION_ID, "value") == "false"';
      case 'doorOpened':     return 'fibaro.getValue(DOOR_ID, "value") == "true"';
      case 'timeEquals':     return 'os.date("%H:%M") == "'+esc(r.triggerValue||"07:30")+'"';
      case 'humidityAbove':  return '(tonumber(fibaro.getValue(HUM_ID, "value")) or 0) >= '+(parseFloat(r.triggerValue||'0')||0);
      case 'globalEqTrig': { var p=pnv(); return 'fibaro.getGlobalVariable("'+esc(p.name||'')+'") == "'+esc(p.value||'')+'"'; }
      case 'sensorEqTrig':  { var p2=pnv(); return 'fibaro.getGlobalVariable("'+esc(p2.name||'')+'") == "'+esc(p2.value||'')+'"'; }
      case 'sensorGtTrig':  { var p3=pnv(); return '(tonumber(fibaro.getGlobalVariable("'+esc(p3.name||'')+'")) or 0) > '+(parseFloat(p3.value||'0')||0); }
      case 'sensorLtTrig':  { var p4=pnv(); return '(tonumber(fibaro.getGlobalVariable("'+esc(p4.name||'')+'")) or 0) < '+(parseFloat(p4.value||'0')||0); }
      case 'sensorGeTrig':  { var p5=pnv(); return '(tonumber(fibaro.getGlobalVariable("'+esc(p5.name||'')+'")) or 0) >= '+(parseFloat(p5.value||'0')||0); }
      case 'sensorLeTrig':  { var p6=pnv(); return '(tonumber(fibaro.getGlobalVariable("'+esc(p6.name||'')+'")) or 0) <= '+(parseFloat(p6.value||'0')||0); }
      default: return 'true';
    } }
  function luaForCond(kind, val){ var v=(val||'').trim(); function p(){ return parseNameValue(v); }
    switch(kind){
      case 'luxBelow':  return '(tonumber(fibaro.getValue(LUX_ID, "value")) or 0) < '+(parseFloat(v||'0')||0);
      case 'luxAbove':  return '(tonumber(fibaro.getValue(LUX_ID, "value")) or 0) > '+(parseFloat(v||'0')||0);
      case 'humAbove':  return '(tonumber(fibaro.getValue(HUM_ID, "value")) or 0) >= '+(parseFloat(v||'0')||0);
      case 'humBelow':  return '(tonumber(fibaro.getValue(HUM_ID, "value")) or 0) <= '+(parseFloat(v||'0')||0);
      case 'windBelow': return '(tonumber(fibaro.getValue(WIND_ID, "value")) or 0) < '+(parseFloat(v||'0')||0);
      case 'weekdayIn': { var parts=v.split(','), set='{'+parts.map(function(pw){ pw=pw.replace(/"/g,'\\"'); return '["'+pw+'"]=true'; }).join(', ')+'}'; return '(function() local D='+set+'; return D[os.date("%a")] == true end)()'; }
      case 'alarmArmed': return 'fibaro.getGlobalVariable("Alarm") == "Armed"';
      case 'alarmHome': return 'fibaro.getGlobalVariable("HomeMode") == "Home"';
      
      case 'globalEq': { var sp=v.split('='), k=(sp[0]||'mode'), expect=(sp[1]||'night'); return 'fibaro.getGlobalVariable("'+esc(k)+'") == "'+esc(expect)+'"'; }
      case 'sensorEq': { var pp=p(); return 'fibaro.getGlobalVariable("'+esc(pp.name||'')+'") == "'+esc(pp.value||'')+'"'; }
      case 'sensorNe': { var pp2=p(); return 'fibaro.getGlobalVariable("'+esc(pp2.name||'')+'") ~= "'+esc(pp2.value||'')+'"'; }
      case 'sensorGt': { var pp3=p(); return '(tonumber(fibaro.getGlobalVariable("'+esc(pp3.name||'')+'")) or 0) > '+(parseFloat(pp3.value||'0')||0); }
      case 'sensorLt': { var pp4=p(); return '(tonumber(fibaro.getGlobalVariable("'+esc(pp4.name||'')+'")) or 0) < '+(parseFloat(pp4.value||'0')||0); }
      case 'sensorGe': { var pp5=p(); return '(tonumber(fibaro.getGlobalVariable("'+esc(pp5.name||'')+'")) or 0) >= '+(parseFloat(pp5.value||'0')||0); }
      case 'sensorLe': { var pp6=p(); return '(tonumber(fibaro.getGlobalVariable("'+esc(pp6.name||'')+'")) or 0) <= '+(parseFloat(pp6.value||'0')||0); }
      case 'sensorContains': { var pp7=p(); return '(tostring(fibaro.getGlobalVariable("'+esc(pp7.name||'')+'")) or ""):find("'+esc(pp7.value||'')+'",1,true) ~= nil'; }
      case 'timeBetween': return '(function() local expr="'+v.replace(/"/g,'\\"')+'"; local function toMin(s) local h,m=s:match("^(%d%d):(%d%d)$"); h=tonumber(h) or 0; m=tonumber(m) or 0; return h*60+m end local now = toMin(os.date("%H:%M")); local a,b=expr:match("^(%d%d:%d%d)%-(%d%d:%d%d)$"); if not a or not b then return false end local A,B=toMin(a),toMin(b); if A<=B then return now>=A and now<=B else return now>=A or now<=B end end)()';
      default: return 'true';
    } }
  function luaForAction(kind, val){
    switch(kind){
      case 'lightOn':  return 'fibaro.call(LIGHT_ID, "turnOn")';
      case 'lightOff': return 'fibaro.call(LIGHT_ID, "turnOff")';
      case 'dim30':    return 'fibaro.call(DIMMER_ID, "setValue", 30)';
      case 'dim100':   return 'fibaro.call(DIMMER_ID, "setValue", 100)';
      case 'fanOn':    return 'fibaro.call(FAN_ID, "turnOn")';
      case 'fanOff':   return 'fibaro.call(FAN_ID, "turnOff")';
      case 'push':     return '-- Skift til fibaro.alert hvis √∏nsket\nfibaro.debug("PUSH", "'+String(val||"(tom besked)").replace(/\\/g,'\\\\').replace(/"/g,'\\"')+'")';
      case 'setGlobal':{ var sp=(val||'mode=night').split('='), k=(sp[0]||'mode'), vv=(sp[1]||'night'); return 'fibaro.setGlobalVariable("'+k.replace(/\\/g,'\\\\').replace(/"/g,'\\"')+'", "'+String(vv).replace(/\\/g,'\\\\').replace(/"/g,'\\"')+'")'; }
      case 'delayLightOff': { var sec=Math.max(0, parseInt(val||'0',10)); return 'fibaro.setTimeout('+(sec*1000)+', function() fibaro.call(LIGHT_ID, "turnOff") end)'; }
      default: return '-- (ukendt action)';
    }
  }
  function buildLua(){
    var rules=state.rules||[], body=[];
    for(var i=0;i<rules.length;i++){
      var r=rules[i], parts=[];
      parts.push('-- Regel #'+(i+1)+(r.ruleName?(' "'+r.ruleName.replace(/"/g,'\\\"')+'"'):''));
      parts.push('do'); parts.push('  local ok = ('+luaForTrigger(r)+')');
      if(r.cond1){ parts.push('  ok = ok and ('+luaForCond(r.cond1, r.cond1Value)+')'); }
      if(r.cond2){ parts.push('  ok = ok and ('+luaForCond(r.cond2, r.cond2Value)+')'); }
      parts.push('  if ok then'); parts.push('    '+luaForAction(r.action1, r.action1Value)); parts.push('  end'); parts.push('end');
      body.push(parts.join('\n'));
    }
    var actionsLua=[
      '-- Scene genereret (v1.7.3)',
      '-- RET ENHEDS-ID\'er HERUNDER:',
      'local LIGHT_ID, DIMMER_ID, FAN_ID = 123, 123, 456',
      'local MOTION_ID, DOOR_ID = 111, 112',
      'local LUX_ID, HUM_ID, WIND_ID = 113, 114, 115',
      '',
      '-- === Regler ===',
      body.join('\\n\\n'),
      ''
    ].join('\n');

    function condForTrigger(r){
      switch(r.trigger){
        case 'motionBreached': return '{ type="device", id=MOTION_ID, property="value", operator="==", value=true,  isTrigger=true }';
        case 'motionSafe':     return '{ type="device", id=MOTION_ID, property="value", operator="==", value=false, isTrigger=true }';
        case 'doorOpened':     return '{ type="device", id=DOOR_ID,   property="value", operator="==", value=true,  isTrigger=true }';
        case 'timeEquals':     return '{ type="time", operator="==", value="'+(r.triggerValue||"07:30").replace(/"/g,'\\\"')+'", isTrigger=true }';
        case 'humidityAbove':  return '{ type="device", id=HUM_ID,    property="value", operator=">=", value='+(parseFloat(r.triggerValue||"0")||0)+', isTrigger=true }';
        default: return null;
      }
    }
    var condSet={}, condList=[]; for(var j=0;j<rules.length;j++){ var c=condForTrigger(rules[j]); if(c&&!condSet[c]){condSet[c]=1; condList.push(c);} }
    if(condList.length===0){ condList.push('{}'); }
    var decl=['{','  conditions = {','    ' + condList.join(',\\n    '),'  },','  operator = "any"','}'].join('\n');
    return ['-- === ERKL√ÜRINGER (venstre panel i HC3) ===',decl,'','-- === HANDLINGER (h√∏jre panel i HC3) ===',actionsLua].join('\\n\\n');
  }
  $('#btnGenLua').onclick=function(){ luaOut.value = buildLua(); log('LUA genereret.'); menu.classList.remove('open'); };
  $('#btnCopyLua').onclick=function(){ try{ luaOut.focus(); luaOut.select(); document.execCommand('copy'); log('LUA kopieret.'); }catch(e){ alert('Kunne ikke kopiere: '+e.message);} menu.classList.remove('open'); };
  $('#btnSaveLua').onclick=async function(){
    try{
      var code=luaOut.value||''; if(!code){ alert('Gener√©r LUA f√∏rst.'); return; }
      var p = await window.api.saveText('hc3_scene.lua', code);
      if(p){ log('LUA gemt: '+p); alert('LUA gemt: '+p); }
    }catch(e){ alert('Kunne ikke gemme LUA: '+e.message);}
    menu.classList.remove('open');
  };

  /* Bootstrap-eksempel */
  if(!localStorage.getItem('hc3_rules_bootstrap_173')){
    state.rules.push({trigger:'sensorEqTrig',triggerValue:'sensor.contact=Opened',cond1:'timeBetween',cond1Value:'22:00-06:00',cond2:'',cond2Value:'',action1:'push',action1Value:'D√òR √ÖBNET OM NATTEN',ruleName:'D√∏r nat'});
    localStorage.setItem('hc3_rules_bootstrap_173','1');
  }

  /* Init */
  function addZwRow(){ var box = document.getElementById('zwRows'); if (!box){ alert('zwRows mangler'); return; } zwMakeRow(box); log('Ny Z-Wave sensor-r√¶kke tilf√∏jet.'); }
  document.getElementById('zwAdd').onclick = addZwRow;



  (function(){ 
    refreshRules(); 
    updateKPI(); 
    

    
    log('v1.7.3 (WebView2 ‚Ä¢ SPA) klar.'); 
  })();

  // === ONBOARDING SYSTEM ===
  (function(){
    var onboardingSteps = [
      {
        title: 'Velkommen til Simulator',
        content: 'Her kan du simulere sensorer og se hvordan de p√•virker dine regler. Pr√∏v at g√• til "Z-Wave sensorer" sektionen og tilf√∏j en PIR-sensor.',
        target: '#zwAdd',
        position: 'bottom'
      },
      {
        title: 'Aktiver √¶ndringer',
        content: 'N√•r du √¶ndrer sensorer via Z-Wave systemet, bliver de f√∏rst "buffered". Klik "Aktiv√©r √¶ndringer" for at anvende dem og k√∏re reglerne.',
        target: '#applyPending',
        position: 'top'
      },
      {
        title: 'Regler sektion',
        content: 'Her bygger du dine automation regler. V√¶lg en trigger (IF), tilf√∏j betingelser (AND) og v√¶lg en handling (THEN).',
        target: '#triggerType',
        position: 'bottom'
      },
      {
        title: 'Tilf√∏j regel',
        content: 'N√•r du har konfigureret din regel, klik "Tilf√∏j regel" for at gemme den. Den vises derefter i listen nedenfor.',
        target: '#addRule',
        position: 'top'
      },
      {
        title: 'K√∏r regler',
        content: 'Klik "K√∏r regler (RUN)" for at evaluere alle regler mod de aktuelle sensor-tilstande og se resultatet i loggen.',
        target: '#runAll',
        position: 'top'
      },
      {
        title: 'LUA generering',
        content: '√Öbn LUA-menuen og v√¶lg "Gener√©r LUA" for at f√• kode du kan bruge i Home Center 3. Koden vises i tekstomr√•det nedenfor.',
        target: '#luaBtn',
        position: 'bottom'
      },
      {
        title: 'Wiresheet Editor',
        content: 'Pr√∏v Wiresheet-fanen (i midten) for en visuel m√•de at bygge regler p√•. Tr√¶k noder rundt og forbind dem for at skabe komplekse automationer.',
        target: '#tabFlow',
        position: 'bottom'
      }
    ];

    var currentStep = 0;
    var onboardingActive = false;

    function showOnboardingStep(stepIndex) {
      if (stepIndex >= onboardingSteps.length) {
        finishOnboarding();
        return;
      }

      var step = onboardingSteps[stepIndex];
      var target = document.querySelector(step.target);
      if (!target) {
        showOnboardingStep(stepIndex + 1);
        return;
      }

      var overlay = document.getElementById('onboardingOverlay');
      var stepEl = document.createElement('div');
      stepEl.className = 'onboarding-step';
      
      var progress = '';
      for (var i = 0; i < onboardingSteps.length; i++) {
        var dotClass = i === stepIndex ? 'active' : (i < stepIndex ? 'completed' : '');
        progress += '<div class="dot ' + dotClass + '"></div>';
      }

      var buttonText = stepIndex === onboardingSteps.length - 1 ? 'Afslut' : 'N√¶ste';
      var buttonClass = stepIndex === onboardingSteps.length - 1 ? 'finish' : 'next';

      stepEl.innerHTML = `
        <div class="progress">${progress}</div>
        <h3>${step.title}</h3>
        <p>${step.content}</p>
        <div class="buttons">
          <button class="skip" onclick="skipOnboarding()">Spring over</button>
          <button class="pause" onclick="pauseOnboarding()">‚è∏Ô∏è Pause</button>
          <button class="${buttonClass}" onclick="nextOnboardingStep()">${buttonText}</button>
        </div>
      `;

      overlay.innerHTML = '';
      overlay.appendChild(stepEl);
      overlay.style.display = 'block';

      // Position step near target but avoid covering it
      // Use setTimeout to ensure element is fully rendered
      setTimeout(function() {
        var rect = target.getBoundingClientRect();
        
        // Estimate tooltip size (320px width, ~200px height based on CSS)
        var tooltipWidth = 320;
        var tooltipHeight = 200;
        
        var left, top;
        
        // For Wiresheet tab specifically, always position to the right
        if (step.target === '#tabFlow') {
          // If rect has zero dimensions, use fallback position
          if (rect.width === 0 || rect.height === 0) {
            // Fallback - position in top-right area
            left = window.innerWidth - tooltipWidth - 50;
            top = 100;
          } else {
            left = rect.right + 20;
            top = rect.top + (rect.height / 2) - (tooltipHeight / 2);
          }
        } else {
          // Try to position tooltip to the side of the target
          
          // Check if there's space to the right
          if (rect.right + tooltipWidth + 20 < window.innerWidth) {
            left = rect.right + 20;
            top = rect.top + (rect.height / 2) - (tooltipHeight / 2);
          }
          // Check if there's space to the left
          else if (rect.left - tooltipWidth - 20 > 0) {
            left = rect.left - tooltipWidth - 20;
            top = rect.top + (rect.height / 2) - (tooltipHeight / 2);
          }
          // Check if there's space above
          else if (rect.top - tooltipHeight - 20 > 0) {
            left = rect.left + (rect.width / 2) - (tooltipWidth / 2);
            top = rect.top - tooltipHeight - 20;
          }
          // Default to below
          else {
            left = rect.left + (rect.width / 2) - (tooltipWidth / 2);
            top = rect.bottom + 20;
          }
        }
        
        // Keep within viewport
        left = Math.max(20, Math.min(left, window.innerWidth - tooltipWidth - 20));
        top = Math.max(20, Math.min(top, window.innerHeight - tooltipHeight - 20));
        
        stepEl.style.left = left + 'px';
        stepEl.style.top = top + 'px';
      }, 0);

      // Highlight target with better visibility
      target.style.outline = '4px solid #2ab0ff';
      target.style.outlineOffset = '4px';
      target.style.boxShadow = '0 0 25px rgba(42, 176, 255, 0.6), inset 0 0 10px rgba(42, 176, 255, 0.1)';
      target.style.zIndex = '10000';
      target.style.position = 'relative';
      target.style.backgroundColor = 'rgba(42, 176, 255, 0.05)';
      target.style.borderRadius = '4px';
    }

    function nextOnboardingStep() {
      // Remove highlight from current target
      if (currentStep < onboardingSteps.length) {
        var currentTarget = document.querySelector(onboardingSteps[currentStep].target);
        if (currentTarget) {
          currentTarget.style.outline = '';
          currentTarget.style.outlineOffset = '';
          currentTarget.style.boxShadow = '';
          currentTarget.style.zIndex = '';
          currentTarget.style.position = '';
          currentTarget.style.backgroundColor = '';
          currentTarget.style.borderRadius = '';
        }
      }
      
      currentStep++;
      showOnboardingStep(currentStep);
    }

    function pauseOnboarding() {
      // Hide the tooltip but keep highlights
      var overlay = document.getElementById('onboardingOverlay');
      overlay.style.display = 'none';
      
      // Show resume button
      var resumeBtn = document.createElement('div');
      resumeBtn.id = 'resumeOnboarding';
      resumeBtn.innerHTML = `
        <div style="position: fixed; top: 20px; right: 20px; z-index: 10003; background: #2ab0ff; color: white; padding: 12px 20px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
          ‚ñ∂Ô∏è Forts√¶t rundtur
        </div>
      `;
      resumeBtn.onclick = function() {
        document.getElementById('resumeOnboarding').remove();
        overlay.style.display = 'block';
      };
      document.body.appendChild(resumeBtn);
    }

    function skipOnboarding() {
      finishOnboarding();
    }

    function finishOnboarding() {
      // Remove all highlights
      onboardingSteps.forEach(function(step) {
        var target = document.querySelector(step.target);
        if (target) {
          target.style.outline = '';
          target.style.outlineOffset = '';
          target.style.boxShadow = '';
          target.style.zIndex = '';
          target.style.position = '';
          target.style.backgroundColor = '';
          target.style.borderRadius = '';
        }
      });

      // Remove resume button if it exists
      var resumeBtn = document.getElementById('resumeOnboarding');
      if (resumeBtn) {
        resumeBtn.remove();
      }

      document.getElementById('onboardingOverlay').style.display = 'none';
      onboardingActive = false;
      localStorage.setItem('onboarding_completed', 'true');
    }

    function startOnboarding() {
      document.getElementById('onboardingWelcome').style.display = 'none';
      currentStep = 0;
      onboardingActive = true;
      showOnboardingStep(0);
    }

    function showQuickStart() {
      document.getElementById('quickStart').style.display = 'block';
      
      // Update completed tasks indicators
      var completedTasks = JSON.parse(localStorage.getItem('completed_tasks') || '[]');
      ['ganglys', 'doorlight', 'bathroom'].forEach(function(taskId) {
        var taskEl = document.getElementById('task-' + taskId);
        if (taskEl) {
          var completedEl = taskEl.querySelector('.task-completed');
          if (completedEl) {
            completedEl.style.display = completedTasks.includes(taskId) ? 'inline' : 'none';
          }
        }
      });
    }

    function closeQuickStart() {
      document.getElementById('quickStart').style.display = 'none';
    }

    // Task validation system
    var activeTask = null;
    var taskCriteria = {
      'ganglys': {
        name: 'Ganglys Basic',
        steps: [
          'G√• til "Z-Wave sensorer" sektionen',
          'V√¶lg "PIR (bev√¶gelse)" fra dropdown',
          'S√¶t v√¶rdi til "Breached"',
          'Klik "S√¶t (buffer)"',
          'Klik "Aktiv√©r √¶ndringer"',
          'G√• til "Regler" sektionen',
          'V√¶lg "IF PIR bliver Breached" som trigger',
          'V√¶lg "THEN Lys ‚Üí T√¶nd" som action',
          'Klik "Tilf√∏j regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'PIR er aktiveret (Breached + Aktiver √¶ndringer)', check: function() { 
            return window.state && window.state.motion === true; 
          }},
          { id: 'rule', text: 'Regel er oprettet', check: function() { 
            return window.state && window.state.rules && window.state.rules.length > 0; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (PIR bliver Breached)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ return r.trigger === 'motionBreached'; }); 
          }},
          { id: 'action', text: 'Handling er korrekt (lightOn)', check: function() { 
            return window.state && window.state.rules && window.state.rules.length > 0 && 
                   window.state.rules.some(r => r.action1 === 'lightOn'); 
          }}
        ]
      },
      'doorlight': {
        name: 'D√∏rlys med tidsbegr√¶nsning',
        steps: [
          'G√• til "Z-Wave sensorer" sektionen',
          'V√¶lg "D√∏r-/vindueskontakt" fra dropdown',
          'S√¶t v√¶rdi til "Opened"',
          'Klik "S√¶t (buffer)"',
          'Klik "Aktiv√©r √¶ndringer"',
          'G√• til "Regler" sektionen',
          'V√¶lg "IF D√∏rkontakt √¶ndres til Opened" som trigger',
          'Tilf√∏j AND: "Tid mellem" med "22:00-06:00"',
          'V√¶lg "THEN Lys ‚Üí T√¶nd" som action',
          'Klik "Tilf√∏j regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'D√∏rkontakt er aktiveret (Opened + Aktiver √¶ndringer)', check: function() { 
            return window.state && window.state.door === true; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (IF D√∏rkontakt √¶ndres til Opened)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ return r.trigger === 'doorOpened'; }); 
          }},
          { id: 'timer', text: 'Tidsbetingelse tilf√∏jet (AND: Tid mellem 22:00-06:00)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'doorOpened' && r.cond1 === 'timeBetween' && r.cond1Value && r.cond1Value.includes('22:00') && r.cond1Value.includes('06:00'); 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Lys ‚Üí T√¶nd)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'doorOpened' && r.action1 === 'lightOn'; 
            }); 
          }}
        ]
      },
      'bathroom': {
        name: 'Badventilator med fugtighed',
        steps: [
          'G√• til "Z-Wave sensorer" sektionen',
          'V√¶lg "Fugtighed (%)" fra dropdown',
          'S√¶t v√¶rdi til 75',
          'Klik "S√¶t (buffer)"',
          'Klik "Aktiv√©r √¶ndringer"',
          'G√• til "Regler" sektionen',
          'V√¶lg "IF Fugtighed ‚â• (v√¶rdi)" som trigger med v√¶rdi 75',
          'Tilf√∏j AND: "Lys (lux) <" med v√¶rdi 50',
          'V√¶lg "THEN Ventilator ‚Üí On" som action',
          'Klik "Tilf√∏j regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'Fugtighed er sat til 75%', check: function() { 
            return window.state && window.state.humidity >= 75; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (IF Fugtighed ‚â• 75)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityAbove' && r.triggerValue && parseFloat(r.triggerValue) >= 75; 
            }); 
          }},
          { id: 'condition', text: 'Betingelse tilf√∏jet (AND: Lys (lux) < 50)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityAbove' && r.cond1 === 'luxBelow' && r.cond1Value && parseFloat(r.cond1Value) <= 50; 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Ventilator ‚Üí On)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityAbove' && r.action1 === 'fanOn'; 
            }); 
          }}
        ]
      },
      'security': {
        name: 'Sikkerhedsalarm',
        steps: [
          'G√• til "Z-Wave sensorer" sektionen',
          'V√¶lg "PIR (bev√¶gelse)" fra dropdown og s√¶t til "Breached"',
          'V√¶lg "D√∏r-/vindueskontakt" fra dropdown og s√¶t til "Closed"',
          'Klik "S√¶t (buffer)" for begge sensorer',
          'Klik "Aktiv√©r √¶ndringer"',
          'G√• til "Regler" sektionen',
          'V√¶lg "IF PIR bliver Breached" som trigger',
          'Tilf√∏j AND: "D√∏rkontakt = Closed"',
          'Tilf√∏j AND: "Tid mellem" med "22:00-06:00"',
          'V√¶lg "THEN Push (log)" som action',
          'Klik "Tilf√∏j regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'PIR er Breached og d√∏rkontakt er Closed', check: function() { 
            return window.state && window.state.motion === true && window.state.door === false; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (IF PIR bliver Breached)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ return r.trigger === 'motionBreached'; }); 
          }},
          { id: 'condition1', text: 'Betingelse 1 tilf√∏jet (AND: D√∏rkontakt = Closed)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'motionBreached' && r.cond1 === 'doorClosed'; 
            }); 
          }},
          { id: 'condition2', text: 'Betingelse 2 tilf√∏jet (AND: Tid mellem 22:00-06:00)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'motionBreached' && r.cond2 === 'timeBetween' && r.cond2Value && r.cond2Value.includes('22:00') && r.cond2Value.includes('06:00'); 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Push log)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'motionBreached' && r.action1 === 'push'; 
            }); 
          }}
        ]
      },
      'energy': {
        name: 'Energibesparende lys',
        steps: [
          'G√• til "Z-Wave sensorer" sektionen',
          'V√¶lg "PIR (bev√¶gelse)" fra dropdown og s√¶t til "Safe"',
          'V√¶lg "Lys (lux)" fra dropdown og s√¶t til 800',
          'Klik "S√¶t (buffer)" for begge sensorer',
          'Klik "Aktiv√©r √¶ndringer"',
          'G√• til "Regler" sektionen',
          'V√¶lg "IF PIR bliver Safe" som trigger',
          'Tilf√∏j AND: "Lys (lux) >" med v√¶rdi 500',
          'Tilf√∏j AND: "Tid mellem" med "08:00-18:00"',
          'V√¶lg "THEN Lys ‚Üí Off" som action',
          'Klik "Tilf√∏j regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'PIR er Safe og lys er 800 lux', check: function() { 
            return window.state && window.state.motion === false && window.state.lux >= 800; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (IF PIR bliver Safe)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ return r.trigger === 'motionSafe'; }); 
          }},
          { id: 'condition1', text: 'Betingelse 1 tilf√∏jet (AND: Lys (lux) > 500)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'motionSafe' && r.cond1 === 'luxAbove' && r.cond1Value && parseFloat(r.cond1Value) >= 500; 
            }); 
          }},
          { id: 'condition2', text: 'Betingelse 2 tilf√∏jet (AND: Tid mellem 08:00-18:00)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'motionSafe' && r.cond2 === 'timeBetween' && r.cond2Value && r.cond2Value.includes('08:00') && r.cond2Value.includes('18:00'); 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Lys ‚Üí Off)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'motionSafe' && r.action1 === 'lightOff'; 
            }); 
          }}
        ]
      },
      'comfort': {
        name: 'Komfortstyring',
        steps: [
          'G√• til "Z-Wave sensorer" sektionen',
          'V√¶lg "Fugtighed (%)" fra dropdown og s√¶t til 40',
          'V√¶lg "Lys (lux)" fra dropdown og s√¶t til 200',
          'Klik "S√¶t (buffer)" for begge sensorer',
          'Klik "Aktiv√©r √¶ndringer"',
          'G√• til "Regler" sektionen',
          'V√¶lg "IF Fugtighed < (v√¶rdi)" som trigger med v√¶rdi 45',
          'Tilf√∏j AND: "Lys (lux) <" med v√¶rdi 300',
          'V√¶lg "THEN D√¶mper ‚Üí 30%" som action',
          'Klik "Tilf√∏j regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'Fugtighed er 40% og lys er 200 lux', check: function() { 
            return window.state && window.state.humidity <= 40 && window.state.lux <= 200; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (IF Fugtighed < 45)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityBelow' && r.triggerValue && parseFloat(r.triggerValue) <= 45; 
            }); 
          }},
          { id: 'condition', text: 'Betingelse tilf√∏jet (AND: Lys (lux) < 300)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityBelow' && r.cond1 === 'luxBelow' && r.cond1Value && parseFloat(r.cond1Value) <= 300; 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN D√¶mper ‚Üí 30%)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityBelow' && r.action1 === 'dim30'; 
            }); 
          }}
        ]
      },
      'schedule': {
        name: 'Tidsbaseret automation',
        steps: [
          'G√• til "Regler" sektionen',
          'V√¶lg "IF Time = hh:mm" som trigger med v√¶rdi "07:00"',
          'Tilf√∏j AND: "Ugedag i" med v√¶rdi "1-5" (mandag-fredag)',
          'V√¶lg "THEN Lys ‚Üí T√¶nd" som action',
          'Klik "Tilf√∏j regel"'
        ],
        criteria: [
          { id: 'trigger', text: 'Trigger er korrekt (IF Time = 07:00)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'timeEquals' && r.triggerValue === '07:00'; 
            }); 
          }},
          { id: 'condition', text: 'Betingelse tilf√∏jet (AND: Ugedag i 1-5)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'timeEquals' && r.cond1 === 'weekdayIn' && r.cond1Value === '1-5'; 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Lys ‚Üí T√¶nd)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'timeEquals' && r.action1 === 'lightOn'; 
            }); 
          }}
        ]
      },
      'ventilation': {
        name: 'Intelligent ventilation',
        steps: [
          'G√• til "Z-Wave sensorer" sektionen',
          'V√¶lg "Fugtighed (%)" fra dropdown og s√¶t til 80',
          'V√¶lg "Vind (m/s)" fra dropdown og s√¶t til 15',
          'Klik "S√¶t (buffer)" for begge sensorer',
          'Klik "Aktiv√©r √¶ndringer"',
          'G√• til "Regler" sektionen',
          'V√¶lg "IF Fugtighed ‚â• (v√¶rdi)" som trigger med v√¶rdi 70',
          'Tilf√∏j AND: "Vind <" med v√¶rdi 20',
          'V√¶lg "THEN Ventilator ‚Üí On" som action',
          'Klik "Tilf√∏j regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'Fugtighed er 80% og vind er 15 km/t', check: function() { 
            return window.state && window.state.humidity >= 80 && window.state.wind <= 15; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (IF Fugtighed ‚â• 70)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityAbove' && r.triggerValue && parseFloat(r.triggerValue) >= 70; 
            }); 
          }},
          { id: 'condition', text: 'Betingelse tilf√∏jet (AND: Vind < 20)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityAbove' && r.cond1 === 'windBelow' && r.cond1Value && parseFloat(r.cond1Value) <= 20; 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Ventilator ‚Üí On)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'humidityAbove' && r.action1 === 'fanOn'; 
            }); 
          }}
        ]
      },
      'alarm': {
        name: 'Alarm system',
        steps: [
          'G√• til "Z-Wave sensorer" sektionen',
          'V√¶lg "D√∏r-/vindueskontakt" fra dropdown og s√¶t til "Opened"',
          'V√¶lg "PIR (bev√¶gelse)" fra dropdown og s√¶t til "Breached"',
          'Klik "S√¶t (buffer)" for begge sensorer',
          'Klik "Aktiv√©r √¶ndringer"',
          'G√• til "Regler" sektionen',
          'V√¶lg "IF D√∏rkontakt √¶ndres til Opened" som trigger',
          'Tilf√∏j AND: "PIR = Breached"',
          'Tilf√∏j AND: "Alarm = Armed"',
          'V√¶lg "THEN Push (log)" som action',
          'Klik "Tilf√∏j regel"'
        ],
        criteria: [
          { id: 'sensor', text: 'D√∏rkontakt er Opened og PIR er Breached', check: function() { 
            return window.state && window.state.door === true && window.state.motion === true; 
          }},
          { id: 'trigger', text: 'Trigger er korrekt (IF D√∏rkontakt √¶ndres til Opened)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ return r.trigger === 'doorOpened'; }); 
          }},
          { id: 'condition1', text: 'Betingelse 1 tilf√∏jet (AND: PIR = Breached)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'doorOpened' && r.cond1 === 'motionBreached'; 
            }); 
          }},
          { id: 'condition2', text: 'Betingelse 2 tilf√∏jet (AND: Alarm = Armed)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'doorOpened' && r.cond2 === 'alarmArmed'; 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Push log)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'doorOpened' && r.action1 === 'push'; 
            }); 
          }}
        ]
      },
      'global': {
        name: 'Global variabel styring',
        steps: [
          'G√• til "Regler" sektionen',
          'V√¶lg "IF Global name=value" som trigger med v√¶rdi "mode=away"',
          'V√¶lg "THEN Set Global" som action med v√¶rdi "lights=off"',
          'Klik "Tilf√∏j regel"'
        ],
        criteria: [
          { id: 'trigger', text: 'Trigger er korrekt (IF Global mode=away)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'globalEqTrig' && r.triggerValue === 'mode=away'; 
            }); 
          }},
          { id: 'action', text: 'Handling er korrekt (THEN Set Global lights=off)', check: function() { 
            return window.state && window.state.rules && window.state.rules.some(function(r){ 
              return r.trigger === 'globalEqTrig' && r.action1 === 'setGlobal' && r.action1Value === 'lights=off'; 
            }); 
          }}
        ]
      }
    };

    function startTask(taskType) {
      closeQuickStart();
      activeTask = taskType;
      
      // Show task validation panel
      showTaskValidation(taskType);
      
      // Switch to simulator view to start the task
      document.querySelector('[data-target="view-sim"]').click();
      
      log('Opgave startet: ' + taskCriteria[taskType].name + ' - F√∏lg trinene i valideringspanelet!');
    }

    function showTaskValidation(taskType) {
      var task = taskCriteria[taskType];
      if (!task) return;

      var validationEl = document.getElementById('taskValidation');
      var nameEl = document.getElementById('taskName');
      var criteriaEl = document.getElementById('taskCriteria');
      
      // Reset state
      validationEl.classList.remove('success');
      validationEl.classList.add('active');
      document.getElementById('taskProgress').style.display = 'block';
      document.getElementById('taskSuccess').style.display = 'none';
      
      // Set task name
      nameEl.textContent = task.name;
      
      // Build criteria list
      criteriaEl.innerHTML = '';
      task.criteria.forEach(function(criterion) {
        var li = document.createElement('li');
        li.id = 'criterion-' + criterion.id;
        li.textContent = criterion.text;
        criteriaEl.appendChild(li);
      });
      
      // Build steps list
      var stepsEl = document.getElementById('taskSteps');
      stepsEl.innerHTML = '';
      if (task.steps) {
        task.steps.forEach(function(step) {
          var li = document.createElement('li');
          li.textContent = step;
          stepsEl.appendChild(li);
        });
      }
      
      // Show panel
      validationEl.style.display = 'block';
      
      // Load help preference
      loadHelpPreference();
      
      // Start validation loop
      if (window.taskValidationInterval) {
        clearInterval(window.taskValidationInterval);
      }
      window.taskValidationInterval = setInterval(validateTask, 500);
    }

    function validateTask() {
      if (!activeTask) return;
      
      var task = taskCriteria[activeTask];
      if (!task) return;
      
      var completed = 0;
      var total = task.criteria.length;
      
      task.criteria.forEach(function(criterion) {
        var li = document.getElementById('criterion-' + criterion.id);
        if (criterion.check()) {
          li.classList.add('completed');
          completed++;
        } else {
          li.classList.remove('completed');
        }
      });
      
      // Update progress bar
      var progress = (completed / total) * 100;
      document.getElementById('taskProgressBar').style.width = progress + '%';
      
      // Check if task is complete
      if (completed === total) {
        completeTask();
      }
    }

    function completeTask() {
      var validationEl = document.getElementById('taskValidation');
      validationEl.classList.remove('active');
      validationEl.classList.add('success');
      
      document.getElementById('taskProgress').style.display = 'none';
      document.getElementById('taskSuccess').style.display = 'block';
      
      // Stop validation loop
      if (window.taskValidationInterval) {
        clearInterval(window.taskValidationInterval);
      }
      
      // Log success
      log('üéâ Opgave fuldf√∏rt: ' + taskCriteria[activeTask].name + '!');
      
      // Store completion in localStorage
      var completedTasks = JSON.parse(localStorage.getItem('completed_tasks') || '[]');
      if (!completedTasks.includes(activeTask)) {
        completedTasks.push(activeTask);
        localStorage.setItem('completed_tasks', JSON.stringify(completedTasks));
      }
      
      console.log('Opgave fuldf√∏rt:', taskCriteria[activeTask].name);
      
      // Gem progress i cloud database
      console.log('üîç Fors√∏ger at gemme progress...');
      const currentUser = getCurrentUser();
      console.log('üîç Current user:', currentUser);
      
               if (currentUser) {
           console.log('üîç Bruger fundet, kalder saveUserProgress...');
           const completedAt = new Date().toLocaleDateString('da-DK') + ' ' + new Date().toLocaleTimeString('da-DK');
           console.log('üîç Data til Firebase:', { userId: currentUser.id, taskId: activeTask, taskName: taskCriteria[activeTask].name, completedAt });
           saveUserProgress(currentUser.id, activeTask, taskCriteria[activeTask].name, completedAt, currentUser);
         } else {
        console.log('‚ùå Ingen bruger fundet - kan ikke gemme progress');
      }
    }

    function closeTaskValidation() {
      document.getElementById('taskValidation').style.display = 'none';
      if (window.taskValidationInterval) {
        clearInterval(window.taskValidationInterval);
      }
      activeTask = null;
    }

    // Toggle help steps visibility
    var helpVisible = false;
    function toggleTaskHelp() {
      helpVisible = !helpVisible;
      var stepsEl = document.getElementById('taskSteps').parentNode;
      var toggleBtn = document.querySelector('.help-toggle-btn');
      
      if (helpVisible) {
        stepsEl.style.display = 'block';
        toggleBtn.classList.add('active');
        toggleBtn.title = 'Skjul hj√¶lp-trin';
      } else {
        stepsEl.style.display = 'none';
        toggleBtn.classList.remove('active');
        toggleBtn.title = 'Vis hj√¶lp-trin';
      }
      
      // Gem pr√¶ference
      localStorage.setItem('task_help_visible', helpVisible);
    }

    // Indl√¶s gemt pr√¶ference
    function loadHelpPreference() {
      var saved = localStorage.getItem('task_help_visible');
      if (saved !== null) {
        // Brug gemt pr√¶ference
        helpVisible = saved === 'true';
      } else {
        // Standard: hj√¶lp er skjult
        helpVisible = false;
      }
      
      // Juster UI til aktuel tilstand
      var stepsEl = document.getElementById('taskSteps').parentNode;
      var toggleBtn = document.querySelector('.help-toggle-btn');
      
      if (helpVisible) {
        stepsEl.style.display = 'block';
        toggleBtn.classList.add('active');
        toggleBtn.title = 'Skjul hj√¶lp-trin';
      } else {
        stepsEl.style.display = 'none';
        toggleBtn.classList.remove('active');
        toggleBtn.title = 'Vis hj√¶lp-trin';
      }
    }

    // Make functions globally available
    window.skipOnboarding = skipOnboarding;
    window.startOnboarding = startOnboarding;
    window.nextOnboardingStep = nextOnboardingStep;
    window.pauseOnboarding = pauseOnboarding;
    window.showQuickStart = showQuickStart;
    window.closeQuickStart = closeQuickStart;
    window.startTask = startTask;
    window.closeTaskValidation = closeTaskValidation;
    window.toggleTaskHelp = toggleTaskHelp;
    
    // Make variables globally available
    window.activeTask = activeTask;
    window.taskCriteria = taskCriteria;
    window.getCurrentUser = getCurrentUser;

    // Check if first time user
    if (!localStorage.getItem('onboarding_completed')) {
      setTimeout(function() {
        document.getElementById('onboardingWelcome').style.display = 'block';
      }, 1000);
    }
  })();


  // === WIRESHEET MVP ===
  (function(){
    var canvas = document.getElementById('wsCanvas');
    if(!canvas) return; // not on this page
    var svg = document.getElementById('wsWires');
    var nodesHost = document.getElementById('wsNodes');

    var WS = {
      seq: 1,
      nodes: {}, // id -> {id,type,subtype,value,x,y,label}
      edges: [],  // {from, to, toPort}
      counters: {trig:1, cond:1, act:1, rule:1}
    };
    function nid(){ return 'n'+(WS.seq++); }

    // --- Helpers
    function createEl(tag, attrs, parent){
      var el = document.createElement(tag);
      if(attrs){ Object.keys(attrs).forEach(function(k){ if(k==='class'){ el.className=attrs[k]; } else if(k==='text'){ el.textContent=attrs[k]; } else { el.setAttribute(k, attrs[k]); } }); }
      if(parent) parent.appendChild(el);
      return el;
    }
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    // Options
    var TRIG_OPTS = [
      ['always','Ved aktivering'],
      ['motionBreached','PIR ‚Üí Breached'],
      ['motionSafe','PIR ‚Üí Safe'],
      ['doorOpened','D√∏r ‚Üí Opened'],
      ['timeEquals','Time = hh:mm'],
      ['humidityAbove','Fugt ‚â•'],
      ['globalEqTrig','Global name=value'],
      ['sensorEqTrig','Sensor =='],
      ['sensorGtTrig','Sensor >'],
      ['sensorLtTrig','Sensor <'],
      ['sensorGeTrig','Sensor ‚â•'],
      ['sensorLeTrig','Sensor ‚â§']
    ];
    var COND_OPTS = [
      ['','(ingen)'],
      ['luxBelow','Lys <'],['luxAbove','Lys >'],
      ['humAbove','Fugt ‚â•'],['humBelow','Fugt ‚â§'],
      ['windBelow','Vind <'],['weekdayIn','Ugedag i'],
      ['alarmArmed','Alarm = Armed'],['alarmHome','Home Mode'],
              ['globalEq','Global name=value'],
      ['sensorEq','Sensor =='],['sensorNe','Sensor ‚â†'],
      ['sensorGt','Sensor >'],['sensorLt','Sensor <'],
      ['sensorGe','Sensor ‚â•'],['sensorLe','Sensor ‚â§'],
      ['sensorContains','Sensor contains'],['timeBetween','Tid mellem']
    ];
    var ACT_OPTS = [
      ['lightOn','Lys ‚Üí On'],['lightOff','Lys ‚Üí Off'],
      ['dim30','D√¶mper ‚Üí 30%'],['dim100','D√¶mper ‚Üí 100%'],
      ['fanOn','Fan ‚Üí On'],['fanOff','Fan ‚Üí Off'],
      ['push','Push (log)'],['setGlobal','Set Global'],['delayLightOff','Delay‚ÜíLightOff']
    ];
    function phTrigger(k){
      return {'always':'','timeEquals':'hh:mm (07:30)','humidityAbove':'tal (65)',
        'globalEqTrig':'navn=v√¶rdi','sensorEqTrig':'sensor.xx=val',
        'sensorGtTrig':'sensor.xx=21','sensorLtTrig':'sensor.xx=21','sensorGeTrig':'sensor.xx=21','sensorLeTrig':'sensor.xx=21'}[k]||'';
    }
    function phCond(k){
      return {'luxBelow':'tal','luxAbove':'tal','humAbove':'procent','humBelow':'procent','windBelow':'tal',
        'weekdayIn':'Mon,Fri','globalEq':'name=value','sensorEq':'name=value','sensorNe':'name=value',
        'sensorGt':'name=tal','sensorLt':'name=tal','sensorGe':'name=tal','sensorLe':'name=tal',
        'sensorContains':'name=del','timeBetween':'HH:MM-HH:MM'}[k]||'';
    }
    function phAct(k){
      return {'push':'besked','setGlobal':'name=value','delayLightOff':'sekunder'}[k]||'';
    }

    // --- Rendering
    function renderAll(){
      nodesHost.innerHTML='';
      Object.values(WS.nodes).forEach(renderNode);
      renderWires();
      updateLinkLabels();
    }
    function renderNode(n){
      var box = createEl('div', {class:'ws-node '+(n.type==='trig'?'trig':n.type==='cond'?'cond':n.type==='act'?'act':'rule')}, nodesHost);
      box.style.left = (n.x||40)+'px';
      box.style.top  = (n.y||40)+'px';
      box.dataset.id = n.id;

      var head = createEl('div',{class:'ws-head'},box);
      var idEl = createEl('div',{class:'ws-id',text:(n.label||'')},head);
      createEl('div',{class:'type',text:
        n.type==='trig'?'Trigger': n.type==='cond'?'AND': n.type==='act'?'Action':'Rule'
      },head);
      var moveBtn = createEl('button',{class:'ws-btn',text:'Flyt'},head);
      var delBtn  = createEl('button',{class:'ws-btn',text:'Slet'},head);

      var body = createEl('div',{class:'ws-body'},box);
      if(n.type!=='rule'){
        var s = createEl('select',{},body);
        var opts = n.type==='trig'?TRIG_OPTS: n.type==='cond'?COND_OPTS: ACT_OPTS;
        opts.forEach(function(p){ var o=createEl('option',{value:p[0],text:p[1]}); s.appendChild(o); });
        if(n.subtype){ s.value=n.subtype; }
        s.onchange = function(){ n.subtype = this.value; v.placeholder = n.type==='trig'?phTrigger(n.subtype): n.type==='cond'?phCond(n.subtype): phAct(n.subtype); preview(); };

        var v = createEl('input',{type:'text', value:(n.value||''), placeholder: n.type==='trig'?phTrigger(n.subtype): n.type==='cond'?phCond(n.subtype): phAct(n.subtype)}, body);
        v.oninput = function(){ n.value=this.value; preview(); };
      } else {
        // Rule node: input ports summary + preview
        createEl('div',{class:'port-row'}, body).innerHTML = '<span class="port in" data-slot="trigger" title="Trigger in"></span><span class="port-label">Trigger</span>';
        createEl('div',{class:'port-row'}, body).innerHTML = '<span class="port in" data-slot="cond1" title="AND #1 in"></span><span class="port-label">AND #1</span>';
        createEl('div',{class:'port-row'}, body).innerHTML = '<span class="port in" data-slot="cond2" title="AND #2 in"></span><span class="port-label">AND #2</span>';
        createEl('div',{class:'port-row'}, body).innerHTML = '<span class="port in" data-slot="actions" title="Actions in (flere tilladt)"></span><span class="port-label">Actions</span>';
        var name = createEl('input',{type:'text', placeholder:'Regelnavn (valgfri)', value:(n.value||'')}, body);
        name.oninput = function(){ n.value = this.value; preview(); };
        var pv = createEl('div',{class:'ws-preview'}, body); pv.dataset.previewFor=n.id;
      }
      var foot = createEl('div',{class:'ws-foot'},box);
      if(n.type!=='rule'){ createEl('div',{class:'port out',title:'Output (klik for at starte forbindelse)'}, foot); }
      var linkInfo = createEl('div',{class:'ws-links'}, box);
      // events
      delBtn.onclick = function(){
        // remove node + edges
        delete WS.nodes[n.id];
        WS.edges = WS.edges.filter(function(e){ return e.from!==n.id && e.to!==n.id; });
        renderAll(); updateLinkLabels();
      };
      // drag
      (function(){
        var dragging=false, sx=0, sy=0, bx=0, by=0;
        function mdown(ev){
          dragging=true; box.classList.add('dragging');
          sx=ev.clientX; sy=ev.clientY;
          bx=parseInt(box.style.left,10)||0; by=parseInt(box.style.top,10)||0;
          document.addEventListener('mousemove', mmove);
          document.addEventListener('mouseup', mup);
          ev.preventDefault();
        }
        function mmove(ev){
          if(!dragging) return;
          var nx = bx + (ev.clientX - sx);
          var ny = by + (ev.clientY - sy);
          nx = clamp(nx, 0, canvas.clientWidth - box.offsetWidth);
          ny = clamp(ny, 0, canvas.clientHeight - box.offsetHeight);
          box.style.left = nx+'px';
          box.style.top  = ny+'px';
          n.x = nx; n.y = ny;
          renderWires();
        }
        function mup(){
          dragging=false; box.classList.remove('dragging');
          document.removeEventListener('mousemove', mmove);
          document.removeEventListener('mouseup', mup);
        }
        moveBtn.addEventListener('mousedown', mdown);
        head.addEventListener('mousedown', function(e){ if(e.target===head) mdown(e); });
      })();

      // linking
      if(n.type!=='rule'){
        var out = foot.querySelector('.port.out');
        out.addEventListener('click', function(){
          linking.from = n.id;
          linking.active = true;
          window.log('Wires: v√¶lg en Rule-in port for at forbinde.');
        });
      } else {
        body.querySelectorAll('.port.in').forEach(function(pin){
          pin.addEventListener('click', function(){
            if(!linking.active || !linking.from) return;
            var toPort = pin.getAttribute('data-slot')||'';
            if(!allowEdge(linking.from, n.id, toPort)) { window.log('Ugyldig forbindelse.'); return; }
            // enforce capacity on trigger/cond1/cond2 (1 each)
            if(['trigger','cond1','cond2'].includes(toPort)){
              WS.edges = WS.edges.filter(function(e){ return !(e.to===n.id && e.toPort===toPort); });
            }
            WS.edges.push({from: linking.from, to: n.id, toPort: toPort});
            linking.active=false; linking.from=null;
            renderWires(); updateLinkLabels(); preview();
          });
        });
      }
    }

    function getPortCenter(nodeId, portSel){
      var card = nodesHost.querySelector('.ws-node[data-id="'+nodeId+'"]');
      if(!card) return {x:0,y:0};
      var el = portSel==='out' ? card.querySelector('.port.out') : card.querySelector('.port.in[data-slot="'+portSel+'"]');
      if(!el) return {x:0,y:0};
      var r1 = canvas.getBoundingClientRect();
      var r2 = el.getBoundingClientRect();
      return { x: r2.left - r1.left + r2.width/2, y: r2.top - r1.top + r2.height/2 };
    }
    
    function updateLinkLabels(){
      // For each node, compute link text
      Object.values(WS.nodes).forEach(function(n){
        var card = nodesHost.querySelector('.ws-node[data-id="'+n.id+'"]');
        if(!card) return;
        var footInfo = card.querySelector('.ws-links');
        if(!footInfo) return;
        function lbl(nodeId){
          var nn = WS.nodes[nodeId]; return nn ? (nn.label||nodeId) : nodeId;
        }
        if(n.type!=='rule'){
          var outs = WS.edges.filter(function(e){ return e.from===n.id; });
          if(outs.length===0){ footInfo.textContent = 'Ikke linket'; return; }
          var parts = outs.map(function(e){ return '‚Üí '+lbl(e.to)+' ('+e.toPort+')'; });
          footInfo.textContent = parts.join('  ‚Ä¢  ');
        } else {
          // incoming per port
          var t = WS.edges.filter(function(e){ return e.to===n.id && e.toPort==='trigger'; }).map(function(e){return lbl(e.from);}).join(',');
          var c1= WS.edges.filter(function(e){ return e.to===n.id && e.toPort==='cond1'; }).map(function(e){return lbl(e.from);}).join(',');
          var c2= WS.edges.filter(function(e){ return e.to===n.id && e.toPort==='cond2'; }).map(function(e){return lbl(e.from);}).join(',');
          var a = WS.edges.filter(function(e){ return e.to===n.id && e.toPort==='actions'; }).map(function(e){return lbl(e.from);}).join(',');
          footInfo.textContent = 'Trigger: '+(t||'‚Äî')+'   ‚Ä¢   AND #1: '+(c1||'‚Äî')+'   ‚Ä¢   AND #2: '+(c2||'‚Äî')+'   ‚Ä¢   Actions: '+(a||'‚Äî');
        }
      });
    }
function renderWires(){
      svg.innerHTML='';
      WS.edges.forEach(function(e){
        var a = getPortCenter(e.from, 'out');
        var b = getPortCenter(e.to, e.toPort);
        var path = createEl('path', { d: cubic(a.x,a.y,b.x,b.y), fill:'none', stroke:'#4f7db8', 'stroke-width':'2', 'stroke-linecap':'round' }, svg);
      });
    }
    function cubic(x1,y1,x2,y2){
      var dx = Math.max(40, Math.abs(x2-x1)/2);
      var c1x = x1 + dx, c1y = y1;
      var c2x = x2 - dx, c2y = y2;
      return 'M '+x1+' '+y1+' C '+c1x+' '+c1y+', '+c2x+' '+c2y+', '+x2+' '+y2;
    }

    var linking = {active:false, from:null};

    function allowEdge(fromId, toId, toPort){
      if(fromId===toId) return false;
      var src = WS.nodes[fromId], dst = WS.nodes[toId];
      if(!src || !dst) return false;
      if(dst.type!=='rule') return false; // only into rule nodes
      if(src.type==='trig' && toPort!=='trigger') return false;
      if(src.type==='cond' && !['cond1','cond2'].includes(toPort)) return false;
      if(src.type==='act'  && toPort!=='actions') return false;
      return true;
    }

    // --- Add nodes
    function addNode(kind, x, y){
      var n = { id:nid(), type:kind, subtype: (kind==='trig'?'always':''), value:'', x:x||40, y:y||40 };
      // assign short label
      var pref = kind==='trig'?'T': kind==='cond'?'C': kind==='act'?'A':'R';
      n.label = pref + (WS.counters[kind]++);
      WS.nodes[n.id]=n;
      renderAll(); updateLinkLabels();
      return n;
    }

    // Tool buttons
    var bTrig = document.getElementById('wsAddTrig');
    var bCond = document.getElementById('wsAddCond');
    var bAct  = document.getElementById('wsAddAct');
    var bRule = document.getElementById('wsAddRule');
    var bBuild= document.getElementById('wsBuild');
    var bClear= document.getElementById('wsClear');
    var bSave = document.getElementById('wsSave');
    var bLoad = document.getElementById('wsLoad');

    if(bTrig) bTrig.onclick = function(){ addNode('trig', 40, 60); };
    if(bCond) bCond.onclick = function(){ addNode('cond', 40, 180); };
    if(bAct)  bAct.onclick  = function(){ addNode('act',  40, 300); };
    if(bRule) bRule.onclick = function(){ addNode('rule', 520, 160); };

    if(bClear) bClear.onclick = function(){
      if(!confirm('Ryd alle noder og forbindelser?')) return;
      WS.nodes={}; WS.edges=[]; renderAll(); updateLinkLabels(); window.log('Wiresheet ryddet.');
    };

    if(bSave) bSave.onclick = function(){
      try{
        var obj = {version:'1.0', nodes:WS.nodes, edges:WS.edges, seq:WS.seq};
        localStorage.setItem('hc3_wiresheet_v1', JSON.stringify(obj));
        window.log('Wiresheet gemt lokalt.');
      }catch(e){ alert('Kunne ikke gemme: '+e.message); }
    };
    if(bLoad) bLoad.onclick = function(){
      try{
        var raw = localStorage.getItem('hc3_wiresheet_v1');
        if(!raw){ alert('Ingen wiresheet i localStorage.'); return; }
        var obj = JSON.parse(raw||'{}');
        WS.nodes = obj.nodes||{}; WS.edges = obj.edges||[]; WS.seq = obj.seq||1;
        renderAll(); updateLinkLabels(); preview();
        window.log('Wiresheet hentet.');
      }catch(e){ alert('Kunne ikke l√¶se: '+e.message); }
    };

    // --- Compile to rules
    function nodeById(id){ return WS.nodes[id]; }
    function incoming(toId, port){ return WS.edges.filter(function(e){ return e.to===toId && (!port || e.toPort===port); }); }

    function compileRule(ruleNode){
      // collect trigger
      var trigE = incoming(ruleNode.id,'trigger')[0];
      if(!trigE) return {ok:false, warn:'Mangler trigger'};
      var trigN = nodeById(trigE.from);
      var cond1E = incoming(ruleNode.id,'cond1')[0];
      var cond2E = incoming(ruleNode.id,'cond2')[0];
      var c1 = cond1E? nodeById(cond1E.from): null;
      var c2 = cond2E? nodeById(cond2E.from): null;
      var actsE = incoming(ruleNode.id,'actions');
      if(actsE.length===0) return {ok:false, warn:'Mangler mindst √©n action'};
      var acts = actsE.map(function(e){ return nodeById(e.from); });

      var base = {
        trigger: trigN.subtype||'always',
        triggerValue: (trigN.value||'').trim(),
        cond1: c1? (c1.subtype||'') : '',
        cond1Value: c1? (c1.value||'') : '',
        cond2: c2? (c2.subtype||'') : '',
        cond2Value: c2? (c2.value||'') : '',
        ruleName: (ruleNode.value||'').trim()
      };
      var outRules = acts.map(function(a){
        return Object.assign({}, base, { action1: a.subtype||'lightOn', action1Value: (a.value||'') });
      });
      return {ok:true, rules: outRules};
    }

    if(bBuild) bBuild.onclick = function(){
      var allRules = [];
      Object.values(WS.nodes).filter(function(n){ return n.type==='rule'; }).forEach(function(rn){
        var res = compileRule(rn);
        if(!res.ok){ window.log('Rule#'+rn.id+': '+res.warn); return; }
        res.rules.forEach(function(rr){ window.state.rules.push(rr); });
        allRules = allRules.concat(res.rules);
      });
      if(allRules.length>0){
        window.refreshRules();
        window.log('Wiresheet ‚Üí '+allRules.length+' regel/r lagt til.');
      } else {
        alert('Ingen gyldige Rule-noder at bygge.');
      }
    };

    // --- Preview strings under each Rule node
    function preview(){
      Object.values(WS.nodes).filter(function(n){ return n.type==='rule'; }).forEach(function(rn){
        var pv = nodesHost.querySelector('.ws-node[data-id="'+rn.id+'"] .ws-preview');
        if(!pv) return;
        var res = compileRule(rn);
        if(!res.ok){ pv.innerHTML = '<span class="ws-warn">‚ö† '+res.warn+'</span>'; return; }
        var lines = res.rules.map(function(rr){
          function label(opts,k){ var m=opts.find(function(x){return x[0]===k;}); return m?m[1]:k; }
          var t = label(TRIG_OPTS, rr.trigger) + (rr.triggerValue?(' '+rr.triggerValue):'');
          var c1 = rr.cond1? ' AND '+label(COND_OPTS, rr.cond1)+(rr.cond1Value?(' '+rr.cond1Value):'') : '';
          var c2 = rr.cond2? ' AND '+label(COND_OPTS, rr.cond2)+(rr.cond2Value?(' '+rr.cond2Value):'') : '';
          var a  = label(ACT_OPTS, rr.action1) + (rr.action1Value?(' '+rr.action1Value):'');
          return 'IF '+t+c1+c2+' THEN '+a + (rr.ruleName?('  ‚Ä¢ '+rr.ruleName):'');
        });
        pv.textContent = lines.join('\\n');
      });
    }

    // initial
    renderAll(); updateLinkLabels();
    // quick palette
    addNode('trig', 60, 60);
    addNode('cond', 60, 180);
    addNode('act',  60, 300);
    addNode('rule', 520, 160);
  })();
})();

  // === Login & credentials (localStorage) ===
  function getStoredCreds(){
    return { user: localStorage.getItem('simUser') || 'admin', pass: localStorage.getItem('simPass') || '1234' };
  }
  function tryLogin(u,p){ 
    // F√∏rst tjek registrerede brugere
    const users = JSON.parse(localStorage.getItem('ibi_users') || '[]');
    const registeredUser = users.find(user => user.username === u && user.password === p);
    
    if (registeredUser) {
      // Opdater lastLogin
      registeredUser.lastLogin = new Date().toISOString();
      const userIndex = users.findIndex(user => user.username === u);
      if (userIndex !== -1) {
        users[userIndex] = registeredUser;
        localStorage.setItem('ibi_users', JSON.stringify(users));
      }
      return true;
    }
    
    // Ellers tjek standard login
    const c=getStoredCreds(); 
    return (u===c.user && p===c.pass); 
  }
  function doLogin(){
    console.log('doLogin function called');
    const u=document.getElementById('loginUser').value.trim();
    const p=document.getElementById('loginPass').value.trim();
    console.log('Login attempt with user:', u, 'pass length:', p.length);
    
    if(tryLogin(u,p)){
      console.log('Login successful!');
      console.log('üîç Gemmer username i localStorage:', u);
      localStorage.setItem('simUser', u);
      localStorage.setItem('simPass', p);
      console.log('üîç localStorage simUser efter gem:', localStorage.getItem('simUser'));
      document.getElementById('loginView').style.display='none';
      document.getElementById('mainApp').style.display='block';
      document.querySelector('.appbar').style.display = 'block';
      if (typeof setTab==='function') setTab('sim');
    } else {
      console.log('Login failed!');
      document.getElementById('loginError').innerText='Forkert login!';
    }
  }
  function updateCreds(){
    const u=document.getElementById('setUser').value.trim();
    const p=document.getElementById('setPass').value.trim();
    if(u && p){
      localStorage.setItem('simUser', u);
      localStorage.setItem('simPass', p);
      alert('Login-info gemt. N√¶ste login bruger '+u+'/'+p);
      document.getElementById('setUser').value='';
      document.getElementById('setPass').value='';
    } else { alert('Udfyld b√•de brugernavn og adgangskode.'); }
  }
  function doLogout(){
    document.getElementById('mainApp').style.display='none';
    document.querySelector('.appbar').style.display = 'none';
    document.getElementById('loginView').style.display='flex';
    
    // Vis l√¶rer login knap igen og skjul dashboard knap
    document.getElementById('btnTeacherLogin').style.display = 'block';
    document.getElementById('btnTeacherTab').style.display = 'none';
    
    // Ryd l√¶rer login status
    localStorage.removeItem('teacher_logged_in');
    localStorage.removeItem('teacher_school_id');
    localStorage.removeItem('teacher_class_id');
    
    document.getElementById('loginUser').focus();
  }
  // === Login event setup ===
  function setupLoginEvents() {
    console.log('Setting up login events...');
    const btnLogin = document.getElementById('btnLogin');
    const lp = document.getElementById('loginPass');
    const btnSave = document.getElementById('btnSaveCreds');
    const btnLogout = document.getElementById('btnLogout');
    
    if(btnLogin) {
      console.log('Login button found, adding click handler');
      btnLogin.onclick = doLogin;
    } else {
      console.error('Login button not found!');
    }
    
    if(lp) {
      console.log('Password field found, adding Enter key handler');
      lp.addEventListener('keydown', e => { 
        if(e.key === 'Enter') {
          console.log('Enter pressed, attempting login');
          doLogin(); 
        }
      });
    } else {
      console.error('Password field not found!');
    }
    
    if(btnSave) btnSave.onclick = updateCreds;
    if(btnLogout) btnLogout.onclick = doLogout;
    
    // L√¶rer logout knap
    const btnTeacherLogout = document.getElementById('btnTeacherLogout');
    if(btnTeacherLogout) {
      btnTeacherLogout.onclick = doTeacherLogout;
    }
    
    // Brugerregistrering
    const btnRegister = document.getElementById('btnRegister');
    if(btnRegister) {
      btnRegister.onclick = showRegisterModal;
    }
    
    // Opret bruger knap
    const btnCreateUser = document.getElementById('btnCreateUser');
    if(btnCreateUser) {
      btnCreateUser.onclick = createUser;
    }
    
    // Gem elev navn knap
    const btnSaveName = document.getElementById('btnSaveName');
    if(btnSaveName) {
      btnSaveName.onclick = saveStudentName;
    }
    
    // L√¶rer login knap
    const btnTeacherLogin = document.getElementById('btnTeacherLogin');
    if(btnTeacherLogin) {
      btnTeacherLogin.onclick = showTeacherLoginModal;
    }
    
    // L√¶rer dashboard knap
    const btnTeacherTab = document.getElementById('btnTeacherTab');
    if(btnTeacherTab) {
      btnTeacherTab.onclick = () => {
        // Skjul alle normale faner
        document.querySelector('.tabs').style.display = 'none';
        
        // Skjul alle normale views
        document.querySelectorAll('.view').forEach(view => {
          if (view.id !== 'view-teacher') {
            view.style.display = 'none';
          }
        });
        
        // Vis kun l√¶rer dashboard
        document.getElementById('view-teacher').style.display = 'block';
        document.getElementById('view-teacher').classList.add('active');
        
        console.log('üîç Skiftet til separat l√¶rer dashboard side');
      };
    }
    
    // L√¶rer login submit knap
    const btnTeacherLoginSubmit = document.getElementById('btnTeacherLoginSubmit');
    if(btnTeacherLoginSubmit) {
      btnTeacherLoginSubmit.onclick = doTeacherLogin;
    }
    
    // L√¶rer dashboard knapper
    const btnLoadProgress = document.getElementById('btnLoadProgress');
    if(btnLoadProgress) {
      btnLoadProgress.onclick = loadTeacherProgress;
    }
    
    const btnExportCSV = document.getElementById('btnExportCSV');
    if(btnExportCSV) {
      btnExportCSV.onclick = () => exportClassData(
        localStorage.getItem('teacher_school_id') || 'default',
        localStorage.getItem('teacher_class_id') || 'default'
      );
    }
    

    

    

  }

  // === Elev navn funktionalitet ===
  function saveStudentName() {
    const firstName = document.getElementById('setFirstName').value.trim();
    const lastName = document.getElementById('setLastName').value.trim();
    const email = document.getElementById('setEmail').value.trim();
    
    if (!firstName || !lastName) {
      alert('Indtast venligst b√•de fornavn og efternavn');
      return;
    }
    
    // Gem i localStorage
    const studentName = {
      firstName: firstName,
      lastName: lastName,
      email: email || 'ingen@email.dk'
    };
    
    localStorage.setItem('student_name', JSON.stringify(studentName));
    
    // Opdater UI
    alert(`‚úÖ Dit navn er gemt: ${firstName} ${lastName}`);
    
    // Genindl√¶s navn i felterne
    loadStudentName();
  }
  
  function loadStudentName() {
    const studentName = JSON.parse(localStorage.getItem('student_name') || '{}');
    
    if (studentName.firstName) {
      document.getElementById('setFirstName').value = studentName.firstName;
    }
    if (studentName.lastName) {
      document.getElementById('setLastName').value = studentName.lastName;
    }
    if (studentName.email) {
      document.getElementById('setEmail').value = studentName.email;
    }
  }
  
  // === L√¶rer Login funktionalitet ===
  function showTeacherLoginModal() {
    document.getElementById('teacherLoginModal').style.display = 'flex';
  }
  
  function closeTeacherLoginModal() {
    document.getElementById('teacherLoginModal').style.display = 'none';
    document.getElementById('teacherLoginError').textContent = '';
  }
  
  function doTeacherLogin() {
    const username = document.getElementById('teacherUsername').value.trim();
    const password = document.getElementById('teacherPassword').value.trim();
    const schoolId = document.getElementById('teacherLoginSchoolId').value.trim();
    const classId = document.getElementById('teacherLoginClassId').value.trim();
    
    if (!username || !password) {
      document.getElementById('teacherLoginError').textContent = 'Indtast venligst b√•de brugernavn og adgangskode';
      return;
    }
    
    // Simpel l√¶rer login - kan tilpasses senere
    if (username === 'l√¶rer' && password === '1234') {
      // Gem l√¶rer info
      localStorage.setItem('teacher_logged_in', 'true');
      localStorage.setItem('teacher_school_id', schoolId);
      localStorage.setItem('teacher_class_id', classId);
      
      // Skjul l√¶rer login knap og vis dashboard knap
      document.getElementById('btnTeacherLogin').style.display = 'none';
      document.getElementById('btnTeacherTab').style.display = 'inline-block';
      
      // Luk modal
      closeTeacherLoginModal();
      
      // Indl√¶s elev progress
      loadTeacherProgress();
      
      alert('‚úÖ Logget ind som l√¶rer! Du kan nu se elev progress.');
    } else {
      document.getElementById('teacherLoginError').textContent = 'Forkert brugernavn eller adgangskode';
    }
  }
  
  function loadTeacherProgress() {
    const schoolId = localStorage.getItem('teacher_school_id') || 'default';
    const classId = localStorage.getItem('teacher_class_id') || 'default';
    
    console.log('üîç loadTeacherProgress kaldt med:', { schoolId, classId });
    
    // Opdater input felter
    document.getElementById('teacherSchoolId').value = schoolId;
    document.getElementById('teacherClassId').value = classId;
    
    // Indl√¶s data fra Firebase
    console.log('üîç Kalder getClassProgress...');
    getClassProgress(schoolId, classId).then(progress => {
      console.log('üîç Fik progress data:', progress);
      displayTeacherProgress(progress);
      updateTeacherStats(progress);
    }).catch(error => {
      console.error('‚ùå Fejl ved indl√¶s af progress:', error);
    });
  }
  
  function displayTeacherProgress(progress) {
    const container = document.getElementById('teacherProgressList');
    
    if (progress.length === 0) {
      container.innerHTML = '<p class="muted">Ingen elev progress fundet for denne skole/klasse</p>';
      return;
    }
    
    const html = progress.map(item => `
      <div class="progress-item">
        <div class="student-name">${item.userFirstName} ${item.userLastName}</div>
        <div class="task-info">‚úÖ ${item.taskName}</div>
        <div class="timestamp">Fuldf√∏rt: ${item.completedAt}</div>
      </div>
    `).join('');
    
    container.innerHTML = html;
  }
  
  function updateTeacherStats(progress) {
    // Beregn statistikker
    const uniqueStudents = new Set(progress.map(p => p.userId)).size;
    const totalTasks = progress.length;
    const uniqueTasks = new Set(progress.map(p => p.taskId)).size;
    
    // Opdater UI
    document.getElementById('totalStudents').textContent = uniqueStudents;
    document.getElementById('totalTasks').textContent = totalTasks;
    document.getElementById('completionRate').textContent = uniqueTasks;
  }
  
  function checkTeacherLogin() {
    const isTeacherLoggedIn = localStorage.getItem('teacher_logged_in') === 'true';
    
    if (isTeacherLoggedIn) {
      // Vis l√¶rer dashboard knap
      document.getElementById('btnTeacherTab').style.display = 'inline-block';
      document.getElementById('btnTeacherLogin').style.display = 'none';
      
      // Indl√¶s elev progress
      loadTeacherProgress();
    } else {
      // Skjul l√¶rer dashboard og knap
      document.getElementById('view-teacher').style.display = 'none';
      document.getElementById('btnTeacherTab').style.display = 'none';
      document.getElementById('btnTeacherLogin').style.display = 'block';
    }
  }
  
  function doTeacherLogout() {
    console.log('üîç doTeacherLogout kaldt - starter logout process');
    
    // Skjul l√¶rer dashboard
    document.getElementById('view-teacher').style.display = 'none';
    document.getElementById('view-teacher').classList.remove('active');
    console.log('üîç L√¶rer dashboard skjult');
    
    // Vis alle normale faner og views igen
    document.querySelector('.tabs').style.display = 'flex';
    document.querySelectorAll('.view').forEach(view => {
      if (view.id !== 'view-teacher') {
        view.style.display = 'block';
      }
    });
    
    // Vis l√¶rer login knap igen og skjul dashboard knap
    document.getElementById('btnTeacherLogin').style.display = 'block';
    document.getElementById('btnTeacherTab').style.display = 'none';
    console.log('üîç L√¶rer login knap vist igen og dashboard knap skjult');
    
    // Skift til simulator fane
    if (typeof setTab === 'function') {
      setTab('sim');
      console.log('üîç Skiftet til simulator fane med setTab');
    } else {
      // Fallback til manuelt fane skift
      document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('tabSim').classList.add('active');
      document.querySelectorAll('.view').forEach(view => {
        if (view.id === 'view-sim') {
          view.classList.add('active');
        } else {
          view.classList.remove('active');
        }
      });
      console.log('üîç Skiftet til simulator fane manuelt (fallback)');
    }
    
    // Ryd l√¶rer login status
    localStorage.removeItem('teacher_logged_in');
    localStorage.removeItem('teacher_school_id');
    localStorage.removeItem('teacher_class_id');
    console.log('üîç L√¶rer login status ryddet');
    
    alert('‚úÖ Logget ud som l√¶rer!');
    console.log('üîç doTeacherLogout f√¶rdig');
  }
  


  // === Firebase konfiguration ===
  console.log('üîç Firebase konfiguration startet');
  console.log('üîç firebase object tilg√¶ngelig:', typeof firebase);
  
  const firebaseConfig = {
    apiKey: "AIzaSyCdXnszAUJfkC5uyv9n-kVE2Whv_0vZfLk",
    authDomain: "ibi-simulator-f6ebe.firebaseapp.com",
    projectId: "ibi-simulator-f6ebe",
    storageBucket: "ibi-simulator-f6ebe.firebasestorage.app",
    messagingSenderId: "929875729041",
    appId: "1:929875729041:web:d53f21685b20d63fb73d30",
    measurementId: "G-YR3XWP3RVH"
  };

  // Initialiser Firebase
  try {
    console.log('Initialiserer Firebase...');
    firebase.initializeApp(firebaseConfig);
    console.log('Firebase app initialiseret');
    
    const db = firebase.firestore();
    const auth = firebase.auth();
    console.log('Firebase services initialiseret');
    
    // G√∏r Firebase tilg√¶ngeligt globalt
    window.firebase = firebase;
    window.db = db;
    window.auth = auth;
    
    // Test forbindelse
    db.collection('test').doc('test').get()
      .then(() => console.log('‚úÖ Firebase forbindelse virker!'))
      .catch(err => console.error('‚ùå Firebase forbindelse fejlede:', err));
      
  } catch (error) {
    console.error('‚ùå Firebase initialisering fejlede:', error);
  }

  // === Cloud Database funktionalitet ===
           async function saveUserProgress(userId, taskId, taskName, completedAt, currentUser) {
           try {
             console.log('üöÄ saveUserProgress kaldt med data:', { userId, taskId, taskName, completedAt, currentUser });
      
      if (!window.db) {
        console.error('‚ùå Firebase database ikke tilg√¶ngelig - window.db er undefined');
        console.log('üîç window.db:', window.db);
        console.log('üîç window.firebase:', window.firebase);
        saveToLocalStorage(userId, taskId, taskName, completedAt, currentUser);
        return false;
      }
      
      console.log('üîç Firebase database tilg√¶ngelig, fors√∏ger at gemme...');
      
               await window.db.collection('user_progress').add({
           userId: userId,
           userFirstName: currentUser.firstName || 'Ukendt',
           userLastName: currentUser.lastName || 'Bruger',
           userEmail: currentUser.email || 'ingen@email.dk',
           taskId: taskId,
           taskName: taskName,
           completedAt: completedAt,
           timestamp: window.firebase.firestore.FieldValue.serverTimestamp(),
           schoolId: 'default', // Kan tilpasses senere
           classId: 'default'   // Kan tilpasses senere
         });
      console.log('‚úÖ Progress gemt i cloud database');
      return true;
    } catch (error) {
      console.error('‚ùå Fejl ved gem af progress:', error);
      console.log('üîç Fejl detaljer:', error.message, error.stack);
      // Fallback til localStorage hvis cloud fejler
      saveToLocalStorage(userId, taskId, taskName, completedAt, currentUser);
      return false;
    }
  }

           function saveToLocalStorage(userId, taskId, taskName, completedAt, currentUser) {
           // currentUser sendes nu som parameter i stedet for at hentes igen
           const pendingSync = JSON.parse(localStorage.getItem('pending_sync') || '[]');
           pendingSync.push({ 
             userId, 
             userFirstName: currentUser?.firstName || 'Ukendt',
             userLastName: currentUser?.lastName || 'Bruger',
             userEmail: currentUser?.email || 'ingen@email.dk',
             taskId, 
             taskName, 
             completedAt, 
             timestamp: new Date().toISOString() 
           });
           localStorage.setItem('pending_sync', JSON.stringify(pendingSync));
           console.log('Progress gemt lokalt (venter p√• sync)');
         }

  async function syncPendingData() {
    if (!navigator.onLine) return;
    
    const pendingSync = JSON.parse(localStorage.getItem('pending_sync') || '[]');
    if (pendingSync.length === 0) return;

    console.log('Syncer pending data til cloud...');
    
    for (const item of pendingSync) {
      try {
                     await window.db.collection('user_progress').add({
               userId: item.userId,
               userFirstName: item.userFirstName || 'Ukendt',
               userLastName: item.userLastName || 'Bruger', 
               userEmail: item.userEmail || 'ingen@email.dk',
               taskId: item.taskId,
               taskName: item.taskName,
               completedAt: item.completedAt,
               timestamp: window.firebase.firestore.FieldValue.serverTimestamp(),
               schoolId: 'default',
               classId: 'default',
               syncedFromLocal: true
             });
      } catch (error) {
        console.error('Fejl ved sync af item:', error);
      }
    }
    
    // Ryd pending data efter succesfuld sync
    localStorage.removeItem('pending_sync');
    console.log('Pending data synced til cloud');
  }

  // === L√¶rer Dashboard funktionalitet ===
  async function getClassProgress(schoolId = 'default', classId = 'default') {
    try {
      const snapshot = await window.db.collection('user_progress')
        .where('schoolId', '==', schoolId)
        .where('classId', '==', classId)
        .orderBy('timestamp', 'desc')
        .get();
      
      const progress = [];
      snapshot.forEach(doc => {
        progress.push({ id: doc.id, ...doc.data() });
      });
      
      return progress;
    } catch (error) {
      console.error('Fejl ved hent af klassedata:', error);
      return [];
    }
  }

  async function exportClassData(schoolId = 'default', classId = 'default') {
    const progress = await getClassProgress(schoolId, classId);
    
    // Opret CSV data
    const csvData = [
      ['Bruger ID', 'Opgave ID', 'Opgave Navn', 'Fuldf√∏rt Dato', 'Tidspunkt', 'Skole ID', 'Klasse ID'],
      ...progress.map(p => [
        p.userId,
        p.taskId,
        p.taskName,
        p.completedAt,
        p.timestamp?.toDate?.()?.toLocaleString('da-DK') || p.timestamp,
        p.schoolId,
        p.classId
      ])
    ];
    
    // Download CSV
    const csvContent = csvData.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `klasse_progress_${classId}_${Date.now()}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('Klassedata eksporteret som CSV');
  }

  // === Brugerregistrering funktionalitet ===
  function showRegisterModal() {
    document.getElementById('registerModal').style.display = 'flex';
  }

  function closeRegisterModal() {
    document.getElementById('registerModal').style.display = 'none';
    // Ryd felterne
    document.getElementById('regFirstName').value = '';
    document.getElementById('regLastName').value = '';
    document.getElementById('regEmail').value = '';
    document.getElementById('regUsername').value = '';
    document.getElementById('regPassword').value = '';
    document.getElementById('registerError').innerText = '';
  }

  function createUser() {
    const firstName = document.getElementById('regFirstName').value.trim();
    const lastName = document.getElementById('regLastName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value.trim();
    
    // Validering
    if (!firstName || !lastName || !email || !username || !password) {
      document.getElementById('registerError').innerText = 'Alle felter skal udfyldes!';
      return;
    }
    
    if (password.length < 4) {
      document.getElementById('registerError').innerText = 'Adgangskode skal v√¶re mindst 4 tegn!';
      return;
    }
    
    // Tjek om brugernavn allerede eksisterer
    const existingUsers = JSON.parse(localStorage.getItem('ibi_users') || '[]');
    if (existingUsers.some(user => user.username === username)) {
      document.getElementById('registerError').innerText = 'Brugernavn findes allerede!';
      return;
    }
    
    // Opret ny bruger
    const newUser = {
      id: Date.now().toString(),
      firstName: firstName,
      lastName: lastName,
      email: email,
      username: username,
      password: password, // I produktion skulle dette hashes
      createdAt: new Date().toISOString(),
      completedTasks: [],
      lastLogin: null
    };
    
    // Gem bruger
    existingUsers.push(newUser);
    localStorage.setItem('ibi_users', JSON.stringify(existingUsers));
    
    // Log ind automatisk
    localStorage.setItem('simUser', username);
    localStorage.setItem('simPass', password);
    
    // Luk modal og log ind
    closeRegisterModal();
    document.getElementById('loginUser').value = username;
    document.getElementById('loginPass').value = password;
    doLogin();
    
    console.log('Ny bruger oprettet:', newUser);
  }


  






    function getCurrentUser() {
    const username = localStorage.getItem('simUser');
    console.log('üîç getCurrentUser - localStorage simUser:', username);
    
    if (!username) {
      console.log('‚ùå getCurrentUser - ingen username i localStorage');
      return null;
    }

    console.log('üîç getCurrentUser kaldt med username:', username);

    // F√∏rst tjek registrerede brugere
    const users = JSON.parse(localStorage.getItem('ibi_users') || '[]');
    const registeredUser = users.find(user => user.username === username);
    if (registeredUser) {
      console.log('üîç Registreret bruger fundet:', registeredUser);
      return registeredUser;
    }

    // Hvis ikke registreret, returner standard bruger info
    if (username === 'admin') {
      // Tjek om der er gemt et elevnavn
      const studentName = JSON.parse(localStorage.getItem('student_name') || '{}');
      
      const adminUser = {
        id: 'admin',
        firstName: studentName.firstName || 'Admin',
        lastName: studentName.lastName || 'Bruger',
        email: studentName.email || 'admin@ibisimulator.dk',
        username: 'admin'
      };
      console.log('üîç Admin bruger returneret:', adminUser);
      return adminUser;
    }

    // For alle andre brugere (fx Test1), returner standard bruger info
    const studentName = JSON.parse(localStorage.getItem('student_name') || '{}');
    
    const defaultUser = {
      id: username,
      firstName: studentName.firstName || username,
      lastName: studentName.lastName || 'Bruger',
      email: studentName.email || `${username}@ibisimulator.dk`,
      username: username
    };
    
    console.log('üîç Standard bruger returneret for:', username, defaultUser);
    return defaultUser;
  }

  function updateUserTaskCompletion(taskId, taskName) {
    const currentUser = getCurrentUser();
    if (!currentUser) return;
    
    const completedAt = new Date().toISOString();
    
    // Tilf√∏j til brugerens completedTasks hvis ikke allerede der
    if (!currentUser.completedTasks.some(task => task.id === taskId)) {
      currentUser.completedTasks.push({
        id: taskId,
        name: taskName,
        completedAt: completedAt
      });
      
      // Opdater brugerdata
      const users = JSON.parse(localStorage.getItem('ibi_users') || '[]');
      const userIndex = users.findIndex(user => user.username === currentUser.username);
      if (userIndex !== -1) {
        users[userIndex] = currentUser;
        localStorage.setItem('ibi_users', JSON.stringify(users));
      }
      
      console.log('Opgave fuldf√∏rt:', taskName, 'for bruger:', currentUser.firstName, currentUser.lastName);
    }
  }

  // === Settings event setup ===
  function setupSettingsEvents() {
    console.log('Setting up settings events...');
    
    // Tema selector
    const themeSelect = document.getElementById('themeSelect');
    if(themeSelect) {
      // Indl√¶s gemt tema
      const savedTheme = localStorage.getItem('ibi.theme') || 'auto';
      themeSelect.value = savedTheme;
      applyTheme(savedTheme);
      
      // Lyt til √¶ndringer
      themeSelect.addEventListener('change', (e) => {
        const theme = e.target.value;
        console.log('Theme changed to:', theme);
        applyTheme(theme);
      });
    }
    
    // Onboarding reset
    const btnResetOnboarding = document.getElementById('btnResetOnboarding');
    if(btnResetOnboarding) {
      btnResetOnboarding.onclick = () => {
        if(confirm('Er du sikker p√•, at du vil starte forfra med onboarding? Dette vil nulstille alle onboarding trin.')) {
          // Slet alle onboarding-relaterede data
          localStorage.removeItem('onboarding_completed');
          localStorage.removeItem('completed_tasks');
          localStorage.removeItem('task_help_visible');
          localStorage.removeItem('ibi.onboarding');
          localStorage.removeItem('ibi.completedTasks');
          localStorage.removeItem('ibi.onboardingStep');
          
          // Vis bekr√¶ftelse
          alert('Onboarding er nulstillet! Siden vil genindl√¶ses for at aktivere onboarding igen.');
          
          // Genindl√¶s siden
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        }
      };
    }
  }

  // === Tema funktionalitet ===
  function applyTheme(theme) {
    console.log('Applying theme:', theme);
    
    if(theme === 'light') {
      // Automatisk tema - f√∏lg system preference
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      console.log('Light theme - system prefers:', prefersDark ? 'dark' : 'light');
      applyTheme(prefersDark ? 'dark' : 'powerful');
      return;
      
    } else if(theme === 'dark') {
      // M√∏rkt tema - gendan originale CSS variabler
      document.documentElement.style.setProperty('--hc-bg', '#0b0d10');
      document.documentElement.style.setProperty('--hc-panel', '#0f1319');
      document.documentElement.style.setProperty('--hc-head', '#0d1116');
      document.documentElement.style.setProperty('--hc-text', '#eef3f8');
      document.documentElement.style.setProperty('--hc-muted', '#a7b4c5');
      document.documentElement.style.setProperty('--hc-hair', 'rgba(255,255,255,.14)');
      document.documentElement.style.setProperty('--hc-hair-2', 'rgba(255,255,255,.22)');
      
           } else if(theme === 'powerful') {
         // Contrast Theme - bruger de specificerede hex koder
         document.documentElement.style.setProperty('--hc-bg', '#212121'); // M√∏rk gr√• baggrund
         document.documentElement.style.setProperty('--hc-panel', '#e67514'); // Orange panel baggrund
         document.documentElement.style.setProperty('--hc-head', '#e67514'); // Orange header baggrund
         document.documentElement.style.setProperty('--hc-text', '#D3ECCD'); // Lys gr√∏n tekst
         document.documentElement.style.setProperty('--hc-muted', '#D3ECCD'); // Lys gr√∏n muted tekst
         document.documentElement.style.setProperty('--hc-hair', 'rgba(6,146,62,0.3)'); // Gr√∏n accent med transparency
         document.documentElement.style.setProperty('--hc-hair-2', 'rgba(6,146,62,0.5)'); // Gr√∏n accent med mere transparency
      
    } else {
      // Auto - f√∏lg system preference
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      console.log('Auto theme - system prefers:', prefersDark ? 'dark' : 'light');
      applyTheme(prefersDark ? 'dark' : 'light');
      return;
    }
    
    // Gem tema valg
    localStorage.setItem('ibi.theme', theme);
    console.log('Theme applied and saved:', theme);
  }
  
  // Setup events when DOM is ready
  if(document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setupLoginEvents();
      setupSettingsEvents();
      loadStudentName(); // Indl√¶s gemt elevnavn
      checkTeacherLogin(); // Tjek om l√¶reren er logget ind
    });
  } else {
    setupLoginEvents();
    setupSettingsEvents();
    loadStudentName(); // Indl√¶s gemt elevnavn
  }

</script>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const ids = ['view-sim','view-flow','view-settings'];
  const buttons = document.querySelectorAll('.mainnav button');
  function show(id){
    ids.forEach(x => {
      const el = document.getElementById(x);
      if(el){ el.style.display = (x===id)?'block':'none'; }
      const btn = document.querySelector(`.mainnav button[data-target="${x}"]`);
      if(btn){ btn.classList.toggle('active', x===id); }
    });
    try{ localStorage.setItem('ibi.activeView', id); }catch(e){}
  }
  buttons.forEach(b => b.addEventListener('click', () => show(b.dataset.target)));
  // initial
  let start = null;
  try{ start = localStorage.getItem('ibi.activeView'); }catch(e){}
  if(!ids.includes(start)) start = ids[0];
  show(start);
});
</script>

<script>
// === LUA bar dropdown (konsolideret) ===
(function(){
  const dd = document.getElementById('luaDD');
  if(!dd) return;
  const btn = document.getElementById('luaBtn');
  const list = document.getElementById('luaList');
  
  if (btn && list){
    btn.addEventListener('click', function(){
      const open = list.classList.toggle('open');
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
    });
    
    // Close dropdown when clicking outside
  document.addEventListener('click', function(e){
      if(!dd.contains(e.target)) { 
      list.classList.remove('open');
      btn.setAttribute('aria-expanded','false');
    }
  });
    
    // Bridge: forward new button clicks to the original hidden ones
    const oldGen  = document.getElementById('btnGenLua');
    const oldCopy = document.getElementById('btnCopyLua');
    const oldSave = document.getElementById('btnSaveLua');
    const nGen  = document.getElementById('luaGen2');
    const nCopy = document.getElementById('luaCopy2');
    const nSave = document.getElementById('luaSave2');
    
    if (nGen && oldGen)  nGen.addEventListener('click',  function(){ oldGen.click();  });
    if (nCopy && oldCopy) nCopy.addEventListener('click', function(){ oldCopy.click(); });
    if (nSave && oldSave) nSave.addEventListener('click', function(){ oldSave.click(); });
  }
})();
</script>

</body>
</html>
